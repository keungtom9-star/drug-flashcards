<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Drug Tutor (Molmo Vision Added)</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Modern Medical Palette */
            --primary: #4F46E5;       /* Indigo: Trust & Professionalism */
            --primary-hover: #4338ca;
            --secondary: #10B981;     /* Emerald: Success/Safe */
            --accent: #F43F5E;        /* Rose: Attention/Urgent */
            --surface: #ffffff;
            --background: #F3F4F6;
            --text-main: #111827;
            --text-muted: #6B7280;
            
            /* UI Variables */
            --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px; /* Subtle dot pattern */
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        /* Updated H1 to handle Image Alignment */
        h1 {
            color: var(--text-main);
            margin-bottom: 5px;
            text-align: center;
            font-weight: 800;
            letter-spacing: -0.025em;
            font-size: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        /* Logo Styling */
        .app-logo {
            height: 45px;        /* Slightly smaller to fit text line */
            width: 45px;         /* Force square aspect ratio */
            min-width: 45px;     /* Prevents squishing on mobile */
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease;
            }

        .app-logo:hover {
            transform: rotate(10deg) scale(1.1); /* Adds a little interaction effect */
        }
        .subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 30px;
            text-align: center;
            font-weight: 500;
            background: #e5e7eb;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }
        /* --- Notice Banner Styling --- */
        .notice-banner {
            background-color: #fffbeb; /* Light Yellow background */
            border: 1px solid #fcd34d; /* Yellow Border */
            color: #92400e;            /* Dark Orange Text */
            
            /* Size & Spacing */
            width: 100%;
            max-width: 850px;          /* Same width as your buttons */
            padding: 12px 20px;
            margin-bottom: 20px;       /* Space below the notice */
            border-radius: 12px;
            box-sizing: border-box;    /* Ensures padding doesn't break layout */
            
            /* Layout: Puts image and text side-by-side */
            display: flex;
            align-items: center;
            gap: 15px;                 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .notice-img {
            height: 60px;              /* Controls the image size */
            width: auto;               /* Keeps the aspect ratio correct */
            object-fit: contain;
            display: block;            /* Fixes alignment issues */
        }

        .notice-text {
            font-size: 0.95rem;
            line-height: 1.4;
            font-weight: 500;
        }

        /* Mobile Tweak: Stack them if screen is very small */
        @media (max-width: 680px) {
            .notice-banner {
                flex-direction: column;
                text-align: center;
            }
        }
        /* --- Controls --- */
        .top-bar {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 30px;
            width: 100%;
            max-width: 850px;
            flex-wrap: wrap;
            background: var(--surface);
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid #e5e7eb;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        button:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        button:active { transform: translateY(0); }

        /* Button Variants */
        button.mode-active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        button.secondary {
            background-color: white;
            color: var(--text-main);
            border: 1px solid #d1d5db;
        }
        button.secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }

        button.lang-lihkg { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); color: white; }
        button.set-extended { background-color: #7c3aed; color: white; }
        button.muted { background-color: var(--accent); color: white; }

        /* --- Settings Panel --- */
        #settings-panel {
            display: none;
            background: var(--surface);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            width: 100%;
            max-width: 600px;
            border: 1px solid #e5e7eb;
            box-sizing: border-box;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .settings-label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-main); }
        .settings-input, select {
            width: 100%; padding: 10px 12px;
            border: 1px solid #d1d5db; border-radius: 8px;
            margin-bottom: 15px; box-sizing: border-box;
            font-family: inherit; font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        .settings-input:focus, select:focus { border-color: var(--primary); outline: 3px solid #e0e7ff; }
        
        /* Cloud Import Styling */
        .import-wrapper {
            border: 1px solid #d1d5db;
            padding: 15px;
            border-radius: 8px;
            background: #f9fafb;
            margin-bottom: 15px;
        }
        .url-input-group { display: flex; gap: 8px; }
        .url-input-group input { flex-grow: 1; }

        /* --- Main Container --- */
        #app-container { width: 100%; max-width: 650px; perspective: 1000px; }

        /* --- Search Bar --- */
        .search-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
        }
        .search-input {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .search-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .btn-search {
            background-color: var(--primary);
            color: white;
            padding: 0 20px;
        }

        /* --- Flashcards --- */
        .flashcard-container {
            width: 100%; height: 650px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .flashcard-container.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            background-color: var(--surface);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 30px; box-sizing: border-box;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.02);
        }

        .card-front {
            background: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%);
        }

        .card-back {
            transform: rotateY(180deg);
            align-items: flex-start; text-align: left;
            overflow-y: auto; padding-top: 25px;
        }
        
        /* Custom Scrollbar for Card Back */
        .card-back::-webkit-scrollbar { width: 6px; }
        .card-back::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }

        .card-title {
            font-size: 1.8rem; font-weight: 800;
            background: -webkit-linear-gradient(45deg, var(--primary), #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 15px 0;
        }
        
        /* Badge for AI Generated cards */
        .ai-badge {
            background-color: #e0f2fe;
            color: #0284c7;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: none; /* hidden by default */
        }

        .detail-row {
            margin-bottom: 15px; width: 100%;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 10px;
        }
        .detail-label {
            font-size: 0.7rem; font-weight: 700;
            color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 4px;
        }
        .detail-content { font-size: 1rem; color: var(--text-main); font-weight: 500; }

        /* --- Quiz & Ask Sections --- */
        .quiz-container, #ask-section {
            background: var(--surface); padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid #e5e7eb;
            display: none;
        }

        .quiz-question { font-size: 1.3rem; font-weight: 700; margin-bottom: 25px; color: var(--text-main); }
        .option-btn {
            background-color: #f9fafb; color: var(--text-main);
            text-align: left; border: 1px solid #e5e7eb;
            padding: 16px 20px; border-radius: 12px;
            transition: all 0.2s; font-size: 1rem;
            margin-bottom: 10px;
            width: 100%;
            cursor: pointer;
        }
        .option-btn:hover { border-color: var(--primary); background-color: #eef2ff; }
        .option-btn.correct { background-color: #ecfdf5; border-color: var(--secondary); color: #065f46; }
        .option-btn.wrong { background-color: #fef2f2; border-color: var(--accent); color: #991b1b; }

        /* --- AI Boxes & Ask --- */
        .ask-textarea { 
            width: 100%; height: 100px; padding: 15px; 
            border: 1px solid #d1d5db; border-radius: 12px; 
            font-size: 1rem; margin-bottom: 15px; 
            box-sizing: border-box; resize: vertical; 
            font-family: inherit;
        }
        .ask-textarea:focus { border-color: var(--primary); outline: 3px solid #e0e7ff; }

        .btn-ask-submit { background-color: var(--accent); width: 100%; font-size: 1rem; justify-content: center; }
        .ask-header { font-weight: 800; color: var(--accent); margin-bottom: 10px; font-size: 1.2rem; }

        .ai-btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; width: 100%; }
        .ai-btn-small { font-size: 0.9rem; padding: 10px 12px; width: 100%; text-align: left; display: flex; align-items: center; gap: 8px; }
        .btn-sim { background-color: var(--secondary); }
        .btn-explain { background-color: var(--primary); color: white; width: 100%; margin-top: 20px; display: none; justify-content: center;}

        .ai-output-box {
            margin-top: 20px; padding: 20px;
            border-radius: 12px; font-size: 0.95rem;
            line-height: 1.7;
            background: #f0fdfa; border-left: 5px solid var(--secondary);
            animation: fadeIn 0.5s;
            display: none;
            width: 100%;
            box-sizing: border-box;
        }
        #ask-response-box { background: #fff1f2; border-left-color: var(--accent); }
        
        .ai-output-box h3 { margin: 15px 0 8px 0; font-size: 1.1rem; color: #0f172a; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 4px; font-weight: 800; }
        .ai-output-box ul { padding-left: 20px; margin: 8px 0; }
        
        .btn-read-ai { background-color: #e0e7ff; color: var(--primary); margin-top: 10px; width: 100%; font-size: 0.85rem; display: none; justify-content: center; }

        /* --- Nav Controls --- */
        .nav-controls {
            margin-top: 25px; display: flex;
            justify-content: space-between; width: 100%;
            background: white; padding: 10px;
            border-radius: 50px; box-shadow: var(--shadow-md);
        }
        .nav-controls button {
            border-radius: 40px;
            padding: 12px 24px;
            background: transparent; color: var(--text-main);
            box-shadow: none;
        }
        .nav-controls button:hover { background: #f3f4f6; transform: none; box-shadow: none; }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #fff;
            animation: spin 0.8s linear infinite; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<h1>
    <svg class="app-logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="64" height="64" rx="16" fill="#4F46E5"/>
        <path d="M32 16V48" stroke="white" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 32H48" stroke="white" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="42" cy="22" r="6" fill="#10B981" stroke="#4F46E5" stroke-width="2"/>
    </svg>
    Integrated Drug Sim
</h1>
    <div class="subtitle" id="provider-display">Provider: Not Configured</div>
    <div class="notice-banner">
    <img src="notice.png" alt="Notice Icon" class="notice-img" onerror="this.style.display='none'">
    
    <span class="notice-text">
        <strong>üì¢ Á•ùÁ¶èËÅ≤ÊÉ≥Â¶≥ÈÉΩËÅΩÂà∞
    </span>
</div>
    <div class="top-bar">
        <button id="mode-flashcard" class="mode-active" onclick="switchMode('flashcard')">Flashcards</button>
        <button id="mode-quiz" class="secondary" onclick="switchMode('quiz')">Quiz</button>
        <button id="mode-ask" class="secondary" onclick="switchMode('ask')">Clinical Ask</button>
        
        <button onclick="toggleDrugSet()" id="set-btn" class="secondary">üìö Set: Common</button>
        <button onclick="reshuffle()" style="background-color: #f59e0b;">Reset</button>
        <button onclick="toggleLanguage()" id="lang-btn" class="lang-lihkg">üåê Lang: LIHKG Mode</button>
        <button onclick="toggleMute()" id="mute-btn" class="secondary">üîä Audio: On</button>
        <button onclick="toggleSettings()" class="secondary">‚öôÔ∏è Settings</button>
    </div>

    <div id="settings-panel">
        <h3 style="margin-top:0;">Configuration</h3>

        <div class="settings-group">
            <label class="settings-label">Preferred iOS/System Voice:</label>
            <select id="voice-select">
                <option value="">Default System Voice</option>
            </select>
            <div style="font-size: 0.75rem; color:#666; margin-top:4px;">Tip: Select "Enhanced" voices for better quality.</div>
            <button onclick="testVoice()" style="margin-top:5px; font-size:0.8rem; padding:5px 10px;">üîä Test Voice</button>
        </div>

        <div class="settings-group">
            <label class="settings-label">Select Active AI Provider:</label>
            <select id="provider-select" onchange="updateProviderDisplay()">
                <option value="deepseek" selected>DeepSeek Official</option>
                <option value="openrouter_xiaomi">OpenRouter (Xiaomi - Text Fast)</option>
                <option value="openrouter_molmo">OpenRouter (Molmo 2 - Vision/Free)</option>
            </select>
            
            <label class="settings-label">OpenRouter API Key (sk-or...):</label>
            <input type="password" id="openrouter-key" class="settings-input" placeholder="Enter OpenRouter Key" />
            
            <label class="settings-label">DeepSeek API Key (sk-...):</label>
            <input type="password" id="deepseek-key" class="settings-input" placeholder="Enter DeepSeek Key" />
        </div>

        <div class="settings-group">
            <label class="settings-label">Load External Data (Google Sheet/Online CSV):</label>
            <div style="font-size:0.75rem; color:#666; margin-bottom:5px;">Paste a Google Sheet Link (must be 'Anyone with link can view')</div>
            
            <div class="import-wrapper">
                <div class="url-input-group">
                    <input type="text" id="sheet-url" class="settings-input" placeholder="https://docs.google.com/spreadsheets/d/..." style="margin-bottom:0;" />
                    <button onclick="fetchSheetData()" style="padding: 5px 15px;">Load</button>
                </div>
                <div id="upload-status" style="font-size:0.8rem; margin-top:5px; color:var(--primary); font-weight:bold;"></div>
            </div>
            
            <div style="margin-top: 10px; background: #f0fdf4; padding: 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid #bbf7d0; color: #166534;">
                <strong style="display:block; margin-bottom:5px;">üí° Format Guide:</strong>
                Create a Google Sheet with Headers required: <code>name, class, indication, SideEffects, nursing</code>
                <br>
                <strong>Split Drugs:</strong> Separate multiple drugs in one cell with a semi-colon:
                <br>
                <em>Example: Aripiprazole; Olanzapine; Risperidone</em>
            </div>
        </div>

        <button onclick="saveSettings()" style="width:100%; background-color: var(--secondary);">üíæ Save & Close</button>
    </div>

    <div id="app-container">
        
        <div id="flashcard-section">
            <div class="search-wrapper">
                <input type="text" id="drug-search" class="search-input" placeholder="Search drug (e.g., Panadol)..." onkeypress="handleEnter(event)">
                <button class="btn-search" onclick="searchDrug()" id="btn-search-trigger">üîç Search</button>
            </div>

            <div class="flashcard-container" id="flashcard" onclick="flipCard(event)">
                <div class="card-face card-front">
                    <span id="ai-badge-front" class="ai-badge">ü§ñ AI Generated</span>
                    <div style="font-size: 3.5rem; margin-bottom: 20px;">üíä</div>
                    <h2 id="fc-name" class="card-title">Drug Name</h2>
                    <p style="color: #9ca3af; font-size: 0.9rem;">(Tap to flip)</p>
                    <button onclick="event.stopPropagation(); speakText(flashcardList[fcCurrentIndex].name, 'en')" style="margin-top: 20px; background:#e0e7ff; color:var(--primary);">üîä Read Name</button>
                </div>
                <div class="card-face card-back">
                    <div class="detail-row"><div class="detail-label">Class</div><div class="detail-content" id="fc-class">...</div></div>
                    <div class="detail-row"><div class="detail-label">Indication</div><div class="detail-content" id="fc-indication">...</div></div>
                    <div class="detail-row"><div class="detail-label">SideEffects</div><div class="detail-content" id="fc-SideEffects">...</div></div>
                    <div class="detail-row" style="border:none;"><div class="detail-label">Nursing Considerations</div><div class="detail-content" id="fc-nursing">...</div></div>

                    <div class="ai-btn-group">
                        <button onclick="event.stopPropagation(); getIntegratedCaseStudy(flashcardList[fcCurrentIndex], 'fc-ai-case', 'btn-case', 'btn-read-case')" class="ai-btn-small btn-sim" id="btn-case">üè• AI: Generate Integrated Patient Case</button>
                        <div id="fc-ai-case" class="ai-output-box"></div>
                        <button onclick="event.stopPropagation(); readAIContent('fc-ai-case')" class="btn-read-ai" id="btn-read-case">üîä Read Out Loud</button>
                    </div>
                    <button onclick="event.stopPropagation(); speakBack(flashcardList[fcCurrentIndex])" style="margin-top: 20px; width:100%; background:#e0e7ff; color:var(--primary); font-size:0.8rem;">üîä Read Basic Details</button>
                </div>
            </div>
            <div class="nav-controls">
                <button onclick="prevCard()">‚Üê Prev</button>
                <span id="counter" style="align-self: center; font-weight: bold; color:#6b7280;">1 / 10</span>
                <button onclick="nextCard()">Next ‚Üí</button>
            </div>
        </div>

        <div id="quiz-section" class="quiz-container">
            <div id="quiz-content">
                <p class="quiz-question" id="quiz-question">Question...</p>
                <div class="quiz-options" id="quiz-options"></div>
            </div>
            <button id="btn-quiz-explain" class="btn-explain" onclick="triggerQuizExplain()">ü§ñ Explain Why (AI Tutor)</button>
            <div id="ai-container" style="display:none;">
                <h3><span id="ai-status-icon">ü§ñ</span> AI Tutor Explanation</h3>
                <div id="ai-content" class="ai-output-box" style="display:block;"></div>
                <button onclick="readAIContent('ai-content')" class="btn-read-ai" id="btn-read-explain" style="margin-bottom:0;">üîä Read Out Loud</button>
            </div>
            <div class="nav-controls" style="justify-content: flex-end;">
                <button onclick="nextQuestion()" id="next-quiz-btn" style="display:none;">Next Question ‚Üí</button>
            </div>
        </div>

        <div id="ask-section">
            <div class="ask-header">üë©‚Äç‚öïÔ∏è Clinical Mentor (Multimodal)</div>
            <p style="font-size:0.9rem; color:#666; margin-bottom: 20px;">Ask scenarios, or analyze images (e.g. pills, labels, ECGs) using <strong>Molmo Vision</strong>.</p>
            
            <input type="text" id="ask-image-url" class="settings-input" placeholder="Optional: Paste Image or Video URL (e.g. https://...)" style="margin-bottom: 10px;">
            
            <textarea id="ask-input" class="ask-textarea" placeholder="e.g. Identify this pill or explain this ECG pattern..."></textarea>
            
            <button onclick="askClinicalMentor()" class="btn-ask-submit" id="btn-ask-submit">üí° Ask Mentor</button>
            <div id="ask-response-box" class="ai-output-box"></div>
            <button onclick="readAIContent('ask-response-box')" class="btn-read-ai" id="btn-read-ask">üîä Read Out Loud</button>
        </div>

    </div>

    <script src="drugs.js"></script>
    <script src="prompts.js"></script>

    <script>
        // --- CONFIGURATION STATE ---
        let currentProvider = 'deepseek'; 
        let openRouterKey = ""; 
        let deepSeekKey = "sk-92db3cf721454bd7b351ca6ef40eaaf7";
        let selectedVoiceURI = ""; 
        let isMuted = false;

        let aiLanguage = 'lihkg'; 
        
        const defaultSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";

        // --- DATA SETS ---
        let extendedDrugs = []; 

        // --- APP STATE ---
        let activeSourceList = []; 
        let flashcardList = []; // Holds RAW data (combined strings)
        let quizList = [];      // Holds SPLIT data (individual drugs)
        
        let fcCurrentIndex = 0;
        let quizCurrentIndex = 0;
        let currentQuizData = null;

        // --- HELPER: SPLIT DRUG DATA (FOR QUIZ ONLY) ---
        function processRawData(data) {
            let processed = [];
            data.forEach(item => {
                if (item.name && typeof item.name === 'string' && item.name.includes(';')) {
                    // Split by semi-colon
                    let names = item.name.split(';');
                    names.forEach(n => {
                        const cleanName = n.trim();
                        // Only add if name is not empty
                        if(cleanName) {
                            processed.push({ ...item, name: cleanName });
                        }
                    });
                } else {
                    // Handle single entries (ensure they are trimmed too)
                    if(item.name) item.name = item.name.trim();
                    processed.push(item);
                }
            });
            return processed;
        }

        // --- INITIALIZATION ---
        function init() {
            const savedOR = localStorage.getItem('or_key');
            if(savedOR) openRouterKey = savedOR;
            
            const savedDS = localStorage.getItem('ds_key');
            if(savedDS) deepSeekKey = savedDS;
            
            const savedProv = localStorage.getItem('active_provider');
            if(savedProv) currentProvider = savedProv;

            const savedVoice = localStorage.getItem('preferred_voice');
            if(savedVoice) selectedVoiceURI = savedVoice;

            document.getElementById('openrouter-key').value = openRouterKey;
            document.getElementById('deepseek-key').value = deepSeekKey;
            document.getElementById('provider-select').value = currentProvider;
            
            document.getElementById('sheet-url').value = defaultSheetUrl;
            
            updateProviderDisplay();

            // Set Initial List (RAW DATA)
            if(typeof commonDrugs !== 'undefined') {
                activeSourceList = [...commonDrugs]; 
            }
            
            fetchSheetData();
            
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
        }

        // --- VOICE LIST POPULATION ---
        function populateVoiceList() {
            const voices = window.speechSynthesis.getVoices();
            const select = document.getElementById('voice-select');
            
            if(voices.length === 0) return; 

            select.innerHTML = '<option value="">Default System Voice</option>';
            
            const sortedVoices = voices.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                if (aName.includes('enhanced') && !bName.includes('enhanced')) return -1;
                if (!aName.includes('enhanced') && bName.includes('enhanced')) return 1;
                return aName.localeCompare(bName);
            });

            sortedVoices.forEach((voice) => {
                const option = document.createElement('option');
                const label = voice.name.includes("Enhanced") || voice.name.includes("Siri") ? `‚ú® ${voice.name}` : voice.name;
                option.textContent = `${label} (${voice.lang})`;
                option.value = voice.voiceURI;
                if(voice.voiceURI === selectedVoiceURI) option.selected = true;
                select.appendChild(option);
            });
        }

        function testVoice() {
            const select = document.getElementById('voice-select');
            const selectedURI = select.value;
            if(selectedURI) {
                selectedVoiceURI = selectedURI;
                speakText("Voice check. This is an enhanced quality test.", 'en', true); 
            } else {
                speakText("Default system voice test.", 'en', true);
            }
        }

        // --- GOOGLE SHEET / ONLINE CSV LOGIC ---
        async function fetchSheetData() {
            const urlInput = document.getElementById('sheet-url').value.trim();
            const statusEl = document.getElementById('upload-status');
            
            if (!urlInput) {
                statusEl.innerText = "‚ùå Please enter a URL.";
                return;
            }

            statusEl.innerText = "‚è≥ Fetching Database...";
            
            let fetchUrl = urlInput;
            if (urlInput.includes("docs.google.com/spreadsheets")) {
                if (urlInput.includes("/edit")) {
                    fetchUrl = urlInput.replace(/\/edit.*$/, "/export?format=csv");
                }
            }

            try {
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error("Network error or invalid link permissions.");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const required = ['name', 'class'];
                        const hasColumns = required.every(col => results.meta.fields.includes(col));
                        
                        if (hasColumns && results.data.length > 0) {
                            // Load RAW data into extendedDrugs (do NOT split here)
                            extendedDrugs = results.data;
                            
                            statusEl.innerText = `‚úÖ Success! Loaded ${extendedDrugs.length} rows.`;
                            
                            activeSourceList = extendedDrugs;
                            updateSetButton();
                            reshuffle();
                        } else {
                            statusEl.innerText = "‚ùå Error: CSV missing 'name' or 'class' headers.";
                        }
                    },
                    error: function(err) {
                        statusEl.innerText = "‚ùå Parse Error.";
                    }
                });
            } catch (e) {
                statusEl.innerText = "‚ùå Failed. Check link permissions (must be 'Anyone with link').";
                console.error(e);
            }
        }

        // --- SETTINGS LOGIC ---
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function saveSettings() {
            const orInput = document.getElementById('openrouter-key').value.trim();
            const dsInput = document.getElementById('deepseek-key').value.trim();
            const provInput = document.getElementById('provider-select').value;
            const voiceInput = document.getElementById('voice-select').value;

            if(orInput) { openRouterKey = orInput; localStorage.setItem('or_key', orInput); }
            if(dsInput) { deepSeekKey = dsInput; localStorage.setItem('ds_key', dsInput); }
            
            currentProvider = provInput;
            localStorage.setItem('active_provider', currentProvider);

            selectedVoiceURI = voiceInput;
            localStorage.setItem('preferred_voice', selectedVoiceURI);

            updateProviderDisplay();
            toggleSettings();
        }

        function updateProviderDisplay() {
            const display = document.getElementById('provider-display');
            if(currentProvider === 'openrouter_xiaomi') display.innerText = "Provider: OpenRouter (Xiaomi - Text)";
            else if(currentProvider === 'openrouter_molmo') display.innerText = "Provider: OpenRouter (Molmo - Vision)";
            else display.innerText = "Provider: DeepSeek Official";
        }

        function toggleDrugSet() {
            if (activeSourceList === commonDrugs || (Array.isArray(commonDrugs) && activeSourceList[0]?.name === commonDrugs[0]?.name)) {
                activeSourceList = extendedDrugs;
            } else {
                if(typeof commonDrugs !== 'undefined') activeSourceList = [...commonDrugs];
            }
            updateSetButton();
            reshuffle();
        }

        function updateSetButton() {
            const btn = document.getElementById('set-btn');
            if(activeSourceList === extendedDrugs) {
                btn.innerText = "üìö Set: Online CSV";
                btn.classList.add('set-extended');
                btn.classList.remove('secondary');
            } else {
                btn.innerText = "üìö Set: Common";
                btn.classList.add('secondary');
                btn.classList.remove('set-extended');
            }
        }

        function reshuffle() {
            if(!activeSourceList || activeSourceList.length === 0) return;
            
            // 1. Prepare Flashcard List (RAW DATA)
            flashcardList = [...activeSourceList];
            for (let i = flashcardList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashcardList[i], flashcardList[j]] = [flashcardList[j], flashcardList[i]];
            }

            // 2. Prepare Quiz List (SPLIT DATA)
            quizList = processRawData(activeSourceList);
            for (let i = quizList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [quizList[i], quizList[j]] = [quizList[j], quizList[i]];
            }

            fcCurrentIndex = 0;
            quizCurrentIndex = 0;
            renderCard();
            generateQuizQuestion();
            resetQuizUI();
        }

        // --- VOICE & LANGUAGE ---
        function toggleLanguage() {
            const btn = document.getElementById('lang-btn');
            btn.classList.remove('secondary', 'lang-canto', 'lang-lihkg');
            if (aiLanguage === 'english') {
                aiLanguage = 'cantonese'; btn.innerText = "üåê Lang: Canto+Eng"; btn.classList.add('lang-canto');
            } else if (aiLanguage === 'cantonese') {
                aiLanguage = 'lihkg'; btn.innerText = "üåê Lang: LIHKG Mode"; btn.classList.add('lang-lihkg');
            } else {
                aiLanguage = 'english'; btn.innerText = "üåê Lang: English"; btn.classList.add('secondary');
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if (isMuted) {
                window.speechSynthesis.cancel();
                btn.innerText = "üîá Audio: Off";
                btn.classList.add('muted');
                btn.classList.remove('secondary');
            } else {
                btn.innerText = "üîä Audio: On";
                btn.classList.remove('muted');
                btn.classList.add('secondary');
            }
        }

        function speakText(text, langCode = 'en', forceSelected = false) {
            if (isMuted) return; 
            
            window.speechSynthesis.cancel();
            
            let targetLang = langCode;
            if ((aiLanguage === 'cantonese' || aiLanguage === 'lihkg') && langCode !== 'en') { 
                targetLang = 'zh-HK'; 
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = targetLang;
            utterance.rate = 0.95;
            
            const voices = window.speechSynthesis.getVoices();
            
            if (selectedVoiceURI && !forceSelected) {
                const preferred = voices.find(v => v.voiceURI === selectedVoiceURI);
                if(preferred) utterance.voice = preferred;
            } 
            else if (voices.length > 0) {
                 const bestMatch = voices.find(v => v.lang.includes(targetLang) && (v.name.includes("Enhanced") || v.name.includes("Siri")));
                 const anyMatch = voices.find(v => v.lang.includes(targetLang));
                 
                 if(bestMatch) utterance.voice = bestMatch;
                 else if(anyMatch) utterance.voice = anyMatch;
            }
            
            if(forceSelected) {
                const select = document.getElementById('voice-select');
                const testURI = select.value;
                const testVoice = voices.find(v => v.voiceURI === testURI);
                if(testVoice) utterance.voice = testVoice;
            }

            window.speechSynthesis.speak(utterance);
        }

        // --- SEARCH & AI GENERATION LOGIC ---
        function handleEnter(e) {
            if(e.key === "Enter") searchDrug();
        }

        async function searchDrug() {
            const input = document.getElementById('drug-search');
            const btn = document.getElementById('btn-search-trigger');
            const query = input.value.trim().toLowerCase();
            
            if(!query) return;

            // 1. Search Local Data
            const foundIndex = flashcardList.findIndex(d => d.name.toLowerCase().includes(query));

            if(foundIndex !== -1) {
                fcCurrentIndex = foundIndex;
                renderCard();
                btn.innerText = "‚úÖ Found";
                setTimeout(() => btn.innerText = "üîç Search", 1500);
            } else {
                // 2. AI Fallback Generation
                btn.disabled = true;
                btn.innerHTML = "<span class='loading-spinner'></span> Generating...";
                
                try {
                    await generateAIDrug(query);
                    btn.innerText = "‚ú® AI Generated";
                } catch (e) {
                    console.error(e);
                    alert("Could not generate drug: " + e.message);
                    btn.innerText = "‚ùå Error";
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerText = "üîç Search";
                    }, 2000);
                }
            }
        }

        async function generateAIDrug(drugName) {
            // Prompt construction tailored to your JSON requirements
            const langInstruction = (aiLanguage === 'cantonese' || aiLanguage === 'lihkg') 
                ? "in Cantonese Chinese mixed with English medical terms. Tone: Professional but easy to understand." 
                : "in English.";

            const prompt = `You are a nursing pharmacology expert. 
            Create a valid JSON object for the drug "${drugName}". 
            Output ONLY valid JSON. No markdown. No comments.
            
            Required Format:
            {
              "name": "${drugName}",
              "class": "Pharmacological class",
              "indication": "Primary uses (${langInstruction})",
              "SideEffects": "Common side effects (${langInstruction})",
              "nursing": "Key nursing considerations (${langInstruction})"
            }`;

            // Force text-only call for search generation regardless of provider
            // We temporarily use current provider but strict text structure
            const response = await getAIResponse(prompt);
            
            // Clean response to ensure valid JSON (remove markdown code blocks if present)
            const jsonString = response.replace(/```json/g, '').replace(/```/g, '').trim();
            const newDrug = JSON.parse(jsonString);

            // Add flag for UI
            newDrug.isAI = true;

            // Insert into list
            flashcardList.splice(fcCurrentIndex + 1, 0, newDrug);
            fcCurrentIndex++;
            renderCard();
        }

        // --- CARD LOGIC ---
        function renderCard() {
            if(flashcardList.length === 0) return;
            const drug = flashcardList[fcCurrentIndex];
            fillCardData('fc', drug);
            
            // AI Badge logic
            const badge = document.getElementById('ai-badge-front');
            if(drug.isAI) badge.style.display = 'inline-block';
            else badge.style.display = 'none';

            document.getElementById('counter').innerText = `${fcCurrentIndex + 1} / ${flashcardList.length}`;
            resetAIUI('fc-ai-case', 'btn-case', 'btn-read-case');
        }
        function fillCardData(prefix, drug) {
            document.getElementById(`${prefix}-name`).innerText = drug.name || "N/A";
            document.getElementById(`${prefix}-class`).innerText = drug.class || "N/A";
            document.getElementById(`${prefix}-indication`).innerText = drug.indication || "N/A";
            document.getElementById(`${prefix}-SideEffects`).innerText = drug.SideEffects || "N/A";
            document.getElementById(`${prefix}-nursing`).innerText = drug.nursing || "N/A";
        }
        function resetAIUI(boxId, btnId, readBtnId) {
            document.getElementById(boxId).style.display = 'none'; document.getElementById(boxId).innerHTML = '';
            document.getElementById(readBtnId).style.display = 'none';
            const btn = document.getElementById(btnId); btn.disabled = false; btn.innerHTML = 'üè• AI: Generate Integrated Patient Case';
        }
        function flipCard(event) {
            if (event && (event.target.tagName === 'BUTTON' || event.target.closest('button') || event.target.tagName === 'INPUT')) return;
            const card = document.getElementById('flashcard');
            card.classList.toggle('flipped'); 
            window.speechSynthesis.cancel();
        }
        function nextCard() { if (fcCurrentIndex < flashcardList.length - 1) { fcCurrentIndex++; document.getElementById('flashcard').classList.remove('flipped'); renderCard(); } }
        function prevCard() { if (fcCurrentIndex > 0) { fcCurrentIndex--; document.getElementById('flashcard').classList.remove('flipped'); renderCard(); } }
        function speakBack(drug) { speakText(`Class: ${drug.class}. Indication: ${drug.indication}. Nursing: ${drug.nursing}`, 'en'); }
        function readAIContent(id) {
            const el = document.getElementById(id);
            const lang = (aiLanguage === 'cantonese' || aiLanguage === 'lihkg') ? 'zh-HK' : 'en';
            if(el) speakText(el.innerText, lang);
        }

        // --- API FUNCTIONS ---
        async function callOpenRouterAPI(messages, modelId) {
            if(!openRouterKey) throw new Error("OpenRouter Key Missing");
            
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { 
                    "Authorization": `Bearer ${openRouterKey}`, 
                    "Content-Type": "application/json",
                    "HTTP-Referer": window.location.href // OpenRouter required headers
                },
                body: JSON.stringify({ 
                    model: modelId, 
                    messages: messages, 
                    stream: false 
                })
            });
            if(!response.ok) {
                const err = await response.text();
                throw new Error("OpenRouter Error: " + err);
            }
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callDeepSeekAPI(messages) {
            if(!deepSeekKey) throw new Error("DeepSeek Key Missing");
            // DeepSeek API doesn't support Image URLs in this endpoint context usually, so we stick to text.
            // If image is present in messages, we must strip it or warn.
            // For now, if DeepSeek is selected, we only send text content.
            
            const textOnlyMessages = messages.map(m => {
                if(Array.isArray(m.content)) {
                    // Extract only text parts
                    const textParts = m.content.filter(c => c.type === 'text').map(c => c.text).join(' ');
                    return { role: m.role, content: textParts };
                }
                return m;
            });

            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${deepSeekKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "deepseek-chat", messages: textOnlyMessages, temperature: 0.7 })
            });
            if(!response.ok) throw new Error("DeepSeek API Error");
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function getAIResponse(promptText, imageUrl = null) {
            let messages = [];

            // Construct Message Payload based on Input Type
            if (imageUrl && currentProvider === 'openrouter_molmo') {
                // Molmo / Multimodal Payload
                const contentArr = [
                    { type: "text", text: promptText }
                ];
                
                // Check if it's a video or image (basic extension check or assume image)
                // The snippet used specific keys. Molmo on OpenRouter usually standardizes to 'image_url'.
                // If the user pasted a video url, we use 'video_url' as per your snippet.
                const isVideo = imageUrl.match(/\.(mp4|webm)|youtube\.com|youtu\.be/i);
                
                if(isVideo) {
                     contentArr.push({ type: "video_url", video_url: { url: imageUrl } });
                } else {
                     contentArr.push({ type: "image_url", image_url: { url: imageUrl } });
                }

                messages = [{ role: "user", content: contentArr }];
            } else {
                // Standard Text Payload
                messages = [{ role: "user", content: promptText }];
            }

            // Route to Provider
            if(currentProvider === 'deepseek') {
                return await callDeepSeekAPI(messages);
            } else if (currentProvider === 'openrouter_molmo') {
                return await callOpenRouterAPI(messages, "allenai/molmo-2-8b:free");
            } else {
                return await callOpenRouterAPI(messages, "xiaomi/mimo-v2-flash:free");
            }
        }

        // --- AI FEATURES ---
        async function askClinicalMentor() {
            const input = document.getElementById('ask-input').value; 
            const imgInput = document.getElementById('ask-image-url').value.trim();
            
            if(!input && !imgInput) return;
            
            const btn = document.getElementById('btn-ask-submit'); 
            const box = document.getElementById('ask-response-box'); 
            const readBtn = document.getElementById('btn-read-ask');
            
            btn.innerHTML = '<span class="loading-spinner"></span> Mentor Thinking...'; btn.disabled = true; box.style.display = 'block'; box.innerHTML = "Generating...";
            
            // Calling function from prompts.js
            let prompt = getMentorPrompt(input || "Analyze this image.", aiLanguage);
            
            // If image is present and no text, adjust prompt
            if(imgInput && !input) {
                prompt = "Please analyze this medical image/video. Identify the drug, label, or condition shown. " + (aiLanguage === 'lihkg' ? "Use Cantonese LIHKG style." : "Use professional tone.");
            }

            try {
                // Pass image URL if available
                const content = await getAIResponse(prompt, imgInput);
                box.innerHTML = marked.parse(content);
                btn.innerHTML = 'üí° Ask Mentor'; btn.disabled = false; readBtn.style.display = 'block';
            } catch (e) { 
                console.error(e);
                box.innerHTML = `Error: ${e.message}. <br>Tip: Ensure you selected the <strong>Molmo</strong> provider for images.`; btn.innerText = "Error"; btn.disabled = false; 
            }
        }

        async function getIntegratedCaseStudy(drugObj, boxId, btnId, readBtnId) {
            const btn = document.getElementById(btnId); const box = document.getElementById(boxId); const readBtn = document.getElementById(readBtnId);
            btn.innerHTML = '<span class="loading-spinner"></span> Simulating Patient...'; btn.disabled = true; box.style.display = 'block';
            
            // Calling function from prompts.js
            const prompt = getCaseStudyPrompt(drugObj, aiLanguage);
            
            try {
                const content = await getAIResponse(prompt);
                box.innerHTML = marked.parse(content);
                btn.innerHTML = '‚úÖ Case Loaded'; readBtn.style.display = 'block';
            } catch (e) { 
                box.innerHTML = `Error: ${e.message}. Check Settings.`; btn.innerText = "Error"; btn.disabled = false; 
            }
        }

        async function triggerQuizExplain() {
            const btn = document.getElementById('btn-quiz-explain'); const box = document.getElementById('ai-content'); const container = document.getElementById('ai-container'); const readBtn = document.getElementById('btn-read-explain');
            btn.innerHTML = '<span class="loading-spinner"></span> Thinking...'; btn.disabled = true; container.style.display = 'block'; box.innerHTML = 'Analyzing...';
            
            // Calling function from prompts.js
            const prompt = getQuizExplainPrompt(currentQuizData, aiLanguage);
            
            try {
                const content = await getAIResponse(prompt);
                box.innerHTML = marked.parse(content);
                btn.innerHTML = '‚úÖ Explained'; readBtn.style.display = 'block';
            } catch (e) { box.innerHTML = `Error: ${e.message}.`; btn.innerText = "Error"; }
        }

        // --- QUIZ LOGIC ---
        function resetQuizUI() {
            document.getElementById('next-quiz-btn').style.display = 'none';
            document.getElementById('ai-container').style.display = 'none';
            document.getElementById('btn-read-explain').style.display = 'none';
            document.getElementById('btn-quiz-explain').style.display = 'none';
            document.getElementById('btn-quiz-explain').innerHTML = 'ü§ñ Explain Why (AI Tutor)';
            document.getElementById('btn-quiz-explain').disabled = false;
        }

        function generateQuizQuestion() {
            resetQuizUI();
            const container = document.getElementById('quiz-options');
            const qEl = document.getElementById('quiz-question');
            container.innerHTML = '';

            if (quizList.length === 0) { qEl.innerText = "No drugs loaded."; return; }
            if (quizCurrentIndex >= quizList.length) { qEl.innerText = "Quiz Complete!"; return; }

            // USE quizList (Processed Split Data)
            const correctDrug = quizList[quizCurrentIndex];
            
            // Randomize Question Type: 0=Indication->Name, 1=Class->Name, 2=Name->Indication, 3=Name->Class
            const qType = Math.floor(Math.random() * 4);
            
            let qText = "";
            let correctText = "";
            let optionType = ""; 

            switch (qType) {
                case 0: // Indication -> Drug
                    qText = `Which drug is indicated for: "${correctDrug.indication}"?`;
                    correctText = correctDrug.name;
                    optionType = 'name';
                    break;
                case 1: // Class -> Drug
                    qText = `Which drug belongs to the class: "${correctDrug.class}"?`;
                    correctText = correctDrug.name;
                    optionType = 'name';
                    break;
                case 2: // Drug -> Indication
                    qText = `What is the primary indication for: "${correctDrug.name}"?`;
                    correctText = correctDrug.indication;
                    optionType = 'indication';
                    break;
                case 3: // Drug -> Class
                    qText = `What is the drug class of: "${correctDrug.name}"?`;
                    correctText = correctDrug.class;
                    optionType = 'class';
                    break;
            }

            qEl.innerText = qText;

            // Generate Options - Smart Filtering
            let wrongOptions = [];
            let attempts = 0;
            
            while(wrongOptions.length < 3 && attempts < 100) {
                attempts++;
                // Pick random from quizList (Split data)
                const randomDrug = quizList[Math.floor(Math.random() * quizList.length)];
                
                // Skip if it is the correct drug object
                if (randomDrug.name === correctDrug.name) continue;

                const optText = randomDrug[optionType];
                
                if (!optText || optText === "N/A") continue;
                if (optText === correctText) continue; // Skip if text is identical
                if (wrongOptions.includes(optText)) continue; // Skip duplicates

                // SMART CHECK: Does this random drug actually match the question criteria?
                let isConfusinglyCorrect = false;

                if (qType === 0) { // Asking for Indication -> expects Name
                    if (randomDrug.indication === correctDrug.indication) isConfusinglyCorrect = true;
                }
                if (qType === 1) { // Asking for Class -> expects Name
                    if (randomDrug.class === correctDrug.class) isConfusinglyCorrect = true;
                }
                
                if (!isConfusinglyCorrect) {
                    wrongOptions.push(optText);
                }
            }
            
            while(wrongOptions.length < 3) { wrongOptions.push("N/A"); }

            let optionsArr = [correctText, ...wrongOptions];
            optionsArr.sort(() => Math.random() - 0.5);

            optionsArr.forEach(optText => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = optText;
                btn.onclick = () => checkAnswer(btn, optText, correctText, correctDrug, qText);
                container.appendChild(btn);
            });
        }
        
        function checkAnswer(btn, selectedText, correctText, correctDrug, qText) {
            const btns = document.querySelectorAll('.option-btn'); 
            btns.forEach(b => b.onclick = null);
            
            let speakPhrase = "";
            
            if (selectedText === correctText) { 
                btn.classList.add('correct');
                speakPhrase = `Correct! ${correctDrug.name} is a ${correctDrug.class} indicated for ${correctDrug.indication}.`;
            } else { 
                btn.classList.add('wrong'); 
                btns.forEach(b => { if(b.innerText === correctText) b.classList.add('correct'); });
                speakPhrase = `Incorrect. The correct answer is ${correctText}. ${correctDrug.name} is a ${correctDrug.class}.`;
            }
            
            speakText(speakPhrase, 'en');
            
            document.getElementById('next-quiz-btn').style.display = 'block'; 
            document.getElementById('btn-quiz-explain').style.display = 'flex'; 
            
            currentQuizData = { q: qText, u: selectedText, c: correctDrug, correctAnswerText: correctText };
        }
        
        function nextQuestion() { quizCurrentIndex++; generateQuizQuestion(); }

        // --- UI SWITCHING ---
        function switchMode(mode) {
            document.getElementById('flashcard-section').style.display = 'none'; document.getElementById('quiz-section').style.display = 'none'; document.getElementById('ask-section').style.display = 'none';
            document.getElementById('mode-flashcard').classList.remove('mode-active'); document.getElementById('mode-flashcard').classList.add('secondary');
            document.getElementById('mode-quiz').classList.remove('mode-active'); document.getElementById('mode-quiz').classList.add('secondary');
            document.getElementById('mode-ask').classList.remove('mode-active'); document.getElementById('mode-ask').classList.add('secondary');
            if (mode === 'flashcard') { document.getElementById('flashcard-section').style.display = 'block'; document.getElementById('mode-flashcard').classList.add('mode-active'); document.getElementById('mode-flashcard').classList.remove('secondary'); }
            else if (mode === 'quiz') { document.getElementById('quiz-section').style.display = 'block'; document.getElementById('mode-quiz').classList.add('mode-active'); document.getElementById('mode-quiz').classList.remove('secondary'); if(quizCurrentIndex === 0) generateQuizQuestion(); }
            else if (mode === 'ask') { document.getElementById('ask-section').style.display = 'block'; document.getElementById('mode-ask').classList.add('mode-active'); document.getElementById('mode-ask').classList.remove('secondary'); }
            window.speechSynthesis.cancel();
        }

        init();
    </script>
</body>
</html>
