<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Drug Tutor">
    <meta name="theme-color" content="#F2F2F7">

    <title>AI Drug Tutor</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // Dynamic Icon Generation (BLUE ICON)
        (function() {
            const svgSource = `
            <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
                <rect width="512" height="512" rx="110" fill="#007AFF"/>
                <g transform="translate(64, 64) scale(0.75)">
                    <path d="M353.1 158.8c-29.2-29.2-76.6-29.2-105.9 0L133 273.1c-29.2 29.2-29.2 76.6 0 105.9 29.2 29.2 76.6 29.2 105.9 0L353.1 264.7c29.2-29.2 29.2-76.6 0-105.9z" fill="#ffffff"/>
                    <path d="M264.7 247.2L158.8 353.1c-20 20-52.4 20-72.4 0-20-20-20-52.4 0-72.4L192.3 174.8" fill="#80CFFF"/>
                </g>
            </svg>`;
            
            function setLink(rel, href) {
                let link = document.querySelector(`link[rel="${rel}"]`) || document.createElement('link');
                link.rel = rel; link.href = href; document.head.appendChild(link);
            }

            const img = new Image();
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgSource);
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                canvas.getContext('2d').drawImage(img, 0, 0);
                const pngUrl = canvas.toDataURL('image/png');
                setLink('apple-touch-icon', pngUrl);
                setLink('icon', pngUrl);
                const headerIcon = document.getElementById('header-icon-display');
                if(headerIcon) headerIcon.src = pngUrl;
            };
        })();
    </script>

    <style>
        :root {
            /* Light Mode Defaults - BLUE THEME */
            --primary: #007AFF;
            --secondary: #34C759;
            --danger: #FF3B30;
            --surface: #ffffff;
            --surface-secondary: #F2F2F7;
            --background: #F2F2F7;
            --text-main: #000000;
            --text-secondary: #8E8E93;
            --border: rgba(0,0,0,0.1);
            --input-bg: #E3E3E8;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --radius: 18px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Dark Mode Overrides */
                --surface: #1C1C1E;
                --surface-secondary: #2C2C2E;
                --background: #000000;
                --text-main: #FFFFFF;
                --text-secondary: #98989D;
                --border: rgba(255,255,255,0.15);
                --input-bg: #1C1C1E;
                --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            margin: 0; padding: 0;
            padding-bottom: calc(var(--safe-bottom) + 20px);
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER --- */
        .app-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(var(--background), 0.8);
            background: var(--surface-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            padding: calc(var(--safe-top) + 6px) 16px 12px 16px;
            border-bottom: 0.5px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        @media (prefers-color-scheme: dark) {
            .app-header { background: rgba(28, 28, 30, 0.75); }
        }

        h1 { margin: 0; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }

        .app-icon-img { width: 28px; height: 28px; border-radius: 7px; background: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .icon-btn {
            background: rgba(118, 118, 128, 0.12);
            border: none; width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.1rem; transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(118, 118, 128, 0.24); }

        /* --- SEARCH --- */
        .search-container { padding: 10px 16px; background: transparent; }
        .search-wrapper { position: relative; width: 100%; }
        .search-bar {
            width: 100%; padding: 12px 12px 12px 42px; border-radius: 12px; border: none;
            background: var(--input-bg); font-size: 17px; color: var(--text-main);
            outline: none; transition: all 0.2s;
        }
        .search-bar:focus { background: var(--surface); box-shadow: 0 0 0 2px var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 18px; pointer-events: none; }

        /* --- CHIPS --- */
        .chip-scroll-row { display: flex; gap: 8px; overflow-x: auto; padding: 8px 16px 16px 16px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .chip-scroll-row::-webkit-scrollbar { display: none; }

        .filter-chip {
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
            white-space: nowrap; flex-shrink: 0; cursor: pointer; border: 1px solid transparent;
            background: var(--surface); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
        }
        .filter-chip.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); border-color: transparent; }
        .filter-chip:active { transform: scale(0.95); }

        /* --- SKELETON LOADING --- */
        .skeleton-loader { padding: 0 16px; display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }
        .sk-card { height: 80px; width: 100%; background: var(--surface); border-radius: var(--radius); position: relative; overflow: hidden; }
        .sk-shimmer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* --- RESULTS --- */
        .results-grid { padding: 0 16px 40px 16px; display: flex; flex-direction: column; gap: 14px; }

        .result-card {
            background: var(--surface); padding: 18px; border-radius: var(--radius);
            box-shadow: var(--shadow); position: relative; overflow: hidden;
            transition: transform 0.15s, box-shadow 0.15s; border: 1px solid var(--border);
        }
        .result-card:active { transform: scale(0.98); }

        .result-header { display: flex; justify-content: space-between; align-items: center; }
        .drug-name { font-size: 19px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
        .drug-class { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .chevron { color: var(--text-secondary); opacity: 0.5; font-size: 24px; font-weight: 300; transition: transform 0.3s; }
        .result-card.expanded .chevron { transform: rotate(90deg); color: var(--primary); opacity: 1; }

        .result-detail { display: none; margin-top: 20px; border-top: 0.5px solid var(--border); padding-top: 16px; }
        .result-card.expanded .result-detail { display: block; animation: slideDown 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .detail-row { margin-bottom: 16px; }
        .d-label { display: block; font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .d-content { font-size: 16px; color: var(--text-main); line-height: 1.5; }

        /* --- SAFETY & TOOLS --- */
        .alert-box {
            background: rgba(255, 59, 48, 0.1); border: 1px solid var(--danger); color: var(--danger);
            padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 700;
            display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
        }
        
        /* --- TOOLS & BUTTONS --- */
        .tool-row { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; margin-top: 20px; }
        .btn-tool {
            font-size: 13px; padding: 8px 16px; border-radius: 20px; border: none; font-weight: 600;
            flex-shrink: 0; cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        .tool-isbar { background: rgba(255, 214, 10, 0.15); color: #FFD60A; }
        .tool-cheat { background: rgba(90, 200, 250, 0.15); color: #5AC8FA; }
        .tool-mix { background: rgba(175, 82, 222, 0.15); color: #AF52DE; }
        .tool-explain { background: rgba(52, 199, 89, 0.15); color: #34C759; } 
        .tool-google { background: var(--input-bg); color: var(--text-main); text-decoration: none; }
        .tool-edit { background: rgba(255, 149, 0, 0.15); color: #FF9500; }

        /* Dark Mode Tool Overrides */
        @media (prefers-color-scheme: light) {
            .tool-isbar { background: #FFF6D6; color: #9A7D00; }
            .tool-cheat { background: #DFF6FF; color: #0070A3; }
            .tool-mix { background: #F6E5FF; color: #8200AD; }
            .tool-explain { background: #E2F9E6; color: #007D2C; }
            .tool-edit { background: #FFF3D6; color: #C47200; }
        }

        .btn-action {
            width: 100%; background: var(--surface-secondary); color: var(--primary); font-weight: 600;
            padding: 14px; border-radius: 14px; border: none; font-size: 16px; margin-top: 12px;
            display: flex; justify-content: center; align-items: center; gap: 8px; transition: background 0.2s;
        }
        .btn-action:active { background: var(--border); opacity: 0.8; }

        /* --- SETTINGS SHEET --- */
        #settings-overlay, #vs-overlay, #gen-overlay, #edit-overlay, #select-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(4px); align-items: flex-end;
        }
        .settings-sheet, .vs-sheet, .gen-sheet, .edit-sheet, .select-sheet {
            background: var(--surface); width: 100%; max-width: 600px; margin: 0 auto;
            border-radius: 24px 24px 0 0; padding: 24px; box-sizing: border-box;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; overflow-y: auto;
            display:flex; flex-direction:column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .settings-group { background: var(--surface-secondary); border-radius: 12px; padding: 0; margin-bottom: 24px; overflow: hidden; }
        .settings-row { padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid var(--border); background: var(--surface-secondary); }
        .settings-row:last-child { border-bottom: none; }
        .settings-input { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--surface); color: var(--text-main); margin-top: 8px; }

        .ai-output-box {
            margin-top: 16px; padding: 16px; border-radius: 12px; font-size: 15px;
            background: var(--surface-secondary); color: var(--text-main); display: none; line-height: 1.6;
        }
        .ai-output-box p { margin: 8px 0; }
        .ai-output-box strong { color: var(--primary); }

        .spinner {
            width: 18px; height: 18px; border: 2px solid rgba(128,128,128,0.3);
            border-top-color: var(--primary); border-radius: 50%; display: inline-block; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .section-label { padding: 0 16px; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-top: 16px; margin-bottom: 8px; letter-spacing: 0.5px; }
        
        /* VS Modal Styles */
        .vs-input-group { margin-bottom: 15px; position:relative; }
        .vs-label { font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:5px; display:block; text-transform:uppercase; }
        .vs-input { width:100%; padding:14px; border-radius:12px; border:1px solid var(--border); background:var(--input-bg); font-size:16px; color:var(--text-main); }
        .vs-suggestions { 
            position:absolute; top:100%; left:0; right:0; background:var(--surface); 
            border:1px solid var(--border); border-radius:12px; max-height:150px; overflow-y:auto; 
            z-index:10; box-shadow:0 4px 12px rgba(0,0,0,0.1); display:none;
        }
        .vs-suggestion-item { padding:10px; border-bottom:1px solid var(--border); font-size:14px; cursor:pointer; }
        .vs-suggestion-item:last-child { border-bottom:none; }
        .vs-suggestion-item:active { background:var(--input-bg); }

        /* Select Modal Styles */
        .select-btn {
            width: 100%; padding: 16px; background: var(--surface-secondary); 
            border: 1px solid var(--border); border-radius: 14px; 
            font-size: 18px; font-weight: 600; margin-bottom: 10px;
            color: var(--primary); text-align: left;
        }
        .select-btn:active { background: var(--border); }
        
        table { width:100%; border-collapse:collapse; font-size:14px; margin-top:10px; }
        th, td { border:1px solid var(--border); padding:8px; text-align:left; vertical-align:top; }
        th { background:var(--input-bg); font-weight:700; }
    </style>
</head>
<body>

<div class="app-header">
    <h1>
        <img id="header-icon-display" src="" alt="" class="app-icon-img">
        Drug Tutor
    </h1>
    <div style="display:flex; gap:10px;">
        <button onclick="toggleGen()" class="icon-btn" style="width:auto; padding:0 12px; border-radius:16px; font-weight:700; font-size:13px; color:var(--primary); background:rgba(0,122,255,0.1);">üìù HA Script</button>
        <button onclick="toggleVS()" class="icon-btn" style="width:auto; padding:0 12px; border-radius:16px; font-weight:700; font-size:13px; color:var(--primary); background:rgba(0,122,255,0.1);">üÜö VS</button>
        <button onclick="toggleSettings()" class="icon-btn">‚öôÔ∏è</button>
    </div>
</div>

<div class="search-container">
    <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="search-input" class="search-bar" placeholder="Search drug..." oninput="handleSearch()" onfocus="handleSearch()" onclick="handleSearch()">
    </div>
</div>

<div id="system-chips" class="chip-scroll-row">
    </div>

<div id="history-container" style="display:none;">
    <div class="section-label">Recent Searches</div>
    <div id="history-list" class="chip-scroll-row" style="padding-top:0;"></div>
</div>

<div id="loading-skeleton" class="skeleton-loader">
    <div class="sk-card"><div class="sk-shimmer"></div></div>
    <div class="sk-card"><div class="sk-shimmer"></div></div>
    <div class="sk-card"><div class="sk-shimmer"></div></div>
</div>

<div id="search-results" class="results-grid">
    <div style="text-align:center; color:var(--text-secondary); margin-top:60px; display:none;" id="empty-state-msg">
        <div style="font-size:4rem; opacity:0.2; margin-bottom:10px;">ü©∫</div>
        <div>Start typing to search database...</div>
    </div>
</div>

<div id="settings-overlay" onclick="if(event.target===this) toggleSettings()">
    <div class="settings-sheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 style="margin:0; font-size:22px;">Settings</h2>
            <button onclick="saveSettings()" style="background:var(--input-bg); color:var(--text-main); border:none; padding:8px 16px; border-radius:20px; font-weight:600;">Done</button>
        </div>

        <div class="settings-group">
            <div class="settings-row">
                <span>üìö Data Source</span>
                <span style="color:var(--text-secondary)">Google Sheets</span>
            </div>
            <div class="settings-row" onclick="toggleLanguage()" style="cursor:pointer;">
                <span>üåê AI Persona</span>
                <span id="lang-display" style="color:var(--primary); font-weight:600;">LIHKG Mode</span>
            </div>
        </div>
        
        <h3 class="section-label">Voice Settings</h3>
        <div class="settings-group">
            <div class="settings-row" style="display:block; padding:10px;">
                <select id="voice-select" onchange="saveVoiceSelection()" style="width:100%; padding:10px; border:none; background:transparent; font-size:16px; color:var(--text-main);">
                    <option value="">ü§ñ Auto-Detect Best (Default)</option>
                </select>
            </div>
            <div class="settings-row" onclick="testVoice()" style="cursor:pointer; justify-content:center; color:var(--primary); font-weight:600;">
                üîä Test Audio
            </div>
        </div>
        
        <h3 class="section-label">AI Configuration</h3>
        <div class="settings-group" style="padding:10px;">
            <select id="provider-select" onchange="updateSettingsUI()" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text-main); font-size:16px;">
                <option value="deepseek">DeepSeek (Official)</option>
                <option value="yinli">Yinli (Gemini/Any)</option>
            </select>
            <div id="settings-dynamic-fields"></div>
        </div>
        
        <button onclick="fetchSheetData()" class="btn-action" style="margin-top:20px; background:var(--input-bg); color:var(--text-main);">
            üîÑ Reload Database
        </button>
    </div>
</div>

<div id="vs-overlay" onclick="if(event.target===this) toggleVS()">
    <div class="vs-sheet" style="height:90vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; font-size:22px;">Drug Comparison</h2>
            <button onclick="toggleVS()" style="background:var(--input-bg); color:var(--text-main); border:none; padding:8px 16px; border-radius:20px; font-weight:600;">Close</button>
        </div>
        
        <div style="display:flex; gap:10px;">
            <div class="vs-input-group" style="flex:1;">
                <span class="vs-label">Drug A</span>
                <input type="text" id="vs-input-a" class="vs-input" placeholder="e.g. Panadol" oninput="handleVsSuggest('a')">
                <div id="vs-suggest-a" class="vs-suggestions"></div>
            </div>
            <div style="display:flex; align-items:center; padding-top:10px; font-weight:800; color:var(--primary);">VS</div>
            <div class="vs-input-group" style="flex:1;">
                <span class="vs-label">Drug B</span>
                <input type="text" id="vs-input-b" class="vs-input" placeholder="e.g. Aspirin" oninput="handleVsSuggest('b')">
                <div id="vs-suggest-b" class="vs-suggestions"></div>
            </div>
        </div>

        <button id="btn-compare" class="btn-action" style="margin-top:0; margin-bottom:15px; background:var(--primary); color:white;" onclick="triggerCompare()">
            ‚öîÔ∏è Compare Now
        </button>

        <div id="vs-result-area" class="ai-output-box" style="flex:1; overflow-y:auto; display:none; background:var(--input-bg);"></div>
    </div>
</div>

<div id="gen-overlay" onclick="if(event.target===this) toggleGen()">
    <div class="gen-sheet" style="height:90vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; font-size:22px;">üìù HA Script Generator</h2>
            <button onclick="toggleGen()" style="background:var(--input-bg); color:var(--text-main); border:none; padding:8px 16px; border-radius:20px; font-weight:600;">Close</button>
        </div>
        
        <div class="vs-input-group">
            <span class="vs-label">Patient Condition / Co-morbidities</span>
            <textarea id="gen-input" class="vs-input" style="height:100px; resize:none;" placeholder="e.g. Patient with HTN, T2DM, Gout, and recent UTI. Needs discharge meds."></textarea>
        </div>

        <button id="btn-gen" class="btn-action" style="margin-top:0; margin-bottom:15px; background:var(--primary); color:white;" onclick="triggerGen()">
            ‚ú® Generate Medication List
        </button>

        <div id="gen-result-area" class="ai-output-box" style="flex:1; overflow-y:auto; display:none; background:var(--input-bg); white-space: pre-wrap;"></div>
    </div>
</div>

<div id="edit-overlay" onclick="if(event.target===this) toggleEditOverlay()">
    <div class="edit-sheet" style="height:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; font-size:22px;">‚úèÔ∏è Edit Drug</h2>
            <button onclick="toggleEditOverlay()" style="background:var(--input-bg); color:var(--text-main); border:none; padding:8px 16px; border-radius:20px; font-weight:600;">Close</button>
        </div>
        <p style="color:var(--text-secondary); margin-top:0;">Tell AI what to change about <strong><span id="edit-drug-name-disp"></span></strong>.</p>
        
        <div class="vs-input-group">
            <textarea id="edit-input" class="vs-input" style="height:100px; resize:none;" placeholder="e.g. Add 'Vomiting' to side effects, change Class to 'Opioid'"></textarea>
        </div>

        <button id="btn-edit-submit" class="btn-action" style="margin-top:0; margin-bottom:15px; background:var(--primary); color:white;" onclick="submitAIEdit()">
            ‚ú® Update
        </button>
    </div>
</div>

<div id="select-overlay" onclick="if(event.target===this) closeSelect()">
    <div class="select-sheet" style="height:auto;">
        <div style="margin-bottom:20px;">
            <h2 style="margin:0; font-size:20px;">Select Medication</h2>
            <p style="color:var(--text-secondary); margin:5px 0 0 0;">Which drug do you want to use?</p>
        </div>
        <div id="select-options-container"></div>
        <button onclick="closeSelect()" class="btn-action" style="margin-top:10px; background:var(--input-bg); color:var(--text-main);">Cancel</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const DB_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";
    const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxyNPyjbVXDMTQxFPxEuuCDTNNf-iVFfqedfNbh-kgn6Tk9rSIFEfIaLWXxXZoNOVnWug/exec";

    // --- STATE ---
    let drugs = [];
    let searchHistory = [];
    let aiLanguage = 'lihkg';
    let availableVoices = [];
    let selectedVoiceURI = '';
    
    // Edit & Select States
    let currentEditDrug = null;
    let pendingSelectAction = null; // { action: 'isbar', contextId: '...', btn: ... }
    
    // --- KEYS (Default) ---
    let provider = 'deepseek';
    let keys = { deepseek: "sk-92db3cf721454bd7b351ca6ef40eaaf7", yinli: "" };
    let yinliUrl = "https://yinli.one/v1/chat/completions";
    let yinliModel = "gemini-2.5-flash"; 
    
    // --- UTILS ---
    let pendingDrugSave = null;

    // --- üìã SYSTEM FILTER LIST ---
    const systems = [
        {id: "GI", name: "üçΩÔ∏è Gastro", full: "Gastro-intestinal system"},
        {id: "CVS", name: "ü´Ä Cardio", full: "Cardiovascular system"},
        {id: "Resp", name: "ü´Å Resp", full: "Respiratory system"},
        {id: "CNS", name: "üß† CNS", full: "Central nervous system"},
        {id: "Inf", name: "ü¶† Infect", full: "Infections"},
        {id: "Endo", name: "ü¶ã Endo", full: "Endocrine system"},
        {id: "ObGyn", name: "ü§∞ ObGyn/GU", full: "Obstetrics, gynaecology, and urinary-tract disorders"},
        {id: "Malig", name: "üéóÔ∏è Onco", full: "Malignant disease and immunosuppression"},
        {id: "Nutri", name: "ü©∏ Blood/Nut", full: "Nutrition and blood"},
        {id: "MSK", name: "ü¶¥ MSK", full: "Musculoskeletal and joint disease"},
        {id: "Eye", name: "üëÅÔ∏è Eye", full: "Eye"},
        {id: "ENT", name: "üëÇ ENT", full: "Ear, nose, and oropharynx"},
        {id: "Skin", name: "üß¥ Skin", full: "Skin"},
        {id: "Immuno", name: "üíâ Vaccine", full: "Immunological products and vaccines"},
        {id: "Anaes", name: "üí§ Anaes", full: "Anaesthesia"},
        {id: "RespOb", name: "ü´Åü§∞ Resp+Ob", full: "Respiratory system, Obstetrics, gynaecology, and urinary-tract disorders"},
        {id: "CVSEndo", name: "ü´Äü¶ã Cardio+Endo", full: "Cardiovascular system, Endocrine system"},
        {id: "MSKAnaes", name: "ü¶¥üí§ MSK+Anaes", full: "Musculoskeletal and joint disease, Anaesthesia"}
    ];

    function init() {
        if(localStorage.getItem('ai_provider')) provider = localStorage.getItem('ai_provider');
        if(localStorage.getItem('ds_key')) keys.deepseek = localStorage.getItem('ds_key');
        if(localStorage.getItem('yl_key')) keys.yinli = localStorage.getItem('yl_key');
        if(localStorage.getItem('yl_model')) yinliModel = localStorage.getItem('yl_model');
        if(localStorage.getItem('search_hist')) searchHistory = JSON.parse(localStorage.getItem('search_hist'));
        if(localStorage.getItem('voice_uri')) selectedVoiceURI = localStorage.getItem('voice_uri');

        // Init Voice Loader
        if (window.speechSynthesis) {
             window.speechSynthesis.onvoiceschanged = loadVoices;
             loadVoices();
        }

        updateSettingsUI();
        renderSystemChips();
        fetchSheetData(true); 
        renderHistory();
        
        // Populate Provider Select Value
        const provSelect = document.getElementById('provider-select');
        if(provSelect) provSelect.value = provider;
        updateSettingsUI();
    }

    // --- HELPER: SAFE EMPTY STATE ---
    function getOrCreateEmptyState() {
        let el = document.getElementById('empty-state-msg');
        if (!el) {
            el = document.createElement('div');
            el.id = 'empty-state-msg';
            el.style.textAlign = 'center';
            el.style.color = 'var(--text-secondary)';
            el.style.marginTop = '60px';
            el.style.display = 'none';
            el.innerHTML = `
                <div style="font-size:4rem; opacity:0.2; margin-bottom:10px;">ü©∫</div>
                <div>Start typing to search database...</div>
            `;
        }
        return el;
    }

    // --- HELPER: RESET TO HOME ---
    function resetToHome() {
        document.getElementById('search-input').value = '';
        const allBtn = document.querySelector('.filter-chip');
        if(allBtn) filterBySystem('All', allBtn);
    }

    // --- üó£Ô∏è VOICE SELECTION LOGIC ---
    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voice-select');
        select.innerHTML = '<option value="">ü§ñ Auto-Detect Best (Default)</option>';
        availableVoices.sort((a, b) => {
            const aName = a.name.toLowerCase();
            const bName = b.name.toLowerCase();
            const isPremA = aName.includes('premium') || aName.includes('enhanced');
            const isPremB = bName.includes('premium') || bName.includes('enhanced');
            if (isPremA && !isPremB) return -1;
            if (!isPremA && isPremB) return 1;
            return aName.localeCompare(bName);
        });
        availableVoices.forEach(voice => {
            const opt = document.createElement('option');
            opt.value = voice.voiceURI;
            opt.innerText = `${voice.name} (${voice.lang})`;
            if(voice.voiceURI === selectedVoiceURI) opt.selected = true;
            select.appendChild(opt);
        });
    }

    function saveVoiceSelection() {
        selectedVoiceURI = document.getElementById('voice-select').value;
        localStorage.setItem('voice_uri', selectedVoiceURI);
    }
    
    function testVoice() {
        speakText("This is a test of the selected voice. Monitoring vitals.");
    }
    
    // --- üîä SMART AUDIO ENGINE ---
    function speakText(text, lang = "en") {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        const targetLang = lang === 'zh-HK' ? 'zh-HK' : 'en-US';
        u.lang = targetLang;
        u.rate = 0.95; 
        
        let bestVoice = null;
        if (selectedVoiceURI) {
            bestVoice = window.speechSynthesis.getVoices().find(v => v.voiceURI === selectedVoiceURI);
        }
        if (!bestVoice) {
            const voices = window.speechSynthesis.getVoices();
            const available = voices.filter(v => v.lang.includes(targetLang.replace('-', '_')) || v.lang.includes(targetLang));
            bestVoice = available.find(v => v.name.includes('Premium'));
            if (!bestVoice) bestVoice = available.find(v => v.name.includes('Enhanced'));
            if (!bestVoice) bestVoice = available.find(v => v.name.includes('Google'));
            if (!bestVoice) bestVoice = available[0];
        }
        if (bestVoice) u.voice = bestVoice;
        window.speechSynthesis.speak(u);

        const buttons = document.querySelectorAll('.btn-action');
        let btn = null;
        buttons.forEach(b => { if(b.innerHTML.includes('Read Aloud')) btn = b; });
        if(btn) {
            const originalText = "üîä Read Aloud";
            btn.innerHTML = "üó£Ô∏è Speaking...";
            setTimeout(() => { btn.innerHTML = originalText; }, text.length * 80); 
        }
    }
    
    function speakDetails(d) {
        let txt = "";
        if (aiLanguage === 'lihkg') {
            txt = `Ëó•Âêç: ${d.name}„ÄÇ È°ûÂà•: ${d.class}„ÄÇ Áî®ÈÄî: ${d.indication}„ÄÇ ÂâØ‰ΩúÁî®: ${d.SideEffects}„ÄÇ Ë≠∑ÁêÜ: ${d.nursing}`;
        } else {
            txt = `Drug Name: ${d.name}. Class: ${d.class}. Indication: ${d.indication}. Side Effects: ${d.SideEffects}. Nursing: ${d.nursing}`;
        }
        speakText(txt, aiLanguage === 'lihkg' ? 'zh-HK' : 'en');
    }

    // --- SEARCH LOGIC ---
    function handleSearch() {
        pendingDrugSave = null; 
        const q = document.getElementById('search-input').value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        const emptyState = getOrCreateEmptyState();
        
        if(!q) {
            // Revert to "All" if search is cleared
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            const allBtn = document.querySelector('.filter-chip'); 
            if(allBtn) allBtn.classList.add('active');
            
            // Re-render full list
            container.innerHTML = '';
            container.appendChild(emptyState);
            emptyState.style.display = 'none';
            const allDrugs = [...drugs].sort((a,b) => (a.name||"").localeCompare(b.name||""));
            allDrugs.forEach((d, idx) => renderResult(d, idx, container));
            return;
        }
        
        // If searching, Deselect chips for visual clarity
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));

        container.innerHTML = '';
        container.appendChild(emptyState); 
        emptyState.style.display = 'none';

        if(q.length > 3 && !searchHistory.includes(q)) {
            searchHistory.unshift(q);
            if(searchHistory.length > 5) searchHistory.pop();
            localStorage.setItem('search_hist', JSON.stringify(searchHistory));
            renderHistory();
        }

        const matches = drugs.filter(d => (d.name+d.class+d.indication+d.system).toLowerCase().includes(q));
        matches.sort((a, b) => {
            const nameA = (a.name || "").toLowerCase();
            const nameB = (b.name || "").toLowerCase();
            if (nameA.startsWith(q) && !nameB.startsWith(q)) return -1;
            if (!nameA.startsWith(q) && nameB.startsWith(q)) return 1;
            return nameA.localeCompare(nameB);
        });

        if (matches.length > 0) {
            matches.forEach((d, idx) => renderResult(d, idx, container));
        } else {
            const div = document.createElement('div');
            div.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <div style="color:var(--text-secondary); margin-bottom:15px;">Drug not found locally.</div>
                    <button id="btn-ai-search" class="btn-action" style="background:var(--primary); color:white; width:auto; margin:0 auto; padding-left:24px; padding-right:24px;" onclick="triggerAISearchAndGenerate('${q}')">
                        ‚ú® Ask AI Pharmacist
                    </button>
                </div>
            `;
            container.appendChild(div);
        }
    }

    function renderResult(d, idx, container, isNew = false) {
        const div = document.createElement('div');
        div.className = 'result-card';
        if(isNew) div.style.border = "2px solid var(--secondary)";
        const uniqueId = Math.random().toString(36).substr(2, 9);
        const aiId = `ai-${uniqueId}`;
        
        // Serialize drug object for passing to onclick
        const drugStr = JSON.stringify(d).replace(/"/g, '&quot;');
        
        let holdHtml = '';
        if (d.hold_param) { holdHtml = `<div class="alert-box"><span>‚õîÔ∏è</span><span>HOLD IF: ${d.hold_param}</span></div>`; }

        // REMOVED: 2min Push and Drip Calc

        div.innerHTML = `
            ${isNew ? '<div style="background:var(--secondary); color:white; font-size:10px; padding:4px 8px; border-radius:10px; display:inline-block; margin-bottom:8px; font-weight:700;">‚úÖ Saved</div>' : ''}
            <div class="result-header">
                <div>
                    <div class="drug-name">${d.name}</div>
                    <div class="drug-class">${d.class}</div>
                </div>
                <div class="chevron">‚Ä∫</div>
            </div>
            <div class="result-detail">
                ${holdHtml}
                <div class="detail-row"><span class="d-label">System</span><span class="d-content">${d.system || "N/A"}</span></div>
                <div class="detail-row"><span class="d-label">Indication</span><span class="d-content">${d.indication || "N/A"}</span></div>
                <div class="detail-row"><span class="d-label">Side Effects</span><span class="d-content">${d.SideEffects || "N/A"}</span></div>
                <div class="detail-row"><span class="d-label">Nursing</span><span class="d-content">${d.nursing || "N/A"}</span></div>
                <div class="tool-row">
                    <button class="btn-tool tool-edit" onclick="event.stopPropagation(); triggerEditPrompt(${drugStr})">‚ú® AI Edit</button>
                    <button class="btn-tool tool-isbar" onclick="event.stopPropagation(); handleToolClick('isbar', ${drugStr}, '${aiId}', this)">üöë ISBAR</button>
                    <button class="btn-tool tool-explain" onclick="event.stopPropagation(); handleToolClick('explain', ${drugStr}, '${aiId}', this)">üéì Explain</button>
                    <button class="btn-tool tool-cheat" onclick="event.stopPropagation(); handleToolClick('cheat', ${drugStr}, '${aiId}', this)">üìã Ward Sheet</button>
                    <button class="btn-tool tool-mix" onclick="event.stopPropagation(); handleToolClick('mix', ${drugStr}, '${aiId}', this)">üß™ Recon</button>
                    <button class="btn-tool tool-google" onclick="event.stopPropagation(); handleToolClick('google', ${drugStr}, '${aiId}', this)">G</button>
                </div>
                <button onclick="event.stopPropagation(); speakDetails({name:'${d.name.replace(/'/g, "")}', class:'${d.class}', system:'${d.system}', indication:'${d.indication.replace(/\n/g, "")}', SideEffects:'${d.SideEffects.replace(/\n/g, "")}', nursing:'${d.nursing.replace(/\n/g, "")}'})" class="btn-action">
                    üîä Read Aloud
                </button>
                <div id="${aiId}" class="ai-output-box"></div>
            </div>
        `;
        div.onclick = (e) => { 
            if(!e.target.closest('button') && !e.target.closest('a') && !e.target.closest('input')) div.classList.toggle('expanded'); 
        };
        container.appendChild(div);
    }

    // --- MULTI-DRUG SELECTOR LOGIC ---
    function handleToolClick(action, drugObj, aiId, btnElement) {
        // Check for semicolon in name
        if (drugObj.name.includes(';')) {
            const names = drugObj.name.split(';').map(n => n.trim()).filter(n => n);
            showSelectModal(names, action, drugObj, aiId, btnElement);
        } else {
            // Single drug, proceed normally
            executeToolAction(action, drugObj.name, drugObj, aiId, btnElement);
        }
    }

    function showSelectModal(names, action, drugObj, aiId, btnElement) {
        const overlay = document.getElementById('select-overlay');
        const container = document.getElementById('select-options-container');
        container.innerHTML = '';
        
        // Save pending context
        pendingSelectAction = { action, drugObj, aiId, btnElement };
        
        names.forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'select-btn';
            btn.innerText = name;
            btn.onclick = () => {
                closeSelect();
                executeToolAction(action, name, drugObj, aiId, btnElement);
            };
            container.appendChild(btn);
        });
        
        overlay.style.display = 'flex';
    }

    function closeSelect() {
        document.getElementById('select-overlay').style.display = 'none';
        pendingSelectAction = null;
    }

    function executeToolAction(action, selectedName, drugObj, aiId, btnElement) {
        if (action === 'google') {
            const googleLink = `https://www.google.com/search?q=${encodeURIComponent(selectedName + ' ‰∏≠Êñá È¶ôÊ∏Øs')}`;
            window.open(googleLink, '_blank');
        } else {
            triggerAIContext(drugObj, action, aiId, btnElement, selectedName);
        }
    }

    // --- EDIT LOGIC ---
    function toggleEditOverlay() {
        const p = document.getElementById('edit-overlay');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }

    function triggerEditPrompt(drugObj) {
        currentEditDrug = drugObj;
        document.getElementById('edit-drug-name-disp').innerText = drugObj.name;
        document.getElementById('edit-input').value = '';
        toggleEditOverlay();
    }

    async function submitAIEdit() {
        if (!currentEditDrug) return;
        const instructions = document.getElementById('edit-input').value.trim();
        const btn = document.getElementById('btn-edit-submit');
        
        if (!instructions) { alert("Please enter instructions."); return; }
        
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Updating...';
        
        const prompt = `You are editing a JSON database entry for a drug.
        Current JSON: ${JSON.stringify(currentEditDrug)}
        User Instructions: ${instructions}
        
        Task: Return the fully updated JSON object strictly. 
        Ensure keys match exactly: name, class, indication, system, SideEffects, nursing, hold_param.
        Do not output markdown blocks. Just the JSON string.`;
        
        try {
            let jsonString = await getFullAIResponse(prompt);
            jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBrace = jsonString.indexOf('{');
            const lastBrace = jsonString.lastIndexOf('}');
            if(firstBrace !== -1 && lastBrace !== -1) {
                jsonString = jsonString.substring(firstBrace, lastBrace + 1);
            }
            
            const newDrugData = JSON.parse(jsonString);
            pendingDrugSave = newDrugData;
            
            toggleEditOverlay();
            
            // Show preview for saving
            const container = document.getElementById('search-results');
            container.innerHTML = `
                <div style="background:var(--surface); border:2px solid var(--primary); padding:24px; border-radius:16px;">
                    <div style="font-weight:700; color:var(--primary); margin-bottom:10px; text-transform:uppercase; font-size:12px;">‚ú® AI Edited Preview</div>
                    <div style="font-size:1.6rem; font-weight:800; margin-bottom:4px; color:var(--text-main);">${newDrugData.name}</div>
                    <div style="color:var(--text-secondary); margin-bottom:20px;">${newDrugData.class}</div>
                    <div style="font-size:1rem; line-height:1.6; color:var(--text-main);">
                        <p><strong>Indication:</strong> ${newDrugData.indication}</p>
                        <p><strong>Side Effects:</strong> ${newDrugData.SideEffects}</p>
                        <p><strong>Nursing:</strong> ${newDrugData.nursing}</p>
                    </div>
                    <button class="btn-action" style="background:var(--primary); color:white;" onclick="confirmSaveDrug()">üíæ Save Changes</button>
                    <button class="btn-action" style="background:transparent; color:var(--text-secondary); margin-top:0;" onclick="resetToHome()">Cancel</button>
                </div>
            `;
            
        } catch(e) {
            alert("Error updating: " + e.message);
        } finally {
            btn.innerHTML = "‚ú® Update";
            btn.disabled = false;
        }
    }

    // --- VS (COMPARE) LOGIC ---
    function toggleVS() {
        const p = document.getElementById('vs-overlay');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }

    function handleVsSuggest(side) {
        const input = document.getElementById(`vs-input-${side}`);
        const box = document.getElementById(`vs-suggest-${side}`);
        const val = input.value.toLowerCase().trim();
        box.innerHTML = '';
        box.style.display = 'none';
        
        if (val.length < 2) return;

        // Auto-suggest from local DB
        const matches = drugs.filter(d => d.name.toLowerCase().includes(val)).slice(0, 5);
        if(matches.length > 0) {
            box.style.display = 'block';
            matches.forEach(d => {
                const div = document.createElement('div');
                div.className = 'vs-suggestion-item';
                div.innerText = d.name;
                div.onclick = () => {
                    input.value = d.name;
                    box.style.display = 'none';
                };
                box.appendChild(div);
            });
        }
    }

    async function triggerCompare() {
        const a = document.getElementById('vs-input-a').value.trim();
        const b = document.getElementById('vs-input-b').value.trim();
        const btn = document.getElementById('btn-compare');
        const res = document.getElementById('vs-result-area');
        
        if (!a || !b) { alert("Please enter two drugs!"); return; }

        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Comparing...';
        res.style.display = 'block'; res.innerHTML = '<span style="color:var(--text-secondary);">AI is analyzing difference...</span>';

        const langInstruction = aiLanguage === 'lihkg' ? "Use Hong Kong Cantonese (LIHKG style)." : "Use English.";
        const prompt = `Compare "${a}" vs "${b}" for a nursing student.
        Format as a Markdown Table.
        Columns: Feature, ${a}, ${b}.
        Rows to include:
        1. Class/Type
        2. Indication (Main use)
        3. Mechanism (Simple)
        4. Side Effects (Key diff)
        5. Nursing (Safety)
        
        After the table, add a one-sentence "Winner" summary for a specific situation (e.g. "Use X for pain, Y for inflammation").
        ${langInstruction}`;

        try {
            await streamAI(prompt, (chunk) => { res.innerHTML = marked.parse(chunk); });
            btn.innerHTML = "‚úÖ Done";
        } catch(e) {
            res.innerHTML = "Error: " + e.message;
            btn.innerHTML = "‚ùå Retry";
        } finally {
            btn.disabled = false;
        }
    }

    // --- GENERATOR LOGIC (HA SCRIPT) ---
    function toggleGen() {
        const p = document.getElementById('gen-overlay');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }

    async function triggerGen() {
        const input = document.getElementById('gen-input').value.trim();
        const btn = document.getElementById('btn-gen');
        const res = document.getElementById('gen-result-area');

        if (!input) { alert("Please enter patient details!"); return; }

        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Generating...';
        res.style.display = 'block'; res.innerHTML = '<span style="color:var(--text-secondary);">Creating HA Prescription...</span>';

        const prompt = `Act as a clinical pharmacist or nurse. Generate a medication list for a patient with: ${input}.
        Format the output exactly in the Hospital Authority (HA) outpatient prescription style.
        Use Markdown Table format.
        Include columns: Drug Name, Dosage, Frequency, Indication, Nursing Considerations.
        Keep it concise and realistic for Hong Kong public hospitals.
        `;

        try {
            await streamAI(prompt, (chunk) => { res.innerHTML = marked.parse(chunk); });
            btn.innerHTML = "‚úÖ Done";
        } catch(e) {
            res.innerHTML = "Error: " + e.message;
            btn.innerHTML = "‚ùå Retry";
        } finally {
            btn.disabled = false;
        }
    }

    // --- AI FUNCTIONS ---
    async function triggerAIContext(obj, type, outputId, btn, drugNameOverride) {
        const out = document.getElementById(outputId);
        const name = drugNameOverride || obj.name;
        const originalText = btn.innerHTML;
        
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
        out.style.display = 'block'; out.innerHTML = '<span style="color:var(--text-secondary);">AI is thinking...</span>';
        
        let prompt = "";
        const langInstruction = aiLanguage === 'lihkg' ? "Use Hong Kong Cantonese (LIHKG style, casual/slang)." : "Use plain English suitable for a student.";
        
        if (type === 'isbar') prompt = `Write a nursing handover for ${name} using ISBAR format. Invent a realistic scenario. Concise. ${langInstruction}`;
        else if (type === 'mix') prompt = `Reconstitution and administration guide for ${name} (IV/IM). Diluent, Rate, Stability. ${langInstruction}`;
        else if (type === 'explain') prompt = `Explain the drug ${name} to a nursing student using a simple analogy. Focus on Mechanism of Action and ONE key danger. Keep it short and fun. ${langInstruction}`;
        else if (type === 'cheat') {
            if (aiLanguage === 'lihkg') {
                prompt = `Create a "Ward Survival Cheatsheet" for ${name}. 
                Format as a table/list with two columns: 
                1. English Medical Term (e.g., "Hypokalemia")
                2. Cantonese Explanation/Patient Phrase (e.g., "‰ΩéÈâÄÔºåË®òÂæóÈ£üËïâ").
                Include:
                - üõë Critical Checks (Before giving)
                - üìâ Monitoring (Vitals/Labs)
                - üó£Ô∏è Patient Teaching (One key phrase)
                Keep it concise for quick ward reference.`;
            } else {
                prompt = `Create a "Ward Survival Cheatsheet" for ${name}. Bullet points only.
                Sections:
                1. üõë STOP Checks (Hold if...)
                2. üìâ Monitoring (What to watch)
                3. ‚ö°Ô∏è Red Flags (Call doctor if...)
                Keep it ultra-concise for a busy ward.`;
            }
        }

        try {
            await streamAI(prompt, (chunk) => { out.innerHTML = marked.parse(chunk); });
            btn.innerHTML = "‚úÖ";
        } catch (e) { out.innerHTML = `Error: ${e.message}`; btn.innerHTML = "‚ùå"; } 
        finally { btn.disabled = false; setTimeout(() => btn.innerHTML = originalText, 3000); }
    }

    async function streamAI(prompt, onChunk) {
        let url = "https://api.deepseek.com/chat/completions";
        let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${keys.deepseek}` };
        let body = { model: "deepseek-chat", messages: [{role:"user", content: prompt}], stream: true };
        
        if(provider === 'yinli') { 
            url = yinliUrl; headers["Authorization"] = `Bearer ${keys.yinli}`; body.model = yinliModel; 
        }

        const response = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        if (!response.ok) throw new Error("API Request Failed");

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";
        let buffer = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, {stream: true});
            const lines = buffer.split('\n');
            buffer = lines.pop(); 

            for (const line of lines) {
                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    try {
                        const json = JSON.parse(line.substring(6));
                        const content = json.choices[0]?.delta?.content || "";
                        fullText += content;
                        onChunk(fullText);
                    } catch (e) { }
                }
            }
        }
    }

    // --- GENERATE AI DRUG ---
    async function triggerAISearchAndGenerate(query) {
        const btn = document.getElementById('btn-ai-search');
        btn.innerHTML = '<span class="spinner"></span> Consulting...';
        btn.disabled = true;

        const prompt = `You are a strict pharmacology database.
        Task: Output a JSON object for the drug "${query}".
        Keys: 
        - "name": (Generic Name(brandname in HK AND È¶ôÊ∏Ø‰∏≠ÊñáÂïÜÂìÅÂêç)Ôºâ
        - "class": (Pharmacological Class)
        - "indication": (Short summary)
        - "system": (Choose STRICTLY one: Gastro-intestinal system, Cardiovascular system, Respiratory system, Central nervous system, Infections, Endocrine system, Obstetrics, gynaecology, and urinary-tract disorders, Malignant disease and immunosuppression, Nutrition and blood, Musculoskeletal and joint disease, Eye, Ear, nose, and oropharynx, Skin, Immunological products and vaccines, Anaesthesia)
        - "SideEffects": (Common side effects)
        - "nursing": (Key monitoring points)
        - "hold_param": (Optional: e.g. "HR<60")
        - "admin_type": (Optional: "IV" or "Oral")
        
        Output ONLY the JSON object. Do not wrap in markdown code blocks.`;

        try {
            let jsonString = await getFullAIResponse(prompt);
            jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBrace = jsonString.indexOf('{');
            const lastBrace = jsonString.lastIndexOf('}');
            if(firstBrace !== -1 && lastBrace !== -1) {
                jsonString = jsonString.substring(firstBrace, lastBrace + 1);
            }

            const drugData = JSON.parse(jsonString);
            pendingDrugSave = drugData;

            const container = document.getElementById('search-results');
            container.innerHTML = `
                <div style="background:var(--surface); border:2px solid var(--primary); padding:24px; border-radius:16px;">
                    <div style="font-weight:700; color:var(--primary); margin-bottom:10px; text-transform:uppercase; font-size:12px;">‚ú® AI Generated Preview</div>
                    <div style="font-size:1.6rem; font-weight:800; margin-bottom:4px; color:var(--text-main);">${drugData.name}</div>
                    <div style="color:var(--text-secondary); margin-bottom:20px;">${drugData.class}</div>
                    <div style="font-size:1rem; line-height:1.6; color:var(--text-main);">
                        <p><strong>System:</strong> ${drugData.system}</p>
                        <p><strong>Indication:</strong> ${drugData.indication}</p>
                        <p><strong>Nursing:</strong> ${drugData.nursing}</p>
                    </div>
                    <button class="btn-action" style="background:var(--primary); color:white;" onclick="confirmSaveDrug()">üíæ Save to Database</button>
                    <button class="btn-action" style="background:transparent; color:var(--text-secondary); margin-top:0;" onclick="resetToHome()">Cancel / Back to List</button>
                </div>
            `;
        } catch (e) {
            btn.innerHTML = `‚ùå Error: ${e.message}`;
            btn.disabled = false;
        }
    }
    
    async function getFullAIResponse(prompt) {
        let url = "https://api.deepseek.com/chat/completions";
        let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${keys.deepseek}` };
        let body = { model: "deepseek-chat", messages: [{role:"user", content: prompt}], stream: false };
        if(provider === 'yinli') { url = yinliUrl; headers["Authorization"] = `Bearer ${keys.yinli}`; body.model = yinliModel; }
        const response = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const json = await response.json();
        return json.choices[0].message.content;
    }

    function confirmSaveDrug() {
        if(!pendingDrugSave) return;
        drugs.push(pendingDrugSave);
        const btn = document.querySelector('.btn-action');
        btn.innerHTML = "‚è≥ Uploading...";
        btn.disabled = true;
        fetch(UPLOAD_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(pendingDrugSave) });
        setTimeout(() => {
            alert("‚úÖ Drug Saved!");
            pendingDrugSave = null;
            resetToHome(); 
        }, 1000);
    }

    // --- FETCH (INSTANT LOAD) ---
    function fetchSheetData(silent = false) {
        const loading = document.getElementById('loading-skeleton');
        const results = document.getElementById('search-results');
        const emptyState = getOrCreateEmptyState();
        
        // 1. Try Cache
        const localData = localStorage.getItem('drug_db_cache');
        if (localData) {
            drugs = JSON.parse(localData);
            loading.style.display = 'none';
            results.style.display = 'flex';
            renderSystemChips();
            // If we have cached data, ensure default filter is applied only if search is empty
            const searchVal = document.getElementById('search-input').value;
            if(!searchVal) {
                const allBtn = document.querySelector('.filter-chip');
                if(allBtn && !document.querySelector('.filter-chip.active')) filterBySystem('All', allBtn);
            }
        } else {
            if(!silent) { results.style.display = 'none'; loading.style.display = 'flex'; }
        }

        // 2. Fetch Background
        fetch(DB_URL).then(r=>r.text()).then(csv=>{
            Papa.parse(csv, {header:true, skipEmptyLines:true, complete:res=>{
                if(res.data.length){ 
                    drugs = res.data;
                    localStorage.setItem('drug_db_cache', JSON.stringify(drugs));
                    if (!localData) {
                        loading.style.display = 'none'; 
                        results.style.display = 'flex'; 
                        if(!silent) alert(`‚úÖ Loaded ${drugs.length} drugs`); 
                        renderSystemChips();
                        const allBtn = document.querySelector('.filter-chip');
                        if(allBtn) filterBySystem('All', allBtn);
                    }
                }
            }});
        }).catch(e => { 
            if(!localData && !silent) { alert("Connection Failed"); loading.style.display = 'none'; }
        });
    }

    function renderSystemChips() {
        const c = document.getElementById('system-chips');
        c.innerHTML = `<button class="filter-chip active" onclick="filterBySystem('All', this)">All</button>`;
        systems.forEach(s => { c.innerHTML += `<button class="filter-chip" onclick="filterBySystem('${s.full}', this)">${s.name}</button>`; });
    }

    function filterBySystem(sys, btn) {
        pendingDrugSave = null;
        document.getElementById('search-input').value = '';

        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const container = document.getElementById('search-results');
        const emptyState = getOrCreateEmptyState();
        container.innerHTML = ''; container.appendChild(emptyState); emptyState.style.display = 'none';
        
        const matches = (sys === 'All') ? drugs : drugs.filter(d => (d.system || "").includes(sys));
        matches.sort((a,b) => (a.name||"").localeCompare(b.name||""));
        matches.forEach((d, idx) => renderResult(d, idx, container));
        if(matches.length === 0) emptyState.style.display = 'block';
    }

    function renderHistory() {
        const c = document.getElementById('history-list');
        const box = document.getElementById('history-container');
        if(searchHistory.length === 0) { box.style.display = 'none'; return; }
        box.style.display = 'block'; c.innerHTML = '';
        searchHistory.forEach(term => { c.innerHTML += `<button class="filter-chip" style="background:var(--input-bg); color:var(--text-main);" onclick="clickHistory('${term}')">${term}</button>`; });
    }
    
    function clickHistory(term) { document.getElementById('search-input').value = term; handleSearch(); }
    
    function saveSettings() {
        const dsInput = document.getElementById('deepseek-key');
        const ylInput = document.getElementById('yinli-key');
        
        if(dsInput) { keys.deepseek = dsInput.value; localStorage.setItem('ds_key', keys.deepseek); }
        if(ylInput) { keys.yinli = ylInput.value; localStorage.setItem('yl_key', keys.yinli); }
        
        provider = document.getElementById('provider-select').value;
        localStorage.setItem('ai_provider', provider);
        
        toggleSettings();
    }

    function toggleSettings() { const p = document.getElementById('settings-overlay'); p.style.display = p.style.display === 'flex' ? 'none' : 'flex'; }
    function toggleLanguage() {
        const display = document.getElementById('lang-display');
        if(aiLanguage === 'english') { aiLanguage = 'lihkg'; display.innerText = "LIHKG Mode"; } 
        else { aiLanguage = 'english'; display.innerText = "English"; }
    }
    function updateSettingsUI() {
        const prov = document.getElementById('provider-select').value;
        const container = document.getElementById('settings-dynamic-fields');
        container.innerHTML = '';
        if (prov === 'yinli') {
            container.innerHTML = `<div style="font-size:12px; font-weight:600; color:var(--text-secondary); margin-top:10px;">Yinli API Key</div><input type="password" id="yinli-key" class="settings-input" value="${keys.yinli}" placeholder="sk-...">`;
        } else if (prov === 'deepseek') {
            container.innerHTML = `<div style="font-size:12px; font-weight:600; color:var(--text-secondary); margin-top:10px;">DeepSeek API Key</div><input type="password" id="deepseek-key" class="settings-input" value="${keys.deepseek}" placeholder="sk-...">`;
        }
    }

    init();
</script>
</body>
</html>
