<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    <title>AI Drug Tutor</title>
    
    <link rel="icon" href="apple-touch-icon.png" type="image/png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <style>
        :root {
            /* iOS 17/Modern Palette */
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-indigo: #5856D6;
            --ios-orange: #FF9500;
            --ios-gray: #8E8E93;
            --ios-separator: #C6C6C8;
            --text-primary: #000000;
            --text-secondary: #3C3C4399; /* 60% opacity */
            
            --radius-card: 20px;
            --radius-btn: 12px;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.06);
            --glass-bg: rgba(255, 255, 255, 0.85);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* iOS Header */
        header {
            width: 100%;
            padding: 15px 20px;
            box-sizing: border-box;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
            position: relative;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-icon-img {
            width: 38px; height: 38px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
            background: rgba(0,0,0,0.05);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        /* Settings Button */
        .settings-btn-top {
            position: absolute;
            right: 20px; top: 20px;
            background: rgba(255,255,255,0.5);
            border: 1px solid rgba(0,0,0,0.05);
            width: 36px; height: 36px; border-radius: 50%;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; backdrop-filter: blur(10px); color: var(--text-primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .settings-btn-top:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }

        /* Nav */
        .glass-nav {
            position: sticky; top: 10px; z-index: 100;
            width: 92%; max-width: 600px;
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 16px; padding: 6px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; justify-content: space-between; gap: 8px; margin-bottom: 20px;
        }

        .nav-btn {
            flex: 1; height: 38px; border: none; background: transparent;
            border-radius: 10px; font-weight: 600; font-size: 0.9rem;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease;
        }
        .nav-btn.active { background-color: var(--ios-card); color: var(--ios-blue); box-shadow: 0 2px 10px rgba(0,0,0,0.08); }

        #app-container { width: 92%; max-width: 600px; flex: 1; padding-bottom: 80px; }

        /* Cards */
        .ios-card {
            background: var(--ios-card); border-radius: var(--radius-card); padding: 20px;
            box-shadow: var(--shadow-soft); margin-bottom: 20px; position: relative; overflow: hidden;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }

        /* Search */
        .search-wrapper { position: relative; margin-bottom: 15px; }
        .search-bar {
            width: 100%; padding: 12px 16px; padding-left: 40px;
            border-radius: 14px; border: none; background: #E3E3E8;
            font-size: 17px; color: var(--text-primary); box-sizing: border-box; outline: none;
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--ios-gray); font-size: 1.1rem;
        }
        
        .section-header {
            font-size: 0.8rem; font-weight: 700; color: var(--ios-gray); 
            margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Daily Recommendations */
        .daily-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;
        }
        .daily-card {
            background: white; border-radius: 16px; padding: 15px;
            box-shadow: var(--shadow-soft); display: flex; flex-direction: column;
            justify-content: space-between; min-height: 100px; cursor: pointer;
            transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.03);
            /* Ensure text stays within card */
            word-break: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .daily-card:active { transform: scale(0.96); }
        .daily-label { font-size: 0.7rem; color: var(--ios-orange); font-weight: 700; text-transform: uppercase; }
        .daily-name { 
            font-size: 1.1rem; font-weight: 700; color: var(--text-primary); 
            line-height: 1.2; margin-top: 5px; margin-bottom: 10px;
            word-break: break-word;
        }
        .daily-sub { font-size: 0.8rem; color: var(--ios-gray); margin-top: auto; }

        /* System Scroll */
        .system-scroll-container {
            display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px;
            margin-bottom: 15px; scrollbar-width: none; flex-wrap: nowrap;
        }
        .system-scroll-container::-webkit-scrollbar { display: none; }

        /* Multi-Drug Select Dropdown */
        .drug-selector-wrapper {
            margin: 10px 0; padding: 8px; background: #F2F2F7; border-radius: 12px;
        }
        .drug-select-label {
            font-size: 0.7rem; color: var(--ios-gray); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; display: block;
        }
        .drug-select {
            width: 100%; padding: 6px; border-radius: 8px; border: 1px solid #d1d1d6;
            background: white; font-size: 0.9rem; color: var(--ios-blue); font-weight: 600;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px auto;
        }

        /* Flashcard */
        .flashcard-wrapper { perspective: 1000px; height: 600px; cursor: pointer; }
        .flashcard-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d;
        }
        .flashcard-wrapper.flipped .flashcard-inner { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: var(--radius-card); background: var(--ios-card);
            box-shadow: var(--shadow-soft); display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .card-back { transform: rotateY(180deg); justify-content: flex-start; text-align: left; padding-top: 25px; overflow-y: auto; }

        .drug-title {
            font-size: 2.2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--ios-blue), var(--ios-indigo));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 15px 0; line-height: 1.2;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .detail-row { width: 100%; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #F2F2F7; }
        .detail-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ios-gray); font-weight: 600; margin-bottom: 4px; }
        .detail-content { 
            font-size: 1.05rem; font-weight: 500; color: var(--text-primary); line-height: 1.4;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }

        .action-btn {
            background: var(--ios-bg); color: var(--ios-blue); border: none;
            padding: 12px 20px; border-radius: 12px; font-weight: 600;
            font-size: 0.95rem; width: 100%; margin-top: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;
        }
        .action-btn:active { background: #d1d1d6; }
        .btn-primary { background: var(--ios-blue); color: white; }
        .btn-green { background: var(--ios-green); color: white; }

        .external-links-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }

        /* Modals & Misc */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: flex-end;
        }
        .modal-card {
            background: var(--ios-card); width: 100%; max-width: 600px; height: 85vh;
            border-radius: 24px 24px 0 0; padding: 25px; box-sizing: border-box;
            overflow-y: auto; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .chip {
            display: inline-flex; padding: 8px 14px; background: #E3E3E8;
            border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            color: var(--text-primary); margin: 0; cursor: pointer; white-space: nowrap;
        }
        
        .filter-scroller {
            display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none;
        }
        .filter-scroller::-webkit-scrollbar { display: none; }
        select.ios-select {
            appearance: none; background: var(--ios-bg); border: none; padding: 10px 16px;
            border-radius: 10px; font-size: 0.9rem; font-weight: 600; color: var(--ios-blue);
        }

        .result-card {
            background: white; padding: 16px; border-radius: 16px; margin-bottom: 12px;
            border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: all 0.2s; cursor: pointer;
            /* Text wrapping safety */
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .result-card:active { transform: scale(0.98); }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .result-name { 
            font-weight: 700; font-size: 1.1rem; color: var(--ios-blue); 
            word-break: break-word; flex: 1;
        }
        .result-class { 
            font-size: 0.85rem; color: var(--ios-gray); text-align: right; 
            max-width: 40%; word-break: break-word;
        }

        .ai-output {
            background: #F0F9FF; border-left: 4px solid var(--ios-blue);
            padding: 15px; border-radius: 12px; margin-top: 15px;
            font-size: 0.95rem; line-height: 1.6; display: none;
            word-wrap: break-word; overflow-wrap: break-word;
        }

        .settings-input {
            width: 100%; padding: 12px; border: 1px solid #d1d1d6;
            border-radius: 10px; margin-bottom: 15px; box-sizing: border-box;
            background: #F2F2F7; font-size: 16px;
        }
        .config-section { margin-bottom: 15px; }

        .loading-spinner {
            display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%; border-top-color: var(--ios-blue); animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hidden Details in Search */
        .extra-details { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.9rem; line-height: 1.4; color: #333; }
        .expanded .extra-details { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

<header>
    <h1>
        <img src="apple-touch-icon.png" class="app-icon-img" alt="App Icon">
        AI Drug Tutor
    </h1>
    <button onclick="toggleSettings()" class="settings-btn-top">‚öôÔ∏è</button>
    <div class="subtitle" id="provider-display">DeepSeek</div>
</header>

<div class="glass-nav">
    <button class="nav-btn active" id="nav-search" onclick="switchMode('search')">Search</button>
    <button class="nav-btn" id="nav-flash" onclick="switchMode('flashcard')">Cards</button>
    <button class="nav-btn" id="nav-quiz" onclick="switchMode('quiz')">Quiz</button>
    <button class="nav-btn" style="color:var(--ios-green);" onclick="window.location.href='ward.html'">üìã Ward</button>
</div>

<div id="filter-bar" class="filter-scroller" style="display:none; width: 92%; max-width:600px;">
    <select id="system-filter" onchange="applyFilter()" class="ios-select">
        <option value="All">All Systems</option>
    </select>
    <select id="mastery-filter" onchange="applyFilter()" class="ios-select">
        <option value="All">All Mastery</option>
        <option value="Focus">‚ö†Ô∏è Focus</option>
        <option value="Learning">üü° Learning</option>
        <option value="Mastered">‚úÖ Mastered</option>
    </select>
</div>

<div id="app-container">
    
    <div id="search-section">
        <div class="section-header">
            <span>üìÖ Daily Study Picks (8)</span>
            <span style="font-size:0.7rem; font-weight:400; color:var(--ios-blue);" onclick="refreshDailyPicks()">Refresh</span>
        </div>
        <div id="daily-container" class="daily-grid">
            <div class="daily-card" style="justify-content:center; align-items:center;">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" id="search-input" class="search-bar" placeholder="Search drugs, classes, side effects..." oninput="handleSearch()">
        </div>

        <div id="history-section" style="margin-bottom:20px; display:none;">
            <div class="section-header">Recent</div>
            <div id="history-container" style="overflow-x:auto; white-space:nowrap; padding-bottom:5px;"></div>
        </div>
        
        <div class="section-header">Browse by System</div>
        <div id="recommend-container" class="system-scroll-container"></div>

        <div id="search-results">
            <div style="text-align:center; color:var(--text-secondary); margin-top:40px;">
                <p>Start typing to search the database.</p>
                <div style="display:flex; justify-content:center; gap:10px;">
                     <span class="chip" onclick="quickSearch('Cardio')">ü´Ä Cardio</span>
                     <span class="chip" onclick="quickSearch('Respiratory')">ü´Å Resp</span>
                </div>
            </div>
        </div>
    </div>

    <div id="flashcard-section" style="display:none;">
        <div class="flashcard-wrapper" id="flashcard" onclick="flipCard(event)">
            <div class="flashcard-inner">
                
                <div class="card-face card-front">
                    <div style="font-size: 4rem; margin-bottom: 10px;">üíä</div>
                    <div style="font-size:0.9rem; color:var(--ios-gray); text-transform:uppercase; letter-spacing:1px; font-weight:700;">Generic Name</div>
                    <h2 id="fc-name" class="drug-title">Drug Name</h2>
                    <p style="color:var(--ios-gray); margin-top:0;">Tap to flip for details</p>
                    
                    <button onclick="event.stopPropagation(); speakText(flashcardList[fcCurrentIndex].name)" class="action-btn" style="width:auto; margin-top:20px; background: #F2F2F7;">
                        üîä Pronounce
                    </button>
                </div>

                <div class="card-face card-back">
                    <div class="detail-row">
                        <div class="detail-label">Class</div>
                        <div class="detail-content" id="fc-class">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">System</div>
                        <div class="detail-content" id="fc-system">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Indication</div>
                        <div class="detail-content" id="fc-indication">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label" style="color:var(--ios-red);">Side Effects</div>
                        <div class="detail-content" id="fc-side-effects">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Nursing Considerations</div>
                        <div class="detail-content" id="fc-nursing" style="font-size:0.9rem; line-height:1.5;">...</div>
                    </div>

                    <div id="fc-selector-container" class="drug-selector-wrapper" style="display:none;">
                        <span class="drug-select-label">Multiple Drugs Detected:</span>
                        <select id="fc-drug-selector" class="drug-select" onchange="updateFlashcardLinks(this.value)"></select>
                    </div>

                    <div class="external-links-grid">
                        <a id="fc-google-link" href="#" target="_blank" onclick="event.stopPropagation();" class="action-btn" style="margin:0; text-decoration:none; font-size:0.85rem;">
                            üåê Google
                        </a>
                        <button id="fc-drugs-btn" onclick="event.stopPropagation(); triggerDrugsCom()" class="action-btn" style="margin:0; font-size:0.85rem; color:#0051ff;">
                            üíä Drugs.com
                        </button>
                    </div>

                    <button onclick="event.stopPropagation(); getIntegratedCaseStudy(flashcardList[fcCurrentIndex], 'fc-ai-case', 'btn-case', 'btn-read-case')" class="action-btn btn-primary" id="btn-case" style="margin-top:15px;">
                        ‚ú® AI: Generate Case Study
                    </button>
                    
                    <div id="fc-ai-case" class="ai-output" onclick="event.stopPropagation();"></div>
                    <button id="btn-read-case" onclick="event.stopPropagation(); readAIContent('fc-ai-case')" class="action-btn" style="display:none; margin-top:5px;">üîä Read</button>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; padding:0 10px;">
            <button onclick="prevCard()" class="action-btn" style="width:auto;">‚Üê Prev</button>
            <span id="counter" style="font-weight:700; color:var(--ios-gray);">1 / 10</span>
            <button onclick="nextCard()" class="action-btn" style="width:auto;">Next ‚Üí</button>
        </div>
    </div>

    <div id="quiz-section" style="display:none;">
        <div class="ios-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin-top:0; color:var(--ios-blue);">Adaptive Quiz</h3>
                <button onclick="showProgressModal()" style="font-size:0.8rem; background:none; border:none; color:var(--ios-gray);">üìä Stats</button>
            </div>
            <p id="quiz-question" style="font-size:1.1rem; font-weight:600; min-height:60px;">Question loading...</p>
            <div id="quiz-options" style="display:flex; flex-direction:column; gap:10px;"></div>
            
            <div id="quiz-feedback" style="display:none; margin-top:15px; padding:12px; border-radius:12px; text-align:center;"></div>

            <button onclick="triggerQuizExplain()" id="btn-quiz-explain" class="action-btn" style="display:none; margin-top:15px;">ü§ñ Explain</button>
            <div id="ai-container" style="display:none;">
                <div id="ai-content" class="ai-output"></div>
                <button id="btn-read-explain" onclick="readAIContent('ai-content')" class="action-btn" style="display:none;">üîä Read</button>
            </div>

            <button onclick="nextQuestion()" id="next-quiz-btn" class="action-btn btn-primary" style="display:none; margin-top:15px;">Next Question ‚Üí</button>
        </div>
    </div>

</div>

<div id="settings-panel" class="modal-overlay" onclick="if(event.target===this) toggleSettings()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Settings</h3>
            <button onclick="toggleSettings()" style="background:none; border:none; color:var(--ios-blue); font-weight:600; font-size:1rem;">Done</button>
        </div>
        
        <div style="margin-bottom:20px; background:#F9FAFB; padding:15px; border-radius:12px;">
            <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">AI MODEL</label>
            <select id="provider-select" onchange="updateProviderDisplay()" class="ios-select" style="width:100%; margin-top:5px; background:white;">
                <option value="deepseek">DeepSeek V3 (Fast)</option>
                <option value="deepseek-r1">DeepSeek R1 (Reasoner)</option>
            </select>
        </div>

        <div id="deepseek-config" class="config-section">
            <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">DEEPSEEK API KEY</label>
            <input type="password" id="deepseek-key" class="settings-input" placeholder="sk-...">
            <div style="font-size:0.75rem; color:var(--ios-gray);">Works for both V3 and R1 models.</div>
        </div>
        
        <div style="margin-top:20px;">
             <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">DATA SOURCE</label>
             <button onclick="toggleDrugSet()" id="set-btn" class="action-btn">üìö Set: Common</button>
             <div class="import-wrapper" style="margin-top:10px;">
                <input type="text" id="sheet-url" class="settings-input" placeholder="Google Sheet CSV URL" style="margin-bottom:5px;" />
                <button onclick="fetchSheetData()" class="action-btn">Load Sheet Data</button>
                <div id="upload-status" style="font-size:0.8rem; margin-top:5px; text-align:center;"></div>
            </div>
        </div>

        <button onclick="saveSettings()" class="action-btn btn-green" style="margin-top:20px;">Save Configuration</button>
    </div>
</div>

<div id="progress-modal" class="modal-overlay" onclick="if(event.target===this) closeProgressModal()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <h3 style="margin:0;">üìä Knowledge Bank</h3>
            <button onclick="closeProgressModal()" style="background:none; border:none; color:var(--ios-blue);">Close</button>
        </div>
        <div id="progress-list-content" style="overflow-y:auto; flex-grow:1;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="drugs.js"></script>

<script>
    // --- STATE VARIABLES ---
    let extendedDrugs = []; 
    let activeSourceList = []; 
    let filteredList = [];     
    let flashcardList = []; 
    let quizList = [];      
    let searchHistory = []; 
    let quizStats = {}; 
    let fcCurrentIndex = 0;
    let quizCurrentIndex = 0;
    let currentQuizData = null;
    let fcSelectedDrug = ""; 
    
    // API & Keys
    let currentProvider = localStorage.getItem('active_provider') || 'deepseek';
    let deepSeekKey = localStorage.getItem('ds_key') || "sk-92db3cf721454bd7b351ca6ef40eaaf7";
    let googleScriptURL = localStorage.getItem('google_script_url') || "https://script.google.com/macros/s/AKfycbxyNPyjbVXDMTQxFPxEuuCDTNNf-iVFfqedfNbh-kgn6Tk9rSIFEfIaLWXxXZoNOVnWug/exec";
    
    // Settings
    let defaultSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";

    // System Data
    const systemCategories = [
        "Gastro-intestinal system", "Cardiovascular system", "Respiratory system", "Central nervous system", "Infections", "Endocrine system",
        "Obstetrics, gynaecology, and urinary-tract disorders", "Malignant disease and immunosuppression", "Nutrition and blood",
        "Musculoskeletal and joint disease", "Eye", "Ear, nose, and oropharynx", "Skin", "Immunological products and vaccines", "Anaesthesia"
    ];
    const systemShortNames = {
        "Gastro-intestinal system": "GI System", "Cardiovascular system": "Cardio", "Respiratory system": "Respiratory",
        "Central nervous system": "CNS / Neuro", "Infections": "Infections", "Endocrine system": "Endocrine",
        "Obstetrics, gynaecology, and urinary-tract disorders": "ObGyn / GU", "Malignant disease and immunosuppression": "Oncology",
        "Nutrition and blood": "Nutrition / Blood", "Musculoskeletal and joint disease": "MSK / Bone",
        "Eye": "Eye", "Ear, nose, and oropharynx": "ENT", "Skin": "Skin", "Immunological products and vaccines": "Immune / Vax", "Anaesthesia": "Anaesthesia"
    };
    const systemIcons = {
        "Gastro-intestinal": "üçî", "Cardiovascular": "ü´Ä", "Respiratory": "ü´Å", "Central nervous": "üß†", 
        "Infections": "ü¶†", "Endocrine": "ü¶ã", "Obstetrics": "ü§∞", "Malignant": "üéóÔ∏è", "Nutrition": "üçé",
        "Musculoskeletal": "ü¶¥", "Eye": "üëÅÔ∏è", "Ear": "üëÇ", "Skin": "üß¥", "Immunological": "üõ°Ô∏è", "Anaesthesia": "üíâ"
    };

    // --- INITIALIZATION ---
    window.onload = function() {
        if(typeof commonDrugs !== 'undefined') {
            activeSourceList = [...commonDrugs];
            activeSourceList.forEach(d => {
                d.system = getSystemForDrug(d);
                d.side_effects = d.SideEffects || d.sideEffects || "Refer to nursing guide";
            });
            flashcardList = [...activeSourceList];
        }
        
        // Restore Data
        const savedHist = localStorage.getItem('drug_tutor_search_history');
        if(savedHist) searchHistory = JSON.parse(savedHist);
        const savedStats = localStorage.getItem('drug_tutor_quiz_stats');
        if(savedStats) quizStats = JSON.parse(savedStats);

        // Init UI
        document.getElementById('provider-select').value = currentProvider;
        document.getElementById('deepseek-key').value = deepSeekKey;
        document.getElementById('sheet-url').value = defaultSheetUrl;

        initSystemDropdown();
        applyFilter(); 
        renderHistory();
        renderAllSystems(); 
        updateProviderDisplay();
        
        // Daily Recommendations
        generateDailyPicks();
        
        // AUTO-CONNECT ONLINE
        fetchSheetData(true);
        
        switchMode('search');
    };

    // --- DAILY RECOMMENDATIONS (8 ITEMS) ---
    function generateDailyPicks() {
        if(!activeSourceList || activeSourceList.length === 0) return;
        
        const today = new Date().toDateString(); 
        const seed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        
        // Pseudo-random generator based on date seed
        const random = (seed) => {
            var x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        };

        let available = [...activeSourceList];
        let picks = [];
        
        // Select 8 random drugs
        for(let i = 0; i < 8; i++) {
            if(available.length === 0) break;
            const idx = Math.floor(random(seed + i) * available.length);
            picks.push(available[idx]);
            available.splice(idx, 1);
        }

        renderDailyPicks(picks);
    }

    function refreshDailyPicks() {
        // Shuffle and pick 8
        let shuffled = [...activeSourceList].sort(() => 0.5 - Math.random());
        renderDailyPicks(shuffled.slice(0, 8));
    }

    function renderDailyPicks(picks) {
        const container = document.getElementById('daily-container');
        container.innerHTML = '';
        
        picks.forEach(drug => {
            const div = document.createElement('div');
            div.className = 'daily-card';
            div.innerHTML = `
                <div>
                    <div class="daily-label">Daily Pick</div>
                    <div class="daily-name">${drug.name.split('(')[0]}</div>
                </div>
                <div class="daily-sub">${drug.class}</div>
            `;
            div.onclick = () => {
                document.getElementById('search-input').value = drug.name;
                handleSearch();
            };
            container.appendChild(div);
        });
    }

    // --- HELPER: DRUG NAME PARSING ---
    function parseDrugGenerics(fullString) {
        if(fullString.includes(';')) {
            return fullString.split(';').map(s => s.replace(/\(.*?\)/g, "").trim()).filter(s => s);
        } else {
            return [fullString.replace(/\(.*?\)/g, "").trim()];
        }
    }

    // --- NAVIGATION MODES ---
    function switchMode(mode) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('flashcard-section').style.display = 'none';
        document.getElementById('quiz-section').style.display = 'none';
        document.getElementById('search-section').style.display = 'none';
        document.getElementById('filter-bar').style.display = 'none';

        if(mode === 'search') {
            document.getElementById('search-section').style.display = 'block';
            document.getElementById('nav-search').classList.add('active');
            document.getElementById('search-input').focus();
        } else if (mode === 'flashcard') {
            document.getElementById('flashcard-section').style.display = 'block';
            document.getElementById('nav-flash').classList.add('active');
            document.getElementById('filter-bar').style.display = 'flex';
            renderCard();
        } else if (mode === 'quiz') {
            document.getElementById('quiz-section').style.display = 'block';
            document.getElementById('nav-quiz').classList.add('active');
            generateQuizQuestion();
        }
    }

    // --- FLASHCARD LOGIC ---
    function renderCard() {
        if(flashcardList.length === 0) return;
        const drug = flashcardList[fcCurrentIndex];
        
        document.getElementById('fc-name').innerText = drug.name;
        document.getElementById('fc-class').innerText = drug.class;
        document.getElementById('fc-system').innerText = drug.system || getSystemForDrug(drug);
        document.getElementById('fc-indication').innerText = drug.indication;
        document.getElementById('fc-side-effects').innerText = drug.side_effects || drug.sideEffects || "Not listed";
        
        document.getElementById('fc-nursing').innerText = drug.nursing;
        document.getElementById('counter').innerText = `${fcCurrentIndex + 1} / ${flashcardList.length}`;
        document.getElementById('fc-ai-case').style.display = 'none';
        document.getElementById('btn-read-case').style.display = 'none';
        document.getElementById('flashcard').classList.remove('flipped');
        
        document.getElementById('btn-case').innerHTML = '‚ú® AI: Generate Case Study';
        document.getElementById('btn-case').disabled = false;

        const generics = parseDrugGenerics(drug.name);
        const selectorContainer = document.getElementById('fc-selector-container');
        const selector = document.getElementById('fc-drug-selector');
        
        selector.innerHTML = '';
        if(generics.length > 1) {
            selectorContainer.style.display = 'block';
            generics.forEach(gen => {
                const opt = document.createElement('option');
                opt.value = gen; opt.innerText = gen; selector.appendChild(opt);
            });
            fcSelectedDrug = generics[0];
        } else {
            selectorContainer.style.display = 'none';
            fcSelectedDrug = generics[0];
        }
        
        updateFlashcardLinks(fcSelectedDrug);
    }

    function updateFlashcardLinks(genericName) {
        fcSelectedDrug = genericName;
        const googleQuery = encodeURIComponent(`${genericName} drug nursing`);
        document.getElementById('fc-google-link').href = `https://www.google.com/search?q=${googleQuery}`;
    }
    
    function triggerDrugsCom() {
        openDrugsCom({name: fcSelectedDrug});
    }

    function flipCard(e) {
        if(e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.tagName === 'SELECT') return;
        document.getElementById('flashcard').classList.toggle('flipped');
    }

    function nextCard() {
        if(fcCurrentIndex < flashcardList.length - 1) { fcCurrentIndex++; renderCard(); }
        else { reshuffle(); renderCard(); } 
    }

    function prevCard() {
        if(fcCurrentIndex > 0) { fcCurrentIndex--; renderCard(); }
    }

    // --- SEARCH LOGIC ---
    function handleSearch() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        if(query.length < 2) return;

        const results = activeSourceList.filter(d => 
            d.name.toLowerCase().includes(query) || 
            d.class.toLowerCase().includes(query) ||
            (d.system && d.system.toLowerCase().includes(query)) ||
            (d.side_effects && d.side_effects.toLowerCase().includes(query))
        ).slice(0, 20); 
        
        if(results.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; color:var(--text-secondary); margin-top:40px;">
                    <p>No local drugs found for "${query}".</p>
                    <button onclick="triggerAISearch('${query.replace(/'/g, "\\'")}')" class="action-btn btn-primary" style="margin-top:15px;">
                        ‚ú® Ask AI to Find & Add "${query}"
                    </button>
                    <div id="ai-search-output"></div>
                </div>
            `;
            return;
        }

        const fragment = document.createDocumentFragment();

        results.forEach((drug, index) => {
            const card = document.createElement('div');
            card.className = 'result-card';
            
            const explainId = 'explain-' + index + '-' + Math.floor(Math.random() * 1000);
            const generics = parseDrugGenerics(drug.name);
            const isMulti = generics.length > 1;
            const sideEffectsText = drug.side_effects || drug.sideEffects || "Not listed";
            
            let selectorHTML = '';
            if(isMulti) {
                let options = generics.map(g => `<option value="${g}">${g}</option>`).join('');
                selectorHTML = `
                    <div class="drug-selector-wrapper" style="margin-bottom:5px; padding:5px;">
                        <span class="drug-select-label" style="font-size:0.7rem;">Select Component:</span>
                        <select class="drug-select" style="font-size:0.85rem; padding:5px;" onclick="event.stopPropagation()" onchange="updateSearchCard(this, '${explainId}')">
                            ${options}
                        </select>
                    </div>
                `;
            }

            let initialGeneric = generics[0];
            let googleLink = `https://www.google.com/search?q=${encodeURIComponent(initialGeneric + " drug nursing")}`;

            card.innerHTML = `
                <div class="result-header">
                    <span class="result-name">${drug.name}</span>
                    <span class="result-class">${drug.class}</span>
                </div>
                ${selectorHTML}
                <div style="font-size:0.9rem; margin-top:5px; color:#555;">${drug.indication}</div>
                
                <div class="extra-details">
                    <div style="margin-bottom:5px;"><strong>Side Effects:</strong> <span style="color:#d32f2f;">${sideEffectsText}</span></div>
                    <div style="margin-bottom:5px;"><strong>Nursing:</strong> ${drug.nursing}</div>
                    <div style="margin-bottom:5px;"><strong>System:</strong> ${drug.system}</div>
                    
                    <div style="display:flex; gap:10px; margin-top:15px; overflow-x:auto;">
                         <a href="${googleLink}" target="_blank" class="chip dynamic-google" onclick="event.stopPropagation()">üåê Google</a>
                         <span class="chip" onclick="event.stopPropagation(); triggerSearchDrugsCom(this)">üíä Drugs.com</span>
                         <span class="chip" onclick="event.stopPropagation(); triggerSearchSpeak(this)">üîä Speak</span>
                         <span class="chip" style="background:var(--ios-indigo); color:white;" onclick="event.stopPropagation(); triggerSearchExplain(this, '${explainId}')">ü§ñ Explain</span>
                    </div>
                    <div id="${explainId}" class="ai-output"></div>
                </div>
            `;
            
            card.dataset.currentGeneric = initialGeneric;
            
            card.onclick = (e) => {
                if(['SELECT', 'A', 'BUTTON', 'SPAN', 'INPUT'].includes(e.target.tagName)) return;
                card.classList.toggle('expanded');
            };
            
            fragment.appendChild(card);
        });
        
        container.appendChild(fragment);
    }

    window.updateSearchCard = function(selectElem, explainId) {
        const card = selectElem.closest('.result-card');
        const newVal = selectElem.value;
        card.dataset.currentGeneric = newVal;
        const googleBtn = card.querySelector('.dynamic-google');
        googleBtn.href = `https://www.google.com/search?q=${encodeURIComponent(newVal + " drug nursing")}`;
    };

    window.triggerSearchDrugsCom = function(btn) {
        const card = btn.closest('.result-card');
        openDrugsCom({name: card.dataset.currentGeneric});
    };
    
    window.triggerSearchSpeak = function(btn) {
        const card = btn.closest('.result-card');
        speakText(card.dataset.currentGeneric);
    };
    
    window.triggerSearchExplain = function(btn, outputId) {
        const card = btn.closest('.result-card');
        const box = document.getElementById(outputId);
        btn.innerText = "‚è≥";
        box.style.display = 'block';
        const prompt = `Explain the drug ${card.dataset.currentGeneric} for a nursing student simply in English. Focus on mechanism of action and key monitoring. Markdown format.`;
        streamAIResponse([{role: "user", content: prompt}], (text) => box.innerHTML = marked.parse(text));
        btn.innerText = "‚úÖ";
    }

    function quickSearch(term) {
        document.getElementById('search-input').value = term;
        handleSearch();
    }

    // --- AI & DATA FUNCTIONS ---
    async function triggerAISearch(query) {
        const container = document.getElementById('ai-search-output');
        container.style.display = 'block';
        container.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <div class="loading-spinner"></div>
                <div style="margin-top:10px; font-weight:600;">Searching Database...</div>
            </div>`;

        const prompt = `You are a nursing tutor. The user is searching for "${query}". 
        Provide a clinical summary in strict JSON format.
        Keys: "name", "class", "system", "indication", "nursing", "side_effects".
        Rules:
        1. "system" MUST be one of: [Gastro-intestinal system, Cardiovascular system, Respiratory system, Central nervous system, Infections, Endocrine system, Obstetrics, gynaecology, and urinary-tract disorders, Malignant disease and immunosuppression, Nutrition and blood, Musculoskeletal and joint disease, Eye, Ear, nose, and oropharynx, Skin, Immunological products and vaccines, Anaesthesia].
        2. "nursing" and "side_effects" should be short summary strings.
        3. No markdown formatting. Just raw JSON.`;

        try {
            let fullText = "";
            await streamAIResponse([{role: "user", content: prompt}], (text) => { fullText = text; });
            fullText = fullText.replace(/```json/g, '').replace(/```/g, '').trim();
            const drugData = JSON.parse(fullText);

            container.innerHTML = `
                <div class="ios-card" style="border:2px solid var(--ios-green); margin-top:20px; text-align:left;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; color:var(--ios-blue);">${drugData.name}</h3>
                        <span class="chip" style="background:var(--ios-green); color:white;">AI Found</span>
                    </div>
                    <div class="detail-row"><div class="detail-label">Class</div><div class="detail-content">${drugData.class}</div></div>
                    <div class="detail-row"><div class="detail-label">System</div><div class="detail-content">${drugData.system}</div></div>
                    <div class="detail-row"><div class="detail-label">Indication</div><div class="detail-content">${drugData.indication}</div></div>
                    <div class="detail-row"><div class="detail-label">Side Effects</div><div class="detail-content" style="color:#d32f2f;">${drugData.side_effects}</div></div>
                    <div class="detail-row"><div class="detail-label">Nursing</div><div class="detail-content" style="font-size:0.9rem;">${drugData.nursing}</div></div>
                    <button id="btn-save-sheet" onclick='saveToGoogleSheet(${JSON.stringify(drugData)})' class="action-btn btn-green">üíæ Save to Database</button>
                    <div id="save-status" style="text-align:center; margin-top:10px; font-size:0.85rem; font-weight:600;"></div>
                </div>`;
        } catch (e) {
            container.innerHTML = `<div style="color:red; margin-top:10px;">Search Failed. Try again.</div>`;
        }
    }

    function saveToGoogleSheet(drugData) {
        const statusEl = document.getElementById('save-status');
        const saveBtn = document.getElementById('btn-save-sheet');
        
        if(!googleScriptURL) { alert("Please set your Google Script URL in Settings (‚öôÔ∏è)."); return; }

        saveBtn.disabled = true; saveBtn.innerText = "‚è≥ Saving..."; statusEl.innerText = "Syncing with cloud...";

        fetch(googleScriptURL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(drugData) })
        .then(() => { 
            statusEl.innerText = "‚úÖ Saved successfully!"; statusEl.style.color = "var(--ios-green)"; 
            saveBtn.innerText = "üíæ Saved"; 
            activeSourceList.push(drugData); 
        })
        .catch(err => { 
            statusEl.innerText = "‚ùå Error saving."; statusEl.style.color = "var(--ios-red)"; saveBtn.disabled = false; 
        });
    }

    function openDrugsCom(drug) {
        let cleanName = drug.name.split('(')[0].trim();
        const query = encodeURIComponent(cleanName);
        window.open(`https://www.drugs.com/search.php?searchterm=${query}`, '_blank');
    }

    // --- HELPER FUNCTIONS ---
    function getSystemForDrug(drug) {
        if (drug.system && systemCategories.includes(drug.system)) return drug.system;
        const txt = (drug.class + " " + drug.indication + " " + drug.name).toLowerCase();
        if (txt.includes("antacid") || txt.includes("ulcer")) return "Gastro-intestinal system";
        if (txt.includes("cardio") || txt.includes("beta-blocker")) return "Cardiovascular system";
        if (txt.includes("asthma") || txt.includes("broncho")) return "Respiratory system";
        if (txt.includes("analgesic") || txt.includes("depress")) return "Central nervous system";
        if (txt.includes("antibiotic") || txt.includes("viral")) return "Infections";
        return "Other"; 
    }
    
    function getSystemIcon(sys) {
        for(let k in systemIcons) { if(sys.includes(k) || k.includes(sys.split(' ')[0])) return systemIcons[k]; }
        return "üíä";
    }

    function initSystemDropdown() {
        const select = document.getElementById('system-filter');
        while (select.options.length > 1) { select.remove(1); }
        systemCategories.forEach(sys => {
            const opt = document.createElement('option');
            opt.value = sys; opt.innerText = sys; select.appendChild(opt);
        });
    }
    
    function applyFilter() {
        const sysCategory = document.getElementById('system-filter').value;
        const masteryCategory = document.getElementById('mastery-filter').value;
        
        filteredList = activeSourceList.filter(drug => {
            const sys = drug.system || getSystemForDrug(drug);
            const sysMatch = (sysCategory === "All" || sys === sysCategory);
            let masteryMatch = true;
            if (masteryCategory !== "All") {
                const s = quizStats[drug.name];
                const pct = s && s.attempts > 0 ? (s.correct/s.attempts)*100 : 0;
                if(masteryCategory === 'Mastered') masteryMatch = (pct >= 80 && s && s.attempts >= 2);
                else if(masteryCategory === 'Learning') masteryMatch = (pct >= 50 && pct < 80);
                else masteryMatch = (pct < 50 || !s);
            }
            return sysMatch && masteryMatch;
        });
        
        if (filteredList.length === 0) {
            alert("No drugs found matching these filters.");
            document.getElementById('mastery-filter').value = "All";
            filteredList = [...activeSourceList];
        }
        reshuffle();
    }
    
    function reshuffle() {
        flashcardList = [...filteredList];
        flashcardList.sort(() => Math.random() - 0.5);
        quizList = [...filteredList];
        fcCurrentIndex = 0;
        renderCard();
    }
    
    function renderAllSystems() {
        const container = document.getElementById('recommend-container');
        container.innerHTML = '';
        systemCategories.forEach(sys => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.style.background = '#E0E7FF'; chip.style.color = '#4338ca';
            const shortName = systemShortNames[sys] || sys;
            chip.innerText = `${getSystemIcon(sys)} ${shortName}`;
            chip.onclick = () => { document.getElementById('search-input').value = sys; handleSearch(); };
            container.appendChild(chip);
        });
    }
    
    function renderHistory() {
        const container = document.getElementById('history-container');
        const section = document.getElementById('history-section');
        container.innerHTML = '';
        if(searchHistory.length === 0) { section.style.display = 'none'; return; }
        section.style.display = 'block';
        searchHistory.forEach(term => {
            const chip = document.createElement('div');
            chip.className = 'chip'; chip.innerText = term;
            chip.onclick = () => { document.getElementById('search-input').value = term; handleSearch(); };
            container.appendChild(chip);
        });
    }

    // --- QUIZ LOGIC ---
    function generateQuizQuestion() {
        const container = document.getElementById('quiz-options');
        const qEl = document.getElementById('quiz-question');
        container.innerHTML = ''; document.getElementById('quiz-feedback').style.display = 'none';
        document.getElementById('next-quiz-btn').style.display = 'none';
        document.getElementById('btn-quiz-explain').style.display = 'none';
        document.getElementById('ai-container').style.display = 'none';

        if (quizList.length === 0) { qEl.innerText = "No drugs available."; return; }

        const correctDrug = quizList[Math.floor(Math.random() * quizList.length)];
        const qType = Math.random() > 0.5 ? 'indication' : 'class';
        
        qEl.innerText = qType === 'indication' 
            ? `Which drug is indicated for: "${correctDrug.indication}"?`
            : `Which drug belongs to the class: "${correctDrug.class}"?`;

        let options = [correctDrug];
        while(options.length < 4) {
            let r = quizList[Math.floor(Math.random() * quizList.length)];
            if(!options.includes(r)) options.push(r);
        }
        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'action-btn'; btn.style.textAlign = 'left'; btn.style.justifyContent = 'flex-start'; btn.style.background = '#F2F2F7';
            btn.innerText = opt.name;
            btn.onclick = () => checkAnswer(btn, opt, correctDrug, qEl.innerText);
            container.appendChild(btn);
        });
    }

    function checkAnswer(btn, selected, correct, questionText) {
         const btns = document.querySelectorAll('#quiz-options button'); btns.forEach(b => b.onclick = null);
         const feedback = document.getElementById('quiz-feedback'); feedback.style.display = 'block';
         
         if(!quizStats[correct.name]) quizStats[correct.name] = { correct: 0, attempts: 0 };
         quizStats[correct.name].attempts++;

         if(selected === correct) {
             btn.style.background = '#dcfce7'; btn.style.color = '#166534';
             feedback.innerHTML = "‚úÖ <strong>Correct!</strong>"; feedback.style.background = "#dcfce7"; feedback.style.color = "#166534";
             quizStats[correct.name].correct++;
         } else {
             btn.style.background = '#fee2e2'; btn.style.color = '#991b1b';
             feedback.innerHTML = `‚ùå <strong>Incorrect.</strong> The answer is ${correct.name}.`; feedback.style.background = "#fee2e2"; feedback.style.color = "#991b1b";
             btns.forEach(b => { if(b.innerText === correct.name) { b.style.background = '#dcfce7'; b.style.color = '#166534'; } });
         }
         
         localStorage.setItem('drug_tutor_quiz_stats', JSON.stringify(quizStats));
         document.getElementById('next-quiz-btn').style.display = 'block';
         document.getElementById('btn-quiz-explain').style.display = 'block';
         currentQuizData = { q: questionText, u: selected.name, c: correct, correctAnswerText: correct.name };
    }

    function nextQuestion() { generateQuizQuestion(); }
    
    function showProgressModal() {
        const modal = document.getElementById('progress-modal');
        const list = document.getElementById('progress-list-content');
        list.innerHTML = '';
        const sorted = Object.keys(quizStats).sort((a,b) => (quizStats[a].correct / quizStats[a].attempts) - (quizStats[b].correct / quizStats[b].attempts));
        sorted.forEach(key => {
            const s = quizStats[key];
            const pct = Math.round((s.correct/s.attempts)*100);
            const row = document.createElement('div');
            row.style.padding = '10px'; row.style.borderBottom = '1px solid #f0f0f0'; row.style.display = 'flex'; row.style.justifyContent = 'space-between';
            row.innerHTML = `<span>${key}</span><span style="font-weight:bold; color:${pct>70?'green':'red'}">${pct}%</span>`;
            list.appendChild(row);
        });
        modal.style.display = 'flex';
    }
    function closeProgressModal() { document.getElementById('progress-modal').style.display = 'none'; }

    // --- AI FUNCTIONS ---
    async function streamAIResponse(messages, onUpdate) {
        // Only DeepSeek supported now
        const apiUrl = "https://api.deepseek.com/chat/completions";
        
        // Determine model based on provider selection
        // If currentProvider is 'deepseek-r1', use 'deepseek-reasoner'
        // Otherwise (default or 'deepseek'), use 'deepseek-chat'
        const modelName = currentProvider === 'deepseek-r1' ? 'deepseek-reasoner' : 'deepseek-chat';

        const headers = { 
            "Authorization": `Bearer ${deepSeekKey}`, 
            "Content-Type": "application/json" 
        };
        
        const body = { 
            model: modelName, 
            messages: messages, 
            temperature: 0.7, 
            stream: true 
        };

        try {
            const response = await fetch(apiUrl, { method: "POST", headers: headers, body: JSON.stringify(body) });
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            const content = json.choices[0]?.delta?.content || "";
                            if (content) { fullText += content; onUpdate(fullText); }
                        } catch (e) {}
                    }
                }
            }
        } catch (e) { onUpdate("Error: " + e.message); }
    }

    async function getIntegratedCaseStudy(drug, outputId, btnId, readBtnId) {
        const btn = document.getElementById(btnId); const box = document.getElementById(outputId);
        btn.innerHTML = '‚è≥ Generating...'; btn.disabled = true; box.style.display = 'block'; box.innerHTML = 'Thinking...';
        
        // Strict English Prompt
        const prompt = `Create a short clinical case study for a nursing student about the drug ${drug.name}. Include a patient scenario, vital signs, and how this drug interacts with them. End with a critical thinking question. English only.`;
        
        await streamAIResponse([{role: "user", content: prompt}], (text) => box.innerHTML = marked.parse(text));
        btn.innerHTML = '‚ú® Regenerate Case'; btn.disabled = false; document.getElementById(readBtnId).style.display = 'block';
    }

    async function triggerQuizExplain() {
        const btn = document.getElementById('btn-quiz-explain'); const box = document.getElementById('ai-content');
        document.getElementById('ai-container').style.display = 'block'; btn.innerHTML = '‚è≥ Thinking...'; btn.disabled = true;
        
        // Strict English Prompt
        const prompt = `The user answered "${currentQuizData.u}" for the question "${currentQuizData.q}". The correct answer is "${currentQuizData.correctAnswerText}". Explain why the correct answer is right and why the chosen answer was wrong in simple English for a nursing student.`;
        
        await streamAIResponse([{role: "user", content: prompt}], (text) => box.innerHTML = marked.parse(text));
        btn.innerHTML = 'ü§ñ Explained'; document.getElementById('btn-read-explain').style.display = 'block';
    }

    // --- UTILS ---
    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }
    
    function saveSettings() {
        localStorage.setItem('active_provider', document.getElementById('provider-select').value);
        localStorage.setItem('ds_key', document.getElementById('deepseek-key').value);
        localStorage.setItem('google_script_url', document.getElementById('sheet-url').value);
        // reload globals
        currentProvider = document.getElementById('provider-select').value;
        deepSeekKey = document.getElementById('deepseek-key').value;
        toggleSettings();
        alert("Settings Saved!");
    }
    
    function updateProviderDisplay() {
        const val = document.getElementById('provider-select').value;
        document.getElementById('deepseek-config').style.display = 'block';
        document.getElementById('provider-display').innerText = val === 'deepseek-r1' ? "DeepSeek R1" : "DeepSeek V3";
    }

    function fetchSheetData(autoSwitch = false) {
        const url = document.getElementById('sheet-url').value;
        let fetchUrl = url;
        if (url.includes("docs.google.com/spreadsheets") && url.includes("/edit")) fetchUrl = url.replace(/\/edit.*$/, "/export?format=csv");
        
        const status = document.getElementById('upload-status');
        status.innerText = "‚è≥ Loading...";
        
        fetch(fetchUrl).then(r => r.text()).then(csv => {
            Papa.parse(csv, { header: true, skipEmptyLines: true, complete: function(results) {
                 if (results.data.length > 0) {
                     extendedDrugs = results.data;
                     // Ensure data integrity
                     extendedDrugs.forEach(d => {
                         d.side_effects = d.side_effects || d.sideEffects || "Refer to nursing guide";
                     });

                     status.innerText = `‚úÖ Loaded ${extendedDrugs.length} drugs`;
                     document.getElementById('set-btn').innerText = "üìö Set: Online CSV";
                     
                     if(autoSwitch) {
                         activeSourceList = extendedDrugs;
                         activeSourceList.forEach(d => d.system = getSystemForDrug(d));
                         applyFilter();
                         generateDailyPicks();
                     }
                 }
            }});
        }).catch(e => {
            status.innerText = "‚ùå Load Failed. Using Local.";
            if(autoSwitch) {
                activeSourceList = commonDrugs;
                activeSourceList.forEach(d => d.system = getSystemForDrug(d));
                applyFilter();
                generateDailyPicks();
            }
        });
    }

    function toggleDrugSet() {
        if(activeSourceList === extendedDrugs) { activeSourceList = commonDrugs; document.getElementById('set-btn').innerText = "üìö Set: Common"; } 
        else if(extendedDrugs.length > 0) { activeSourceList = extendedDrugs; document.getElementById('set-btn').innerText = "üìö Set: Online CSV"; }
        activeSourceList.forEach(d => d.system = getSystemForDrug(d));
        applyFilter();
        generateDailyPicks();
    }
    
    function speakText(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
    }
    
    function readAIContent(id) {
        speakText(document.getElementById(id).innerText);
    }

</script>
</body>
</html>
