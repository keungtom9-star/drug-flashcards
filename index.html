<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    <title>AI Drug Tutor</title>
    
    <link rel="icon" href="apple-touch-icon.png" type="image/png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <style>
        :root {
            /* iOS 17/Modern Palette */
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-indigo: #5856D6;
            --ios-orange: #FF9500;
            --ios-gray: #8E8E93;
            --ios-separator: #C6C6C8;
            --text-primary: #000000;
            --text-secondary: #3C3C4399; /* 60% opacity */
            
            --radius-card: 20px;
            --radius-btn: 12px;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.06);
            --glass-bg: rgba(255, 255, 255, 0.85);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* iOS Header */
        header {
            width: 100%;
            padding: 15px 20px;
            box-sizing: border-box;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
            position: relative;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-icon-img {
            width: 38px; height: 38px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
            background: rgba(0,0,0,0.05);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        /* Settings Button */
        .settings-btn-top {
            position: absolute;
            right: 20px; top: 20px;
            background: rgba(255,255,255,0.5);
            border: 1px solid rgba(0,0,0,0.05);
            width: 36px; height: 36px; border-radius: 50%;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; backdrop-filter: blur(10px); color: var(--text-primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .settings-btn-top:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }

        /* Nav */
        .glass-nav {
            position: sticky; top: 10px; z-index: 100;
            width: 92%; max-width: 600px;
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 16px; padding: 6px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; justify-content: space-between; gap: 8px; margin-bottom: 20px;
        }

        .nav-btn {
            flex: 1; height: 38px; border: none; background: transparent;
            border-radius: 10px; font-weight: 600; font-size: 0.9rem;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease;
        }
        .nav-btn.active { background-color: var(--ios-card); color: var(--ios-blue); box-shadow: 0 2px 10px rgba(0,0,0,0.08); }

        #app-container { width: 92%; max-width: 600px; flex: 1; padding-bottom: 80px; }

        /* Cards */
        .ios-card {
            background: var(--ios-card); border-radius: var(--radius-card); padding: 20px;
            box-shadow: var(--shadow-soft); margin-bottom: 20px; position: relative; overflow: hidden;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }

        /* Search */
        .search-wrapper { position: relative; margin-bottom: 15px; }
        .search-bar {
            width: 100%; padding: 12px 16px; padding-left: 40px;
            border-radius: 14px; border: none; background: #E3E3E8;
            font-size: 17px; color: var(--text-primary); box-sizing: border-box; outline: none;
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--ios-gray); font-size: 1.1rem;
        }
        
        .section-header {
            font-size: 0.8rem; font-weight: 700; color: var(--ios-gray); 
            margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Daily Recommendations */
        .daily-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;
        }
        .daily-card {
            background: linear-gradient(145deg, #ffffff, #f7fbff); border-radius: 16px; padding: 15px;
            box-shadow: var(--shadow-soft); display: flex; flex-direction: column;
            justify-content: space-between; min-height: 100px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.05);
            /* Ensure text stays within card */
            word-break: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .daily-card:hover { box-shadow: 0 8px 25px rgba(0, 122, 255, 0.18); }
        .daily-card:active { transform: scale(0.96); }
        .daily-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .daily-icon-pill {
            width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.9);
            display:flex; align-items:center; justify-content:center; font-size: 0.95rem;
        }
        .daily-label {
            font-size: 0.68rem; color: #fff; font-weight: 800; text-transform: uppercase;
            letter-spacing: .6px; background: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 999px;
        }
        .daily-name { 
            font-size: 1.1rem; font-weight: 700; color: var(--text-primary); 
            line-height: 1.2; margin-top: 5px; margin-bottom: 10px;
            word-break: break-word;
        }
        .daily-sub { font-size: 0.8rem; color: #1f2937; margin-top: auto; opacity: .85; }

        .anki-controls {
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding: 0 10px;
        }
        .anki-btn {
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            padding: 10px 6px;
            cursor: pointer;
        }

        .anki-meta {
            margin-top: 10px;
            font-size: 0.78rem;
            color: var(--ios-gray);
            text-align: center;
        }

        .quiz-stats-row {
            margin: 12px 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .quiz-stat-pill {
            background: #F2F2F7;
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            font-size: 0.78rem;
            color: var(--ios-gray);
        }

        .quiz-stat-pill strong {
            display: block;
            color: var(--text-primary);
            font-size: 1rem;
            margin-top: 2px;
        }


        .mobile-tab-label { display: none; }

        .app-smooth {
            contain: content;
            will-change: transform;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        @media (max-width: 768px) {
            header { padding: 10px 14px 8px; }
            h1 { font-size: 1.35rem; }
            .subtitle { font-size: 0.74rem; }
            .settings-btn-top { right: 14px; top: 12px; width: 34px; height: 34px; }

            .glass-nav {
                position: fixed;
                top: auto;
                bottom: calc(8px + env(safe-area-inset-bottom));
                left: 10px;
                right: 10px;
                width: auto;
                max-width: none;
                margin-bottom: 0;
                z-index: 500;
                border-radius: 18px;
                padding: 7px;
                box-shadow: 0 10px 28px rgba(0,0,0,0.14);
            }

            .nav-btn {
                height: 42px;
                font-size: 0.82rem;
                display: flex;
                flex-direction: column;
                gap: 2px;
                align-items: center;
                justify-content: center;
            }

            #app-container { width: 94%; padding-bottom: 130px; }
            #filter-bar { width: 94% !important; }

            .flashcard-wrapper {
                height: 66dvh;
                min-height: 460px;
                max-height: 680px;
            }

            .drug-title { font-size: 1.8rem; }
            .detail-content { font-size: 0.97rem; }
            .action-btn { min-height: 44px; }
            .result-card { padding: 13px; }
            .daily-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        /* System Scroll */
        .system-scroll-container {
            display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px;
            margin-bottom: 15px; scrollbar-width: none; flex-wrap: nowrap;
        }
        .system-scroll-container::-webkit-scrollbar { display: none; }

        /* Multi-Drug Select Dropdown */
        .drug-selector-wrapper {
            margin: 10px 0; padding: 8px; background: #F2F2F7; border-radius: 12px;
        }
        .drug-select-label {
            font-size: 0.7rem; color: var(--ios-gray); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; display: block;
        }
        .drug-select {
            width: 100%; padding: 6px; border-radius: 8px; border: 1px solid #d1d1d6;
            background: white; font-size: 0.9rem; color: var(--ios-blue); font-weight: 600;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px auto;
        }

        /* Flashcard */
        .flashcard-wrapper { perspective: 1000px; height: 600px; cursor: pointer; }
        .flashcard-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d;
        }
        .flashcard-wrapper.flipped .flashcard-inner { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: var(--radius-card); background: var(--ios-card);
            box-shadow: var(--shadow-soft); display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .card-back { transform: rotateY(180deg); justify-content: flex-start; text-align: left; padding-top: 25px; overflow-y: auto; }

        .drug-title {
            font-size: 2.2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--ios-blue), var(--ios-indigo));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 15px 0; line-height: 1.2;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .detail-row { width: 100%; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #F2F2F7; }
        .detail-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ios-gray); font-weight: 600; margin-bottom: 4px; }
        .detail-content { 
            font-size: 1.05rem; font-weight: 500; color: var(--text-primary); line-height: 1.4;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }

        .action-btn {
            background: var(--ios-bg); color: var(--ios-blue); border: none;
            padding: 12px 20px; border-radius: 12px; font-weight: 600;
            font-size: 0.95rem; width: 100%; margin-top: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;
        }
        .action-btn:active { background: #d1d1d6; }
        .btn-primary { background: var(--ios-blue); color: white; }
        .btn-green { background: var(--ios-green); color: white; }

        .external-links-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }

        /* Modals & Misc */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: flex-end;
        }
        .modal-card {
            background: var(--ios-card); width: 100%; max-width: 600px; height: 85vh;
            border-radius: 24px 24px 0 0; padding: 25px; box-sizing: border-box;
            overflow-y: auto; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .chip {
            display: inline-flex; padding: 8px 14px; background: #E3E3E8;
            border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            color: var(--text-primary); margin: 0; cursor: pointer; white-space: nowrap;
        }
        
        .filter-scroller {
            display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none;
        }
        .filter-scroller::-webkit-scrollbar { display: none; }
        select.ios-select {
            appearance: none; background: var(--ios-bg); border: none; padding: 10px 16px;
            border-radius: 10px; font-size: 0.9rem; font-weight: 600; color: var(--ios-blue);
        }

        .result-card {
            background: white; padding: 16px; border-radius: 16px; margin-bottom: 12px;
            border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: all 0.2s; cursor: pointer;
            /* Text wrapping safety */
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .result-card:active { transform: scale(0.98); }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .result-name { 
            font-weight: 700; font-size: 1.1rem; color: var(--ios-blue); 
            word-break: break-word; flex: 1;
        }
        .result-class { 
            font-size: 0.85rem; color: var(--ios-gray); text-align: right; 
            max-width: 40%; word-break: break-word;
        }
        .name-with-speak { display:flex; align-items:center; gap:8px; flex:1; min-width:0; }
        .speak-icon-btn {
            border:none; background:#eef2ff; color:var(--ios-blue); width:30px; height:30px;
            border-radius:50%; font-size:0.95rem; cursor:pointer; flex-shrink:0;
        }
        .quiz-mini-explainer {
            display:none; margin-top:10px; padding:10px 12px; border-radius:10px;
            background:#eff6ff; color:#1e3a8a; font-size:0.82rem; line-height:1.45;
        }

        .ai-output {
            background: #F0F9FF; border-left: 4px solid var(--ios-blue);
            padding: 15px; border-radius: 12px; margin-top: 15px;
            font-size: 0.95rem; line-height: 1.6; display: none;
            word-wrap: break-word; overflow-wrap: break-word;
        }

        .settings-input {
            width: 100%; padding: 12px; border: 1px solid #d1d1d6;
            border-radius: 10px; margin-bottom: 15px; box-sizing: border-box;
            background: #F2F2F7; font-size: 16px;
        }
        .config-section { margin-bottom: 15px; }

        .loading-spinner {
            display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%; border-top-color: var(--ios-blue); animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hidden Details in Search */
        .extra-details { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.9rem; line-height: 1.4; color: #333; }
        .expanded .extra-details { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

<header>
    <h1>
        <img src="apple-touch-icon.png" class="app-icon-img" alt="App Icon">
        AI Drug Tutor
    </h1>
    <button onclick="toggleSettings()" class="settings-btn-top">‚öôÔ∏è</button>
    <div class="subtitle" id="provider-display">DeepSeek</div>
</header>

<div class="glass-nav">
    <button class="nav-btn active" id="nav-search" onclick="switchMode('search')">Search</button>
    <button class="nav-btn" id="nav-flash" onclick="switchMode('flashcard')">Cards</button>
    <button class="nav-btn" id="nav-quiz" onclick="switchMode('quiz')">Quiz</button>
    <button class="nav-btn" style="color:var(--ios-green);" onclick="window.location.href='ward.html'">üìã Ward</button>
</div>

<div id="filter-bar" class="filter-scroller" style="display:none; width: 92%; max-width:600px;">
    <select id="system-filter" onchange="applyFilter()" class="ios-select">
        <option value="All">All Systems</option>
    </select>
    <select id="mastery-filter" onchange="applyFilter()" class="ios-select">
        <option value="All">All Mastery</option>
        <option value="Focus">‚ö†Ô∏è Focus</option>
        <option value="Learning">üü° Learning</option>
        <option value="Mastered">‚úÖ Mastered</option>
    </select>
</div>

<div id="app-container">
    
    <div id="search-section" class="app-smooth">
        <div class="section-header">
            <span>üìÖ Daily Study Picks (8)</span>
            <span style="font-size:0.7rem; font-weight:400; color:var(--ios-blue);" onclick="refreshDailyPicks()">Refresh</span>
        </div>
        <div id="daily-container" class="daily-grid">
            <div class="daily-card" style="justify-content:center; align-items:center;">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" id="search-input" class="search-bar" placeholder="Search drugs, classes, side effects..." oninput="handleSearch()">
        </div>

        <div id="history-section" style="margin-bottom:20px; display:none;">
            <div class="section-header">Recent</div>
            <div id="history-container" style="overflow-x:auto; white-space:nowrap; padding-bottom:5px;"></div>
        </div>
        
        <div class="section-header">Browse by System</div>
        <div id="recommend-container" class="system-scroll-container"></div>

        <div id="search-results">
            <div style="text-align:center; color:var(--text-secondary); margin-top:40px;">
                <p>Start typing to search the database.</p>
                <div style="display:flex; justify-content:center; gap:10px;">
                     <span class="chip" onclick="quickSearch('Cardio')">ü´Ä Cardio</span>
                     <span class="chip" onclick="quickSearch('Respiratory')">ü´Å Resp</span>
                </div>
            </div>
        </div>
    </div>

    <div id="flashcard-section" class="app-smooth" style="display:none;">
        <div class="flashcard-wrapper" id="flashcard" onclick="flipCard(event)">
            <div class="flashcard-inner">
                
                <div class="card-face card-front">
                    <div style="font-size: 4rem; margin-bottom: 10px;">üíä</div>
                    <div style="font-size:0.9rem; color:var(--ios-gray); text-transform:uppercase; letter-spacing:1px; font-weight:700;">Generic Name</div>
                    <h2 id="fc-name" class="drug-title">Drug Name</h2>
                    <p style="color:var(--ios-gray); margin-top:0;">Tap to flip for details</p>
                    
                    <button onclick="event.stopPropagation(); speakText(flashcardList[fcCurrentIndex].name)" class="action-btn" style="width:auto; margin-top:20px; background: #F2F2F7;">
                        üîä Pronounce
                    </button>
                </div>

                <div class="card-face card-back">
                    <div class="detail-row">
                        <div class="detail-label">Class</div>
                        <div class="detail-content" id="fc-class">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">System</div>
                        <div class="detail-content" id="fc-system">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Indication</div>
                        <div class="detail-content" id="fc-indication">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label" style="color:var(--ios-red);">Side Effects</div>
                        <div class="detail-content" id="fc-side-effects">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Nursing Considerations</div>
                        <div class="detail-content" id="fc-nursing" style="font-size:0.9rem; line-height:1.5;">...</div>
                    </div>

                    <div id="fc-selector-container" class="drug-selector-wrapper" style="display:none;">
                        <span class="drug-select-label">Multiple Drugs Detected:</span>
                        <div id="fc-selected-drug-label" style="font-size:0.82rem; color:var(--ios-gray); margin-top:6px;"></div>
                    </div>

                    <div class="external-links-grid">
                        <a id="fc-google-link" href="#" target="_blank" onclick="event.stopPropagation(); triggerFcAction('google')" class="action-btn" style="margin:0; text-decoration:none; font-size:0.85rem;">
                            üåê Google
                        </a>
                        <button id="fc-drugs-btn" onclick="event.stopPropagation(); triggerFcAction('drugs')" class="action-btn" style="margin:0; font-size:0.85rem; color:#0051ff;">
                            üíä Drugs.com
                        </button>
                        
                    </div>

                    <button onclick="event.stopPropagation(); triggerFcAction('case')" class="action-btn btn-primary" id="btn-case" style="margin-top:15px;">
                        ‚ú® AI: Generate Case Study
                    </button>
                    
                    <div id="fc-ai-case" class="ai-output" onclick="event.stopPropagation();"></div>
                    <button id="btn-read-case" onclick="event.stopPropagation(); readAIContent('fc-ai-case')" class="action-btn" style="display:none; margin-top:5px;">üîä Read</button>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; padding:0 10px;">
            <button onclick="prevCard()" class="action-btn" style="width:auto;">‚Üê Prev</button>
            <span id="counter" style="font-weight:700; color:var(--ios-gray);">1 / 10</span>
            <button onclick="nextCard()" class="action-btn" style="width:auto;">Next ‚Üí</button>
        </div>
        <button id="show-answer-btn" onclick="showAnswer()" class="action-btn btn-primary" style="margin-top:12px;">Show Answer</button>
        <div id="anki-controls" class="anki-controls">
            <button class="anki-btn" style="background:#ef4444;" onclick="rateCurrentCard('again')">Again</button>
            <button class="anki-btn" style="background:#f59e0b;" onclick="rateCurrentCard('hard')">Hard</button>
            <button class="anki-btn" style="background:#3b82f6;" onclick="rateCurrentCard('good')">Good</button>
            <button class="anki-btn" style="background:#10b981;" onclick="rateCurrentCard('easy')">Easy</button>
        </div>
        <div id="anki-meta" class="anki-meta"></div>
    </div>

    <div id="quiz-section" class="app-smooth" style="display:none;">
        <div class="ios-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin-top:0; color:var(--ios-blue);">Adaptive Quiz</h3>
                <button onclick="showProgressModal()" style="font-size:0.8rem; background:none; border:none; color:var(--ios-gray);">üìä Stats</button>
            </div>
            <p id="quiz-question" style="font-size:1.1rem; font-weight:600; min-height:60px;">Question loading...</p>
            <div class="quiz-stats-row">
                <div class="quiz-stat-pill">Score<strong id="quiz-score">0%</strong></div>
                <div class="quiz-stat-pill">Streak<strong id="quiz-streak">0</strong></div>
                <div class="quiz-stat-pill">Answered<strong id="quiz-answered">0</strong></div>
            </div>
            <div id="quiz-options" style="display:flex; flex-direction:column; gap:10px;"></div>
            
            <div id="quiz-feedback" style="display:none; margin-top:15px; padding:12px; border-radius:12px; text-align:center;"></div>
            <div id="quiz-mini-explainer" class="quiz-mini-explainer"></div>

            <button onclick="triggerQuizExplain()" id="btn-quiz-explain" class="action-btn" style="display:none; margin-top:15px;">ü§ñ Explain</button>
            <div id="ai-container" style="display:none;">
                <div id="ai-content" class="ai-output"></div>
                <button id="btn-read-explain" onclick="readAIContent('ai-content')" class="action-btn" style="display:none;">üîä Read</button>
            </div>

            <button onclick="nextQuestion()" id="next-quiz-btn" class="action-btn btn-primary" style="display:none; margin-top:15px;">Next Question ‚Üí</button>
        </div>
    </div>

</div>

<div id="fc-drug-picker" class="modal-overlay" onclick="if(event.target===this) closeFcDrugPicker()">
    <div class="modal-card" style="height:auto; max-height:70vh; border-radius:24px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0;">Select Drug Component</h3>
            <button onclick="closeFcDrugPicker()" style="background:none; border:none; color:var(--ios-blue); font-weight:600;">Close</button>
        </div>
        <div id="fc-picker-list" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
</div>

<div id="settings-panel" class="modal-overlay" onclick="if(event.target===this) toggleSettings()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Settings</h3>
            <button onclick="toggleSettings()" style="background:none; border:none; color:var(--ios-blue); font-weight:600; font-size:1rem;">Done</button>
        </div>
        
        <div style="margin-bottom:20px; background:#F9FAFB; padding:15px; border-radius:12px;">
            <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">AI MODEL</label>
            <select id="provider-select" onchange="updateProviderDisplay()" class="ios-select" style="width:100%; margin-top:5px; background:white;">
                <option value="deepseek">DeepSeek V3 (Fast)</option>
                <option value="deepseek-r1">DeepSeek R1 (Reasoner)</option>
            </select>
        </div>

        <div id="deepseek-config" class="config-section">
            <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">DEEPSEEK API KEY</label>
            <input type="password" id="deepseek-key" class="settings-input" placeholder="sk-...">
            <div style="font-size:0.75rem; color:var(--ios-gray);">Works for both V3 and R1 models.</div>
        </div>
        
        <div style="margin-top:20px;">
             <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">DATA SOURCE</label>
             <button onclick="toggleDrugSet()" id="set-btn" class="action-btn">üìö Set: Common</button>
             <div class="import-wrapper" style="margin-top:10px;">
                <input type="text" id="sheet-url" class="settings-input" placeholder="Google Sheet CSV URL" style="margin-bottom:5px;" />
                <button onclick="fetchSheetData()" class="action-btn">Load Sheet Data</button>
                <div id="upload-status" style="font-size:0.8rem; margin-top:5px; text-align:center;"></div>
            </div>
        </div>

        <div style="margin-top:20px; background:#F9FAFB; padding:15px; border-radius:12px;">
            <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">STUDY MODE</label>
            <select id="flashcard-mode" class="ios-select" style="width:100%; margin-top:8px; background:white;">
                <option value="anki">Flashcard: Anki Spaced Repetition</option>
                <option value="classic">Flashcard: Classic Next/Prev</option>
            </select>
            <select id="daily-pick-mode" class="ios-select" style="width:100%; margin-top:8px; background:white;">
                <option value="anki">Daily Picks: Anki Due Cards</option>
                <option value="random">Daily Picks: Random Mix</option>
            </select>
        </div>

        <div style="margin-top:12px; font-size:0.82rem; color:#4b5563; background:#eef6ff; border:1px solid #dbeafe; border-radius:12px; padding:12px; line-height:1.45;">
            <div style="font-weight:700; color:#1d4ed8; margin-bottom:4px;">How to apply</div>
            <div>1) Choose <strong>Anki</strong> for Flashcard mode.</div>
            <div>2) Choose Daily Picks as <strong>Anki Due Cards</strong> (or Random).</div>
            <div>3) Tap <strong>Save Configuration</strong>.</div>
            <div>4) In Cards mode, use <strong>Again / Hard / Good / Easy</strong> to schedule the next review.</div>
        </div>

        <button onclick="saveSettings()" class="action-btn btn-green" style="margin-top:20px;">Save Configuration</button>
    </div>
</div>

<div id="progress-modal" class="modal-overlay" onclick="if(event.target===this) closeProgressModal()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <h3 style="margin:0;">üìä Knowledge Bank</h3>
            <button onclick="closeProgressModal()" style="background:none; border:none; color:var(--ios-blue);">Close</button>
        </div>
        <div id="progress-list-content" style="overflow-y:auto; flex-grow:1;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="drugs.js"></script>

<script>
    // --- STATE VARIABLES ---
    let extendedDrugs = []; 
    let activeSourceList = []; 
    let filteredList = [];     
    let flashcardList = []; 
    let quizList = [];      
    let searchHistory = []; 
    let quizStats = {}; 
    let fcCurrentIndex = 0;
    let quizCurrentIndex = 0;
    let currentQuizData = null;
    let currentQuizQuestion = null;
    let quizSession = { answered: 0, correct: 0, streak: 0, bestStreak: 0 };
    let searchDebounceTimer = null;
    const SEARCH_DEBOUNCE_MS = 120;
    let fcSelectedDrug = ""; 
    let flashcardMode = localStorage.getItem('flashcard_mode') || 'anki';
    let dailyPickMode = localStorage.getItem('daily_pick_mode') || 'anki';
    let ankiStats = JSON.parse(localStorage.getItem('drug_tutor_anki') || '{}');
    
    // API & Keys
    let currentProvider = localStorage.getItem('active_provider') || 'deepseek';
    let deepSeekKey = localStorage.getItem('ds_key') || "sk-92db3cf721454bd7b351ca6ef40eaaf7";
    let googleScriptURL = localStorage.getItem('google_script_url') || "https://script.google.com/macros/s/AKfycbxyNPyjbVXDMTQxFPxEuuCDTNNf-iVFfqedfNbh-kgn6Tk9rSIFEfIaLWXxXZoNOVnWug/exec";
    
    // Settings
    let defaultSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";

    // System Data
    const systemCategories = [
        "Gastro-intestinal system", "Cardiovascular system", "Respiratory system", "Central nervous system", "Infections", "Endocrine system",
        "Obstetrics, gynaecology, and urinary-tract disorders", "Malignant disease and immunosuppression", "Nutrition and blood",
        "Musculoskeletal and joint disease", "Eye", "Ear, nose, and oropharynx", "Skin", "Immunological products and vaccines", "Anaesthesia"
    ];
    const systemShortNames = {
        "Gastro-intestinal system": "GI System", "Cardiovascular system": "Cardio", "Respiratory system": "Respiratory",
        "Central nervous system": "CNS / Neuro", "Infections": "Infections", "Endocrine system": "Endocrine",
        "Obstetrics, gynaecology, and urinary-tract disorders": "ObGyn / GU", "Malignant disease and immunosuppression": "Oncology",
        "Nutrition and blood": "Nutrition / Blood", "Musculoskeletal and joint disease": "MSK / Bone",
        "Eye": "Eye", "Ear, nose, and oropharynx": "ENT", "Skin": "Skin", "Immunological products and vaccines": "Immune / Vax", "Anaesthesia": "Anaesthesia"
    };
    const systemIcons = {
        "Gastro-intestinal": "üçî", "Cardiovascular": "ü´Ä", "Respiratory": "ü´Å", "Central nervous": "üß†", 
        "Infections": "ü¶†", "Endocrine": "ü¶ã", "Obstetrics": "ü§∞", "Malignant": "üéóÔ∏è", "Nutrition": "üçé",
        "Musculoskeletal": "ü¶¥", "Eye": "üëÅÔ∏è", "Ear": "üëÇ", "Skin": "üß¥", "Immunological": "üõ°Ô∏è", "Anaesthesia": "üíâ"
    };

    function normalizeDrugData(drug) {
        drug.system = getSystemForDrug(drug);
        drug.side_effects = drug.side_effects || drug.SideEffects || drug.sideEffects || "Refer to nursing guide";
        drug.__searchBlob = `${drug.name || ''} ${(drug.class || '')} ${(drug.system || '')} ${(drug.indication || '')} ${(drug.side_effects || '')}`.toLowerCase();
        return drug;
    }

    function prepareDrugListForFastSearch(list) {
        return list.map(normalizeDrugData);
    }

    // --- INITIALIZATION ---
    window.onload = function() {
        if(typeof commonDrugs !== 'undefined') {
            activeSourceList = prepareDrugListForFastSearch([...commonDrugs]);
            flashcardList = [...activeSourceList];
        }
        
        // Restore Data
        const savedHist = localStorage.getItem('drug_tutor_search_history');
        if(savedHist) searchHistory = JSON.parse(savedHist);
        const savedStats = localStorage.getItem('drug_tutor_quiz_stats');
        if(savedStats) quizStats = JSON.parse(savedStats);

        // Init UI
        document.getElementById('provider-select').value = currentProvider;
        document.getElementById('deepseek-key').value = deepSeekKey;
        document.getElementById('sheet-url').value = defaultSheetUrl;
        document.getElementById('flashcard-mode').value = flashcardMode;
        document.getElementById('daily-pick-mode').value = dailyPickMode;

        initSystemDropdown();
        applyFilter(); 
        renderHistory();
        renderAllSystems(); 
        updateProviderDisplay();
        
        // Daily Recommendations
        generateDailyPicks();
        
        // AUTO-CONNECT ONLINE
        fetchSheetData(true);
        
        switchMode('search');
    };

    // --- DAILY RECOMMENDATIONS (8 ITEMS) ---
    function generateDailyPicks() {
        if(!activeSourceList || activeSourceList.length === 0) return;

        if (dailyPickMode === 'anki') {
            const picks = getDueCards(activeSourceList).slice(0, 8);
            renderDailyPicks(picks.length ? picks : activeSourceList.slice(0, 8));
            return;
        }
        
        const today = new Date().toDateString(); 
        const seed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        
        // Pseudo-random generator based on date seed
        const random = (seed) => {
            var x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        };

        let available = [...activeSourceList];
        let picks = [];
        
        // Select 8 random drugs
        for(let i = 0; i < 8; i++) {
            if(available.length === 0) break;
            const idx = Math.floor(random(seed + i) * available.length);
            picks.push(available[idx]);
            available.splice(idx, 1);
        }

        renderDailyPicks(picks);
    }

    function refreshDailyPicks() {
        if (dailyPickMode === 'anki') {
            const due = getDueCards(activeSourceList).slice(0, 8);
            renderDailyPicks(due.length ? due : activeSourceList.slice(0, 8));
        } else {
            let shuffled = [...activeSourceList].sort(() => 0.5 - Math.random());
            renderDailyPicks(shuffled.slice(0, 8));
        }
    }

    function renderDailyPicks(picks) {
        const container = document.getElementById('daily-container');
        container.innerHTML = '';
        const gradients = [
            'linear-gradient(140deg, #bfdbfe 0%, #93c5fd 50%, #dbeafe 100%)',
            'linear-gradient(140deg, #fde68a 0%, #fca5a5 55%, #fecaca 100%)',
            'linear-gradient(140deg, #bbf7d0 0%, #86efac 55%, #dcfce7 100%)',
            'linear-gradient(140deg, #ddd6fe 0%, #c4b5fd 50%, #ede9fe 100%)'
        ];
        
        picks.forEach((drug, idx) => {
            const div = document.createElement('div');
            div.className = 'daily-card';
            div.style.background = gradients[idx % gradients.length];
            const icon = getSystemIcon(drug.system || getSystemForDrug(drug));
            div.innerHTML = `
                <div>
                    <div class="daily-header">
                        <div class="daily-label">${dailyPickMode === 'anki' ? 'Due Today' : 'Daily Pick'}</div>
                        <div class="daily-icon-pill">${icon}</div>
                    </div>
                    <div class="daily-name">${drug.name.split('(')[0]}</div>
                </div>
                <div class="daily-sub">${drug.class}</div>
            `;
            div.onclick = () => {
                document.getElementById('search-input').value = drug.name;
                runSearch();
            };
            container.appendChild(div);
        });
    }

    // --- HELPER: DRUG NAME PARSING ---
    function parseDrugGenerics(fullString) {
        if(fullString.includes(';')) {
            return fullString.split(';').map(s => s.replace(/\(.*?\)/g, "").trim()).filter(s => s);
        } else {
            return [fullString.replace(/\(.*?\)/g, "").trim()];
        }
    }

    // --- NAVIGATION MODES ---
    function switchMode(mode) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('flashcard-section').style.display = 'none';
        document.getElementById('quiz-section').style.display = 'none';
        document.getElementById('search-section').style.display = 'none';
        document.getElementById('filter-bar').style.display = 'none';

        if(mode === 'search') {
            document.getElementById('search-section').style.display = 'block';
            document.getElementById('nav-search').classList.add('active');
            document.getElementById('search-input').focus();
        } else if (mode === 'flashcard') {
            document.getElementById('flashcard-section').style.display = 'block';
            document.getElementById('nav-flash').classList.add('active');
            document.getElementById('filter-bar').style.display = 'flex';
            const source = filteredList.length ? filteredList : activeSourceList;
            hydrateAnkiForList(source);
            flashcardList = getDueCards(source);
            fcCurrentIndex = 0;
            renderCard();
        } else if (mode === 'quiz') {
            document.getElementById('quiz-section').style.display = 'block';
            document.getElementById('nav-quiz').classList.add('active');
            generateQuizQuestion();
        }
    }

    // --- FLASHCARD LOGIC ---
    function formatRelativeDue(dueTs) {
        const delta = dueTs - Date.now();
        const hours = Math.round(delta / (1000 * 60 * 60));
        if (Math.abs(hours) < 24) return hours <= 0 ? 'due now' : `due in ${hours}h`;
        const days = Math.round(hours / 24);
        return days <= 0 ? 'due now' : `due in ${days}d`;
    }

    function updateAnkiMeta(drug) {
        const metaEl = document.getElementById('anki-meta');
        if (!drug) {
            metaEl.innerText = 'No cards due right now. Great work.';
            return;
        }
        const stat = ankiStats[drug.name] || { ease: 2.3, reps: 0, lapses: 0, due: Date.now() };
        metaEl.innerText = `Ease ${Number(stat.ease || 2.3).toFixed(2)} ‚Ä¢ Reps ${stat.reps || 0} ‚Ä¢ Lapses ${stat.lapses || 0} ‚Ä¢ ${formatRelativeDue(stat.due || Date.now())}`;
    }

    function renderCard() {
        if(flashcardList.length === 0) {
            document.getElementById('fc-name').innerText = 'No cards due üìö';
            document.getElementById('fc-class').innerText = 'Great job. You have no due cards right now.';
            document.getElementById('fc-system').innerText = 'Anki review queue is empty.';
            document.getElementById('fc-indication').innerText = 'Come back later or study from Search mode.';
            document.getElementById('fc-side-effects').innerText = '-';
            document.getElementById('fc-nursing').innerText = '-';
            document.getElementById('counter').innerText = '0 / 0';
            document.getElementById('fc-selector-container').style.display = 'none';
            document.getElementById('btn-case').disabled = true;
            document.getElementById('btn-case').innerHTML = '‚ú® AI: Generate Case Study';
            document.getElementById('fc-ai-case').style.display = 'none';
            document.getElementById('btn-read-case').style.display = 'none';
            document.getElementById('show-answer-btn').style.display = 'none';
            document.getElementById('anki-controls').style.display = 'none';
            updateAnkiMeta(null);
            return;
        }
        const drug = flashcardList[fcCurrentIndex];
        
        document.getElementById('fc-name').innerText = drug.name;
        document.getElementById('fc-class').innerText = drug.class;
        document.getElementById('fc-system').innerText = drug.system || getSystemForDrug(drug);
        document.getElementById('fc-indication').innerText = drug.indication;
        document.getElementById('fc-side-effects').innerText = drug.side_effects || drug.sideEffects || "Not listed";
        
        document.getElementById('fc-nursing').innerText = drug.nursing;
        document.getElementById('counter').innerText = `${fcCurrentIndex + 1} / ${flashcardList.length}`;
        document.getElementById('fc-ai-case').style.display = 'none';
        document.getElementById('btn-read-case').style.display = 'none';
        document.getElementById('flashcard').classList.remove('flipped');
        document.getElementById('show-answer-btn').style.display = 'flex';
        document.getElementById('anki-controls').style.display = 'none';

        document.getElementById('btn-case').innerHTML = '‚ú® AI: Generate Case Study';
        document.getElementById('btn-case').disabled = false;
        updateAnkiMeta(drug);

        const generics = parseDrugGenerics(drug.name);
        const selectorContainer = document.getElementById('fc-selector-container');
        const pickerList = document.getElementById('fc-picker-list');

        pickerList.innerHTML = '';
        if(generics.length > 1) {
            selectorContainer.style.display = 'block';
            generics.forEach(gen => {
                const btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.style.margin = '0';
                btn.style.justifyContent = 'flex-start';
                btn.innerText = gen;
                btn.onclick = () => chooseFcDrug(gen);
                pickerList.appendChild(btn);
            });
            fcSelectedDrug = generics[0];
            document.getElementById('fc-selected-drug-label').innerText = `Auto-selected: ${fcSelectedDrug}. Tap Google/Drugs/Case to choose another.`;
        } else {
            selectorContainer.style.display = 'none';
            fcSelectedDrug = generics[0];
        }

        closeFcDrugPicker();
        updateFlashcardLinks(fcSelectedDrug);
    }

    function openFcDrugPicker() {
        document.getElementById('fc-drug-picker').style.display = 'flex';
    }

    function closeFcDrugPicker() {
        document.getElementById('fc-drug-picker').style.display = 'none';
    }

    function chooseFcDrug(genericName) {
        updateFlashcardLinks(genericName);
        closeFcDrugPicker();
        if (window.__fcPendingAction) {
            const action = window.__fcPendingAction;
            window.__fcPendingAction = null;
            runFcAction(action);
        }
    }

    function updateFlashcardLinks(genericName) {
        fcSelectedDrug = genericName;
        const labelEl = document.getElementById('fc-selected-drug-label');
        if (labelEl) labelEl.innerText = `Selected: ${fcSelectedDrug}`;
        const googleQuery = encodeURIComponent(`${genericName} ‰∏≠Êñá È¶ôÊ∏Ø`);
        document.getElementById('fc-google-link').href = `https://www.google.com/search?q=${googleQuery}`;
    }

    function triggerFcAction(action) {
        const drug = flashcardList[fcCurrentIndex];
        const generics = parseDrugGenerics(drug.name);
        if (generics.length > 1) {
            openFcDrugPicker();
            window.__fcPendingAction = action;
            return;
        }
        runFcAction(action);
    }

    function runFcAction(action) {
        if (action === 'google') {
            const googleQuery = encodeURIComponent(`${fcSelectedDrug} ‰∏≠Êñá È¶ôÊ∏Ø`);
            window.open(`https://www.google.com/search?q=${googleQuery}`, '_blank');
        } else if (action === 'drugs') {
            openDrugsCom({name: fcSelectedDrug});
        } else if (action === 'case') {
            const d = {...flashcardList[fcCurrentIndex], name: fcSelectedDrug};
            getIntegratedCaseStudy(d, 'fc-ai-case', 'btn-case', 'btn-read-case');
        }
    }

    function showAnswer() {
        document.getElementById('flashcard').classList.add('flipped');
        document.getElementById('show-answer-btn').style.display = 'none';
        document.getElementById('anki-controls').style.display = 'grid';
    }

    function flipCard(e) {
        if(e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.tagName === 'SELECT') return;
        const card = document.getElementById('flashcard');
        card.classList.toggle('flipped');
        const showingBack = card.classList.contains('flipped');
        document.getElementById('show-answer-btn').style.display = showingBack ? 'none' : 'flex';
        document.getElementById('anki-controls').style.display = showingBack ? 'grid' : 'none';
    }

    function nextCard() {
        if(fcCurrentIndex < flashcardList.length - 1) { fcCurrentIndex++; renderCard(); }
        else {
            flashcardList = getDueCards(filteredList.length ? filteredList : activeSourceList);
            fcCurrentIndex = 0;
            renderCard();
        }
    }

    function prevCard() {
        if(fcCurrentIndex > 0) { fcCurrentIndex--; renderCard(); }
    }

    function hydrateAnkiForList(list) {
        list.forEach(drug => {
            if (!ankiStats[drug.name]) {
                ankiStats[drug.name] = { ease: 2.3, interval: 0, reps: 0, lapses: 0, due: Date.now() };
            }
        });
    }

    function getDueCards(list) {
        hydrateAnkiForList(list);
        const now = Date.now();
        const due = list.filter(d => (ankiStats[d.name]?.due || 0) <= now);
        due.sort((a, b) => (ankiStats[a.name].due || 0) - (ankiStats[b.name].due || 0));
        return due;
    }

    function rateCurrentCard(rating) {
        if (flashcardList.length === 0) return;
        const drug = flashcardList[fcCurrentIndex];
        hydrateAnkiForList([drug]);
        const stat = ankiStats[drug.name];

        const qualityMap = { again: 1, hard: 3, good: 4, easy: 5 };
        const q = qualityMap[rating] || 4;

        if (q < 3) {
            stat.reps = 0;
            stat.lapses = (stat.lapses || 0) + 1;
            stat.interval = 1;
        } else {
            stat.reps = (stat.reps || 0) + 1;
            if (stat.reps === 1) stat.interval = 1;
            else if (stat.reps === 2) stat.interval = 3;
            else {
                const mult = rating === 'hard' ? 1.2 : (rating === 'easy' ? (stat.ease + 0.15) : stat.ease);
                stat.interval = Math.max(1, Math.round(stat.interval * mult));
            }
        }

        stat.ease = Math.max(1.3, (stat.ease || 2.3) + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02)));
        const minute = 60 * 1000;
        const day = 24 * 60 * 60 * 1000;
        if (rating === 'again') stat.due = Date.now() + 10 * minute;
        else if (rating === 'hard') stat.due = Date.now() + Math.max(1, Math.round(stat.interval * 0.6)) * day;
        else if (rating === 'easy') stat.due = Date.now() + Math.max(2, Math.round(stat.interval * 1.3)) * day;
        else stat.due = Date.now() + (stat.interval * day);

        localStorage.setItem('drug_tutor_anki', JSON.stringify(ankiStats));
        nextCard();
    }

    // --- SEARCH LOGIC ---
    function handleSearch() {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => runSearch(), SEARCH_DEBOUNCE_MS);
    }

    function runSearch() {
        const query = document.getElementById('search-input').value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        if(query.length < 2) return;

        const results = activeSourceList.filter(d => (d.__searchBlob || '').includes(query)).slice(0, 20);
        
        if(results.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; color:var(--text-secondary); margin-top:40px;">
                    <p>No local drugs found for "${query}".</p>
                    <button onclick="triggerAISearch('${query.replace(/'/g, "\\'")}')" class="action-btn btn-primary" style="margin-top:15px;">
                        ‚ú® Ask AI to Find & Add "${query}"
                    </button>
                    <div id="ai-search-output"></div>
                </div>
            `;
            return;
        }

        const fragment = document.createDocumentFragment();

        results.forEach((drug, index) => {
            const card = document.createElement('div');
            card.className = 'result-card';
            
            const explainId = 'explain-' + index + '-' + Math.floor(Math.random() * 1000);
            const generics = parseDrugGenerics(drug.name);
            const isMulti = generics.length > 1;
            const sideEffectsText = drug.side_effects || drug.sideEffects || "Not listed";
            
            let selectorHTML = '';
            if(isMulti) {
                let options = generics.map(g => `<option value="${g}">${g}</option>`).join('');
                selectorHTML = `
                    <div class="drug-selector-wrapper" style="margin-bottom:5px; padding:5px;">
                        <span class="drug-select-label" style="font-size:0.7rem;">Select Component:</span>
                        <select class="drug-select" style="font-size:0.85rem; padding:5px;" onclick="event.stopPropagation()" onchange="updateSearchCard(this, '${explainId}')">
                            ${options}
                        </select>
                    </div>
                `;
            }

            let initialGeneric = generics[0];
            let googleLink = `https://www.google.com/search?q=${encodeURIComponent(initialGeneric + " ‰∏≠Êñá È¶ôÊ∏Ø")}`;

            card.innerHTML = `
                <div class="result-header">
                    <div class="name-with-speak">
                        <span class="result-name">${drug.name}</span>
                        <button class="speak-icon-btn" onclick="event.stopPropagation(); triggerSearchSpeak(this)" title="Speak">üîä</button>
                    </div>
                    <span class="result-class">${drug.class}</span>
                </div>
                ${selectorHTML}
                <div style="font-size:0.9rem; margin-top:5px; color:#555;">${drug.indication}</div>
                
                <div class="extra-details">
                    <div style="margin-bottom:5px;"><strong>Side Effects:</strong> <span style="color:#d32f2f;">${sideEffectsText}</span></div>
                    <div style="margin-bottom:5px;"><strong>Nursing:</strong> ${drug.nursing}</div>
                    <div style="margin-bottom:5px;"><strong>System:</strong> ${drug.system}</div>
                    
                    <div style="display:flex; gap:10px; margin-top:15px; overflow-x:auto;">
                         <a href="${googleLink}" target="_blank" class="chip dynamic-google" onclick="event.stopPropagation()">üåê Google</a>
                         <span class="chip" onclick="event.stopPropagation(); triggerSearchDrugsCom(this)">üíä Drugs.com</span>
                                                  <span class="chip" style="background:var(--ios-indigo); color:white;" onclick="event.stopPropagation(); triggerSearchExplain(this, '${explainId}')">ü§ñ Explain</span>
                    </div>
                    <div id="${explainId}" class="ai-output"></div>
                </div>
            `;
            
            card.dataset.currentGeneric = initialGeneric;
            
            card.onclick = (e) => {
                if(['SELECT', 'A', 'BUTTON', 'SPAN', 'INPUT'].includes(e.target.tagName)) return;
                card.classList.toggle('expanded');
            };
            
            fragment.appendChild(card);
        });
        
        container.appendChild(fragment);
    }

    window.updateSearchCard = function(selectElem, explainId) {
        const card = selectElem.closest('.result-card');
        const newVal = selectElem.value;
        card.dataset.currentGeneric = newVal;
        const googleBtn = card.querySelector('.dynamic-google');
        googleBtn.href = `https://www.google.com/search?q=${encodeURIComponent(newVal + " ‰∏≠Êñá È¶ôÊ∏Ø")}`;
    };

    window.triggerSearchDrugsCom = function(btn) {
        const card = btn.closest('.result-card');
        openDrugsCom({name: card.dataset.currentGeneric});
    };
    
    window.triggerSearchSpeak = function(btn) {
        const card = btn.closest('.result-card');
        const name = card?.dataset?.currentGeneric || '';
        if(name) speakText(name);
    };
    
    window.triggerSearchExplain = function(btn, outputId) {
        const card = btn.closest('.result-card');
        const box = document.getElementById(outputId);
        btn.innerText = "‚è≥";
        box.style.display = 'block';
        const prompt = `Explain the drug ${card.dataset.currentGeneric} for a nursing student simply in English. Focus on mechanism of action and key monitoring. Markdown format.`;
        streamAIResponse([{role: "user", content: prompt}], (text) => box.innerHTML = marked.parse(text));
        btn.innerText = "‚úÖ";
    }

    function quickSearch(term) {
        document.getElementById('search-input').value = term;
        runSearch();
    }

    // --- AI & DATA FUNCTIONS ---
    async function triggerAISearch(query) {
        const container = document.getElementById('ai-search-output');
        container.style.display = 'block';
        container.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <div class="loading-spinner"></div>
                <div style="margin-top:10px; font-weight:600;">Searching Database...</div>
            </div>`;

        const prompt = `You are a nursing tutor. The user is searching for "${query}". 
        Provide a clinical summary in strict JSON format.
        Keys: "name", "class", "system", "indication", "nursing", "side_effects".
        Rules:
        1. "system" MUST be one of: [Gastro-intestinal system, Cardiovascular system, Respiratory system, Central nervous system, Infections, Endocrine system, Obstetrics, gynaecology, and urinary-tract disorders, Malignant disease and immunosuppression, Nutrition and blood, Musculoskeletal and joint disease, Eye, Ear, nose, and oropharynx, Skin, Immunological products and vaccines, Anaesthesia].
        2. "nursing" and "side_effects" should be short summary strings.
        3. No markdown formatting. Just raw JSON.`;

        try {
            let fullText = "";
            await streamAIResponse([{role: "user", content: prompt}], (text) => { fullText = text; });
            fullText = fullText.replace(/```json/g, '').replace(/```/g, '').trim();
            const drugData = JSON.parse(fullText);

            container.innerHTML = `
                <div class="ios-card" style="border:2px solid var(--ios-green); margin-top:20px; text-align:left;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; color:var(--ios-blue);">${drugData.name}</h3>
                        <span class="chip" style="background:var(--ios-green); color:white;">AI Found</span>
                    </div>
                    <div class="detail-row"><div class="detail-label">Class</div><div class="detail-content">${drugData.class}</div></div>
                    <div class="detail-row"><div class="detail-label">System</div><div class="detail-content">${drugData.system}</div></div>
                    <div class="detail-row"><div class="detail-label">Indication</div><div class="detail-content">${drugData.indication}</div></div>
                    <div class="detail-row"><div class="detail-label">Side Effects</div><div class="detail-content" style="color:#d32f2f;">${drugData.side_effects}</div></div>
                    <div class="detail-row"><div class="detail-label">Nursing</div><div class="detail-content" style="font-size:0.9rem;">${drugData.nursing}</div></div>
                    <button id="btn-save-sheet" onclick='saveToGoogleSheet(${JSON.stringify(drugData)})' class="action-btn btn-green">üíæ Save to Database</button>
                    <div id="save-status" style="text-align:center; margin-top:10px; font-size:0.85rem; font-weight:600;"></div>
                </div>`;
        } catch (e) {
            container.innerHTML = `<div style="color:red; margin-top:10px;">Search Failed. Try again.</div>`;
        }
    }

    function saveToGoogleSheet(drugData) {
        const statusEl = document.getElementById('save-status');
        const saveBtn = document.getElementById('btn-save-sheet');
        
        if(!googleScriptURL) { alert("Please set your Google Script URL in Settings (‚öôÔ∏è)."); return; }

        saveBtn.disabled = true; saveBtn.innerText = "‚è≥ Saving..."; statusEl.innerText = "Syncing with cloud...";

        fetch(googleScriptURL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(drugData) })
        .then(() => { 
            statusEl.innerText = "‚úÖ Saved successfully!"; statusEl.style.color = "var(--ios-green)"; 
            saveBtn.innerText = "üíæ Saved"; 
            activeSourceList.push(normalizeDrugData(drugData)); 
        })
        .catch(err => { 
            statusEl.innerText = "‚ùå Error saving."; statusEl.style.color = "var(--ios-red)"; saveBtn.disabled = false; 
        });
    }

    function openDrugsCom(drug) {
        let cleanName = drug.name.split('(')[0].trim();
        const query = encodeURIComponent(cleanName);
        window.open(`https://www.drugs.com/search.php?searchterm=${query}`, '_blank');
    }

    // --- HELPER FUNCTIONS ---
    function getSystemForDrug(drug) {
        if (drug.system && systemCategories.includes(drug.system)) return drug.system;
        const txt = (drug.class + " " + drug.indication + " " + drug.name).toLowerCase();
        if (txt.includes("antacid") || txt.includes("ulcer")) return "Gastro-intestinal system";
        if (txt.includes("cardio") || txt.includes("beta-blocker")) return "Cardiovascular system";
        if (txt.includes("asthma") || txt.includes("broncho")) return "Respiratory system";
        if (txt.includes("analgesic") || txt.includes("depress")) return "Central nervous system";
        if (txt.includes("antibiotic") || txt.includes("viral")) return "Infections";
        return "Other"; 
    }
    
    function getSystemIcon(sys) {
        for(let k in systemIcons) { if(sys.includes(k) || k.includes(sys.split(' ')[0])) return systemIcons[k]; }
        return "üíä";
    }

    function initSystemDropdown() {
        const select = document.getElementById('system-filter');
        while (select.options.length > 1) { select.remove(1); }
        systemCategories.forEach(sys => {
            const opt = document.createElement('option');
            opt.value = sys; opt.innerText = sys; select.appendChild(opt);
        });
    }
    
    function applyFilter() {
        const sysCategory = document.getElementById('system-filter').value;
        const masteryCategory = document.getElementById('mastery-filter').value;
        
        filteredList = activeSourceList.filter(drug => {
            const sys = drug.system || getSystemForDrug(drug);
            const sysMatch = (sysCategory === "All" || sys === sysCategory);
            let masteryMatch = true;
            if (masteryCategory !== "All") {
                const s = quizStats[drug.name];
                const pct = s && s.attempts > 0 ? (s.correct/s.attempts)*100 : 0;
                if(masteryCategory === 'Mastered') masteryMatch = (pct >= 80 && s && s.attempts >= 2);
                else if(masteryCategory === 'Learning') masteryMatch = (pct >= 50 && pct < 80);
                else masteryMatch = (pct < 50 || !s);
            }
            return sysMatch && masteryMatch;
        });
        
        if (filteredList.length === 0) {
            alert("No drugs found matching these filters.");
            document.getElementById('mastery-filter').value = "All";
            filteredList = [...activeSourceList];
        }
        reshuffle();
    }
    
    function reshuffle() {
        flashcardList = [...filteredList];
        flashcardList.sort(() => Math.random() - 0.5);
        quizList = [...filteredList];
        fcCurrentIndex = 0;
        hydrateAnkiForList(filteredList);
        flashcardList = getDueCards(filteredList);
        renderCard();
    }
    
    function renderAllSystems() {
        const container = document.getElementById('recommend-container');
        container.innerHTML = '';
        systemCategories.forEach(sys => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.style.background = '#E0E7FF'; chip.style.color = '#4338ca';
            const shortName = systemShortNames[sys] || sys;
            chip.innerText = `${getSystemIcon(sys)} ${shortName}`;
            chip.onclick = () => { document.getElementById('search-input').value = sys; runSearch(); };
            container.appendChild(chip);
        });
    }
    
    function renderHistory() {
        const container = document.getElementById('history-container');
        const section = document.getElementById('history-section');
        container.innerHTML = '';
        if(searchHistory.length === 0) { section.style.display = 'none'; return; }
        section.style.display = 'block';
        searchHistory.forEach(term => {
            const chip = document.createElement('div');
            chip.className = 'chip'; chip.innerText = term;
            chip.onclick = () => { document.getElementById('search-input').value = term; runSearch(); };
            container.appendChild(chip);
        });
    }

    // --- QUIZ LOGIC ---
    function updateQuizSessionUI() {
        const answered = quizSession.answered || 0;
        const pct = answered ? Math.round((quizSession.correct / answered) * 100) : 0;
        document.getElementById('quiz-score').innerText = `${pct}%`;
        document.getElementById('quiz-streak').innerText = `${quizSession.streak}`;
        document.getElementById('quiz-answered').innerText = `${answered}`;
    }

    function getWeakDrugPool(list) {
        if (!list.length) return [];
        const scored = list.map(drug => {
            const s = quizStats[drug.name];
            if (!s || !s.attempts) return { drug, weakness: 1.2 };
            const accuracy = s.correct / s.attempts;
            return { drug, weakness: Math.max(0.05, 1 - accuracy) + Math.min(0.5, s.attempts * 0.03) };
        });
        scored.sort((a, b) => b.weakness - a.weakness);
        return scored.slice(0, Math.min(12, scored.length)).map(x => x.drug);
    }

    function buildQuizQuestion(correctDrug) {
        const templates = [
            {
                type: 'indication_to_drug',
                prompt: `A patient presentation best fits this indication: "${correctDrug.indication}". Which drug is most appropriate?`,
                answerLabel: d => d.name,
            },
            {
                type: 'class_to_drug',
                prompt: `Which drug belongs to this class: "${correctDrug.class}"?`,
                answerLabel: d => d.name,
            },
            {
                type: 'drug_to_class',
                prompt: `${correctDrug.name} belongs to which drug class?`,
                answerLabel: d => d.class,
            },
            {
                type: 'drug_to_indication',
                prompt: `What is the key indication for ${correctDrug.name}?`,
                answerLabel: d => d.indication,
            }
        ];

        const selectedTemplate = templates[Math.floor(Math.random() * templates.length)];
        return {
            type: selectedTemplate.type,
            prompt: selectedTemplate.prompt,
            answerLabel: selectedTemplate.answerLabel,
            correctDrug
        };
    }

    function generateQuizQuestion() {
        const container = document.getElementById('quiz-options');
        const qEl = document.getElementById('quiz-question');
        container.innerHTML = '';
        document.getElementById('quiz-feedback').style.display = 'none';
        document.getElementById('next-quiz-btn').style.display = 'none';
        document.getElementById('btn-quiz-explain').style.display = 'none';
        document.getElementById('quiz-mini-explainer').style.display = 'none';
        document.getElementById('ai-container').style.display = 'none';
        updateQuizSessionUI();

        if (quizList.length === 0) { qEl.innerText = "No drugs available."; return; }

        const weakPool = getWeakDrugPool(quizList);
        const pickFromWeak = weakPool.length > 0 && Math.random() < 0.7;
        const sourcePool = pickFromWeak ? weakPool : quizList;
        const correctDrug = sourcePool[Math.floor(Math.random() * sourcePool.length)];
        const q = buildQuizQuestion(correctDrug);
        currentQuizQuestion = q;

        qEl.innerText = q.prompt;

        const optionDrugs = [correctDrug];
        while (optionDrugs.length < Math.min(4, quizList.length)) {
            const r = quizList[Math.floor(Math.random() * quizList.length)];
            if (!optionDrugs.includes(r)) optionDrugs.push(r);
        }

        const optionTexts = [];
        optionDrugs.forEach(d => {
            const txt = q.answerLabel(d);
            if (!optionTexts.includes(txt)) optionTexts.push(txt);
        });

        while (optionTexts.length < Math.min(4, quizList.length)) {
            const r = quizList[Math.floor(Math.random() * quizList.length)];
            const txt = q.answerLabel(r);
            if (!optionTexts.includes(txt)) optionTexts.push(txt);
        }

        optionTexts.sort(() => Math.random() - 0.5);

        optionTexts.forEach(optText => {
            const btn = document.createElement('button');
            btn.className = 'action-btn';
            btn.style.textAlign = 'left';
            btn.style.justifyContent = 'flex-start';
            btn.style.background = '#F2F2F7';
            btn.innerText = optText;
            btn.onclick = () => checkAnswer(btn, optText, q);
            container.appendChild(btn);
        });
    }

    function checkAnswer(btn, selectedText, q) {
         const btns = document.querySelectorAll('#quiz-options button');
         btns.forEach(b => b.onclick = null);
         const feedback = document.getElementById('quiz-feedback');
         feedback.style.display = 'block';

         const correct = q.answerLabel(q.correctDrug);
         const isCorrect = selectedText === correct;

         if(!quizStats[q.correctDrug.name]) quizStats[q.correctDrug.name] = { correct: 0, attempts: 0 };
         quizStats[q.correctDrug.name].attempts++;
         quizSession.answered++;

         if(isCorrect) {
             btn.style.background = '#dcfce7'; btn.style.color = '#166534';
             feedback.innerHTML = "‚úÖ <strong>Correct!</strong>";
             feedback.style.background = "#dcfce7"; feedback.style.color = "#166534";
             quizStats[q.correctDrug.name].correct++;
             quizSession.correct++;
             quizSession.streak++;
             quizSession.bestStreak = Math.max(quizSession.bestStreak, quizSession.streak);
         } else {
             btn.style.background = '#fee2e2'; btn.style.color = '#991b1b';
             feedback.innerHTML = `‚ùå <strong>Incorrect.</strong> Correct answer: ${correct}.`;
             feedback.style.background = "#fee2e2"; feedback.style.color = "#991b1b";
             quizSession.streak = 0;
             btns.forEach(b => { if(b.innerText === correct) { b.style.background = '#dcfce7'; b.style.color = '#166534'; } });
         }

         const mini = document.getElementById('quiz-mini-explainer');
         mini.style.display = 'block';
         mini.innerHTML = `<strong>Clinical link:</strong> ${q.correctDrug.name} ‚Ä¢ Class: <strong>${q.correctDrug.class}</strong> ‚Ä¢ Indication: <strong>${q.correctDrug.indication}</strong>.`;

         updateQuizSessionUI();
         localStorage.setItem('drug_tutor_quiz_stats', JSON.stringify(quizStats));
         document.getElementById('next-quiz-btn').style.display = 'block';
         document.getElementById('btn-quiz-explain').style.display = 'block';
         currentQuizData = { q: q.prompt, u: selectedText, c: q.correctDrug, correctAnswerText: correct };
    }

    function nextQuestion() { generateQuizQuestion(); }
    
    function showProgressModal() {
        const modal = document.getElementById('progress-modal');
        const list = document.getElementById('progress-list-content');
        list.innerHTML = '';
        const sorted = Object.keys(quizStats).sort((a,b) => (quizStats[a].correct / quizStats[a].attempts) - (quizStats[b].correct / quizStats[b].attempts));
        sorted.forEach(key => {
            const s = quizStats[key];
            const pct = Math.round((s.correct/s.attempts)*100);
            const row = document.createElement('div');
            row.style.padding = '10px'; row.style.borderBottom = '1px solid #f0f0f0'; row.style.display = 'flex'; row.style.justifyContent = 'space-between';
            row.innerHTML = `<span>${key}</span><span style="font-weight:bold; color:${pct>70?'green':'red'}">${pct}%</span>`;
            list.appendChild(row);
        });
        modal.style.display = 'flex';
    }
    function closeProgressModal() { document.getElementById('progress-modal').style.display = 'none'; }

    // --- AI FUNCTIONS ---
    async function streamAIResponse(messages, onUpdate) {
        // Only DeepSeek supported now
        const apiUrl = "https://api.deepseek.com/chat/completions";
        
        // Determine model based on provider selection
        // If currentProvider is 'deepseek-r1', use 'deepseek-reasoner'
        // Otherwise (default or 'deepseek'), use 'deepseek-chat'
        const modelName = currentProvider === 'deepseek-r1' ? 'deepseek-reasoner' : 'deepseek-chat';

        const headers = { 
            "Authorization": `Bearer ${deepSeekKey}`, 
            "Content-Type": "application/json" 
        };
        
        const body = { 
            model: modelName, 
            messages: messages, 
            temperature: 0.7, 
            stream: true 
        };

        try {
            const response = await fetch(apiUrl, { method: "POST", headers: headers, body: JSON.stringify(body) });
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            const content = json.choices[0]?.delta?.content || "";
                            if (content) { fullText += content; onUpdate(fullText); }
                        } catch (e) {}
                    }
                }
            }
        } catch (e) { onUpdate("Error: " + e.message); }
    }

    async function getIntegratedCaseStudy(drug, outputId, btnId, readBtnId) {
        const btn = document.getElementById(btnId); const box = document.getElementById(outputId);
        btn.innerHTML = '‚è≥ Generating...'; btn.disabled = true; box.style.display = 'block'; box.innerHTML = 'Thinking...';
        
        // Strict English Prompt
        const prompt = `Create a short clinical case study for a nursing student about the drug ${drug.name}. Include a patient scenario, vital signs, and how this drug interacts with them. End with a critical thinking question. English only.`;
        
        await streamAIResponse([{role: "user", content: prompt}], (text) => box.innerHTML = marked.parse(text));
        btn.innerHTML = '‚ú® Regenerate Case'; btn.disabled = false; document.getElementById(readBtnId).style.display = 'block';
    }

    async function triggerQuizExplain() {
        const btn = document.getElementById('btn-quiz-explain'); const box = document.getElementById('ai-content');
        document.getElementById('ai-container').style.display = 'block'; btn.innerHTML = '‚è≥ Thinking...'; btn.disabled = true;
        
        // Strict English Prompt
        const prompt = `The user answered "${currentQuizData.u}" for the question "${currentQuizData.q}". The correct answer is "${currentQuizData.correctAnswerText}". Explain why the correct answer is right and why the chosen answer was wrong in simple English for a nursing student.`;
        
        await streamAIResponse([{role: "user", content: prompt}], (text) => box.innerHTML = marked.parse(text));
        btn.innerHTML = 'ü§ñ Explained'; document.getElementById('btn-read-explain').style.display = 'block';
    }

    // --- UTILS ---
    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }
    
    function saveSettings() {
        localStorage.setItem('active_provider', document.getElementById('provider-select').value);
        localStorage.setItem('ds_key', document.getElementById('deepseek-key').value);
        localStorage.setItem('google_script_url', document.getElementById('sheet-url').value);
        localStorage.setItem('flashcard_mode', document.getElementById('flashcard-mode').value);
        localStorage.setItem('daily_pick_mode', document.getElementById('daily-pick-mode').value);
        // reload globals
        currentProvider = document.getElementById('provider-select').value;
        deepSeekKey = document.getElementById('deepseek-key').value;
        flashcardMode = document.getElementById('flashcard-mode').value;
        dailyPickMode = document.getElementById('daily-pick-mode').value;
        generateDailyPicks();
        toggleSettings();
        alert("Settings Saved!");
    }
    
    function updateProviderDisplay() {
        const val = document.getElementById('provider-select').value;
        document.getElementById('deepseek-config').style.display = 'block';
        document.getElementById('provider-display').innerText = val === 'deepseek-r1' ? "DeepSeek R1" : "DeepSeek V3";
    }

    function fetchSheetData(autoSwitch = false) {
        const url = document.getElementById('sheet-url').value;
        let fetchUrl = url;
        if (url.includes("docs.google.com/spreadsheets") && url.includes("/edit")) fetchUrl = url.replace(/\/edit.*$/, "/export?format=csv");
        
        const status = document.getElementById('upload-status');
        status.innerText = "‚è≥ Loading...";
        
        fetch(fetchUrl).then(r => r.text()).then(csv => {
            Papa.parse(csv, { header: true, skipEmptyLines: true, complete: function(results) {
                 if (results.data.length > 0) {
                     extendedDrugs = prepareDrugListForFastSearch(results.data);

                     status.innerText = `‚úÖ Loaded ${extendedDrugs.length} drugs`;
                     document.getElementById('set-btn').innerText = "üìö Set: Online CSV";
                     
                     if(autoSwitch) {
                         activeSourceList = prepareDrugListForFastSearch([...extendedDrugs]);
                         applyFilter();
                         generateDailyPicks();
                     }
                 }
            }});
        }).catch(e => {
            status.innerText = "‚ùå Load Failed. Using Local.";
            if(autoSwitch) {
                activeSourceList = prepareDrugListForFastSearch([...commonDrugs]);
                applyFilter();
                generateDailyPicks();
            }
        });
    }

    function toggleDrugSet() {
        const usingOnline = document.getElementById('set-btn').innerText.includes('Online CSV');
        if(usingOnline) {
            activeSourceList = prepareDrugListForFastSearch([...commonDrugs]);
            document.getElementById('set-btn').innerText = "üìö Set: Common";
        } else if(extendedDrugs.length > 0) {
            activeSourceList = prepareDrugListForFastSearch([...extendedDrugs]);
            document.getElementById('set-btn').innerText = "üìö Set: Online CSV";
        }
        applyFilter();
        generateDailyPicks();
    }
    
    function speakText(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
    }
    
    function readAIContent(id) {
        speakText(document.getElementById(id).innerText);
    }

</script>
</body>
</html>
