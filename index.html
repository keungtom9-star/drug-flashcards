<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Drug Tutor</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíä</text></svg>">
    <link rel="apple-touch-icon" href="app-icon.png">
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4F46E5;       
            --secondary: #10B981;     
            --surface: #ffffff;
            --background: #F3F4F6;
            --text-main: #111827;
            --text-muted: #6B7280;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100dvh; margin: 0;
            padding: var(--safe-top) 10px var(--safe-bottom) 10px;
            box-sizing: border-box; overflow-x: hidden;
        }

        h1 {
            color: var(--text-main); margin: 5px 0 2px 0;
            text-align: center; font-weight: 800; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .top-bar {
            display: flex; gap: 6px; justify-content: center; align-items: center;    
            margin-bottom: 10px; width: 100%; max-width: 800px;
            background: var(--surface); padding: 8px; 
            border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #e5e7eb;
        }

        button {
            height: 36px; padding: 0 12px; border-radius: 8px; border: none;
            cursor: pointer; font-weight: 600; font-size: 0.85rem; 
            transition: all 0.2s; white-space: nowrap;
        }
        button:active { transform: scale(0.96); }
        .mode-active { background-color: var(--primary); color: white; }
        .secondary { background-color: white; color: var(--text-main); border: 1px solid #d1d5db; }

        /* SEARCH SECTION */
        #search-section { background: var(--surface); padding: 15px; border-radius: var(--radius); height: 100%; display: flex; flex-direction: column; width: 100%; max-width: 800px; box-sizing: border-box; }
        .search-bar { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #e5e7eb; font-size: 16px; margin-bottom: 5px; box-sizing: border-box; }
        
        .chip-scroll-row {
            display: flex; gap: 6px; overflow-x: auto; padding: 5px 2px;
            margin-bottom: 10px; -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .chip-scroll-row::-webkit-scrollbar { display: none; }

        .filter-chip {
            padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            white-space: nowrap; border: 1px solid transparent; flex-shrink: 0;
            cursor: pointer; transition: background 0.2s;
        }
        .chip-sys { background: #e0e7ff; color: var(--primary); border-color: #c7d2fe; }
        .chip-sys.active { background: var(--primary); color: white; }
        .chip-hist { background: #f3f4f6; color: #4b5563; border-color: #e5e7eb; }

        .section-label { font-size: 0.7rem; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin-top: 5px; margin-bottom: 2px; }

        /* Results */
        .results-grid { overflow-y: auto; flex-grow: 1; padding-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .result-card { background: white; padding: 12px; border-radius: 10px; border: 1px solid #e5e7eb; position: relative; }
        .result-header { font-weight: 700; color: var(--primary); display: flex; justify-content: space-between; font-size: 1rem; }
        .result-detail { display: none; margin-top: 10px; border-top: 1px solid #f3f4f6; padding-top: 10px; font-size: 0.9rem; }
        .result-card.expanded .result-detail { display: block; animation: fadeIn 0.2s; }
        
        .detail-row { margin-bottom: 12px; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; }
        .detail-row:last-child { border-bottom: none; }
        .d-label { display: block; font-size: 0.7rem; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 2px; }
        .d-content { font-size: 0.95rem; color: #111827; line-height: 1.4; }

        .saved-badge { position: absolute; top: -8px; right: -5px; background: #10B981; color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none; }

        /* Tool Buttons */
        .tool-row { display: flex; gap: 8px; overflow-x: auto; padding: 4px 2px; width: 100%; margin-top: 10px; }
        .btn-tool { font-size: 0.75rem; padding: 6px 12px; height: 32px; flex-shrink: 0; border-radius: 20px; border: 1px solid transparent; }
        .tool-isbar { background: #fee2e2; color: #991b1b; }
        .tool-cheat { background: #e0f2fe; color: #075985; }
        .tool-mix { background: #f3e8ff; color: #6b21a8; }
        
        .tool-google { 
            background: white; color: #374151; border: 1px solid #d1d5db; 
            text-decoration: none; display: inline-flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 1.2rem; font-weight: 800; font-family: 'Inter', sans-serif;
            flex-shrink: 0;
        }
        
        .btn-audio {
            background: #eef2ff; color: var(--primary); border: 1px solid #c7d2fe;
            font-size: 0.8rem; width: 100%; margin-top: 5px; display: flex; justify-content: center;
        }

        .ai-output-box { margin-top: 10px; padding: 12px; border-radius: 8px; font-size: 0.9rem; background: #f0fdfa; border-left: 4px solid var(--secondary); display: none; overflow-wrap: break-word; line-height: 1.5; }
        
        /* Flashcard - Larger UI */
        .flashcard-container { 
            width: 100%; 
            height: calc(100dvh - 140px); 
            min-height: 500px; 
            position: relative; transform-style: preserve-3d; transition: transform 0.6s; 
        }
        .flashcard-container.flipped { transform: rotateY(180deg); }
        
        .card-face { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            border-radius: 20px; background: white; padding: 25px; 
            box-sizing: border-box; box-shadow: var(--shadow); border: 1px solid #eee; 
            display: flex; flex-direction: column; overflow-y: auto; 
        }
        .card-back { transform: rotateY(180deg); }
        
        #settings-panel { display: none; background: var(--surface); padding: 15px; border-radius: var(--radius); width: 100%; max-width: 600px; border: 1px solid #e5e7eb; margin-bottom: 15px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .spinner { width: 12px; height: 12px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; display: inline-block; animation: spin 0.8s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .btn-ai-add {
            width: 100%; margin-top: 20px; background: linear-gradient(135deg, #6366f1, #a855f7); 
            color: white; padding: 12px; border-radius: 12px; font-size: 0.95rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        
        .btn-confirm-save {
            width: 100%; margin-top: 10px; background: #10B981; color: white; padding: 10px; 
            border-radius: 8px; font-weight: bold; cursor: pointer; border: none;
        }
        
        .settings-input {
            width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; 
            margin-bottom: 10px; box-sizing: border-box; font-family: monospace;
        }
    </style>
</head>
<body>

<h1>
    <svg style="height:28px; width:28px; border-radius:6px;" viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="16" fill="#4F46E5"/><path d="M32 16V48M16 32H48" stroke="white" stroke-width="6" stroke-linecap="round"/><circle cx="42" cy="22" r="6" fill="#10B981" stroke="#4F46E5" stroke-width="2"/></svg>
    Drug Tutor
</h1>

<div class="top-bar">
    <button id="mode-search" class="mode-active" onclick="switchMode('search')">Search</button>
    <button id="mode-flashcard" class="secondary" onclick="switchMode('flashcard')">Cards</button>
    <button onclick="toggleSettings()" class="secondary">‚öôÔ∏è</button>
</div>

<div id="settings-panel">
    <div style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:15px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <button onclick="toggleDrugSet()" id="set-btn" class="secondary">üìö Set: Common</button>
        <button onclick="toggleLanguage()" id="lang-btn" style="background:linear-gradient(135deg, #fbbf24, #d97706); color:white;">üåê LIHKG Mode</button>
        <button onclick="toggleMute()" id="mute-btn" class="secondary" style="grid-column:span 2;">üîä Audio: On</button>
    </div>
    
    <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
        <label style="font-weight:bold; font-size:0.8rem;">üó£Ô∏è Premium Voice Selection</label>
        <select id="voice-select" onchange="saveSettings()" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid #d1d5db;">
            <option value="">Auto-Detect Best</option>
        </select>
        <button onclick="testVoice()" class="secondary" style="width:100%; margin-top:5px; font-size:0.8rem;">üîä Test Voice</button>
    </div>

    <label style="font-weight:bold; font-size:0.8rem;">AI Provider</label>
    <select id="provider-select" onchange="updateSettingsUI()" style="width:100%; padding:8px; margin-bottom:10px;">
        <option value="deepseek">DeepSeek (Official)</option>
        <option value="yinli">Yinli (Gemini/Any)</option>
        <option value="github">GitHub Models</option>
    </select>
    
    <div id="settings-dynamic-fields"></div>
    
    <button onclick="fetchSheetData()" class="secondary" style="width:100%;">Force Reload Database</button>
    <button onclick="toggleSettings()" style="width:100%; margin-top:10px; background:var(--text-main); color:white;">Close</button>
</div>

<div id="app-container" style="width:100%; max-width:800px; flex-grow:1; display:flex; flex-direction:column;">
    
    <div id="search-section">
        <input type="text" id="search-input" class="search-bar" placeholder="Search drug..." oninput="handleSearch()">
        
        <div id="history-container" style="display:none;">
            <div class="section-label">üïí Recent</div>
            <div id="history-list" class="chip-scroll-row"></div>
        </div>

        <div class="section-label">ü´Å Quick Filter</div>
        <div id="system-chips" class="chip-scroll-row"></div>

        <div id="search-results" class="results-grid">
            <div style="text-align:center; color:#aaa; margin-top:20px;">Type to search database...</div>
        </div>
    </div>

    <div id="flashcard-section" style="display:none;">
        <div class="flashcard-container" id="flashcard" onclick="flipCard(event)">
            <div class="card-face card-front" style="justify-content:center; align-items:center; text-align:center;">
                <div style="font-size:3rem;">üíä</div>
                <h2 id="fc-name" style="margin:10px 0; font-size:1.8rem; color:var(--primary); text-align:center;">Name</h2>
                <div style="color:#999; font-size:0.8rem;">(Tap to Flip)</div>
                <button onclick="event.stopPropagation(); speakText(flashcardList[fcCurrentIndex].name)" class="secondary" style="margin-top:20px;">üîä Pronounce Name</button>
            </div>
            
            <div class="card-face card-back">
                <div id="fc-details" style="flex-grow:1;">
                    </div>
                
                <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                    <button onclick="event.stopPropagation(); speakDetails(flashcardList[fcCurrentIndex])" class="btn-audio" style="margin-bottom:10px;">üîä Read Details</button>
                    
                    <div style="font-size:0.75rem; font-weight:bold; color:#666; margin-bottom:5px;">Clinical Tools:</div>
                    <div class="tool-row">
                        <button class="btn-tool tool-isbar" onclick="event.stopPropagation(); triggerAIContext(flashcardList[fcCurrentIndex], 'isbar', 'fc-ai', this)">üöë ISBAR</button>
                        <button class="btn-tool tool-cheat" onclick="event.stopPropagation(); triggerAIContext(flashcardList[fcCurrentIndex], 'cheat', 'fc-ai', this)">üìã Cheatsheet</button>
                        <button class="btn-tool tool-mix" onclick="event.stopPropagation(); triggerAIContext(flashcardList[fcCurrentIndex], 'mix', 'fc-ai', this)">üß™ Recon</button>
                        <a id="fc-google" href="#" target="_blank" class="tool-google" onclick="event.stopPropagation();">G</a>
                    </div>
                    <div id="fc-ai" class="ai-output-box"></div>
                    <button class="secondary" style="width:100%; margin-top:5px; display:none;" onclick="event.stopPropagation(); readAIContent('fc-ai')">üîä Read Output</button>
                </div>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:15px;">
            <button onclick="prevCard()" class="secondary">‚Üê Prev</button>
            <span id="counter" style="align-self:center; font-size:0.9rem; font-weight:bold;">1/1</span>
            <button onclick="nextCard()" class="secondary">Next ‚Üí</button>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="drugs.js"></script>

<script>
    // --- CONFIGURATION ---
    const DB_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";
    const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxyNPyjbVXDMTQxFPxEuuCDTNNf-iVFfqedfNbh-kgn6Tk9rSIFEfIaLWXxXZoNOVnWug/exec";

    // --- STATE ---
    let drugs = [];
    let flashcardList = [];
    let searchHistory = [];
    let fcCurrentIndex = 0;
    let aiLanguage = 'lihkg';
    
    // --- KEYS ---
    let provider = 'deepseek';
    let keys = { deepseek: "sk-92db3cf721454bd7b351ca6ef40eaaf7", yinli: "", github: "" };
    let yinliUrl = "https://yinli.one/v1/chat/completions";
    let yinliModel = "gemini-2.5-flash"; 
    
    // --- VOICE ---
    let selectedVoiceURI = "";
    let availableVoices = [];

    // --- TEMP DATA ---
    let pendingDrugSave = null;

    const systems = [
        {id: "Gastro", name: "üçî GI System", full: "Gastro-intestinal system"},
        {id: "Cardio", name: "ü´Ä Cardio", full: "Cardiovascular system"},
        {id: "Resp", name: "ü´Å Respiratory", full: "Respiratory system"},
        {id: "CNS", name: "üß† CNS / Neuro", full: "Central nervous system"},
        {id: "Infection", name: "ü¶† Infections", full: "Infections"},
        {id: "Endo", name: "ü¶ã Endocrine", full: "Endocrine system"},
        {id: "ObGyn", name: "ü§∞ ObGyn", full: "Obstetrics"},
        {id: "Onco", name: "üéóÔ∏è Oncology", full: "Malignant disease"},
        {id: "MSK", name: "ü¶¥ MSK / Bone", full: "Musculoskeletal"}
    ];

    function init() {
        if(localStorage.getItem('ai_provider')) provider = localStorage.getItem('ai_provider');
        if(localStorage.getItem('ds_key')) keys.deepseek = localStorage.getItem('ds_key');
        if(localStorage.getItem('yl_key')) keys.yinli = localStorage.getItem('yl_key');
        if(localStorage.getItem('yl_model')) yinliModel = localStorage.getItem('yl_model');
        if(localStorage.getItem('search_hist')) searchHistory = JSON.parse(localStorage.getItem('search_hist'));
        if(localStorage.getItem('voice_uri')) selectedVoiceURI = localStorage.getItem('voice_uri');

        updateSettingsUI();
        
        // Init Audio
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        fetchSheetData(true); 

        renderSystemChips();
        renderHistory();
    }
    
    // --- VOICE LOGIC ---
    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voice-select');
        select.innerHTML = '<option value="">ü§ñ Auto-Detect Best (Recommended)</option>';
        
        // Sort: Premium/Google/Microsoft/Enhanced first
        availableVoices.sort((a, b) => {
            const priority = ["Google", "Microsoft", "Enhanced", "Premium", "Siri"];
            const aPrem = priority.some(p => a.name.includes(p));
            const bPrem = priority.some(p => b.name.includes(p));
            return (bPrem === aPrem) ? a.name.localeCompare(b.name) : bPrem - aPrem;
        });

        availableVoices.forEach(voice => {
            const opt = document.createElement('option');
            opt.value = voice.voiceURI;
            opt.innerText = `${voice.name} (${voice.lang})`;
            if (voice.voiceURI === selectedVoiceURI) opt.selected = true;
            select.appendChild(opt);
        });
    }

    function getBestVoice(lang = "en-US") {
        if (selectedVoiceURI) {
            const userVoice = availableVoices.find(v => v.voiceURI === selectedVoiceURI);
            if (userVoice) return userVoice;
        }
        
        const keywords = ["Google", "Microsoft", "Enhanced", "Siri", "Premium"];
        const langVoices = availableVoices.filter(v => v.lang.startsWith(lang.split('-')[0]));
        
        for (let k of keywords) {
            const hit = langVoices.find(v => v.name.includes(k) && v.lang === lang);
            if (hit) return hit;
        }
        for (let k of keywords) {
            const hit = langVoices.find(v => v.name.includes(k));
            if (hit) return hit;
        }
        return langVoices[0] || availableVoices[0];
    }

    function speakText(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        const lang = aiLanguage === 'lihkg' ? 'zh-HK' : 'en-US';
        u.lang = lang;
        u.rate = 0.95; 
        
        const bestVoice = getBestVoice(lang);
        if (bestVoice) u.voice = bestVoice;
        
        window.speechSynthesis.speak(u);
    }
    
    function speakDetails(d) {
        const txt = `Name: ${d.name}. Class: ${d.class}. System: ${d.system}. Indication: ${d.indication}. Side Effects: ${d.SideEffects}. Nursing: ${d.nursing}`;
        speakText(txt);
    }
    
    function testVoice() {
        speakText("This is a test of the premium voice engine. Checking clarity and tone.");
    }

    // --- SETTINGS UI ---
    function updateSettingsUI() {
        const prov = document.getElementById('provider-select').value;
        const container = document.getElementById('settings-dynamic-fields');
        container.innerHTML = '';

        if (prov === 'yinli') {
            container.innerHTML = `
                <label style="font-weight:bold; font-size:0.8rem;">Yinli API Key</label>
                <input type="password" id="yinli-key" class="settings-input" value="${keys.yinli}" placeholder="sk-...">
                <label style="font-weight:bold; font-size:0.8rem;">Model ID (e.g. gemini-2.0-flash)</label>
                <input type="text" id="yinli-model" class="settings-input" value="${yinliModel}" placeholder="gemini-2.5-flash">
            `;
        } else if (prov === 'deepseek') {
            container.innerHTML = `
                <label style="font-weight:bold; font-size:0.8rem;">DeepSeek API Key</label>
                <input type="password" id="deepseek-key" class="settings-input" value="${keys.deepseek}" placeholder="sk-...">
            `;
        } else {
             container.innerHTML = `
                <label style="font-weight:bold; font-size:0.8rem;">GitHub Token</label>
                <input type="password" id="github-key" class="settings-input" value="${keys.github}" placeholder="ghp_...">
            `;
        }
    }

    // --- AI SEARCH ---
    async function triggerAISearchAndGenerate(query) {
        const btn = document.getElementById('btn-ai-search');
        btn.innerHTML = '<span class="spinner"></span> Consulting Pharmacist...';
        btn.disabled = true;

        const prompt = `You are a strict pharmacology database.
        Task: Output a JSON object for the drug "${query}".
        Keys: 
        - "name": (Generic Name)
        - "class": (Pharmacological Class)
        - "indication": (Short summary)
        - "system": (Choose STRICTLY one: Gastro-intestinal system, Cardiovascular system, Respiratory system, Central nervous system, Infections, Endocrine system, Obstetrics, gynaecology, and urinary-tract disorders, Malignant disease and immunosuppression, Nutrition and blood, Musculoskeletal and joint disease, Eye, Ear, nose, and oropharynx, Skin, Immunological products and vaccines, Anaesthesia)
        - "SideEffects": (Common side effects)
        - "nursing": (Key monitoring points)
        
        Output ONLY the JSON object. No markdown.`;

        try {
            let jsonString = await getFullAIResponse(prompt);
            jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const drugData = JSON.parse(jsonString);

            pendingDrugSave = drugData;

            const container = document.getElementById('search-results');
            container.innerHTML = `
                <div style="background:#fff7ed; border:2px solid #f97316; padding:15px; border-radius:10px; position:relative;">
                    <div style="font-weight:bold; color:#c2410c; margin-bottom:10px;">‚ú® AI Preview (Not Saved Yet)</div>
                    <div style="font-size:1.1rem; font-weight:800;">${drugData.name}</div>
                    <div>${drugData.class}</div>
                    <hr style="border:0; border-top:1px solid #fed7aa; margin:10px 0;">
                    <div style="font-size:0.9rem;">
                        <p><strong>System:</strong> ${drugData.system}</p>
                        <p><strong>Indication:</strong> ${drugData.indication}</p>
                        <p><strong>Side Effects:</strong> ${drugData.SideEffects}</p>
                        <p><strong>Nursing:</strong> ${drugData.nursing}</p>
                    </div>
                    <button class="btn-confirm-save" onclick="confirmSaveDrug()">
                        üíæ Confirm & Save to Database
                    </button>
                </div>
            `;

        } catch (e) {
            btn.innerHTML = `‚ùå Error: ${e.message}`;
            btn.disabled = false;
        }
    }

    function confirmSaveDrug() {
        if(!pendingDrugSave) return;
        
        drugs.push(pendingDrugSave);
        flashcardList = [...drugs];
        shuffleArray(flashcardList); // Maintain randomization
        
        const btn = document.querySelector('.btn-confirm-save');
        btn.innerHTML = "‚è≥ Uploading to Cloud...";
        btn.disabled = true;

        fetch(UPLOAD_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(pendingDrugSave)
        });

        setTimeout(() => {
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            renderResult(pendingDrugSave, drugs.length - 1, container, true);
            pendingDrugSave = null;
        }, 1000);
    }

    async function getFullAIResponse(prompt) {
        let url = "https://api.deepseek.com/chat/completions";
        let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${keys.deepseek}` };
        let body = { model: "deepseek-chat", messages: [{role:"user", content: prompt}], stream: false };

        if(provider === 'yinli') { 
            url = yinliUrl; 
            headers["Authorization"] = `Bearer ${keys.yinli}`; 
            body.model = yinliModel; 
        }
        
        const response = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const json = await response.json();
        return json.choices[0].message.content;
    }

    // --- SEARCH LOGIC ---
    function handleSearch() {
        const q = document.getElementById('search-input').value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        container.innerHTML = '';
        
        if(!q) return;

        if(q.length > 3 && !searchHistory.includes(q)) {
            searchHistory.unshift(q);
            if(searchHistory.length > 5) searchHistory.pop();
            localStorage.setItem('search_hist', JSON.stringify(searchHistory));
            renderHistory();
        }

        const matches = drugs.filter(d => (d.name+d.class+d.indication+d.system).toLowerCase().includes(q));
        
        matches.sort((a, b) => {
            const nameA = (a.name || "").toLowerCase();
            const nameB = (b.name || "").toLowerCase();
            const query = q;
            const aNameMatch = nameA.includes(query);
            const bNameMatch = nameB.includes(query);
            if (aNameMatch && !bNameMatch) return -1;
            if (!aNameMatch && bNameMatch) return 1;
            if (aNameMatch && bNameMatch) {
                if (nameA.startsWith(query) && !nameB.startsWith(query)) return -1;
                if (!nameA.startsWith(query) && nameB.startsWith(query)) return 1;
            }
            return nameA.localeCompare(nameB);
        });

        if (matches.length > 0) {
            matches.forEach((d, idx) => renderResult(d, idx, container));
        } else {
            container.innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <div style="color:#666; margin-bottom:10px;">Drug not found locally.</div>
                    <button id="btn-ai-search" class="btn-ai-add" onclick="triggerAISearchAndGenerate('${q}')">
                        ‚ú® AI Search & Preview
                    </button>
                </div>
            `;
        }
    }

    function renderResult(d, idx, container, isNew = false) {
        const div = document.createElement('div');
        div.className = 'result-card';
        if(isNew) div.style.border = "2px solid #10B981";
        
        const aiId = `ai-res-${Math.random().toString(36).substr(2, 9)}`;
        const googleLink = `https://www.google.com/search?q=${encodeURIComponent(d.name + ' hk nursing')}`;
        
        div.innerHTML = `
            ${isNew ? '<div class="saved-badge" style="display:block;">‚úÖ Saved to Database</div>' : ''}
            <div class="result-header">
                <span>${d.name}</span>
                <span style="font-size:0.8rem; color:#666; font-weight:normal;">${d.class}</span>
            </div>
            <div class="result-detail">
                <div class="detail-row"><span class="d-label">System</span><span class="d-content">${d.system || "N/A"}</span></div>
                <div class="detail-row"><span class="d-label">Indication</span><span class="d-content">${d.indication || "N/A"}</span></div>
                <div class="detail-row"><span class="d-label">Side Effects</span><span class="d-content">${d.SideEffects || "N/A"}</span></div>
                <div class="detail-row"><span class="d-label">Nursing</span><span class="d-content">${d.nursing || "N/A"}</span></div>
                
                <div style="margin-top:10px;">
                     <button onclick="event.stopPropagation(); speakDetails({name:'${d.name.replace(/'/g, "")}', class:'${d.class}', system:'${d.system}', indication:'${d.indication.replace(/\n/g, "")}', SideEffects:'${d.SideEffects.replace(/\n/g, "")}', nursing:'${d.nursing.replace(/\n/g, "")}'})" class="btn-audio">üîä Read</button>
                </div>

                <div style="font-size:0.75rem; font-weight:bold; color:#666; margin-top:10px;">Clinical Tools:</div>
                <div class="tool-row">
                    <button class="btn-tool tool-isbar" onclick="event.stopPropagation(); triggerAIContext(null, 'isbar', '${aiId}', this, '${d.name}')">üöë ISBAR</button>
                    <button class="btn-tool tool-cheat" onclick="event.stopPropagation(); triggerAIContext(null, 'cheat', '${aiId}', this, '${d.name}')">üìã Cheat</button>
                    <button class="btn-tool tool-mix" onclick="event.stopPropagation(); triggerAIContext(null, 'mix', '${aiId}', this, '${d.name}')">üß™ Recon</button>
                    <a href="${googleLink}" target="_blank" class="tool-google" onclick="event.stopPropagation();">G</a>
                </div>
                <div id="${aiId}" class="ai-output-box"></div>
                <button class="secondary" style="width:100%; margin-top:5px; display:none;" onclick="event.stopPropagation(); readAIContent('${aiId}')">üîä Read Output</button>
            </div>
        `;
        div.onclick = (e) => { 
            if(!e.target.closest('button') && !e.target.closest('a')) div.classList.toggle('expanded'); 
        };
        container.appendChild(div);
    }

    // --- STANDARD APP LOGIC ---
    function fetchSheetData(silent = false) {
        fetch(DB_URL).then(r=>r.text()).then(csv=>{
            Papa.parse(csv, {header:true, skipEmptyLines:true, complete:res=>{
                if(res.data.length){ 
                    drugs=res.data; 
                    flashcardList=[...drugs]; 
                    shuffleArray(flashcardList); // RANDOMIZE ON LOAD
                    if(!silent) alert(`‚úÖ Loaded ${drugs.length} drugs`);
                    renderCard();
                }
            }});
        }).catch(e => { if(!silent) alert("Connection Failed"); });
    }

    // --- HELPER: SHUFFLE ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function renderSystemChips() {
        const c = document.getElementById('system-chips');
        c.innerHTML = `<div class="filter-chip chip-sys active" onclick="filterBySystem('All', this)">All</div>`;
        systems.forEach(s => {
            c.innerHTML += `<div class="filter-chip chip-sys" onclick="filterBySystem('${s.full}', this)">${s.name}</div>`;
        });
    }

    function renderHistory() {
        const c = document.getElementById('history-list');
        const box = document.getElementById('history-container');
        if(searchHistory.length === 0) { box.style.display = 'none'; return; }
        box.style.display = 'block';
        c.innerHTML = '';
        searchHistory.forEach(term => {
            c.innerHTML += `<div class="filter-chip chip-hist" onclick="clickHistory('${term}')">${term}</div>`;
        });
    }

    function filterBySystem(sys, btn) {
        document.querySelectorAll('.chip-sys').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const container = document.getElementById('search-results');
        container.innerHTML = '';
        document.getElementById('search-input').value = '';
        const matches = (sys === 'All') ? drugs : drugs.filter(d => (d.system || "").includes(sys));
        matches.sort((a,b) => (a.name||"").localeCompare(b.name||""));
        matches.forEach((d, idx) => renderResult(d, idx, container));
    }

    function clickHistory(term) {
        document.getElementById('search-input').value = term;
        handleSearch();
    }

    function renderCard() {
        if(flashcardList.length === 0) return;
        const d = flashcardList[fcCurrentIndex];
        document.getElementById('fc-name').innerText = d.name;
        document.getElementById('fc-google').href = `https://www.google.com/search?q=${encodeURIComponent(d.name + ' hk nursing')}`;
        
        // Flashcard Back
        document.getElementById('fc-details').innerHTML = `
            <div class="detail-row"><span class="d-label">Class</span><span class="d-content">${d.class || "N/A"}</span></div>
            <div class="detail-row"><span class="d-label">System</span><span class="d-content">${d.system || "N/A"}</span></div>
            <div class="detail-row"><span class="d-label">Indication</span><span class="d-content">${d.indication || "N/A"}</span></div>
            <div class="detail-row"><span class="d-label">Side Effects</span><span class="d-content">${d.SideEffects || "N/A"}</span></div>
            <div class="detail-row"><span class="d-label">Nursing</span><span class="d-content">${d.nursing || "N/A"}</span></div>
        `;
        document.getElementById('counter').innerText = `${fcCurrentIndex+1}/${flashcardList.length}`;
    }
    
    function flipCard(e) { if(!e.target.closest('button') && !e.target.closest('a')) document.getElementById('flashcard').classList.toggle('flipped'); }
    function nextCard() { if(fcCurrentIndex < flashcardList.length-1) { fcCurrentIndex++; renderCard(); document.getElementById('flashcard').classList.remove('flipped'); }}
    function prevCard() { if(fcCurrentIndex > 0) { fcCurrentIndex--; renderCard(); document.getElementById('flashcard').classList.remove('flipped'); }}

    async function triggerAIContext(obj, type, outputId, btn, drugNameOverride) {
        const out = document.getElementById(outputId);
        const name = drugNameOverride || obj.name;
        const originalText = btn.innerText;
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Wait...';
        out.style.display = 'block'; out.innerHTML = '<span style="color:#666;">ü§ñ AI is thinking...</span>';
        
        let prompt = "";
        const langInstruction = aiLanguage === 'lihkg' ? "Use Hong Kong Cantonese (LIHKG style, casual)." : "Use professional English.";
        if (type === 'isbar') prompt = `Write a nursing handover for ${name} using ISBAR. Invent a scenario. Concise. ${langInstruction}`;
        else if (type === 'cheat') prompt = `Create a "Ward Cheatsheet" for ${name}. Bullet points: 1. Critical Checks 2. Monitoring 3. Red Flags. ${langInstruction}`;
        else if (type === 'mix') prompt = `Reconstitution guide for ${name} (IV/IM). Diluent, Rate, Stability. ${langInstruction}`;

        try {
            await streamAI(prompt, (chunk) => { out.innerHTML = marked.parse(chunk); });
            btn.innerHTML = "‚úÖ Done";
            if(out.nextElementSibling) out.nextElementSibling.style.display = 'block';
        } catch (e) { out.innerHTML = `Error: ${e.message}`; btn.innerHTML = "‚ùå Error"; } 
        finally { btn.disabled = false; setTimeout(() => btn.innerText = originalText, 3000); }
    }

    async function streamAI(prompt, onChunk) {
        let url = "https://api.deepseek.com/chat/completions";
        let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${keys.deepseek}` };
        let body = { model: "deepseek-chat", messages: [{role:"user", content: prompt}], stream: true };
        
        if(provider === 'yinli') { 
            url = yinliUrl; 
            headers["Authorization"] = `Bearer ${keys.yinli}`; 
            body.model = yinliModel; 
        }

        const response = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            for (const line of lines) {
                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    try {
                        const json = JSON.parse(line.substring(6));
                        const content = json.choices[0]?.delta?.content || "";
                        fullText += content;
                        onChunk(fullText);
                    } catch (e) {}
                }
            }
        }
    }

    function switchMode(mode) {
        document.getElementById('search-section').style.display = 'none';
        document.getElementById('flashcard-section').style.display = 'none';
        document.querySelectorAll('.top-bar button').forEach(b => { b.classList.remove('mode-active'); b.classList.add('secondary'); });
        document.getElementById('mode-'+mode).classList.add('mode-active');
        document.getElementById('mode-'+mode).classList.remove('secondary');
        document.getElementById(mode+'-section').style.display = (mode==='search' ? 'flex' : 'block');
    }

    function readAIContent(id) { speakText(document.getElementById(id).innerText); }

    function toggleLanguage() {
        const btn = document.getElementById('lang-btn');
        if(aiLanguage === 'english') { aiLanguage = 'lihkg'; btn.innerText = "üåê LIHKG Mode"; btn.style.background = "linear-gradient(135deg, #fbbf24, #d97706)"; } 
        else { aiLanguage = 'english'; btn.innerText = "üåê English"; btn.style.background = "#fff"; btn.style.color = "#333"; }
    }

    function saveSettings() {
        provider = document.getElementById('provider-select').value;
        localStorage.setItem('active_provider', provider);
        selectedVoiceURI = document.getElementById('voice-select').value;
        localStorage.setItem('voice_uri', selectedVoiceURI);

        if(document.getElementById('deepseek-key')) {
             keys.deepseek = document.getElementById('deepseek-key').value;
             localStorage.setItem('ds_key', keys.deepseek);
        }
        if(document.getElementById('yinli-key')) {
             keys.yinli = document.getElementById('yinli-key').value;
             localStorage.setItem('yl_key', keys.yinli);
        }
        if(document.getElementById('yinli-model')) {
             yinliModel = document.getElementById('yinli-model').value;
             localStorage.setItem('yl_model', yinliModel);
        }

        toggleSettings();
    }
    
    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }
    
    function toggleDrugSet() { alert("Switched sets"); }
    function toggleMute() { alert("Mute toggled"); }

    init();
</script>
</body>
</html>
