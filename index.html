<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Drug Tutor</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --sim: #059669;    
            --ai: #7c3aed;     
            --canto: #0891b2;  
            --lihkg: #fbbf24;  
            --lihkg-text: #78350f;
            --ask: #db2777;    
            --set-extended: #4f46e5; 
            --mute: #dc2626;   
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overscroll-behavior-y: none;
        }

        h1 { color: var(--primary); margin-bottom: 5px; text-align: center; }
        .subtitle { font-size: 0.85rem; color: #666; margin-bottom: 15px; text-align:center; }

        /* --- Controls --- */
        .top-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            background-color: var(--primary);
            color: white;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            touch-action: manipulation;
        }

        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(0); }

        button.secondary { background-color: #6b7280; }
        button.lang-canto { background-color: var(--canto); }
        button.lang-lihkg { background-color: var(--lihkg); color: var(--lihkg-text); }
        button.set-extended { background-color: var(--set-extended); }
        button.muted { background-color: var(--mute); }
        button.mode-active { ring: 2px solid var(--primary); box-shadow: 0 0 0 3px #bfdbfe; }

        /* --- Settings --- */
        #settings-panel {
            display: none; background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 20px; width: 100%; max-width: 600px;
            border: 1px solid #e5e7eb; box-sizing: border-box;
        }
        .settings-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .settings-label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .settings-input { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 5px; box-sizing: border-box; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #d1d5db; width: 100%; margin-bottom: 10px; }
        
        /* Cloud Import Styling */
        .import-wrapper {
            border: 1px solid #d1d5db;
            padding: 15px;
            border-radius: 8px;
            background: #f9fafb;
        }
        .url-input-group { display: flex; gap: 8px; }
        .url-input-group input { flex-grow: 1; }

        /* --- Main Container --- */
        #app-container { width: 100%; max-width: 650px; perspective: 1000px; padding-bottom: 50px; }

        /* --- Flashcards --- */
        .flashcard-container { width: 100%; height: 650px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard-container.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background-color: var(--card-bg);
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; text-align: center;
        }
        .card-back { transform: rotateY(180deg); align-items: flex-start; text-align: left; overflow-y: auto; padding-top: 15px; }
        .card-title { font-size: 1.6rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .detail-row { margin-bottom: 12px; width: 100%; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; }
        .detail-label { font-size: 0.75rem; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-content { margin-top: 4px; font-size: 0.95rem; color: #374151; line-height: 1.4; }

        /* --- Quiz --- */
        .quiz-container { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: none; }
        .quiz-question { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; color: #111827; }
        .quiz-options { display: flex; flex-direction: column; gap: 10px; }
        .option-btn { background-color: #f9fafb; color: #374151; text-align: left; border: 1px solid #e5e7eb; padding: 12px 16px; border-radius: 8px; transition: all 0.2s; }
        .option-btn.correct { background-color: #d1fae5; border-color: #10b981; color: #065f46; }
        .option-btn.wrong { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }

        /* --- Clinical Ask --- */
        #ask-section { display: none; width: 100%; background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); box-sizing: border-box; }
        .ask-textarea { width: 100%; height: 100px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; margin-bottom: 15px; box-sizing: border-box; resize: vertical; }
        .btn-ask-submit { background-color: var(--ask); width: 100%; font-size: 1rem; }
        .ask-header { font-weight: bold; color: var(--ask); margin-bottom: 10px; }

        /* --- Common AI --- */
        .ai-btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; width: 100%; }
        .ai-btn-small { font-size: 0.9rem; padding: 10px 12px; width: 100%; text-align: left; display: flex; align-items: center; gap: 8px; }
        .btn-sim { background-color: var(--sim); }
        .btn-explain { background-color: var(--ai); color: white; width: 100%; margin-top: 10px; display: none; }
        .ai-output-box { margin-top: 15px; padding: 15px; border-radius: 8px; font-size: 0.95rem; width: 100%; box-sizing: border-box; display: none; line-height: 1.6; background: #ecfdf5; border: 1px solid #a7f3d0; }
        #ask-response-box { background: #fdf2f8; border: 1px solid #fbcfe8; }
        .ai-output-box h3 { margin: 15px 0 8px 0; font-size: 1.1rem; color: #0f172a; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 4px; font-weight: 800; }
        .ai-output-box ul { padding-left: 20px; margin: 8px 0; }
        .btn-read-ai { background-color: #e0e7ff; color: var(--primary); margin-top: 10px; width: 100%; font-size: 0.85rem; display: none; }
        .loading-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.6); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .nav-controls { margin-top: 20px; display: flex; justify-content: space-between; width: 100%; }
        
        /* Persistent Banner */
        #custom-data-banner {
            background-color: var(--set-extended); color: white; width: 100%; text-align: center;
            padding: 5px; font-size: 0.75rem; display: none;
        }
    </style>
</head>
<body>

    <div id="custom-data-banner">üìÇ Using Saved Custom Database</div>

    <h1>üíä Integrated Drug Sim</h1>
    <div class="subtitle" id="provider-display">Provider: Not Configured</div>

    <div class="top-bar">
        <button id="mode-flashcard" class="mode-active" onclick="switchMode('flashcard')">Flashcards</button>
        <button id="mode-quiz" class="secondary" onclick="switchMode('quiz')">Quiz</button>
        <button id="mode-ask" class="secondary" onclick="switchMode('ask')">Clinical Ask</button>
        
        <button onclick="toggleDrugSet()" id="set-btn" class="secondary">üìö Set: Common</button>
        <button onclick="reshuffle()" style="background-color: #f59e0b;">Reset</button>
        <button onclick="toggleLanguage()" id="lang-btn" class="lang-canto">üåê Lang: Canto</button>
        <button onclick="toggleMute()" id="mute-btn" class="secondary">üîä Audio: On</button>
        <button onclick="toggleSettings()" class="secondary">‚öôÔ∏è Settings</button>
    </div>

    <div id="settings-panel">
        <h3 style="margin-top:0;">Configuration</h3>

        <div class="settings-group">
            <label class="settings-label">Preferred iOS/System Voice:</label>
            <select id="voice-select">
                <option value="">Default System Voice</option>
            </select>
            <button onclick="testVoice()" style="margin-top:5px; font-size:0.8rem; padding:5px 10px;">üîä Test Voice</button>
        </div>

        <div class="settings-group">
            <label class="settings-label">Select Active AI Provider:</label>
            <select id="provider-select" onchange="updateProviderDisplay()">
                <option value="openrouter">OpenRouter (Free)</option>
                <option value="deepseek">DeepSeek Official</option>
            </select>
            
            <label class="settings-label">OpenRouter API Key:</label>
            <input type="password" id="openrouter-key" class="settings-input" placeholder="sk-or..." />
            
            <label class="settings-label">DeepSeek API Key:</label>
            <input type="password" id="deepseek-key" class="settings-input" placeholder="sk-..." />
        </div>

        <div class="settings-group">
            <label class="settings-label">Load External Data (Google Sheet/CSV):</label>
            <div style="font-size:0.75rem; color:#666; margin-bottom:5px;">Data is saved permanently to this device.</div>
            
            <div class="import-wrapper">
                <div class="url-input-group">
                    <input type="text" id="sheet-url" class="settings-input" placeholder="https://docs.google.com/spreadsheets/..." style="margin-bottom:0;" />
                    <button onclick="fetchSheetData()" style="padding: 5px 15px;">Load & Save</button>
                </div>
                <div id="upload-status" style="font-size:0.8rem; margin-top:5px; color:var(--primary); font-weight:bold;"></div>
                <button onclick="clearCustomData()" style="margin-top:10px; background-color:#ef4444; font-size:0.8rem; width:100%;">üóëÔ∏è Delete Saved Data</button>
            </div>
        </div>

        <button onclick="saveSettings()" style="width:100%; background-color:#059669;">üíæ Save & Close</button>
    </div>

    <div id="app-container">
        <div id="flashcard-section">
            <div class="flashcard-container" id="flashcard" onclick="flipCard(event)">
                <div class="card-face card-front">
                    <div style="font-size: 3.5rem; margin-bottom: 20px;">üíä</div>
                    <h2 id="fc-name" class="card-title">Drug Name</h2>
                    <p style="color: #9ca3af; font-size: 0.9rem;">(Tap to flip)</p>
                    <button onclick="event.stopPropagation(); speakText(drugList[currentIndex].name, 'en')" style="margin-top: 20px; background:#e0e7ff; color:var(--primary);">üîä Read Name</button>
                </div>
                <div class="card-face card-back">
                    <div class="detail-row"><div class="detail-label">Class</div><div class="detail-content" id="fc-class">...</div></div>
                    <div class="detail-row"><div class="detail-label">Indication</div><div class="detail-content" id="fc-indication">...</div></div>
                    <div class="detail-row"><div class="detail-label">SideEffects</div><div class="detail-content" id="fc-SideEffects">...</div></div>
                    <div class="detail-row" style="border:none;"><div class="detail-label">Nursing Considerations</div><div class="detail-content" id="fc-nursing">...</div></div>

                    <div class="ai-btn-group">
                        <button onclick="event.stopPropagation(); getIntegratedCaseStudy(drugList[currentIndex], 'fc-ai-case', 'btn-case', 'btn-read-case')" class="ai-btn-small btn-sim" id="btn-case">üè• AI: Generate Integrated Patient Case</button>
                        <div id="fc-ai-case" class="ai-output-box"></div>
                        <button onclick="event.stopPropagation(); readAIContent('fc-ai-case')" class="btn-read-ai" id="btn-read-case">üîä Read Out Loud</button>
                    </div>
                </div>
            </div>
            <div class="nav-controls">
                <button onclick="prevCard()">‚Üê Prev</button>
                <span id="counter" style="align-self: center; font-weight: bold; color:#6b7280;">1 / 10</span>
                <button onclick="nextCard()">Next ‚Üí</button>
            </div>
        </div>

        <div id="quiz-section" class="quiz-container">
            <div id="quiz-content">
                <p class="quiz-question" id="quiz-question">Question...</p>
                <div class="quiz-options" id="quiz-options"></div>
            </div>
            <button id="btn-quiz-explain" class="btn-explain" onclick="triggerQuizExplain()">ü§ñ Explain Why (AI Tutor)</button>
            <div id="ai-container">
                <h3><span id="ai-status-icon">ü§ñ</span> AI Tutor Explanation</h3>
                <div id="ai-content"></div>
                <button onclick="readAIContent('ai-content')" class="btn-read-ai" id="btn-read-explain" style="margin-bottom:0;">üîä Read Out Loud</button>
            </div>
            <div class="nav-controls" style="justify-content: flex-end;">
                <button onclick="nextQuestion()" id="next-quiz-btn" style="display:none;">Next Question ‚Üí</button>
            </div>
        </div>

        <div id="ask-section">
            <div class="ask-header">üë©‚Äç‚öïÔ∏è Clinical Mentor (Bedside Teaching)</div>
            <p style="font-size:0.9rem; color:#666;">Enter a scenario/question. I will explain using analogies, nursing priorities & mnemonics.</p>
            <textarea id="ask-input" class="ask-textarea" placeholder="e.g. Patient on Digoxin with pulse 52. What to do?"></textarea>
            <button onclick="askClinicalMentor()" class="btn-ask-submit" id="btn-ask-submit">üí° Ask Mentor</button>
            <div id="ask-response-box" class="ai-output-box"></div>
            <button onclick="readAIContent('ask-response-box')" class="btn-read-ai" id="btn-read-ask">üîä Read Out Loud</button>
        </div>
    </div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Error', err));
            });
        }

        // --- CONFIGURATION STATE ---
        let currentProvider = 'openrouter'; 
        let openRouterKey = ""; 
        let deepSeekKey = "";
        let selectedVoiceURI = "";
        let isMuted = false;
        
        // UPDATED: Default Language is now Cantonese
        let aiLanguage = 'cantonese'; 
        
        // UPDATED: Default Database URL
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";

        // --- DATA SETS ---
        const commonDrugs = [
            { name: "Acetaminophen/Paracetamol", class: "Analgesic", indication: "Pain, Fever", SideEffects: "Hepatotoxicity", nursing: "Monitor LFTs; Max 4g/day" },
            { name: "Ibuprofen", class: "NSAID", indication: "Inflammation", SideEffects: "GI Bleed, Renal", nursing: "Take with food" },
            { name: "Digoxin", class: "Cardiac Glycoside", indication: "HF, AFib", SideEffects: "Halo vision, Bradycardia", nursing: "Apical pulse > 60" }
        ];

        let extendedDrugs = []; 
        let activeSourceList = commonDrugs; 
        let drugList = [];
        let currentIndex = 0;
        let quizCurrentIndex = 0;
        let currentQuizData = null;

        // --- INITIALIZATION ---
        function init() {
            const savedOR = localStorage.getItem('or_key');
            if(savedOR) openRouterKey = savedOR;
            
            const savedDS = localStorage.getItem('ds_key');
            if(savedDS) deepSeekKey = savedDS;
            
            const savedProv = localStorage.getItem('active_provider');
            if(savedProv) currentProvider = savedProv;

            const savedVoice = localStorage.getItem('preferred_voice');
            if(savedVoice) selectedVoiceURI = savedVoice;

            document.getElementById('openrouter-key').value = openRouterKey;
            document.getElementById('deepseek-key').value = deepSeekKey;
            document.getElementById('provider-select').value = currentProvider;
            
            // Set input to default URL
            document.getElementById('sheet-url').value = DEFAULT_SHEET_URL;

            updateProviderDisplay();

            // --- LOAD SAVED DATABASE ---
            const savedCustomData = localStorage.getItem('custom_drug_data');
            const savedSheetUrl = localStorage.getItem('custom_sheet_url');
            
            if (savedCustomData) {
                // If we have saved data, load it immediately (fast/offline friendly)
                try {
                    extendedDrugs = JSON.parse(savedCustomData);
                    if (extendedDrugs.length > 0) {
                        activeSourceList = extendedDrugs; 
                        document.getElementById('custom-data-banner').style.display = 'block';
                        if(savedSheetUrl) document.getElementById('sheet-url').value = savedSheetUrl;
                        updateSetButton();
                        reshuffle();
                    }
                } catch (e) { console.error("Error loading saved data", e); }
            } else {
                // AUTO-FETCH: If no saved data, automatically fetch the default sheet
                console.log("No saved data found. Auto-fetching default database...");
                fetchSheetData(DEFAULT_SHEET_URL);
            }

            // Ensure UI matches the default variable set at top
            if(aiLanguage !== 'english') toggleLanguage(true); // Force update UI

            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
        }

        // --- GOOGLE SHEET LOGIC ---
        async function fetchSheetData(autoUrl = null) {
            const urlInput = autoUrl || document.getElementById('sheet-url').value.trim();
            const statusEl = document.getElementById('upload-status');
            
            if (!urlInput) { statusEl.innerText = "‚ùå Please enter a URL."; return; }

            // Only show "Fetching" if manually clicked, to avoid UI flicker on auto-load
            if(!autoUrl) statusEl.innerText = "‚è≥ Fetching & Saving...";
            
            let fetchUrl = urlInput;
            if (urlInput.includes("docs.google.com/spreadsheets") && urlInput.includes("/edit")) {
                fetchUrl = urlInput.replace(/\/edit.*$/, "/export?format=csv");
            }

            try {
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error("Network error");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const required = ['name', 'class'];
                        const hasColumns = required.every(col => results.meta.fields.includes(col));
                        
                        if (hasColumns && results.data.length > 0) {
                            extendedDrugs = results.data;
                            
                            // SAVE TO LOCAL STORAGE
                            localStorage.setItem('custom_drug_data', JSON.stringify(extendedDrugs));
                            localStorage.setItem('custom_sheet_url', urlInput);

                            statusEl.innerText = `‚úÖ Loaded ${extendedDrugs.length} drugs.`;
                            
                            activeSourceList = extendedDrugs;
                            document.getElementById('custom-data-banner').style.display = 'block';
                            
                            // Ensure the set button reflects the new state
                            updateSetButton();
                            reshuffle();
                        } else {
                            statusEl.innerText = "‚ùå CSV missing 'name' or 'class'.";
                        }
                    },
                    error: function(err) { statusEl.innerText = "‚ùå Parse Error."; }
                });
            } catch (e) {
                statusEl.innerText = "‚ùå Failed to load database.";
            }
        }

        function clearCustomData() {
            localStorage.removeItem('custom_drug_data');
            localStorage.removeItem('custom_sheet_url');
            extendedDrugs = [];
            activeSourceList = commonDrugs;
            // Reset URL input to default when cleared
            document.getElementById('sheet-url').value = DEFAULT_SHEET_URL;
            document.getElementById('upload-status').innerText = "üóëÔ∏è Data deleted.";
            document.getElementById('custom-data-banner').style.display = 'none';
            updateSetButton();
            reshuffle();
        }

        // --- STANDARD FUNCTIONS ---
        function populateVoiceList() {
            const voices = window.speechSynthesis.getVoices();
            const select = document.getElementById('voice-select');
            if(voices.length === 0) return; 
            select.innerHTML = '<option value="">Default System Voice</option>';
            const sortedVoices = voices.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                if (aName.includes('enhanced') && !bName.includes('enhanced')) return -1;
                if (!aName.includes('enhanced') && bName.includes('enhanced')) return 1;
                return aName.localeCompare(bName);
            });
            sortedVoices.forEach((voice) => {
                const option = document.createElement('option');
                const label = voice.name.includes("Enhanced") || voice.name.includes("Siri") ? `‚ú® ${voice.name}` : voice.name;
                option.textContent = `${label} (${voice.lang})`;
                option.value = voice.voiceURI;
                if(voice.voiceURI === selectedVoiceURI) option.selected = true;
                select.appendChild(option);
            });
        }
        function testVoice() {
            const select = document.getElementById('voice-select');
            const selectedURI = select.value;
            if(selectedURI) { selectedVoiceURI = selectedURI; speakText("Voice check.", 'en', true); } 
            else { speakText("Default system voice test.", 'en', true); }
        }
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        function saveSettings() {
            const orInput = document.getElementById('openrouter-key').value.trim();
            const dsInput = document.getElementById('deepseek-key').value.trim();
            const provInput = document.getElementById('provider-select').value;
            const voiceInput = document.getElementById('voice-select').value;
            if(orInput) { openRouterKey = orInput; localStorage.setItem('or_key', orInput); }
            if(dsInput) { deepSeekKey = dsInput; localStorage.setItem('ds_key', dsInput); }
            currentProvider = provInput; localStorage.setItem('active_provider', currentProvider);
            selectedVoiceURI = voiceInput; localStorage.setItem('preferred_voice', selectedVoiceURI);
            updateProviderDisplay(); toggleSettings();
        }
        function updateProviderDisplay() {
            const display = document.getElementById('provider-display');
            if(currentProvider === 'openrouter') display.innerText = "Provider: OpenRouter";
            else display.innerText = "Provider: DeepSeek";
        }
        function toggleDrugSet() {
            if (activeSourceList === commonDrugs && extendedDrugs.length > 0) {
                activeSourceList = extendedDrugs;
            } else {
                activeSourceList = commonDrugs;
            }
            updateSetButton();
            reshuffle();
        }
        function updateSetButton() {
            const btn = document.getElementById('set-btn');
            if(activeSourceList === extendedDrugs) {
                btn.innerText = "üìö Set: Saved Custom";
                btn.classList.add('set-extended'); btn.classList.remove('secondary');
            } else {
                btn.innerText = "üìö Set: Common";
                btn.classList.add('secondary'); btn.classList.remove('set-extended');
            }
        }
        function reshuffle() {
            drugList = [...activeSourceList];
            for (let i = drugList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [drugList[i], drugList[j]] = [drugList[j], drugList[i]];
            }
            currentIndex = 0; quizCurrentIndex = 0; renderCard(); generateQuizQuestion(); resetQuizUI();
        }
        function toggleLanguage(forceUpdate = false) {
            const btn = document.getElementById('lang-btn');
            
            // If just updating UI to match variable (e.g. at startup)
            if(forceUpdate) {
                btn.classList.remove('secondary', 'lang-canto', 'lang-lihkg');
                if (aiLanguage === 'cantonese') { btn.innerText = "üåê Lang: Canto"; btn.classList.add('lang-canto'); }
                else if (aiLanguage === 'lihkg') { btn.innerText = "üåê Lang: LIHKG"; btn.classList.add('lang-lihkg'); }
                else { btn.innerText = "üåê Lang: English"; btn.classList.add('secondary'); }
                return;
            }

            // Normal Toggle Logic
            btn.classList.remove('secondary', 'lang-canto', 'lang-lihkg');
            if (aiLanguage === 'english') { aiLanguage = 'cantonese'; btn.innerText = "üåê Lang: Canto"; btn.classList.add('lang-canto'); } 
            else if (aiLanguage === 'cantonese') { aiLanguage = 'lihkg'; btn.innerText = "üåê Lang: LIHKG"; btn.classList.add('lang-lihkg'); } 
            else { aiLanguage = 'english'; btn.innerText = "üåê Lang: English"; btn.classList.add('secondary'); }
        }
        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if (isMuted) { window.speechSynthesis.cancel(); btn.innerText = "üîá Audio: Off"; btn.classList.add('muted'); btn.classList.remove('secondary'); } 
            else { btn.innerText = "üîä Audio: On"; btn.classList.remove('muted'); btn.classList.add('secondary'); }
        }
        function speakText(text, langCode = 'en', forceSelected = false) {
            if (isMuted) return;
            window.speechSynthesis.cancel();
            let targetLang = langCode;
            if ((aiLanguage === 'cantonese' || aiLanguage === 'lihkg') && langCode !== 'en') { targetLang = 'zh-HK'; }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = targetLang; utterance.rate = 0.95;
            const voices = window.speechSynthesis.getVoices();
            if (selectedVoiceURI && !forceSelected) {
                const preferred = voices.find(v => v.voiceURI === selectedVoiceURI);
                if(preferred) utterance.voice = preferred;
            } else if (voices.length > 0) {
                const bestMatch = voices.find(v => v.lang.includes(targetLang) && (v.name.includes("Enhanced") || v.name.includes("Siri")));
                if(bestMatch) utterance.voice = bestMatch;
            }
            window.speechSynthesis.speak(utterance);
        }
        function renderCard() {
            if(drugList.length === 0) return;
            const drug = drugList[currentIndex];
            fillCardData('fc', drug);
            document.getElementById('counter').innerText = `${currentIndex + 1} / ${drugList.length}`;
            resetAIUI('fc-ai-case', 'btn-case', 'btn-read-case');
        }
        function fillCardData(prefix, drug) {
            document.getElementById(`${prefix}-name`).innerText = drug.name || "N/A";
            document.getElementById(`${prefix}-class`).innerText = drug.class || "N/A";
            document.getElementById(`${prefix}-indication`).innerText = drug.indication || "N/A";
            document.getElementById(`${prefix}-SideEffects`).innerText = drug.SideEffects || "N/A";
            document.getElementById(`${prefix}-nursing`).innerText = drug.nursing || "N/A";
        }
        function resetAIUI(boxId, btnId, readBtnId) {
            document.getElementById(boxId).style.display = 'none'; document.getElementById(boxId).innerHTML = '';
            document.getElementById(readBtnId).style.display = 'none';
            const btn = document.getElementById(btnId); btn.disabled = false; btn.innerHTML = 'üè• AI: Generate Integrated Patient Case';
        }
        function flipCard(event) {
            if (event && (event.target.tagName === 'BUTTON' || event.target.closest('button'))) return;
            document.getElementById('flashcard').classList.toggle('flipped'); window.speechSynthesis.cancel();
        }
        function nextCard() { if (currentIndex < drugList.length - 1) { currentIndex++; document.getElementById('flashcard').classList.remove('flipped'); renderCard(); } }
        function prevCard() { if (currentIndex > 0) { currentIndex--; document.getElementById('flashcard').classList.remove('flipped'); renderCard(); } }
        function readAIContent(id) { const el = document.getElementById(id); const lang = (aiLanguage === 'cantonese' || aiLanguage === 'lihkg') ? 'zh-HK' : 'en'; if(el) speakText(el.innerText, lang); }
        async function callOpenRouterAPI(messages) {
            if(!openRouterKey) throw new Error("Key Missing");
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST", headers: { "Authorization": `Bearer ${openRouterKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "xiaomi/mimo-v2-flash:free", messages: messages })
            });
            const data = await response.json(); return data.choices[0].message.content;
        }
        async function callDeepSeekAPI(messages) {
            if(!deepSeekKey) throw new Error("Key Missing");
            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST", headers: { "Authorization": `Bearer ${deepSeekKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "deepseek-chat", messages: messages })
            });
            const data = await response.json(); return data.choices[0].message.content;
        }
        async function getAIResponse(prompt) {
            const messages = [{ role: "user", content: prompt }];
            return (currentProvider === 'deepseek') ? await callDeepSeekAPI(messages) : await callOpenRouterAPI(messages);
        }
        function getRoleInstruction() {
            if (aiLanguage === 'cantonese') return "Response in Traditional Chinese (Cantonese). English for medical terms only.";
            if (aiLanguage === 'lihkg') return "Response in Traditional Chinese with HK Slang (LIHKG style).";
            return "Response in English.";
        }
        async function askClinicalMentor() {
            const input = document.getElementById('ask-input').value; if(!input) return;
            const btn = document.getElementById('btn-ask-submit'); const box = document.getElementById('ask-response-box'); const readBtn = document.getElementById('btn-read-ask');
            btn.innerHTML = '<span class="loading-spinner"></span> Thinking...'; btn.disabled = true; box.style.display = 'block'; box.innerHTML = "Generating...";
            const prompt = `Role: Clinical Educator. Input: "${input}". 1. Pathophysiology analogy. 2. Nursing actions. Keep short. ${getRoleInstruction()}`;
            try { const content = await getAIResponse(prompt); box.innerHTML = marked.parse(content); btn.innerHTML = 'üí° Ask Mentor'; btn.disabled = false; readBtn.style.display = 'block'; } 
            catch (e) { box.innerHTML = `Error: ${e.message}`; btn.disabled = false; }
        }
        async function getIntegratedCaseStudy(drugObj, boxId, btnId, readBtnId) {
            const btn = document.getElementById(btnId); const box = document.getElementById(boxId); const readBtn = document.getElementById(readBtnId);
            btn.innerHTML = '<span class="loading-spinner"></span> Simulating...'; btn.disabled = true; box.style.display = 'block';
            const prompt = `Drug: ${drugObj.name}. Create clinical case study. Patient profile, indication, other meds, specific nursing action. ${getRoleInstruction()}`;
            try { const content = await getAIResponse(prompt); box.innerHTML = marked.parse(content); btn.innerHTML = '‚úÖ Case Loaded'; readBtn.style.display = 'block'; } 
            catch (e) { box.innerHTML = `Error: ${e.message}`; btn.disabled = false; }
        }
        async function triggerQuizExplain() {
            const btn = document.getElementById('btn-quiz-explain'); const box = document.getElementById('ai-content'); const container = document.getElementById('ai-container'); const readBtn = document.getElementById('btn-read-explain');
            btn.innerHTML = '<span class="loading-spinner"></span> Thinking...'; btn.disabled = true; container.style.display = 'block'; box.innerHTML = 'Analyzing...';
            const prompt = `Explain quiz. Q: "${currentQuizData.q}". Answered: "${currentQuizData.u}". Correct: "${currentQuizData.correctAnswerText}". Drug: ${currentQuizData.c.name}. ${getRoleInstruction()}`;
            try { const content = await getAIResponse(prompt); box.innerHTML = marked.parse(content); btn.innerHTML = '‚úÖ Explained'; readBtn.style.display = 'block'; } 
            catch (e) { box.innerHTML = `Error: ${e.message}`; }
        }
        function resetQuizUI() {
            document.getElementById('next-quiz-btn').style.display = 'none'; document.getElementById('ai-container').style.display = 'none';
            document.getElementById('btn-read-explain').style.display = 'none'; document.getElementById('btn-quiz-explain').style.display = 'none';
            document.getElementById('btn-quiz-explain').innerHTML = 'ü§ñ Explain Why'; document.getElementById('btn-quiz-explain').disabled = false;
        }
        function generateQuizQuestion() {
            resetQuizUI();
            const container = document.getElementById('quiz-options'); const qEl = document.getElementById('quiz-question'); container.innerHTML = '';
            if (drugList.length === 0) { qEl.innerText = "No drugs loaded."; return; }
            if (quizCurrentIndex >= drugList.length) { qEl.innerText = "Quiz Complete!"; return; }
            const correctDrug = drugList[quizCurrentIndex];
            const qType = Math.floor(Math.random() * 4);
            let qText = "", correctText = "", optionType = ""; 
            switch (qType) {
                case 0: qText = `Which drug is indicated for: "${correctDrug.indication}"?`; correctText = correctDrug.name; optionType = 'name'; break;
                case 1: qText = `Which drug belongs to class: "${correctDrug.class}"?`; correctText = correctDrug.name; optionType = 'name'; break;
                case 2: qText = `Primary indication for: "${correctDrug.name}"?`; correctText = correctDrug.indication; optionType = 'indication'; break;
                case 3: qText = `Drug class of: "${correctDrug.name}"?`; correctText = correctDrug.class; optionType = 'class'; break;
            }
            qEl.innerText = qText;
            const otherDrugs = drugList.filter(d => d.name !== correctDrug.name);
            const shuffledOthers = otherDrugs.sort(() => Math.random() - 0.5);
            let wrongOptions = [];
            for (let d of shuffledOthers) {
                const text = d[optionType];
                if (text && text !== correctText && !wrongOptions.includes(text)) { wrongOptions.push(text); }
                if (wrongOptions.length === 3) break;
            }
            while(wrongOptions.length < 3) { wrongOptions.push("N/A"); }
            let optionsArr = [correctText, ...wrongOptions].sort(() => Math.random() - 0.5);
            optionsArr.forEach(optText => {
                const btn = document.createElement('button'); btn.className = 'option-btn'; btn.innerText = optText;
                btn.onclick = () => checkAnswer(btn, optText, correctText, correctDrug, qText);
                container.appendChild(btn);
            });
        }
        function checkAnswer(btn, selectedText, correctText, correctDrug, qText) {
            const btns = document.querySelectorAll('.option-btn'); btns.forEach(b => b.onclick = null);
            let speakPhrase = "";
            if (selectedText === correctText) { btn.classList.add('correct'); speakPhrase = "Correct!"; } 
            else { btn.classList.add('wrong'); btns.forEach(b => { if(b.innerText === correctText) b.classList.add('correct'); }); speakPhrase = "Incorrect."; }
            speakText(speakPhrase, 'en');
            document.getElementById('next-quiz-btn').style.display = 'block'; document.getElementById('btn-quiz-explain').style.display = 'block';
            currentQuizData = { q: qText, u: selectedText, c: correctDrug, correctAnswerText: correctText };
        }
        function nextQuestion() { quizCurrentIndex++; generateQuizQuestion(); }
        function switchMode(mode) {
            document.getElementById('flashcard-section').style.display = 'none'; document.getElementById('quiz-section').style.display = 'none'; document.getElementById('ask-section').style.display = 'none';
            document.getElementById('mode-flashcard').classList.remove('mode-active', 'secondary'); document.getElementById('mode-flashcard').classList.add('secondary');
            document.getElementById('mode-quiz').classList.remove('mode-active', 'secondary'); document.getElementById('mode-quiz').classList.add('secondary');
            document.getElementById('mode-ask').classList.remove('mode-active', 'secondary'); document.getElementById('mode-ask').classList.add('secondary');
            if (mode === 'flashcard') { document.getElementById('flashcard-section').style.display = 'block'; document.getElementById('mode-flashcard').classList.add('mode-active'); document.getElementById('mode-flashcard').classList.remove('secondary'); }
            else if (mode === 'quiz') { document.getElementById('quiz-section').style.display = 'block'; document.getElementById('mode-quiz').classList.add('mode-active'); document.getElementById('mode-quiz').classList.remove('secondary'); if(quizCurrentIndex === 0) generateQuizQuestion(); }
            else if (mode === 'ask') { document.getElementById('ask-section').style.display = 'block'; document.getElementById('mode-ask').classList.add('mode-active'); document.getElementById('mode-ask').classList.remove('secondary'); }
            window.speechSynthesis.cancel();
        }

        init();
    </script>
</body>
</html>
