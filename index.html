<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Drug Tutor">
    <meta name="theme-color" content="#F2F2F7">

    <title>AI Drug Tutor Pro</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // Dynamic Icon Generation (Professional Blue Gradient)
        (function() {
            const svgSource = `
            <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#00C6FB;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#005BEA;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="512" height="512" rx="110" fill="url(#grad1)"/>
                <path d="M368 160H144C126.3 160 112 174.3 112 192V320C112 337.7 126.3 352 144 352H368C385.7 352 400 337.7 400 320V192C400 174.3 385.7 160 368 160ZM256 312C233.9 312 216 294.1 216 272C216 249.9 233.9 232 256 232C278.1 232 296 249.9 296 272C296 294.1 278.1 312 256 312ZM352 208H296V200C296 195.6 292.4 192 288 192H224C219.6 192 216 195.6 216 200V208H160C155.6 208 152 204.4 152 200V192C152 174.3 166.3 160 184 160H328C345.7 160 360 174.3 360 192V200C360 204.4 356.4 208 352 208Z" fill="white" opacity="0.9"/>
                <path d="M190 272H322" stroke="white" stroke-width="40" stroke-linecap="round"/>
                <path d="M256 206V338" stroke="white" stroke-width="40" stroke-linecap="round"/>
            </svg>`;
            
            function setLink(rel, href) {
                let link = document.querySelector(`link[rel="${rel}"]`) || document.createElement('link');
                link.rel = rel; link.href = href; document.head.appendChild(link);
            }

            const img = new Image();
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgSource);
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                canvas.getContext('2d').drawImage(img, 0, 0);
                const pngUrl = canvas.toDataURL('image/png');
                setLink('apple-touch-icon', pngUrl);
                setLink('icon', pngUrl);
            };
        })();
    </script>

    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-gray-bg: #F2F2F7;
            --ios-card-bg: #FFFFFF;
            --ios-text: #000000;
            --ios-text-sec: #8E8E93;
            --ios-border: #E5E5EA;
            --ios-separator: #C6C6C8;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-indigo: #5856D6;
            
            /* Dynamic Safe Areas */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ios-gray-bg: #000000;
                --ios-card-bg: #1C1C1E;
                --ios-text: #FFFFFF;
                --ios-text-sec: #98989D;
                --ios-border: #38383A;
                --ios-separator: #38383A;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background-color: var(--ios-gray-bg);
            color: var(--ios-text);
            margin: 0; padding: 0;
            padding-bottom: calc(var(--safe-bottom) + 80px); /* Extra space for bottom actions */
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER --- */
        .app-header {
            position: sticky; top: 0; z-index: 99;
            background: rgba(242, 242, 247, 0.85); /* Light translucent */
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 0.5px solid var(--ios-separator);
            padding: calc(var(--safe-top) + 10px) 16px 10px 16px;
            display: flex; justify-content: space-between; align-items: center;
        }
        @media (prefers-color-scheme: dark) {
            .app-header { background: rgba(28, 28, 30, 0.85); }
        }

        .header-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }

        .icon-btn {
            background: rgba(118, 118, 128, 0.12);
            border: none; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(118, 118, 128, 0.24); }

        /* --- SEARCH --- */
        .search-container { padding: 10px 16px 5px 16px; background: transparent; }
        .search-wrapper { position: relative; width: 100%; }
        .search-bar {
            width: 100%; padding: 10px 12px 10px 36px; border-radius: 10px; border: none;
            background: rgba(118, 118, 128, 0.12); font-size: 17px; color: var(--ios-text);
            transition: all 0.2s;
        }
        .search-bar::placeholder { color: var(--ios-text-sec); }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--ios-text-sec); font-size: 16px; }

        /* --- CHIPS --- */
        .chip-scroll-row { 
            display: flex; gap: 8px; overflow-x: auto; padding: 10px 16px; 
            scrollbar-width: none; -webkit-overflow-scrolling: touch; 
        }
        .chip-scroll-row::-webkit-scrollbar { display: none; }

        .filter-chip {
            padding: 6px 14px; border-radius: 16px; font-size: 14px; font-weight: 500;
            white-space: nowrap; flex-shrink: 0; cursor: pointer; border: none;
            background: var(--ios-card-bg); color: var(--ios-text); 
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .filter-chip.active { background: var(--ios-text); color: var(--ios-gray-bg); font-weight: 600; }
        .filter-chip:active { transform: scale(0.95); opacity: 0.8; }

        /* --- RESULTS --- */
        .results-grid { padding: 0 16px; display: flex; flex-direction: column; gap: 16px; }

        .result-card {
            background: var(--ios-card-bg); padding: 16px; border-radius: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
            transition: transform 0.1s; position: relative; overflow: hidden;
        }
        .result-card:active { transform: scale(0.98); }
        
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        
        .drug-name-main { font-size: 19px; font-weight: 700; color: var(--ios-text); line-height: 1.2; }
        .drug-class-badge { 
            font-size: 11px; font-weight: 600; text-transform: uppercase; 
            color: var(--ios-blue); background: rgba(0, 122, 255, 0.1);
            padding: 3px 8px; border-radius: 6px; margin-top: 4px; display: inline-block;
        }

        .system-tag {
            font-size: 12px; color: var(--ios-text-sec); margin-top: 4px; display: flex; align-items: center; gap: 4px;
        }

        .chevron { 
            color: var(--ios-separator); font-size: 20px; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); 
            margin-left: 10px;
        }
        .result-card.expanded .chevron { transform: rotate(90deg); color: var(--ios-blue); }

        .result-detail { 
            display: none; margin-top: 16px; padding-top: 16px; 
            border-top: 0.5px solid var(--ios-border); 
        }
        .result-card.expanded .result-detail { display: block; animation: fadeSlide 0.25s ease-out; }

        @keyframes fadeSlide { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Structured Data Display */
        .info-grid { display: grid; gap: 12px; }
        .info-item { display: flex; flex-direction: column; gap: 3px; }
        .info-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ios-text-sec); font-weight: 600; }
        .info-val { font-size: 15px; color: var(--ios-text); line-height: 1.5; }

        /* Tools */
        .tools-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 4px 0; margin-top: 16px; -webkit-overflow-scrolling: touch; }
        .tool-btn {
            padding: 8px 14px; border-radius: 18px; border: none; font-size: 13px; font-weight: 600;
            white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 6px; flex-shrink: 0;
        }
        .t-blue { background: rgba(0, 122, 255, 0.1); color: var(--ios-blue); }
        .t-indigo { background: rgba(88, 86, 214, 0.1); color: var(--ios-indigo); }
        .t-green { background: rgba(52, 199, 89, 0.1); color: var(--ios-green); }
        .t-orange { background: rgba(255, 149, 0, 0.1); color: #FF9500; }
        .t-gray { background: var(--ios-gray-bg); color: var(--ios-text); }

        /* --- SHEET MODALS (iOS Style) --- */
        .sheet-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 1000; backdrop-filter: blur(2px);
            align-items: flex-end;
        }
        .sheet-modal {
            background: var(--ios-card-bg); width: 100%; max-width: 600px; margin: 0 auto;
            border-radius: 20px 20px 0 0; padding: 0; box-sizing: border-box;
            max-height: 90vh; display: flex; flex-direction: column;
            animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .sheet-handle-area { width: 100%; padding: 12px; display: flex; justify-content: center; }
        .sheet-handle { width: 40px; height: 5px; background: var(--ios-separator); border-radius: 10px; opacity: 0.5; }

        .sheet-content { padding: 0 20px 30px 20px; overflow-y: auto; }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-size: 20px; font-weight: 700; margin: 0; }
        
        .close-txt { font-size: 16px; color: var(--ios-blue); font-weight: 600; background: none; border: none; padding: 0; }

        /* Forms inside Sheets */
        .form-label { font-size: 13px; font-weight: 600; color: var(--ios-text-sec); margin-bottom: 6px; display: block; text-transform: uppercase; }
        .form-input {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--ios-border);
            background: var(--ios-gray-bg); font-size: 16px; color: var(--ios-text); margin-bottom: 16px;
            font-family: inherit; resize: none;
        }
        .form-input:focus { border-color: var(--ios-blue); background: var(--ios-card-bg); }

        .big-btn {
            width: 100%; padding: 16px; border-radius: 14px; border: none;
            background: var(--ios-blue); color: white; font-size: 17px; font-weight: 600;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            margin-top: 10px; transition: opacity 0.2s;
        }
        .big-btn:active { opacity: 0.7; }
        .big-btn.secondary { background: var(--ios-gray-bg); color: var(--ios-text); }

        /* AI Output Area */
        .ai-box {
            background: var(--ios-gray-bg); border-radius: 12px; padding: 16px; margin-top: 16px;
            font-size: 15px; line-height: 1.6; color: var(--ios-text); display: none;
        }
        .ai-box table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
        .ai-box th { text-align: left; border-bottom: 1px solid var(--ios-separator); color: var(--ios-text-sec); padding: 5px; }
        .ai-box td { padding: 6px 5px; border-bottom: 1px solid var(--ios-border); }

        .spinner {
            width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Skeleton */
        .sk-card { height: 90px; background: var(--ios-card-bg); border-radius: 14px; margin-bottom: 16px; position: relative; overflow: hidden; }
        .sk-shimmer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(128,128,128,0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    </style>
</head>
<body>

<div class="app-header">
    <div style="display:flex; align-items:center; gap:8px;">
        <div style="width:30px; height:30px; background:linear-gradient(135deg, #00C6FB, #005BEA); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px;">üíä</div>
        <div class="header-title">Drug Tutor</div>
    </div>
    <div style="display:flex; gap:12px;">
        <button onclick="toggleGen()" class="icon-btn" style="width:auto; padding:0 12px; border-radius:18px; color:var(--ios-blue); font-weight:600; font-size:13px; background:rgba(0,122,255,0.1);">
            ü¶† Disease ‚Üí Rx
        </button>
        <button onclick="toggleVS()" class="icon-btn" style="color:var(--ios-indigo);">üÜö</button>
        <button onclick="toggleSettings()" class="icon-btn" style="color:var(--ios-text-sec);">‚öôÔ∏è</button>
    </div>
</div>

<div class="search-container">
    <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="search-input" class="search-bar" placeholder="Search drugs, classes..." oninput="handleSearch()" onfocus="handleSearch()">
    </div>
</div>

<div id="system-chips" class="chip-scroll-row"></div>

<div id="loading-skeleton" style="padding:16px;">
    <div class="sk-card"><div class="sk-shimmer"></div></div>
    <div class="sk-card"><div class="sk-shimmer"></div></div>
</div>

<div id="search-results" class="results-grid">
    <div id="empty-state" style="text-align:center; padding:60px 20px; color:var(--ios-text-sec); display:none;">
        <div style="font-size:40px; margin-bottom:10px; opacity:0.3;">ü©∫</div>
        <div>Start typing or select a system<br>to browse the formulary.</div>
    </div>
</div>

<div id="settings-overlay" class="sheet-overlay" onclick="if(event.target===this) toggleSettings()">
    <div class="sheet-modal">
        <div class="sheet-handle-area"><div class="sheet-handle"></div></div>
        <div class="sheet-content">
            <div class="sheet-header">
                <div class="sheet-title">Settings</div>
                <button class="close-txt" onclick="saveSettings()">Done</button>
            </div>

            <span class="form-label">AI Persona</span>
            <div onclick="toggleLanguage()" style="background:var(--ios-gray-bg); padding:14px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                <span>Speaking Style</span>
                <span id="lang-display" style="color:var(--ios-blue); font-weight:600;">LIHKG Mode</span>
            </div>

            <span class="form-label">AI Provider</span>
            <select id="provider-select" onchange="updateSettingsUI()" class="form-input" style="appearance:none;">
                <option value="yinli">Yinli (GPT-5.1)</option>
                <option value="deepseek">DeepSeek (Standard)</option>
            </select>

            <div id="settings-dynamic-fields"></div>
            
            <button onclick="fetchSheetData()" class="big-btn secondary">üîÑ Reload Database</button>
        </div>
    </div>
</div>

<div id="vs-overlay" class="sheet-overlay" onclick="if(event.target===this) toggleVS()">
    <div class="sheet-modal">
        <div class="sheet-handle-area"><div class="sheet-handle"></div></div>
        <div class="sheet-content">
            <div class="sheet-header">
                <div class="sheet-title">Compare Drugs</div>
                <button class="close-txt" onclick="toggleVS()">Close</button>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center;">
                <div style="flex:1;">
                    <span class="form-label">Drug A</span>
                    <input type="text" id="vs-input-a" class="form-input" placeholder="e.g. Panadol" style="margin-bottom:0;">
                </div>
                <div style="font-weight:800; color:var(--ios-text-sec); font-size:12px;">VS</div>
                <div style="flex:1;">
                    <span class="form-label">Drug B</span>
                    <input type="text" id="vs-input-b" class="form-input" placeholder="e.g. Brufen" style="margin-bottom:0;">
                </div>
            </div>

            <button id="btn-compare" class="big-btn" onclick="triggerCompare()">‚öîÔ∏è Compare</button>
            <div id="vs-result-area" class="ai-box"></div>
        </div>
    </div>
</div>

<div id="gen-overlay" class="sheet-overlay" onclick="if(event.target===this) toggleGen()">
    <div class="sheet-modal">
        <div class="sheet-handle-area"><div class="sheet-handle"></div></div>
        <div class="sheet-content">
            <div class="sheet-header">
                <div class="sheet-title">Protocol & Rx Guide</div>
                <button class="close-txt" onclick="toggleGen()">Close</button>
            </div>
            
            <p style="color:var(--ios-text-sec); font-size:14px; margin-top:0;">
                Enter a disease or condition. AI will suggest standard HA formulary drugs and precautions.
            </p>

            <span class="form-label">Disease / Condition</span>
            <input type="text" id="gen-input" class="form-input" placeholder="e.g. CAP Pneumonia, Atrial Fibrillation...">

            <button id="btn-gen" class="big-btn" onclick="triggerGen()">
                ‚ú® Get Treatment Protocol
            </button>

            <div id="gen-result-area" class="ai-box"></div>
        </div>
    </div>
</div>

<div id="edit-overlay" class="sheet-overlay" onclick="if(event.target===this) toggleEditOverlay()">
    <div class="sheet-modal">
        <div class="sheet-handle-area"><div class="sheet-handle"></div></div>
        <div class="sheet-content">
            <div class="sheet-header">
                <div class="sheet-title">Edit Entry</div>
                <button class="close-txt" onclick="toggleEditOverlay()">Cancel</button>
            </div>
            <p id="edit-drug-name-disp" style="font-weight:700; font-size:18px; margin-bottom:10px;"></p>
            <textarea id="edit-input" class="form-input" style="height:120px;" placeholder="Tell AI what to fix (e.g., 'Add nausea to side effects')."></textarea>
            <button id="btn-edit-submit" class="big-btn" onclick="submitAIEdit()">‚ú® Auto-Update</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const DB_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";
    const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxyNPyjbVXDMTQxFPxEuuCDTNNf-iVFfqedfNbh-kgn6Tk9rSIFEfIaLWXxXZoNOVnWug/exec";

    // --- STATE ---
    let drugs = [];
    let aiLanguage = 'lihkg';
    let provider = 'yinli';
    let keys = { deepseek: "sk-92db3cf721454bd7b351ca6ef40eaaf7", yinli: "" };
    let yinliUrl = "https://yinli.one/v1/chat/completions";
    let currentEditDrug = null;

    // --- SYSTEMS ---
    const systems = [
        {id: "GI", name: "üçΩÔ∏è Gastro"}, {id: "CVS", name: "ü´Ä Cardio"},
        {id: "Resp", name: "ü´Å Resp"}, {id: "CNS", name: "üß† CNS"},
        {id: "Inf", name: "ü¶† Infect"}, {id: "Endo", name: "ü¶ã Endo"},
        {id: "Pain", name: "üíä Pain"}, {id: "Emerg", name: "üö® Emerg"}
    ];

    // --- INIT ---
    function init() {
        if(localStorage.getItem('ai_provider')) provider = localStorage.getItem('ai_provider');
        if(localStorage.getItem('ds_key')) keys.deepseek = localStorage.getItem('ds_key');
        if(localStorage.getItem('yl_key')) keys.yinli = localStorage.getItem('yl_key');
        
        updateSettingsUI();
        renderSystemChips();
        fetchSheetData(true);
        
        // Restore search
        const lastSearch = localStorage.getItem('last_search_term');
        if(lastSearch) {
            document.getElementById('search-input').value = lastSearch;
        }
    }

    // --- DATA FETCHING ---
    function fetchSheetData(silent = false) {
        const loading = document.getElementById('loading-skeleton');
        const results = document.getElementById('search-results');
        
        // Load Cache
        const localData = localStorage.getItem('drug_db_cache');
        if (localData) {
            drugs = JSON.parse(localData);
            loading.style.display = 'none';
            if(document.getElementById('search-input').value) handleSearch();
        }

        // Fetch Fresh
        fetch(DB_URL).then(r=>r.text()).then(csv=>{
            Papa.parse(csv, {header:true, skipEmptyLines:true, complete:res=>{
                if(res.data.length){ 
                    drugs = res.data;
                    localStorage.setItem('drug_db_cache', JSON.stringify(drugs));
                    loading.style.display = 'none';
                    if(!localData && !silent) handleSearch();
                }
            }});
        }).catch(e => { if(!localData && !silent) alert("Offline Mode"); });
    }

    // --- RENDERING ---
    function renderSystemChips() {
        const c = document.getElementById('system-chips');
        c.innerHTML = `<button class="filter-chip active" onclick="filterBySystem('All', this)">All</button>`;
        systems.forEach(s => { c.innerHTML += `<button class="filter-chip" onclick="filterBySystem('${s.name.split(' ')[1]}', this)">${s.name}</button>`; });
    }

    function filterBySystem(term, btn) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('search-input').value = '';
        
        const container = document.getElementById('search-results');
        container.innerHTML = '';
        
        const subset = (term === 'All') ? drugs : drugs.filter(d => (d.system || "").includes(term) || (d.class || "").includes(term));
        if(subset.length === 0) document.getElementById('empty-state').style.display = 'block';
        else subset.slice(0, 50).forEach(d => renderCard(d, container));
    }

    function handleSearch() {
        const q = document.getElementById('search-input').value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        container.innerHTML = '';
        
        if(!q) { document.getElementById('empty-state').style.display = 'block'; return; }
        document.getElementById('empty-state').style.display = 'none';

        const matches = drugs.filter(d => (d.name+d.class+d.indication).toLowerCase().includes(q));
        
        if (matches.length > 0) {
            matches.forEach(d => renderCard(d, container));
        } else {
            container.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <div style="color:var(--ios-text-sec);">Not found locally.</div>
                    <button class="big-btn" onclick="triggerAISearchAndGenerate('${q}')" style="margin-top:15px;">
                        ‚ú® Ask AI Pharmacist
                    </button>
                </div>`;
        }
    }

    // --- MAIN CARD RENDER FUNCTION ---
    function renderCard(d, container) {
        const div = document.createElement('div');
        div.className = 'result-card';
        const uniqueId = `ai-${Math.random().toString(36).substr(2, 9)}`;
        const drugStr = JSON.stringify(d).replace(/"/g, '&quot;');
        
        let alertHtml = '';
        if(d.hold_param) alertHtml = `<div style="background:rgba(255,59,48,0.1); color:var(--ios-red); padding:10px; border-radius:8px; font-weight:700; font-size:13px; margin-bottom:12px;">‚õîÔ∏è HOLD IF: ${d.hold_param}</div>`;

        div.innerHTML = `
            <div class="card-top">
                <div style="flex:1;">
                    <div class="drug-name-main">${d.name}</div>
                    <span class="drug-class-badge">${d.class}</span>
                    <div class="system-tag">${d.system || ''}</div>
                </div>
                <div style="display:flex; align-items:center;">
                    <button onclick="event.stopPropagation(); speakText('${d.name}. ${d.indication}')" style="background:none; border:none; font-size:18px; cursor:pointer; color:var(--ios-blue);">üîä</button>
                    <div class="chevron">‚Ä∫</div>
                </div>
            </div>
            
            <div class="result-detail">
                ${alertHtml}
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Indication</span>
                        <span class="info-val">${d.indication}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Nursing Considerations</span>
                        <span class="info-val">${d.nursing}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Side Effects</span>
                        <span class="info-val" style="color:var(--ios-text-sec);">${d.SideEffects}</span>
                    </div>
                </div>

                <div class="tools-scroll">
                    <button class="tool-btn t-blue" onclick="event.stopPropagation(); handleTool('isbar', ${drugStr}, '${uniqueId}')">üöë ISBAR</button>
                    <button class="tool-btn t-indigo" onclick="event.stopPropagation(); handleTool('explain', ${drugStr}, '${uniqueId}')">üéì Explain</button>
                    <button class="tool-btn t-green" onclick="event.stopPropagation(); handleTool('cheat', ${drugStr}, '${uniqueId}')">üìã CheatSheet</button>
                    <button class="tool-btn t-orange" onclick="event.stopPropagation(); triggerEditPrompt(${drugStr})">‚úèÔ∏è Edit</button>
                </div>
                <div id="${uniqueId}" class="ai-box"></div>
            </div>
        `;
        div.onclick = (e) => { 
            if(!e.target.closest('button') && !e.target.closest('input')) div.classList.toggle('expanded'); 
        };
        container.appendChild(div);
    }

    // --- AI TOOLS LOGIC ---
    function handleTool(action, drugObj, id) {
        const out = document.getElementById(id);
        out.style.display = 'block';
        out.innerHTML = 'Thinking...';
        
        const hkPersona = "You are a seasoned Hong Kong HA Nursing Senior (Old Seafood). Speak in LIHKG style (Cantonese/English Mix). Be strict about patient safety.";
        let prompt = "";
        
        if (action === 'isbar') prompt = `System: ${hkPersona}. Write a nursing ISBAR handover for ${drugObj.name} assuming a patient emergency (e.g. Desat).`;
        if (action === 'explain') prompt = `System: ${hkPersona}. Explain ${drugObj.name} to a Year 1 student using a funny analogy.`;
        if (action === 'cheat') prompt = `System: ${hkPersona}. Create a Markdown 'Ward Survival Guide' for ${drugObj.name}. Sections: STOP Checks, Monitoring, Red Flags.`;

        streamAI(prompt, (txt) => { out.innerHTML = marked.parse(txt); });
    }

    // --- DISEASE -> RX LOGIC (UPDATED HA SCRIPT) ---
    function toggleGen() { 
        const el = document.getElementById('gen-overlay');
        el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    async function triggerGen() {
        const input = document.getElementById('gen-input').value.trim();
        const res = document.getElementById('gen-result-area');
        const btn = document.getElementById('btn-gen');
        
        if(!input) return;
        
        btn.innerHTML = '<div class="spinner"></div> Processing...';
        res.style.display = 'block';
        res.innerHTML = "Consulting HA Guidelines...";
        
        // REFRAMED PROMPT
        const prompt = `Act as a Hong Kong Hospital Authority (HA) Pharmacist.
        The user asks about the condition: "${input}".
        
        Task: Provide a "Treatment Protocol" table.
        1. Suggest the standard HA formulary drugs for this condition.
        2. List standard dosages.
        3. Add specific "Nurse Alerts" (LIHKG Style - cantonese/english mix).
        
        Format: Markdown Table.
        | Drug | Route/Dose | Nursing Alert (HK Style) |
        |---|---|---|
        
        After the table, give one "Old Seafood" tip about managing this patient type.`;

        await streamAI(prompt, (txt) => { res.innerHTML = marked.parse(txt); });
        btn.innerHTML = '‚ú® Get Treatment Protocol';
    }

    // --- GENERIC AI API ---
    async function streamAI(prompt, onChunk) {
        let url = "https://api.deepseek.com/chat/completions";
        let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${keys.deepseek}` };
        let body = { model: "deepseek-chat", messages: [{role:"user", content: prompt}], stream: true };
        
        if(provider === 'yinli') { 
            url = yinliUrl; headers["Authorization"] = `Bearer ${keys.yinli}`; body.model = "gpt-5.1"; 
        }

        try {
            const response = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, {stream: true});
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        try {
                            const json = JSON.parse(line.substring(6));
                            fullText += json.choices[0]?.delta?.content || "";
                            onChunk(fullText);
                        } catch (e) {}
                    }
                }
            }
        } catch(e) { onChunk("Error: " + e.message); }
    }

    // --- VS & EDIT UTILS ---
    function toggleVS() { const el = document.getElementById('vs-overlay'); el.style.display = (el.style.display==='flex')?'none':'flex'; }
    function toggleEditOverlay() { const el = document.getElementById('edit-overlay'); el.style.display = (el.style.display==='flex')?'none':'flex'; }
    function toggleSettings() { const el = document.getElementById('settings-overlay'); el.style.display = (el.style.display==='flex')?'none':'flex'; }
    
    function triggerEditPrompt(d) { currentEditDrug = d; document.getElementById('edit-drug-name-disp').innerText = d.name; toggleEditOverlay(); }
    
    async function submitAIEdit() {
        const inst = document.getElementById('edit-input').value;
        const btn = document.getElementById('btn-edit-submit');
        btn.innerText = "Updating...";
        
        const prompt = `Edit this JSON: ${JSON.stringify(currentEditDrug)}. Instructions: ${inst}. Return ONLY valid JSON.`;
        
        // Simulating non-streaming response for Edit (simplified)
        await streamAI(prompt, (txt) => {
             // Logic to parse JSON and save would go here (omitted for brevity in UI demo)
             if(txt.includes('}')) { alert("Edit generated (See console for JSON)"); console.log(txt); toggleEditOverlay(); }
        });
        btn.innerText = "‚ú® Auto-Update";
    }

    async function triggerCompare() {
        const a = document.getElementById('vs-input-a').value;
        const b = document.getElementById('vs-input-b').value;
        const res = document.getElementById('vs-result-area');
        if(!a || !b) return;
        
        res.style.display='block'; res.innerHTML = "Comparing...";
        const prompt = `Compare ${a} vs ${b} for a nurse. Markdown Table format. Focus on Clinical Differences.`;
        await streamAI(prompt, (txt) => { res.innerHTML = marked.parse(txt); });
    }

    function toggleLanguage() {
        const el = document.getElementById('lang-display');
        aiLanguage = (aiLanguage === 'lihkg') ? 'english' : 'lihkg';
        el.innerText = (aiLanguage === 'lihkg') ? "LIHKG Mode" : "English Mode";
    }
    
    function saveSettings() {
        const p = document.getElementById('provider-select').value;
        localStorage.setItem('ai_provider', p);
        toggleSettings();
        location.reload(); 
    }

    function updateSettingsUI() {
        const p = document.getElementById('provider-select').value;
        const c = document.getElementById('settings-dynamic-fields');
        c.innerHTML = (p === 'yinli') 
            ? `<span class="form-label">Yinli Key</span><input type="password" id="yinli-key" class="form-input" value="${keys.yinli}" onchange="localStorage.setItem('yl_key', this.value)">`
            : `<span class="form-label">DeepSeek Key</span><input type="password" id="deepseek-key" class="form-input" value="${keys.deepseek}" onchange="localStorage.setItem('ds_key', this.value)">`;
    }

    function speakText(txt) {
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-GB';
        window.speechSynthesis.speak(u);
    }

    // Run
    init();
</script>
</body>
</html>
