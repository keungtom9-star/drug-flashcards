<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Drug Tutor Ultimate (SRS + Cloud + AI)</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338ca;
            --secondary: #10B981;
            --accent: #F43F5E;
            --surface: #ffffff;
            --background: #F3F4F6;
            --text-main: #111827;
            --text-muted: #6B7280;
            --radius: 16px;
            
            /* SRS Colors */
            --srs-again: #ef4444;
            --srs-hard: #f59e0b;
            --srs-good: #10b981;
            --srs-easy: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 40px 20px; line-height: 1.6;
        }

        h1 {
            color: var(--text-main); margin-bottom: 5px; text-align: center;
            font-weight: 800; font-size: 2.2rem; display: flex; align-items: center; gap: 15px;
        }

        .app-logo { height: 45px; width: 45px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* Stats Bar */
        .stats-bar {
            display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-muted);
            background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px;
            margin-bottom: 20px; border: 1px solid #e5e7eb; align-items: center;
        }
        .stat-item strong { color: var(--primary); }
        .sync-status { font-size: 0.75rem; display: flex; align-items: center; gap: 5px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .sync-dot.active { background: #f59e0b; animation: pulse 1s infinite; }
        .sync-dot.done { background: #10b981; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Controls */
        .top-bar {
            display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; width: 100%; max-width: 850px;
            background: var(--surface); padding: 15px; border-radius: var(--radius);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; flex-wrap: wrap;
        }

        button {
            padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer;
            font-weight: 600; transition: all 0.2s ease; font-size: 0.9rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .mode-active { background-color: var(--primary); color: white; }
        .secondary { background-color: white; color: var(--text-main); border: 1px solid #d1d5db; }
        .secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .lang-lihkg { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); color: white; }
        .muted { background-color: var(--accent); color: white; }

        /* Settings */
        #settings-panel {
            display: none; background: var(--surface); padding: 30px;
            border-radius: var(--radius); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            margin-bottom: 30px; width: 100%; max-width: 600px;
            border: 1px solid #e5e7eb; box-sizing: border-box; animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .settings-label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-main); }
        .settings-input, select {
            width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px;
            margin-bottom: 15px; box-sizing: border-box; font-family: inherit; font-size: 0.95rem;
        }

        /* Flashcards */
        #app-container { width: 100%; max-width: 650px; perspective: 1000px; }
        
        .flashcard-container {
            width: 100%; height: 720px; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .flashcard-container.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 24px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            background-color: var(--surface); display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 30px; box-sizing: border-box;
            text-align: center; border: 1px solid rgba(0,0,0,0.02);
        }
        .card-front { background: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%); }
        .card-back { transform: rotateY(180deg); align-items: flex-start; text-align: left; overflow-y: auto; padding-top: 25px; }
        .card-back::-webkit-scrollbar { width: 6px; }
        .card-back::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }

        .card-title {
            font-size: 1.8rem; font-weight: 800; margin: 15px 0;
            background: -webkit-linear-gradient(45deg, var(--primary), #818cf8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .detail-row { margin-bottom: 15px; width: 100%; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        .detail-label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .detail-content { font-size: 1rem; color: var(--text-main); font-weight: 500; }

        /* SRS Controls */
        .srs-controls { margin-top: 20px; width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        .btn-reveal { width: 100%; margin-top: 25px; padding: 15px; background: var(--text-main); color: white; font-size: 1.1rem; border-radius: 12px; }
        
        .srs-btn { display: flex; flex-direction: column; align-items: center; padding: 10px 5px; font-size: 0.85rem; color: white; border: none; }
        .srs-btn span { font-size: 0.7rem; opacity: 0.8; margin-top: 2px; }
        .btn-again { background: var(--srs-again); }
        .btn-hard { background: var(--srs-hard); }
        .btn-good { background: var(--srs-good); }
        .btn-easy { background: var(--srs-easy); }

        /* AI & Search Styles */
        .ai-output-box {
            margin-top: 20px; padding: 20px; border-radius: 12px; font-size: 0.95rem;
            line-height: 1.7; background: #f0fdfa; border-left: 5px solid var(--secondary);
            display: none; width: 100%; box-sizing: border-box;
        }
        .ai-output-box h3 { margin: 15px 0 8px 0; font-size: 1.1rem; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 4px; }
        
        .quiz-container, #search-section { background: var(--surface); padding: 30px; border-radius: var(--radius); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; display: none; box-sizing: border-box; min-height: 400px; }
        .quiz-question { font-size: 1.3rem; font-weight: 700; margin-bottom: 25px; }
        
        .option-btn { background-color: #f9fafb; color: var(--text-main); text-align: left; border: 1px solid #e5e7eb; padding: 16px 20px; border-radius: 12px; margin-bottom: 10px; width: 100%; cursor: pointer; font-size: 1rem; }
        .option-btn:hover { border-color: var(--primary); background-color: #eef2ff; }
        .option-btn.correct { background-color: #ecfdf5; border-color: var(--secondary); color: #065f46; }
        .option-btn.wrong { background-color: #fef2f2; border-color: var(--accent); color: #991b1b; }

        .search-bar { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #e5e7eb; font-size: 1.1rem; margin-bottom: 20px; box-sizing: border-box; }
        .search-bar:focus { border-color: var(--primary); outline: none; }
        
        .results-grid { display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto; }
        .result-card { background: white; padding: 15px; border-radius: 12px; border: 1px solid #e5e7eb; cursor: pointer; }
        .result-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .result-detail { display: none; margin-top: 12px; border-top: 1px solid #f3f4f6; padding-top: 12px; font-size: 0.9rem; }
        .result-card.expanded .result-detail { display: block; }

        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.2); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<h1>
    <svg class="app-logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="64" height="64" rx="16" fill="#4F46E5"/>
        <path d="M32 16V48" stroke="white" stroke-width="6" stroke-linecap="round"/>
        <path d="M16 32H48" stroke="white" stroke-width="6" stroke-linecap="round"/>
        <circle cx="42" cy="22" r="6" fill="#10B981" stroke="#4F46E5" stroke-width="2"/>
    </svg>
    Integrated Drug
</h1>

<div class="stats-bar">
    <div class="stat-item">Due: <strong id="count-due">0</strong></div>
    <div class="stat-item">New: <strong id="count-new">0</strong></div>
    <div class="stat-item">Learned: <strong id="count-learned">0</strong></div>
    <div style="flex-grow:1;"></div>
    <div class="sync-status">
        <div id="sync-dot" class="sync-dot"></div>
        <span id="sync-text">Local</span>
    </div>
</div>

<div class="top-bar">
    <button id="mode-flashcard" class="mode-active" onclick="switchMode('flashcard')">Flashcards</button>
    <button id="mode-quiz" class="secondary" onclick="switchMode('quiz')">Quiz</button>
    <button id="mode-search" class="secondary" onclick="switchMode('search')">Search</button>
    <button onclick="toggleSettings()" class="secondary">‚öôÔ∏è Settings</button>
</div>

<div id="settings-panel">
    <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
        <label class="settings-label" style="margin-bottom: 10px;">‚ö° Quick Controls</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
             <button onclick="toggleDrugSet()" id="set-btn" class="secondary" style="width:100%; font-size:0.85rem;">üìö Set: Common</button>
             <button onclick="toggleLanguage()" id="lang-btn" class="lang-lihkg" style="width:100%; font-size:0.85rem;">üåê Lang: LIHKG</button>
             <button onclick="toggleMute()" id="mute-btn" class="secondary" style="grid-column: span 2; width:100%;">üîä Audio: On</button>
        </div>
    </div>

    <h3 style="margin-top:0;">‚òÅÔ∏è Cloud Progress (Google Sheets)</h3>
    <label class="settings-label">GAS Web App URL:</label>
    <input type="text" id="script-url" class="settings-input" placeholder="https://script.google.com/macros/s/..." onchange="saveSettings()">
    <button onclick="loadCloudData()" class="secondary" style="width:100%; margin-bottom:15px;">üì• Force Download from Cloud</button>

    <h3>üîä Audio Config</h3>
    <select id="tts-provider-select" onchange="updateTTSUI()">
        <option value="browser">Browser Native</option>
        <option value="azure">Azure Neural</option>
    </select>
    <div id="azure-config-group" style="display:none; background:#eff6ff; padding:10px; border-radius:8px; margin-bottom:10px;">
        <input type="password" id="azure-key" class="settings-input" placeholder="Azure Key" />
        <input type="text" id="azure-region" class="settings-input" placeholder="Region (e.g. southeastasia)" />
    </div>
    <select id="voice-select"><option value="">Default Voice</option></select>
    <button onclick="testVoice()" style="width:100%; margin-bottom:15px;">üîä Test Voice</button>

    <h3>ü§ñ AI Provider</h3>
    <select id="provider-select" onchange="updateProviderDisplay()">
        <option value="deepseek">DeepSeek Official</option>
        <option value="openrouter">OpenRouter</option>
        <option value="github">GitHub Models</option>
    </select>
    <input type="password" id="api-key" class="settings-input" placeholder="API Key" onchange="saveSettings()">

    <h3>üìö Data Source</h3>
    <div class="import-wrapper">
        <div class="url-input-group">
            <input type="text" id="sheet-url" class="settings-input" placeholder="CSV URL" style="margin-bottom:0;" />
            <button onclick="fetchSheetData()" style="padding: 5px 15px;">Load</button>
        </div>
        <div id="upload-status" style="font-size:0.8rem; margin-top:5px; color:var(--primary);"></div>
    </div>

    <button onclick="saveSettings()" style="width:100%; background-color: var(--secondary); margin-top:20px;">üíæ Save & Close</button>
</div>

<div id="app-container">

    <div id="flashcard-section">
        <div id="deck-empty-state" style="display:none; text-align:center; padding:50px; background:white; border-radius:12px;">
            <h2>üéâ All caught up!</h2>
            <p style="color:#6b7280;">You have reviewed all due cards for now.</p>
            <button onclick="forceReviewAll()" class="secondary" style="margin-top:20px;">Review Ahead (Cram)</button>
        </div>

        <div id="card-wrapper">
            <div class="flashcard-container" id="flashcard">
                <div class="card-face card-front">
                    <div style="font-size: 3.5rem; margin-bottom: 20px;">üíä</div>
                    <h2 id="fc-name" class="card-title">Drug Name</h2>
                    <p style="color: #9ca3af; font-size: 0.9rem;">(Tap "Show Answer" below)</p>
                    <button onclick="speakText(currentCard.name, 'en')" style="margin-top: 20px; background:#e0e7ff; color:var(--primary); border:none; padding:8px 16px; border-radius:8px;">üîä Pronounce</button>
                </div>
                <div class="card-face card-back">
                    <div class="detail-row"><div class="detail-label">Class</div><div class="detail-content" id="fc-class">...</div></div>
                    <div class="detail-row"><div class="detail-label">System</div><div class="detail-content" id="fc-system">...</div></div>
                    <div class="detail-row"><div class="detail-label">Indication</div><div class="detail-content" id="fc-indication">...</div></div>
                    <div class="detail-row"><div class="detail-label">Side Effects</div><div class="detail-content" id="fc-SideEffects">...</div></div>
                    <div class="detail-row" style="border:none;"><div class="detail-label">Nursing</div><div class="detail-content" id="fc-nursing">...</div></div>

                    <div class="ai-btn-group">
                        <button onclick="getIntegratedCaseStudy(currentCard, 'fc-ai-case', 'btn-case', 'btn-read-case')" class="ai-btn-small btn-sim" id="btn-case" style="color:white; border:none;">üè• AI: Generate Integrated Patient Case</button>
                        <div id="fc-ai-case" class="ai-output-box"></div>
                        <button onclick="readAIContent('fc-ai-case')" class="btn-read-ai" id="btn-read-case">üîä Read Out Loud</button>
                    </div>
                    <button onclick="speakBack(currentCard)" style="margin-top: 20px; width:100%; background:#e0e7ff; color:var(--primary); font-size:0.8rem; border:none; padding:10px; border-radius:8px;">üîä Read Basic Details</button>
                </div>
            </div>

            <div id="controls-pre-reveal">
                <button class="btn-reveal" onclick="revealAnswer()">Show Answer</button>
            </div>
            <div id="controls-post-reveal" class="srs-controls" style="display:none;">
                <button class="srs-btn btn-again" onclick="rateCard(1)">Again <span>&lt; 1m</span></button>
                <button class="srs-btn btn-hard" onclick="rateCard(2)">Hard <span>2d</span></button>
                <button class="srs-btn btn-good" onclick="rateCard(3)">Good <span>4d</span></button>
                <button class="srs-btn btn-easy" onclick="rateCard(4)">Easy <span>7d</span></button>
            </div>
        </div>
    </div>

    <div id="quiz-section" class="quiz-container">
        <div id="quiz-content">
            <p class="quiz-question" id="quiz-question">Question...</p>
            <div class="quiz-options" id="quiz-options"></div>
        </div>
        <button id="btn-quiz-explain" class="btn-explain" onclick="triggerQuizExplain()">ü§ñ Explain Why (AI Tutor)</button>
        <div id="ai-container" style="display:none;">
            <h3>ü§ñ AI Explanation</h3>
            <div id="ai-content" class="ai-output-box" style="display:block;"></div>
            <button onclick="readAIContent('ai-content')" class="btn-read-ai" id="btn-read-explain">üîä Read Out Loud</button>
        </div>
        <div class="nav-controls">
            <button onclick="nextQuestion()" id="next-quiz-btn" style="display:none;">Next Question ‚Üí</button>
        </div>
    </div>

    <div id="search-section">
        <div style="text-align:center; margin-bottom:15px; font-weight:800; color:var(--primary); font-size:1.2rem;">üîç Drug Database</div>
        <input type="text" id="search-input" class="search-bar" placeholder="Search drug, class, or indication..." oninput="handleSearch()">
        <div id="search-results" class="results-grid"></div>
    </div>

</div>

<script src="drugs.js"></script>
<script src="prompts.js"></script>

<script>
    // --- STATE ---
    let drugDatabase = [];
    let srsProgress = {}; 
    let studyQueue = [];
    let currentCard = null;
    let activeSourceList = []; // For toggling datasets
    let quizList = [];
    let quizCurrentIndex = 0;
    let currentQuizData = null;

    // Config
    let openRouterKey = ""; 
    let deepSeekKey = "sk-92db3cf721454bd7b351ca6ef40eaaf7";
    let githubKey = "";
    let activeProvider = 'deepseek';
    
    let ttsProvider = 'browser';
    let azureSpeechKey = "";
    let azureSpeechRegion = "southeastasia";
    let selectedVoiceURI = "";
    let azureSynthesizer = null;
    let isMuted = false;
    let aiLanguage = 'lihkg';

    const defaultSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";

    // --- INIT ---
    async function init() {
        loadSettings();
        
        // Load SRS (Local -> Cloud)
        const localData = localStorage.getItem('srsProgress');
        if (localData) srsProgress = JSON.parse(localData);
        await loadCloudData(true); // Silent sync

        // Check fallback data
        if(typeof commonDrugs !== 'undefined') {
            activeSourceList = [...commonDrugs];
        }
        
        fetchSheetData(); // Load CSV
        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoiceList;
    }

    function loadSettings() {
        openRouterKey = localStorage.getItem('or_key') || "";
        deepSeekKey = localStorage.getItem('ds_key') || deepSeekKey;
        githubKey = localStorage.getItem('gh_key') || "";
        activeProvider = localStorage.getItem('active_provider') || 'deepseek';
        
        ttsProvider = localStorage.getItem('tts_provider') || 'browser';
        azureSpeechKey = localStorage.getItem('azure_key') || "";
        azureSpeechRegion = localStorage.getItem('azure_region') || "southeastasia";
        selectedVoiceURI = localStorage.getItem('preferred_voice') || "";
        
        document.getElementById('openrouter-key').value = openRouterKey;
        document.getElementById('deepseek-key').value = deepSeekKey;
        document.getElementById('api-key').value = getKeyForProvider(activeProvider);
        document.getElementById('provider-select').value = activeProvider;
        document.getElementById('script-url').value = localStorage.getItem('scriptUrl') || "";
        document.getElementById('sheet-url').value = localStorage.getItem('csvUrl') || defaultSheetUrl;
        
        document.getElementById('tts-provider-select').value = ttsProvider;
        updateTTSUI();
    }

    function getKeyForProvider(p) {
        if(p==='openrouter') return openRouterKey;
        if(p==='github') return githubKey;
        return deepSeekKey;
    }

    // --- CLOUD SYNC (GOOGLE SHEETS) ---
    
    
    async function loadCloudData(silent = false) {
        const url = document.getElementById('script-url').value;
        const statusText = document.getElementById('sync-text');
        const statusDot = document.getElementById('sync-dot');
        
        if(!url) return;
        
        statusText.innerText = "Syncing...";
        statusDot.className = "sync-dot active";

        try {
            const resp = await fetch(url);
            const cloudData = await resp.json();
            
            // Merge strategies: prefer cloud if exists, else keep local
            srsProgress = { ...srsProgress, ...cloudData };
            localStorage.setItem('srsProgress', JSON.stringify(srsProgress));
            
            statusText.innerText = "Synced";
            statusDot.className = "sync-dot done";
            if(!silent) buildStudyQueue(); // Refresh deck
        } catch(e) {
            console.error(e);
            statusText.innerText = "Sync Error";
            statusDot.className = "sync-dot";
        }
    }

    function syncToCloud() {
        const url = document.getElementById('script-url').value;
        if(!url) return;
        
        const statusText = document.getElementById('sync-text');
        const statusDot = document.getElementById('sync-dot');
        statusText.innerText = "Saving...";
        statusDot.className = "sync-dot active";

        // Using simple POST to GAS
        fetch(url, {
            method: 'POST',
            mode: 'no-cors', // Avoids preflight check issues
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(srsProgress)
        }).then(() => {
            statusText.innerText = "Saved";
            statusDot.className = "sync-dot done";
        }).catch(e => {
            statusText.innerText = "Save Fail";
            statusDot.className = "sync-dot";
        });
    }

    // --- ANKI ALGORITHM (SM-2) ---
    

    function buildStudyQueue() {
        if(!activeSourceList || activeSourceList.length === 0) return;
        
        const now = Date.now();
        let due = [];
        let newCards = [];
        let learnedCount = 0;

        activeSourceList.forEach(drug => {
            if(!drug.name) return;
            // Clean/Trim
            const d = { ...drug, name: drug.name.trim() };
            const stats = srsProgress[d.name];

            if(!stats) {
                newCards.push({ ...d, _type: 'new' });
            } else {
                if(stats.interval > 21) learnedCount++;
                if(stats.dueDate <= now) due.push({ ...d, ...stats, _type: 'due' });
            }
        });

        // Sort: Due by date asc, New randomized
        due.sort((a,b) => a.dueDate - b.dueDate);
        newCards.sort(() => Math.random() - 0.5);

        document.getElementById('count-due').innerText = due.length;
        document.getElementById('count-new').innerText = newCards.length;
        document.getElementById('count-learned').innerText = learnedCount;

        // Mix: All due + batch of new
        studyQueue = [...due, ...newCards.slice(0, 15)];
        loadNextCard();
    }

    function loadNextCard() {
        const wrapper = document.getElementById('card-wrapper');
        const empty = document.getElementById('deck-empty-state');

        if(studyQueue.length === 0) {
            wrapper.style.display = 'none';
            empty.style.display = 'block';
            return;
        }

        wrapper.style.display = 'block';
        empty.style.display = 'none';
        currentCard = studyQueue[0];

        // UI Reset
        document.getElementById('flashcard').classList.remove('flipped');
        document.getElementById('controls-pre-reveal').style.display = 'block';
        document.getElementById('controls-post-reveal').style.display = 'none';
        
        // Clear AI
        document.getElementById('fc-ai-case').innerHTML = '';
        document.getElementById('fc-ai-case').style.display = 'none';
        document.getElementById('btn-read-case').style.display = 'none';
        document.getElementById('btn-case').disabled = false;
        document.getElementById('btn-case').innerHTML = 'üè• AI: Generate Integrated Patient Case';

        // Fill Data
        document.getElementById('fc-name').innerText = currentCard.name;
        document.getElementById('fc-class').innerText = currentCard.class || "N/A";
        document.getElementById('fc-system').innerText = currentCard.system || "N/A";
        document.getElementById('fc-indication').innerText = currentCard.indication || "N/A";
        document.getElementById('fc-SideEffects').innerText = currentCard.SideEffects || "N/A";
        document.getElementById('fc-nursing').innerText = currentCard.nursing || "N/A";
    }

    function revealAnswer() {
        document.getElementById('flashcard').classList.add('flipped');
        document.getElementById('controls-pre-reveal').style.display = 'none';
        document.getElementById('controls-post-reveal').style.display = 'grid';
        stopAudio();
    }

    function rateCard(quality) {
        // SM-2: 1=Fail, 2=Hard, 3=Good, 4=Easy
        const qMap = { 1: 0, 2: 3, 3: 4, 4: 5 };
        const q = qMap[quality];
        
        const id = currentCard.name;
        let stats = srsProgress[id] || { interval: 0, repetitions: 0, ef: 2.5 };

        if (q < 3) {
            stats.repetitions = 0;
            stats.interval = 1;
        } else {
            if (stats.repetitions === 0) stats.interval = 1;
            else if (stats.repetitions === 1) stats.interval = 6;
            else stats.interval = Math.round(stats.interval * stats.ef);
            
            stats.repetitions++;
            stats.ef = stats.ef + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
            if (stats.ef < 1.3) stats.ef = 1.3;
        }

        // Calculate Due Date
        const dayMs = 86400000;
        // If fail, requeue immediately (1 min from now)
        if(quality === 1) {
            stats.dueDate = Date.now(); 
            studyQueue.push(currentCard); 
        } else {
            stats.dueDate = Date.now() + (stats.interval * dayMs);
        }

        // Save & Sync
        srsProgress[id] = stats;
        localStorage.setItem('srsProgress', JSON.stringify(srsProgress));
        syncToCloud();

        // Next
        studyQueue.shift();
        loadNextCard();
    }

    function forceReviewAll() {
        studyQueue = [...activeSourceList].sort(() => Math.random() - 0.5);
        loadNextCard();
    }

    // --- DATA & CSV ---
    function fetchSheetData() {
        const urlInput = document.getElementById('sheet-url').value.trim();
        const statusEl = document.getElementById('upload-status');
        
        let fetchUrl = urlInput;
        if (urlInput.includes("docs.google.com/spreadsheets") && urlInput.includes("/edit")) {
            fetchUrl = urlInput.replace(/\/edit.*$/, "/export?format=csv");
        }

        fetch(fetchUrl).then(resp => resp.text()).then(csvText => {
            Papa.parse(csvText, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (results.data.length > 0) {
                        extendedDrugs = processRawData(results.data);
                        activeSourceList = extendedDrugs;
                        statusEl.innerText = `‚úÖ Loaded ${extendedDrugs.length} drugs`;
                        updateSetButton();
                        buildStudyQueue();
                        
                        // Prepare Quiz List
                        quizList = [...activeSourceList];
                        quizList.sort(() => Math.random() - 0.5);
                    }
                }
            });
        }).catch(e => { statusEl.innerText = "‚ùå CSV Load Failed"; });
    }

    // --- AI FUNCTIONS ---
    async function callAI(messages) {
        // Select provider based on current setting
        if(activeProvider === 'github') {
            if(!githubKey) throw new Error("GitHub Key missing");
            const resp = await fetch("https://models.github.ai/inference/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${githubKey}`, "Content-Type": "application/json", "Accept": "application/vnd.github+json", "X-GitHub-Api-Version": "2022-11-28" },
                body: JSON.stringify({ model: "gpt-4o-mini", messages: messages, temperature: 0.7 })
            });
            if(!resp.ok) throw new Error("GitHub API Error");
            const data = await resp.json(); return data.choices[0].message.content;
        } 
        else if (activeProvider === 'openrouter') {
            if(!openRouterKey) throw new Error("OpenRouter Key missing");
            const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${openRouterKey}`, "Content-Type": "application/json", "HTTP-Referer": window.location.href },
                body: JSON.stringify({ model: "arcee-ai/trinity-mini:free", messages: messages })
            });
            if(!resp.ok) throw new Error("OpenRouter Error");
            const data = await resp.json(); return data.choices[0].message.content;
        } 
        else {
            // Default DeepSeek
            if(!deepSeekKey) throw new Error("DeepSeek Key missing");
            const resp = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${deepSeekKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "deepseek-chat", messages: messages, temperature: 0.7 })
            });
            if(!resp.ok) throw new Error("DeepSeek Error");
            const data = await resp.json(); return data.choices[0].message.content;
        }
    }

    async function getIntegratedCaseStudy(drugObj, boxId, btnId, readBtnId) {
        const btn = document.getElementById(btnId); const box = document.getElementById(boxId); const readBtn = document.getElementById(readBtnId);
        btn.innerHTML = '<span class="loading-spinner"></span> Simulating...'; btn.disabled = true; box.style.display = 'block';
        
        const prompt = `Create a short clinical nursing case study for a patient prescribed ${drugObj.name} (${drugObj.class}). Include presenting complaint, reason for drug, and one critical nursing priority.`;
        
        try {
            const content = await callAI([{ role: "user", content: prompt }]);
            box.innerHTML = marked.parse(content);
            btn.innerHTML = '‚úÖ Case Loaded'; readBtn.style.display = 'block';
        } catch (e) {
            box.innerHTML = `Error: ${e.message}`; btn.innerText = "Error"; btn.disabled = false;
        }
    }

    async function triggerAISearch(query) {
        const outputBox = document.getElementById('ai-search-output');
        const btn = document.querySelector('#search-results button');
        if(btn) { btn.innerHTML = '<span class="loading-spinner"></span> Searching Global Database...'; btn.disabled = true; }
        outputBox.style.display = 'block'; outputBox.innerHTML = 'Thinking...';

        const prompt = `Provide a structured clinical summary for the drug "${query}". Headers: Class, System, Indication, Side Effects, Nursing Considerations. Keep it concise.`;
        try {
            const content = await callAI([{ role: "user", content: prompt }]);
            outputBox.innerHTML = marked.parse(content);
            if(btn) btn.innerHTML = '‚úÖ AI Result Loaded';
            
            const speakBtn = document.createElement('button');
            speakBtn.className = 'btn-read-ai'; speakBtn.innerText = 'üîä Read Result';
            speakBtn.onclick = () => speakText(outputBox.innerText, 'en');
            outputBox.appendChild(speakBtn);
        } catch (e) {
            outputBox.innerHTML = `Error: ${e.message}`; if(btn) { btn.innerText = '‚ùå Error'; btn.disabled = false; }
        }
    }

    // --- SEARCH ---
    function handleSearch() {
        const input = document.getElementById('search-input');
        const query = input.value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        if(query.length === 0) return;

        const matches = activeSourceList.filter(d => 
            (d.name||'').toLowerCase().includes(query) || (d.class||'').toLowerCase().includes(query)
        );

        if(matches.length === 0) {
             container.innerHTML = `
                <div style="text-align:center; color:#9ca3af; margin:20px;">No local match.</div>
                <button onclick="triggerAISearch('${query.replace(/'/g, "\\'")}')" class="ai-btn-small btn-sim" style="justify-content:center; width:100%;">‚ú® AI Search for "${input.value}"</button>
                <div id="ai-search-output" class="ai-output-box" style="margin-top:15px;"></div>
             `;
             return;
        }

        matches.forEach(drug => {
            const div = document.createElement('div');
            div.className = 'result-card';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;"><strong>${drug.name}</strong> <span style="color:#666;">${drug.class}</span></div>
                <div class="result-detail">
                    <p><strong>Indication:</strong> ${drug.indication}</p>
                    <button onclick="event.stopPropagation(); speakText('${drug.name}', 'en')" style="margin-top:10px; padding:5px;">üîä</button>
                </div>
            `;
            div.onclick = () => { div.classList.toggle('expanded'); };
            container.appendChild(div);
        });
    }

    // --- QUIZ & UTILS ---
    function generateQuizQuestion() {
        // Simple randomization logic from previous version
        document.getElementById('next-quiz-btn').style.display = 'none';
        document.getElementById('ai-container').style.display = 'none';
        document.getElementById('btn-quiz-explain').style.display = 'none';
        const container = document.getElementById('quiz-options');
        container.innerHTML = '';
        
        if (quizList.length === 0) return;
        if (quizCurrentIndex >= quizList.length) quizCurrentIndex = 0; 

        const correctDrug = quizList[quizCurrentIndex];
        const qEl = document.getElementById('quiz-question');
        qEl.innerText = `Which drug belongs to the class: "${correctDrug.class}"?`;
        
        let options = [correctDrug];
        while(options.length < 4) {
            let r = quizList[Math.floor(Math.random()*quizList.length)];
            if(!options.includes(r)) options.push(r);
        }
        options.sort(()=>Math.random()-0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt.name;
            btn.onclick = () => {
                if(opt === correctDrug) { btn.classList.add('correct'); speakText("Correct"); }
                else { btn.classList.add('wrong'); speakText("Incorrect"); }
                document.getElementById('next-quiz-btn').style.display = 'block';
                document.getElementById('btn-quiz-explain').style.display = 'block';
                currentQuizData = { q: qEl.innerText, u: opt.name, c: correctDrug, correctAnswerText: correctDrug.name };
            }
            container.appendChild(btn);
        });
    }
    function nextQuestion() { quizCurrentIndex++; generateQuizQuestion(); }
    
    // --- UI HELPERS ---
    function switchMode(mode) {
        document.getElementById('flashcard-section').style.display = 'none';
        document.getElementById('quiz-section').style.display = 'none';
        document.getElementById('search-section').style.display = 'none';
        document.querySelectorAll('.top-bar button').forEach(b => { b.classList.remove('mode-active'); b.classList.add('secondary'); });
        
        document.getElementById('mode-'+mode).classList.add('mode-active');
        document.getElementById('mode-'+mode).classList.remove('secondary');
        
        if(mode === 'flashcard') {
            document.getElementById('flashcard-section').style.display = 'block';
            buildStudyQueue();
        } else if (mode === 'quiz') {
            document.getElementById('quiz-section').style.display = 'block';
            if(quizCurrentIndex === 0) generateQuizQuestion();
        } else {
            document.getElementById('search-section').style.display = 'block';
            document.getElementById('search-input').focus();
        }
        stopAudio();
    }

    function updateSetButton() {
        const btn = document.getElementById('set-btn');
        if(activeSourceList === extendedDrugs) { btn.innerText = "üìö Set: Online CSV"; btn.classList.add('set-extended'); btn.classList.remove('secondary'); } 
        else { btn.innerText = "üìö Set: Common"; btn.classList.add('secondary'); btn.classList.remove('set-extended'); }
    }
    
    function toggleDrugSet() {
        if (activeSourceList === commonDrugs || (Array.isArray(commonDrugs) && activeSourceList[0]?.name === commonDrugs[0]?.name)) activeSourceList = extendedDrugs;
        else if(typeof commonDrugs !== 'undefined') activeSourceList = [...commonDrugs];
        updateSetButton(); buildStudyQueue();
    }

    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    function saveSettings() {
        localStorage.setItem('or_key', document.getElementById('openrouter-key').value);
        localStorage.setItem('ds_key', document.getElementById('deepseek-key').value);
        localStorage.setItem('active_provider', document.getElementById('provider-select').value);
        localStorage.setItem('scriptUrl', document.getElementById('script-url').value);
        localStorage.setItem('csvUrl', document.getElementById('sheet-url').value);
        
        loadSettings();
        toggleSettings();
    }

    function updateTTSUI() {
        const p = document.getElementById('tts-provider-select').value;
        document.getElementById('azure-config-group').style.display = p === 'azure' ? 'block' : 'none';
        populateVoiceList();
    }

    // Azure/Browser Voice Logic retained from previous version (simplified for brevity)
    async function populateVoiceList() {
        const select = document.getElementById('voice-select');
        select.innerHTML = '<option value="">Default</option>';
        if (ttsProvider === 'browser') {
            window.speechSynthesis.getVoices().forEach(v => {
                const opt = document.createElement('option'); opt.value = v.voiceURI; opt.innerText = v.name;
                select.appendChild(opt);
            });
        }
    }
    function speakText(text) {
        if(isMuted) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(u);
    }
    function speakBack(d) { speakText(`${d.name}. ${d.class}.`); }
    function toggleMute() { isMuted = !isMuted; document.getElementById('mute-btn').innerText = isMuted ? "üîá Off" : "üîä On"; }

    // Start
    init();
</script>
</body>
</html>
