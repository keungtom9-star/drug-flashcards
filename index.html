<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nursing Drug Tutor (Pro)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4F46E5; --background: #F3F4F6; --surface: #ffffff;
            --text: #111827; --muted: #6B7280;
            --srs-again: #ef4444; --srs-hard: #f59e0b; --srs-good: #10b981; --srs-easy: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif; background: var(--background); margin: 0;
            padding: env(safe-area-inset-top) 15px 40px 15px; display: flex; flex-direction: column; align-items: center;
        }

        .stats-bar {
            display: flex; gap: 10px; background: white; padding: 12px 20px; 
            border-radius: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.8rem; margin: 20px 0;
            width: 100%; max-width: 400px; justify-content: space-around; align-items: center;
        }

        /* Settings Overlay */
        #settings-panel {
            display: none; background: white; width: 100%; max-width: 380px; 
            padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: fixed; top: 100px; z-index: 100; border: 1px solid #ddd;
        }
        .settings-input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }

        #app-container { width: 100%; max-width: 400px; perspective: 1000px; }
        .card-box { width: 100%; height: 480px; position: relative; transform-style: preserve-3d; transition: transform 0.5s; }
        .card-box.flipped { transform: rotateY(180deg); }
        
        .face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            background: white; border-radius: 24px; padding: 25px; box-sizing: border-box;
            display: flex; flex-direction: column; border: 1px solid #e5e7eb; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .front { justify-content: center; align-items: center; text-align: center; }
        .back { transform: rotateY(180deg); overflow-y: auto; }
        
        .drug-name { font-size: 2.2rem; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-top: 10px; }
        .val { font-size: 0.95rem; margin-bottom: 8px; color: var(--text); line-height: 1.4; }

        .controls { width: 100%; max-width: 400px; margin-top: 20px; }
        .btn-reveal { width: 100%; padding: 18px; border-radius: 15px; border: none; background: #111; color: white; font-weight: 600; font-size: 1.1rem; }
        
        .srs-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; display: none; }
        .srs-btn { padding: 12px 2px; border-radius: 12px; border: none; color: white; font-weight: 700; font-size: 0.75rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .srs-btn span { font-weight: 400; font-size: 0.55rem; opacity: 0.8; margin-top: 2px; }

        .btn-more { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 600; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

<div class="stats-bar">
    <span>Due: <strong id="due-count">0</strong></span>
    <span>New: <strong id="new-count">0</strong></span>
    <span>Left: <strong id="session-left">0</strong></span>
    <button onclick="toggleSettings()" style="background:none; border:none; font-size:1.2rem;">‚öôÔ∏è</button>
</div>

<div id="settings-panel">
    <h3 style="margin-top:0;">Study Settings</h3>
    <label style="font-size:0.8rem; font-weight:600;">Daily New Drug Quota</label>
    <input type="number" id="quota-input" class="settings-input" value="15">
    <p style="font-size:0.7rem; color:var(--muted);">Changes will apply when you refresh or finish today's batch.</p>
    <button onclick="saveSettings()" style="width:100%; padding:12px; background:var(--secondary); color:white; border:none; border-radius:10px; font-weight:600;">Save & Close</button>
</div>

<div id="app-container">
    <div id="empty-state" style="display:none; text-align:center; padding:50px 20px;">
        <div style="font-size: 4rem;">üéâ</div>
        <h2>Êî∂ÂæóÂ∑•ÔºÅ</h2>
        <p style="color:var(--muted)">You've finished your daily quota.</p>
        <button class="btn-more" onclick="studyExtra()">Study 5 More New Drugs</button>
        <br>
        <button onclick="location.reload()" style="background:none; border:none; color:var(--primary); margin-top:20px; font-size:0.9rem;">Reload Database</button>
    </div>

    <div id="card-wrapper">
        <div class="card-box" id="card-element" onclick="flipCard()">
            <div class="face front">
                <p class="label">NURSING PHARMACOLOGY</p>
                <h1 class="drug-name" id="display-name">...</h1>
                <button onclick="event.stopPropagation(); speak(currentCard.name)" style="margin-top:15px; border:none; background:#e0e7ff; color:var(--primary); padding:10px 15px; border-radius:10px;">üîä ÁôºÈü≥</button>
            </div>
            <div class="face back">
                <p class="label">Class</p><div class="val" id="display-class"></div>
                <p class="label">Indication</p><div class="val" id="display-indication"></div>
                <p class="label">Nursing Priority</p><div class="val" id="display-nursing"></div>
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                <button onclick="event.stopPropagation(); getLihkgExplain()" id="lihkg-btn" style="width:100%; padding:10px; background:#f97316; color:white; border:none; border-radius:10px; font-weight:600; font-size:0.8rem;">üî• LIHKG Â∏´ÂÖÑËß£Èáã</button>
                <div id="lihkg-explain-box" style="display:none; margin-top:10px; font-size:0.85rem; background:#fff7ed; padding:10px; border-radius:10px; border-left:4px solid #f97316;"></div>
            </div>
        </div>

        <div class="controls">
            <button id="btn-reveal" class="btn-reveal" onclick="flipCard()">Êè≠ÁõÖ (Show Answer)</button>
            <div id="srs-controls" class="srs-grid">
                <button class="srs-btn" style="background:var(--srs-again)" onclick="rate(1)">Again<span>1m</span></button>
                <button class="srs-btn" style="background:var(--srs-hard)" onclick="rate(2)">Hard<span>2d</span></button>
                <button class="srs-btn" style="background:var(--srs-good)" onclick="rate(3)">Good<span>4d</span></button>
                <button class="srs-btn" style="background:var(--srs-easy)" onclick="rate(4)">Easy<span>7d</span></button>
            </div>
        </div>
    </div>
</div>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";
    const DEEPSEEK_KEY = "sk-8fd0f4776401470ab71b9aa166a02a25";

    let drugDb = [];
    let srsData = JSON.parse(localStorage.getItem('anki_srs_v2')) || {};
    let sessionQueue = [];
    let currentCard = null;
    let dailyQuota = parseInt(localStorage.getItem('daily_quota')) || 15;

    async function init() {
        document.getElementById('quota-input').value = dailyQuota;
        Papa.parse(CSV_URL, {
            download: true, header: true, skipEmptyLines: true,
            complete: (results) => {
                drugDb = results.data.filter(d => d.name);
                buildSession();
            }
        });
    }

    function buildSession() {
        const now = Date.now();
        let due = [], newCards = [];
        
        drugDb.forEach(drug => {
            const stats = srsData[drug.name];
            if (!stats) newCards.push(drug);
            else if (stats.dueDate <= now) due.push({...drug, ...stats});
        });

        document.getElementById('due-count').innerText = due.length;
        document.getElementById('new-count').innerText = newCards.length;
        
        sessionQueue = [...due, ...newCards.slice(0, dailyQuota)];
        sessionQueue.sort(() => Math.random() - 0.5);
        render();
    }

    function studyExtra() {
        let newCards = drugDb.filter(drug => !srsData[drug.name]);
        let extra = newCards.slice(0, 5);
        if(extra.length > 0) {
            sessionQueue = [...extra];
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('card-wrapper').style.display = 'block';
            render();
        } else {
            alert("No more new drugs found in database!");
        }
    }

    function render() {
        document.getElementById('session-left').innerText = sessionQueue.length;
        if (sessionQueue.length === 0) {
            document.getElementById('card-wrapper').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            return;
        }
        currentCard = sessionQueue[0];
        document.getElementById('card-element').classList.remove('flipped');
        document.getElementById('btn-reveal').style.display = 'block';
        document.getElementById('srs-controls').style.display = 'none';
        document.getElementById('lihkg-explain-box').style.display = 'none';
        
        document.getElementById('display-name').innerText = currentCard.name;
        document.getElementById('display-class').innerText = currentCard.class || 'N/A';
        document.getElementById('display-indication').innerText = currentCard.indication || 'N/A';
        document.getElementById('display-nursing').innerText = currentCard.nursing || 'N/A';
    }

    function flipCard() {
        document.getElementById('card-element').classList.add('flipped');
        document.getElementById('btn-reveal').style.display = 'none';
        document.getElementById('srs-controls').style.display = 'grid';
    }

    function rate(q) {
        let stats = srsData[currentCard.name] || { interval: 0, reps: 0, ef: 2.5 };
        if (q === 1) { 
            stats.reps = 0;
            const card = sessionQueue.shift();
            sessionQueue.push(card);
        } else {
            if (stats.reps === 0) stats.interval = q === 4 ? 4 : 1;
            else if (stats.reps === 1) stats.interval = 6;
            else stats.interval = Math.round(stats.interval * stats.ef);
            
            stats.ef = stats.ef + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
            if (stats.ef < 1.3) stats.ef = 1.3;
            stats.reps++;
            stats.dueDate = Date.now() + (stats.interval * 86400000);
            srsData[currentCard.name] = stats;
            localStorage.setItem('anki_srs_v2', JSON.stringify(srsData));
            sessionQueue.shift();
        }
        render();
    }

    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    function saveSettings() {
        dailyQuota = parseInt(document.getElementById('quota-input').value);
        localStorage.setItem('daily_quota', dailyQuota);
        toggleSettings();
        buildSession();
    }

    async function getLihkgExplain() {
        const box = document.getElementById('lihkg-explain-box');
        box.style.display = 'block'; box.innerText = "Â∏´ÂÖÑË´óÁ∑äÈªûÁ≠î‰Ω†...";
        try {
            const prompt = `You are a senior nurse in Hong Kong. Explain ${currentCard.name} for a student in clinical. Use LIHKG tone and HK Cantonese.`;
            const resp = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST", headers: { "Authorization": `Bearer ${DEEPSEEK_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "user", content: prompt}] })
            });
            const data = await resp.json();
            box.innerHTML = marked.parse(data.choices[0].message.content);
        } catch(e) { box.innerText = "Error loading AI."; }
    }

    function speak(txt) { window.speechSynthesis.cancel(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt)); }

    init();
</script>
</body>
</html>
