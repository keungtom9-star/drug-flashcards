<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    <title>AI Drug Tutor</title>
    
    <link rel="icon" href="apple-touch-icon.png" type="image/png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="prefetch" href="ward.html" as="document">
    
    <style>
        :root {
            /* iOS 17/Modern Palette */
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-indigo: #5856D6;
            --ios-orange: #FF9500;
            --ios-gray: #8E8E93;
            --ios-separator: #C6C6C8;
            --text-primary: #000000;
            --text-secondary: #3C3C4399; /* 60% opacity */
            
            --radius-card: 20px;
            --radius-btn: 12px;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.06);
            --glass-bg: rgba(255, 255, 255, 0.85);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.18s ease;
        }

        body.page-leaving { opacity: 0.7; }

        /* iOS Header */
        header {
            width: 100%;
            padding: 15px 20px;
            box-sizing: border-box;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
            position: relative;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-icon-img {
            width: 38px; height: 38px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
            background: rgba(0,0,0,0.05);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        /* Settings Button */
        .settings-btn-top {
            position: absolute;
            right: 20px; top: 20px;
            background: rgba(255,255,255,0.5);
            border: 1px solid rgba(0,0,0,0.05);
            width: 36px; height: 36px; border-radius: 50%;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; backdrop-filter: blur(10px); color: var(--text-primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .settings-btn-top:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }

        /* Nav */
        .glass-nav {
            position: sticky; top: 10px; z-index: 100;
            width: 92%; max-width: 600px;
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 16px; padding: 6px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; justify-content: space-between; gap: 8px; margin-bottom: 20px;
        }

        .nav-btn {
            flex: 1; height: 38px; border: none; background: transparent;
            border-radius: 10px; font-weight: 600; font-size: 0.9rem;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease;
        }
        .nav-btn.active { background-color: var(--ios-card); color: var(--ios-blue); box-shadow: 0 2px 10px rgba(0,0,0,0.08); }

        #app-container { width: 92%; max-width: 600px; flex: 1; padding-bottom: 80px; }

        /* Cards */
        .ios-card {
            background: var(--ios-card); border-radius: var(--radius-card); padding: 20px;
            box-shadow: var(--shadow-soft); margin-bottom: 20px; position: relative; overflow: hidden;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }

        /* Search */
        .search-wrapper { position: relative; margin-bottom: 15px; }
        .search-bar {
            width: 100%; padding: 12px 16px; padding-left: 40px;
            border-radius: 14px; border: none; background: #E3E3E8;
            font-size: 17px; color: var(--text-primary); box-sizing: border-box; outline: none;
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--ios-gray); font-size: 1.1rem;
        }
        
        .section-header {
            font-size: 0.8rem; font-weight: 700; color: var(--ios-gray); 
            margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Daily Recommendations */
        .daily-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;
        }
        .daily-card {
            background: linear-gradient(145deg, #ffffff, #f7fbff); border-radius: 16px; padding: 15px;
            box-shadow: var(--shadow-soft); display: flex; flex-direction: column;
            justify-content: space-between; min-height: 100px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.05);
            /* Ensure text stays within card */
            word-break: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .daily-card:hover { box-shadow: 0 8px 25px rgba(0, 122, 255, 0.18); }
        .daily-card:active { transform: scale(0.96); }
        .daily-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .daily-icon-pill {
            width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.9);
            display:flex; align-items:center; justify-content:center; font-size: 0.95rem;
        }
        .daily-label {
            font-size: 0.68rem; color: #fff; font-weight: 800; text-transform: uppercase;
            letter-spacing: .6px; background: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 999px;
        }
        .daily-name { 
            font-size: 1.1rem; font-weight: 700; color: var(--text-primary); 
            line-height: 1.2; margin-top: 5px; margin-bottom: 10px;
            word-break: break-word;
        }
        .daily-sub { font-size: 0.8rem; color: #1f2937; margin-top: auto; opacity: .85; }

        .anki-controls {
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding: 0 10px;
        }
        .anki-btn {
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            padding: 10px 6px;
            cursor: pointer;
        }

        .anki-meta {
            margin-top: 10px;
            font-size: 0.78rem;
            color: var(--ios-gray);
            text-align: center;
        }

        .quiz-stats-row {
            margin: 12px 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .quiz-stat-pill {
            background: #F2F2F7;
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            font-size: 0.78rem;
            color: var(--ios-gray);
        }

        .quiz-stat-pill strong {
            display: block;
            color: var(--text-primary);
            font-size: 1rem;
            margin-top: 2px;
        }


        .mobile-tab-label { display: none; }

        .app-smooth {
            contain: content;
            will-change: transform;
        }


        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(12px) scale(0.99); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes softPulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(0, 122, 255, 0.08); }
            50% { box-shadow: 0 8px 28px rgba(0, 122, 255, 0.18); }
        }

        .daily-card { animation: fadeSlideUp 0.35s ease both; }
        .flashcard-wrapper { animation: fadeSlideUp 0.3s ease both; }
        .glass-nav .nav-btn.active { animation: softPulse 1.8s ease-in-out infinite; }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        @media (max-width: 768px) {
            header { padding: 10px 14px 8px; }
            h1 { font-size: 1.35rem; }
            .subtitle { font-size: 0.74rem; }
            .settings-btn-top { right: 14px; top: 12px; width: 34px; height: 34px; }

            .glass-nav {
                position: fixed;
                top: auto;
                bottom: calc(8px + env(safe-area-inset-bottom));
                left: 10px;
                right: 10px;
                width: auto;
                max-width: none;
                margin-bottom: 0;
                z-index: 500;
                border-radius: 18px;
                padding: 7px;
                box-shadow: 0 10px 28px rgba(0,0,0,0.14);
            }

            .nav-btn {
                height: 42px;
                font-size: 0.82rem;
                display: flex;
                flex-direction: column;
                gap: 2px;
                align-items: center;
                justify-content: center;
            }

            #app-container { width: 94%; padding-bottom: 130px; }
            #filter-bar { width: 94% !important; }

            .flashcard-wrapper {
                height: 66dvh;
                min-height: 460px;
                max-height: 680px;
            }

            .drug-title { font-size: 1.8rem; }
            .detail-content { font-size: 0.97rem; }
            .action-btn { min-height: 44px; }
            #quiz-question {
                font-size: 1rem !important;
                line-height: 1.45;
                min-height: 72px !important;
            }
            .quiz-option-btn {
                font-size: 0.95rem;
                min-height: 52px;
            }
            .quiz-controls-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .quiz-controls-grid .ios-select {
                width: 100%;
            }
            .result-card { padding: 13px; }
            .daily-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        /* System Scroll */
        .system-scroll-container {
            display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px;
            margin-bottom: 15px; scrollbar-width: none; flex-wrap: nowrap;
        }
        .system-scroll-container::-webkit-scrollbar { display: none; }

        /* Multi-Drug Select Dropdown */
        .drug-selector-wrapper {
            margin: 10px 0; padding: 8px; background: #F2F2F7; border-radius: 12px;
        }
        .drug-select-label {
            font-size: 0.7rem; color: var(--ios-gray); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; display: block;
        }
        .drug-select {
            width: 100%; padding: 6px; border-radius: 8px; border: 1px solid #d1d1d6;
            background: white; font-size: 0.9rem; color: var(--ios-blue); font-weight: 600;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px auto;
        }

        /* Flashcard */
        .flashcard-wrapper { perspective: 1000px; height: 600px; cursor: pointer; }
        .flashcard-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d;
        }
        .flashcard-wrapper.flipped .flashcard-inner { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: var(--radius-card); background: var(--ios-card);
            box-shadow: var(--shadow-soft); display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .card-back { transform: rotateY(180deg); justify-content: flex-start; text-align: left; padding-top: 25px; overflow-y: auto; }

        .drug-title {
            font-size: 2.2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--ios-blue), var(--ios-indigo));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 15px 0; line-height: 1.2;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .detail-row { width: 100%; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #F2F2F7; }
        .detail-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ios-gray); font-weight: 600; margin-bottom: 4px; }
        .detail-content { 
            font-size: 1.05rem; font-weight: 500; color: var(--text-primary); line-height: 1.4;
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }

        .action-btn {
            background: var(--ios-bg); color: var(--ios-blue); border: none;
            padding: 12px 20px; border-radius: 12px; font-weight: 600;
            font-size: 0.95rem; width: 100%; margin-top: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;
        }
        .action-btn:active { background: #d1d1d6; }
        .btn-primary { background: var(--ios-blue); color: white; }
        .btn-green { background: var(--ios-green); color: white; }

        .external-links-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }

        /* Modals & Misc */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: flex-end;
        }
        .modal-card {
            background: var(--ios-card); width: 100%; max-width: 600px; height: 85vh;
            border-radius: 24px 24px 0 0; padding: 25px; box-sizing: border-box;
            overflow-y: auto; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .chip {
            display: inline-flex; padding: 8px 14px; background: #E3E3E8;
            border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            color: var(--text-primary); margin: 0; cursor: pointer; white-space: nowrap;
        }
        
        .filter-scroller {
            display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none;
        }
        .filter-scroller::-webkit-scrollbar { display: none; }
        select.ios-select {
            appearance: none; background: var(--ios-bg); border: none; padding: 10px 16px;
            border-radius: 10px; font-size: 0.9rem; font-weight: 600; color: var(--ios-blue);
        }

        .result-card {
            background: white; padding: 16px; border-radius: 16px; margin-bottom: 12px;
            border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: all 0.2s; cursor: pointer;
            /* Text wrapping safety */
            word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;
        }
        .result-card:active { transform: scale(0.98); }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .result-name { 
            font-weight: 700; font-size: 1.1rem; color: var(--ios-blue); 
            word-break: break-word; flex: 1;
        }
        .result-class { 
            font-size: 0.85rem; color: var(--ios-gray); text-align: right; 
            max-width: 40%; word-break: break-word;
        }
        .name-with-speak { display:flex; align-items:center; gap:8px; flex:1; min-width:0; }
        .speak-icon-btn {
            border:none; background:#eef2ff; color:var(--ios-blue); width:30px; height:30px;
            border-radius:50%; font-size:0.95rem; cursor:pointer; flex-shrink:0;
        }
        .quiz-mini-explainer {
            display:none; margin-top:10px; padding:10px 12px; border-radius:10px;
            background:#eff6ff; color:#1e3a8a; font-size:0.82rem; line-height:1.45;
        }

        .quiz-option-btn {
            text-align: left;
            justify-content: flex-start;
            background: #F2F2F7;
            white-space: normal;
            line-height: 1.45;
            padding: 14px 16px;
            font-size: 0.98rem;
        }

        .quiz-controls-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 10px;
        }

        .quiz-start-btn {
            grid-column: 1 / -1;
            margin: 0;
            width: 100%;
        }

        .quiz-topbar {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 10px;
        }

        .quiz-progress-pill {
            font-size:0.85rem;
            color:var(--ios-gray);
            margin-bottom:8px;
            background:#f1f5f9;
            border:1px solid #e2e8f0;
            border-radius:999px;
            padding:6px 10px;
            display:inline-block;
        }

        .multi-chip-wrap { display:flex; flex-wrap:wrap; gap:6px; }
        .multi-chip {
            background:#eef2ff; color:#3730a3; border-radius:999px; padding:4px 10px; font-size:0.75rem; font-weight:600;
            border: 1px solid transparent; transition: all 0.2s ease;
        }
        .multi-chip.selectable { cursor: pointer; }
        .multi-chip.selectable:hover { transform: translateY(-1px); }
        .multi-chip.is-active { background:#dbeafe; color:#1d4ed8; border-color:#93c5fd; }

        body { animation: appEnter 0.5s cubic-bezier(0.22, 1, 0.36, 1); }
        .ios-card, .daily-card, .result-card { animation: cardPop 0.34s cubic-bezier(0.22, 1, 0.36, 1); }
        .app-smooth.mode-transition { animation: sectionSlideIn 0.24s ease-out; }
        .action-btn, .chip, .nav-btn { transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; }
        .action-btn:active, .chip:active, .nav-btn:active { transform: scale(0.97); }

        @keyframes appEnter {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes sectionSlideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes cardPop {
            from { opacity: 0; transform: translateY(8px) scale(0.99); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .ai-output {
            background: #F0F9FF; border-left: 4px solid var(--ios-blue);
            padding: 15px; border-radius: 12px; margin-top: 15px;
            font-size: 0.95rem; line-height: 1.6; display: none;
            word-wrap: break-word; overflow-wrap: break-word;
        }

        .settings-input {
            width: 100%; padding: 12px; border: 1px solid #d1d1d6;
            border-radius: 10px; margin-bottom: 15px; box-sizing: border-box;
            background: #F2F2F7; font-size: 16px;
        }
        .config-section { margin-bottom: 15px; }

        .loading-spinner {
            display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%; border-top-color: var(--ios-blue); animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hidden Details in Search */
        .extra-details { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.9rem; line-height: 1.4; color: #333; }
        .expanded .extra-details { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

<header>
    <h1>
        <img src="apple-touch-icon.png" class="app-icon-img" alt="App Icon">
        AI Drug Tutor
    </h1>
    <button onclick="toggleSettings()" class="settings-btn-top">‚öôÔ∏è</button>
    <div class="subtitle" id="provider-display">DeepSeek</div>
</header>

<div class="glass-nav">
    <button class="nav-btn active" id="nav-search" onclick="switchMode('search')">üß∏ Search</button>
    <button class="nav-btn" id="nav-flash" onclick="switchMode('flashcard')">üóÇÔ∏è Flashcard</button>
    <button class="nav-btn" id="nav-quiz" onclick="switchMode('quiz')">üß† Quiz</button>
    <button class="nav-btn" id="nav-ward" style="color:var(--ios-green);" onclick="openWardCheat()">ü©∫ Ward</button>
</div>

<div id="filter-bar" class="filter-scroller" style="display:none; width: 92%; max-width:600px;">
    <select id="system-filter" onchange="applyFilter()" class="ios-select">
        <option value="All">All Systems</option>
    </select>
    <select id="mastery-filter" onchange="applyFilter()" class="ios-select">
        <option value="All">All Mastery</option>
        <option value="Focus">‚ö†Ô∏è Focus</option>
        <option value="Learning">üü° Learning</option>
        <option value="Mastered">‚úÖ Mastered</option>
    </select>
</div>

<div id="app-container">
    
    <div id="search-section" class="app-smooth">
        <div class="section-header">
            <span id="daily-title">üìÖ Daily Study Picks</span>
            <span style="font-size:0.7rem; font-weight:400; color:var(--ios-blue);" onclick="refreshDailyPicks()">Refresh</span>
        </div>
        <div id="daily-container" class="daily-grid">
            <div class="daily-card" style="justify-content:center; align-items:center;">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" id="search-input" class="search-bar" placeholder="Search drugs, class, indication, side effects..." oninput="handleSearch()">
        </div>

        <div id="history-section" style="margin-bottom:20px; display:none;">
            <div class="section-header">Recent Searches</div>
            <div id="history-container" style="overflow-x:auto; white-space:nowrap; padding-bottom:5px;"></div>
        </div>
        
        <div class="section-header">Browse by System</div>
        <div id="recommend-container" class="system-scroll-container"></div>

        <div id="search-results">
            <div style="text-align:center; color:var(--text-secondary); margin-top:40px;">
                <p>Type at least 2 letters to search the database.</p>
                <div style="display:flex; justify-content:center; gap:10px;">
                     <span class="chip" onclick="quickSearch('Cardio')">ü´Ä Cardio</span>
                     <span class="chip" onclick="quickSearch('Respiratory')">ü´Å Resp</span>
                </div>
            </div>
        </div>
    </div>

    <div id="flashcard-section" class="app-smooth" style="display:none;">
        <div id="flashcard-queue-stats" style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-bottom:12px;"></div>
        <div class="flashcard-wrapper" id="flashcard" onclick="flipCard(event)">
            <div class="flashcard-inner">
                
                <div class="card-face card-front">
                    <div style="font-size: 4rem; margin-bottom: 10px;">üíä</div>
                    <div style="font-size:0.9rem; color:var(--ios-gray); text-transform:uppercase; letter-spacing:1px; font-weight:700;">Generic Name</div>
                    <h2 id="fc-name" class="drug-title">Drug Name</h2>
                    <p style="color:var(--ios-gray); margin-top:0;">Tap the card to flip</p>
                    
                    <button onclick="event.stopPropagation(); triggerFcAction('speak')" class="action-btn" style="width:auto; margin-top:20px; background: #F2F2F7;">
                        üó£Ô∏è Speak name
                    </button>
                </div>

                <div class="card-face card-back">
                    <div class="detail-row">
                        <div class="detail-label">Class</div>
                        <div class="detail-content" id="fc-class">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">System</div>
                        <div class="detail-content" id="fc-system">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Indication</div>
                        <div class="detail-content" id="fc-indication">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label" style="color:var(--ios-red);">Side Effects</div>
                        <div class="detail-content" id="fc-side-effects">...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Nursing Considerations</div>
                        <div class="detail-content" id="fc-nursing" style="font-size:0.9rem; line-height:1.5;">...</div>
                    </div>

                    <div id="fc-multi-chip-wrap" style="display:none; margin-top:4px; margin-bottom:10px;"></div>

                    <div class="external-links-grid">
                        <button id="fc-google-link" onclick="event.stopPropagation(); triggerFcAction('google')" class="action-btn" style="margin:0; text-decoration:none; font-size:0.85rem;">
                            üîé Google
                        </button>
                        <button id="fc-drugs-btn" onclick="event.stopPropagation(); triggerFcAction('drugs')" class="action-btn" style="margin:0; font-size:0.85rem; color:#0051ff;">
                            üß¥ Drugs.com
                        </button>
                        
                    </div>

                    <button onclick="event.stopPropagation(); triggerFcAction('case')" class="action-btn btn-primary" id="btn-case" style="margin-top:15px;">
                        ü™Ñ AI Clinical Case
                    </button>
                    
                    <div id="fc-ai-case" class="ai-output" onclick="event.stopPropagation();"></div>
                    <button id="btn-read-case" onclick="event.stopPropagation(); readAIContent('fc-ai-case')" class="action-btn" style="display:none; margin-top:5px;">üîä Read</button>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; padding:0 10px;">
            <button onclick="prevCard()" class="action-btn" style="width:auto;">‚Üê Previous</button>
            <span id="counter" style="font-weight:700; color:var(--ios-gray);">1 / 10</span>
            <button onclick="nextCard()" class="action-btn" style="width:auto;">Next ‚Üí</button>
        </div>
        <button id="show-answer-btn" onclick="showAnswer()" class="action-btn btn-primary" style="margin-top:12px;">Show Answer</button>
        <div id="anki-controls" class="anki-controls">
            <button class="anki-btn" style="background:#ef4444;" onclick="rateCurrentCard('again')">Again</button>
            <button class="anki-btn" style="background:#f59e0b;" onclick="rateCurrentCard('hard')">Hard</button>
            <button class="anki-btn" style="background:#3b82f6;" onclick="rateCurrentCard('good')">Good</button>
            <button class="anki-btn" style="background:#10b981;" onclick="rateCurrentCard('easy')">Easy</button>
        </div>
        <div id="anki-meta" class="anki-meta"></div>
    </div>

    <div id="quiz-section" class="app-smooth" style="display:none;">
        <div class="ios-card">
            <div class="quiz-topbar">
                <h3 style="margin-top:0; color:var(--ios-blue);">Adaptive Quiz</h3>
                <button onclick="showProgressModal()" style="font-size:0.8rem; background:none; border:none; color:var(--ios-gray);">üìä Stats</button>
            </div>
            <div class="quiz-controls-grid">
                <select id="quiz-level" class="ios-select" style="margin:0; width:100%;">
                    <option value="">Select level</option>
                    <option value="mix">Mixed level</option>
                    <option value="remembering">Remembering</option>
                    <option value="understanding">Understanding</option>
                    <option value="applying">Applying</option>
                    <option value="analyzing">Analyzing</option>
                    <option value="evaluating">Evaluating</option>
                </select>
                <select id="quiz-system" class="ios-select" style="margin:0; width:100%;">
                    <option value="">Select system</option>
                    <option value="All">All systems</option>
                </select>
                <select id="quiz-count" class="ios-select" style="margin:0; width:100%;">
                    <option value="5">5 questions</option>
                    <option value="10" selected>10 questions</option>
                    <option value="15">15 questions</option>
                    <option value="20">20 questions</option>
                </select>
                <button onclick="startQuizRound()" class="action-btn btn-primary quiz-start-btn" style="padding:10px 12px;">Start</button>
            </div>
            <div id="quiz-round-progress" class="quiz-progress-pill">Round not started</div>
            <p id="quiz-question" style="font-size:1.1rem; font-weight:600; min-height:60px;">Loading question...</p>
            <div class="quiz-stats-row">
                <div class="quiz-stat-pill">Score<strong id="quiz-score">0%</strong></div>
                <div class="quiz-stat-pill">Streak<strong id="quiz-streak">0</strong></div>
                <div class="quiz-stat-pill">Answered<strong id="quiz-answered">0</strong></div>
            </div>
            <div id="quiz-options" style="display:flex; flex-direction:column; gap:10px;"></div>
            
            <div id="quiz-feedback" style="display:none; margin-top:15px; padding:12px; border-radius:12px; text-align:center;"></div>
            <div id="quiz-mini-explainer" class="quiz-mini-explainer"></div>


            <button onclick="nextQuestion()" id="next-quiz-btn" class="action-btn btn-primary" style="display:none; margin-top:15px;">Next question ‚Üí</button>
        </div>
    </div>

</div>

<div id="fc-drug-picker" class="modal-overlay" onclick="if(event.target===this) closeFcDrugPicker()">
    <div class="modal-card" style="height:auto; max-height:70vh; border-radius:24px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0;">Pick a Drug</h3>
            <button onclick="closeFcDrugPicker()" style="background:none; border:none; color:var(--ios-blue); font-weight:600;">Close</button>
        </div>
        <div id="fc-picker-list" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
</div>

<div id="settings-panel" class="modal-overlay" onclick="if(event.target===this) toggleSettings()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Settings</h3>
            <button onclick="toggleSettings()" style="background:none; border:none; color:var(--ios-blue); font-weight:600; font-size:1rem;">Done</button>
        </div>
        
        <div style="margin-bottom:20px; background:#F9FAFB; padding:15px; border-radius:12px;">
            <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">AI Model</label>
            <select id="provider-select" onchange="updateProviderDisplay()" class="ios-select" style="width:100%; margin-top:5px; background:white;">
                <option value="deepseek">DeepSeek V3 (Fast)</option>
                <option value="deepseek-r1">DeepSeek R1 (Reasoning)</option>
            </select>
        </div>

        <div id="deepseek-config" class="config-section">
            <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">DeepSeek API Key</label>
            <input type="password" id="deepseek-key" class="settings-input" placeholder="sk-...">
            <div style="font-size:0.75rem; color:var(--ios-gray);">Works with both V3 and R1.</div>
        </div>
        
        <div style="margin-top:20px;">
             <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">Data Source</label>
             <button onclick="toggleDrugSet()" id="set-btn" class="action-btn">üìö Source: Common drugs</button>
             <div class="import-wrapper" style="margin-top:10px;">
                <input type="text" id="sheet-url" class="settings-input" placeholder="Google Sheet CSV URL" style="margin-bottom:5px;" />
                <button onclick="fetchSheetData()" class="action-btn">Load Sheet Data</button>
                <label style="display:flex; align-items:center; gap:8px; margin-top:10px; font-size:0.82rem; color:#374151;">
                    <input id="auto-sync-startup" type="checkbox" style="width:16px; height:16px;"> Auto-sync online CSV on startup (slower)
                </label>
                <div id="upload-status" style="font-size:0.8rem; margin-top:5px; text-align:center;"></div>
            </div>
        </div>

        <div style="margin-top:20px; background:#F9FAFB; padding:15px; border-radius:12px;">
            <label style="font-size:0.85rem; font-weight:600; color:var(--ios-gray);">Study Mode</label>
            <div style="margin-top:8px; padding:12px; border-radius:10px; background:white; border:1px solid #e5e7eb; color:#111827; font-size:0.9rem; line-height:1.4;">
                ‚úÖ <strong>Flashcard (Anki-style)</strong> enabled<br>
                ‚Ä¢ Uses Again / Hard / Good / Easy scheduling<br>
                ‚Ä¢ Daily picks show only cards due today
            </div>
            <label style="display:block; margin-top:10px; font-size:0.8rem; color:var(--ios-gray);">Daily card limit</label>
            <input id="anki-daily-limit" type="number" min="5" max="200" step="1" class="settings-input" style="margin-top:6px; margin-bottom:0; background:white;" placeholder="e.g. 20">
            <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-top:8px;">
                <div>
                    <label style="display:block; font-size:0.75rem; color:var(--ios-gray);">Due limit</label>
                    <input id="anki-due-limit" type="number" min="1" max="200" step="1" class="settings-input" style="margin:4px 0 0; background:white;" placeholder="50">
                </div>
                <div>
                    <label style="display:block; font-size:0.75rem; color:var(--ios-gray);">Learn limit</label>
                    <input id="anki-learn-limit" type="number" min="1" max="100" step="1" class="settings-input" style="margin:4px 0 0; background:white;" placeholder="20">
                </div>
                <div>
                    <label style="display:block; font-size:0.75rem; color:var(--ios-gray);">New limit</label>
                    <input id="anki-new-limit" type="number" min="1" max="100" step="1" class="settings-input" style="margin:4px 0 0; background:white;" placeholder="20">
                </div>
            </div>
            <select id="quiz-engine" class="ios-select" style="width:100%; margin-top:8px; background:white;">
                <option value="local">Quiz engine: Local (fast, offline)</option>
                <option value="deepseek">Quiz engine: DeepSeek AI</option>
            </select>
        </div>

        <div style="margin-top:12px; font-size:0.82rem; color:#4b5563; background:#eef6ff; border:1px solid #dbeafe; border-radius:12px; padding:12px; line-height:1.45;">
            <div style="font-weight:700; color:#1d4ed8; margin-bottom:4px;">How to use</div>
            <div>1) Flashcard mode uses Anki-style spaced repetition.</div>
            <div>2) Set your <strong>daily card limit</strong> (e.g. 20).</div>
            <div>3) Set separate limits for <strong>Due / Learn / New</strong>.</div>
            <div>4) In Flashcard mode, rate cards with <strong>Again / Hard / Good / Easy</strong>.</div>
        </div>

        <button onclick="saveSettings()" class="action-btn btn-green" style="margin-top:20px;">Save Settings</button>
    </div>
</div>

<div id="progress-modal" class="modal-overlay" onclick="if(event.target===this) closeProgressModal()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <h3 style="margin:0;">üìä Knowledge Base</h3>
            <button onclick="closeProgressModal()" style="background:none; border:none; color:var(--ios-blue);">Close</button>
        </div>
        <div id="progress-list-content" style="overflow-y:auto; flex-grow:1;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="drugs.js"></script>

<script>
    // --- STATE VARIABLES ---
    let extendedDrugs = []; 
    let activeSourceList = []; 
    let filteredList = [];     
    let flashcardList = []; 
    let quizList = [];      
    let searchHistory = []; 
    let quizStats = {}; 
    let fcCurrentIndex = 0;
    let quizCurrentIndex = 0;
    let currentQuizData = null;
    let currentQuizQuestion = null;
    let selectedQuizLevel = '';
    let selectedQuizSystem = '';
    let selectedQuizCount = 10;
    let currentRoundTotal = 0;
    let currentRoundAnswered = 0;
    let quizQuestionQueue = [];
    let quizGenerationInFlight = false;
    let quizSession = { answered: 0, correct: 0, streak: 0, bestStreak: 0 };
    let searchDebounceTimer = null;
    const SEARCH_DEBOUNCE_MS = 120;
    let fcSelectedDrug = ""; 
    let quizEngine = localStorage.getItem('quiz_engine') || 'local';
    let ankiStats = JSON.parse(localStorage.getItem('drug_tutor_anki') || '{}');
    let ankiDailyLimit = parseInt(localStorage.getItem('anki_daily_limit') || '20', 10);
    let ankiNewLimit = parseInt(localStorage.getItem('anki_new_limit') || '20', 10);
    let ankiLearnLimit = parseInt(localStorage.getItem('anki_learn_limit') || '20', 10);
    let ankiDueLimit = parseInt(localStorage.getItem('anki_due_limit') || '50', 10);
    let autoSyncOnStartup = localStorage.getItem('auto_sync_startup') !== '0';

    const LOCAL_DRUG_CACHE_KEY = 'drug_tutor_local_data_v1';
    
    // API & Keys
    let currentProvider = localStorage.getItem('active_provider') || 'deepseek';
    let deepSeekKey = localStorage.getItem('ds_key') || "sk-92db3cf721454bd7b351ca6ef40eaaf7";
    let googleScriptURL = localStorage.getItem('google_script_url') || "https://script.google.com/macros/s/AKfycbxyNPyjbVXDMTQxFPxEuuCDTNNf-iVFfqedfNbh-kgn6Tk9rSIFEfIaLWXxXZoNOVnWug/exec";
    
    // Settings
    let defaultSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";

    // System Data
    const systemCategories = [
        "Gastro-intestinal system", "Cardiovascular system", "Respiratory system", "Central nervous system", "Infections", "Endocrine system",
        "Obstetrics, gynaecology, and urinary-tract disorders", "Malignant disease and immunosuppression", "Nutrition and blood",
        "Musculoskeletal and joint disease", "Eye", "Ear, nose, and oropharynx", "Skin", "Immunological products and vaccines", "Anaesthesia"
    ];
    const systemShortNames = {
        "Gastro-intestinal system": "GI System", "Cardiovascular system": "Cardio", "Respiratory system": "Respiratory",
        "Central nervous system": "CNS / Neuro", "Infections": "Infections", "Endocrine system": "Endocrine",
        "Obstetrics, gynaecology, and urinary-tract disorders": "ObGyn / GU", "Malignant disease and immunosuppression": "Oncology",
        "Nutrition and blood": "Nutrition / Blood", "Musculoskeletal and joint disease": "MSK / Bone",
        "Eye": "Eye", "Ear, nose, and oropharynx": "ENT", "Skin": "Skin", "Immunological products and vaccines": "Immune / Vax", "Anaesthesia": "Anaesthesia"
    };
    const systemIcons = {
        "Gastro-intestinal": "üçî", "Cardiovascular": "ü´Ä", "Respiratory": "ü´Å", "Central nervous": "üß†", 
        "Infections": "ü¶†", "Endocrine": "ü¶ã", "Obstetrics": "ü§∞", "Malignant": "üéóÔ∏è", "Nutrition": "üçé",
        "Musculoskeletal": "ü¶¥", "Eye": "üëÅÔ∏è", "Ear": "üëÇ", "Skin": "üß¥", "Immunological": "üõ°Ô∏è", "Anaesthesia": "üíâ"
    };

    function normalizeDrugData(drug) {
        drug.system = getSystemForDrug(drug);
        drug.side_effects = drug.side_effects || drug.SideEffects || drug.sideEffects || "Refer to nursing guide";
        drug.__searchBlob = `${drug.name || ''} ${(drug.class || '')} ${(drug.system || '')} ${(drug.indication || '')} ${(drug.side_effects || '')}`.toLowerCase();
        return drug;
    }

    function prepareDrugListForFastSearch(list) {
        return list.map(normalizeDrugData);
    }

    // --- INITIALIZATION ---
    window.onload = function() {
        if(typeof commonDrugs !== 'undefined') {
            activeSourceList = prepareDrugListForFastSearch([...commonDrugs]);
            flashcardList = [...activeSourceList];
        }

        // Load locally cached data first for faster startup on iPhone.
        const cachedData = loadLocalDrugCache();
        if (cachedData.length > 0) {
            activeSourceList = prepareDrugListForFastSearch(cachedData);
            flashcardList = [...activeSourceList];
            document.getElementById('set-btn').innerText = 'üìö Source: Local cache';
        }
        
        // Restore Data
        const savedHist = localStorage.getItem('drug_tutor_search_history');
        if(savedHist) searchHistory = JSON.parse(savedHist);
        const savedStats = localStorage.getItem('drug_tutor_quiz_stats');
        if(savedStats) quizStats = JSON.parse(savedStats);

        // Init UI
        document.getElementById('provider-select').value = currentProvider;
        document.getElementById('deepseek-key').value = deepSeekKey;
        document.getElementById('sheet-url').value = defaultSheetUrl;
        document.getElementById('quiz-engine').value = quizEngine;
        document.getElementById('anki-daily-limit').value = getAnkiDailyLimit();
        document.getElementById('anki-new-limit').value = getAnkiLimit(ankiNewLimit, 20, 1, 100);
        document.getElementById('anki-learn-limit').value = getAnkiLimit(ankiLearnLimit, 20, 1, 100);
        document.getElementById('anki-due-limit').value = getAnkiLimit(ankiDueLimit, 50, 1, 200);
        document.getElementById('auto-sync-startup').checked = autoSyncOnStartup;

        initSystemDropdown();
        initQuizSystemDropdown();
        applyFilter(false);
        renderHistory();
        updateProviderDisplay();

        const runNonCriticalInit = () => {
            renderAllSystems();
            generateDailyPicks();
            updateQueueStats(filteredList.length ? filteredList : activeSourceList);
        };
        if (window.requestIdleCallback) window.requestIdleCallback(runNonCriticalInit, { timeout: 600 });
        else setTimeout(runNonCriticalInit, 0);
        
        // Optional online sync (can be disabled for faster launch).
        if (autoSyncOnStartup) {
            fetchSheetData(true);
        } else {
            const status = document.getElementById('upload-status');
            if (status) status.innerText = '‚ö° Fast startup using local data';
        }
        
        switchMode('search');
    };


    function getAnkiDailyLimit() {
        const raw = Number(ankiDailyLimit);
        if (!Number.isFinite(raw)) return 20;
        return Math.min(200, Math.max(5, Math.round(raw)));
    }

    function getAnkiLimit(rawValue, fallback, minVal, maxVal) {
        const raw = Number(rawValue);
        if (!Number.isFinite(raw)) return fallback;
        return Math.min(maxVal, Math.max(minVal, Math.round(raw)));
    }

    function getAnkiQueueConfig() {
        const due = getAnkiLimit(ankiDueLimit, 50, 1, 200);
        const learn = getAnkiLimit(ankiLearnLimit, 20, 1, 100);
        const news = getAnkiLimit(ankiNewLimit, 20, 1, 100);
        return { due, learn, new: news };
    }

    function getTodaySeed() {
        const today = new Date().toISOString().slice(0, 10);
        return today.split('').reduce((acc, ch) => acc + ch.charCodeAt(0), 0);
    }

    function deterministicShuffle(list, seedBase = 1) {
        const arr = [...list];
        let seed = seedBase;
        const rand = () => {
            const x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        };
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(rand() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function updateDailyTitle(count) {
        const titleEl = document.getElementById('daily-title');
        if (titleEl) titleEl.innerText = `üìÖ Daily Study Picks (${count})`;
    }

    // --- DAILY RECOMMENDATIONS ---
    function generateDailyPicks() {
        if(!activeSourceList || activeSourceList.length === 0) return;
        const picks = getTodayStudyQueue(activeSourceList, getAnkiDailyLimit());
        renderDailyPicks(picks);
    }

    function refreshDailyPicks() {
        const due = getTodayStudyQueue(activeSourceList, getAnkiDailyLimit());
        renderDailyPicks(due);
    }

    function renderDailyPicks(picks) {
        const container = document.getElementById('daily-container');
        container.innerHTML = '';
        updateDailyTitle(picks.length);
        if (!picks.length) {
            container.innerHTML = `
                <div class="daily-card" style="grid-column: 1 / -1; justify-content:center; align-items:center; text-align:center;">
                    <div class="daily-name" style="font-size:1rem; margin:0;">‚úÖ No cards due today</div>
                    <div class="daily-sub" style="margin-top:6px;">You have finished today‚Äôs study queue.</div>
                </div>
            `;
            return;
        }
        const gradients = [
            'linear-gradient(140deg, #bfdbfe 0%, #93c5fd 50%, #dbeafe 100%)',
            'linear-gradient(140deg, #fde68a 0%, #fca5a5 55%, #fecaca 100%)',
            'linear-gradient(140deg, #bbf7d0 0%, #86efac 55%, #dcfce7 100%)',
            'linear-gradient(140deg, #ddd6fe 0%, #c4b5fd 50%, #ede9fe 100%)'
        ];
        
        picks.forEach((drug, idx) => {
            const div = document.createElement('div');
            div.className = 'daily-card';
            div.style.background = gradients[idx % gradients.length];
            const icon = getSystemIcon(drug.system || getSystemForDrug(drug));
            div.innerHTML = `
                <div>
                    <div class="daily-header">
                        <div class="daily-label">Due Today</div>
                        <div class="daily-icon-pill">${icon}</div>
                    </div>
                    <div class="daily-name">${drug.name.split('(')[0]}</div>
                </div>
                <div class="daily-sub">${drug.class}</div>
            `;
            div.onclick = () => {
                document.getElementById('search-input').value = drug.name;
                runSearch();
            };
            container.appendChild(div);
        });
    }

    // --- HELPER: DRUG NAME PARSING ---
    function parseDrugNamePairs(fullString) {
        const source = String(fullString || '');
        const chunks = source.includes(';') ? source.split(';') : [source];
        return chunks.map((chunk) => {
            const raw = String(chunk || '').trim();
            const generic = raw.replace(/\(.*?\)/g, '').trim();
            const brands = [...raw.matchAll(/\((.*?)\)/g)].map(m => (m[1] || '').trim()).filter(Boolean);
            return { generic, brand: brands.join(' / '), raw };
        }).filter(p => p.generic);
    }

    function parseDrugGenerics(fullString) {
        return parseDrugNamePairs(fullString).map(p => p.generic);
    }

    function buildSpeakLabel(selectedGeneric, fullName) {
        const pairs = parseDrugNamePairs(fullName);
        const target = pairs.find(p => p.generic.toLowerCase() === String(selectedGeneric || '').toLowerCase()) || pairs[0];
        if (!target) return '';
        if (!target.brand) return target.generic;
        return `${target.generic}. Brand name ${target.brand}`;
    }

    // --- NAVIGATION MODES ---
    function switchMode(mode) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('flashcard-section').style.display = 'none';
        document.getElementById('quiz-section').style.display = 'none';
        document.getElementById('search-section').style.display = 'none';
        document.getElementById('filter-bar').style.display = 'none';

        const sectionToShow = mode === 'quiz'
            ? document.getElementById('quiz-section')
            : (mode === 'search' ? document.getElementById('search-section') : document.getElementById('flashcard-section'));
        sectionToShow.classList.remove('mode-transition');
        void sectionToShow.offsetWidth;
        sectionToShow.classList.add('mode-transition');
        sectionToShow.style.animation = 'fadeSlideUp .24s ease-out';

        if(mode === 'search') {
            document.getElementById('search-section').style.display = 'block';
            document.getElementById('nav-search').classList.add('active');
            document.getElementById('search-input').focus();
        } else if (mode === 'anki' || mode === 'flashcard') {
            document.getElementById('flashcard-section').style.display = 'block';
            document.getElementById('nav-flash').classList.add('active');
            document.getElementById('filter-bar').style.display = 'flex';
            const source = filteredList.length ? filteredList : activeSourceList;
            hydrateAnkiForList(source);
            flashcardList = getTodayStudyQueue(source, getAnkiDailyLimit());
            updateQueueStats(source);
            fcCurrentIndex = 0;
            renderCard();
        } else if (mode === 'quiz') {
            document.getElementById('quiz-section').style.display = 'block';
            document.getElementById('nav-quiz').classList.add('active');
            const qEl = document.getElementById('quiz-question');
            if (qEl) qEl.innerText = 'Select level, system, and question count. Then tap Start.';
        }
    }

    // --- ANKI CARD LOGIC ---
    function formatRelativeDue(dueTs) {
        const delta = dueTs - Date.now();
        const hours = Math.round(delta / (1000 * 60 * 60));
        if (Math.abs(hours) < 24) return hours <= 0 ? 'due now' : `due in ${hours}h`;
        const days = Math.round(hours / 24);
        return days <= 0 ? 'due now' : `due in ${days}d`;
    }

    function updateAnkiMeta(drug) {
        const metaEl = document.getElementById('anki-meta');
        if (!drug) {
            metaEl.innerText = 'No cards due right now. Great work.';
            return;
        }
        const stat = ankiStats[drug.name] || { ease: 2.3, reps: 0, lapses: 0, due: Date.now(), lastReviewed: 0 };
        const reps = stat.reps || 0;
        const learning = reps === 0 && (stat.lastReviewed || 0) > 0 ? 'Learn' : (reps > 0 ? 'Due' : 'New');
        metaEl.innerText = `${learning} ‚Ä¢ Ease ${Number(stat.ease || 2.3).toFixed(2)} ‚Ä¢ Reps ${reps} ‚Ä¢ Lapses ${stat.lapses || 0} ‚Ä¢ ${formatRelativeDue(stat.due || Date.now())}`;
    }

    function getQueueBucketCounts(list) {
        const now = Date.now();
        const counts = { due: 0, learn: 0, new: 0 };
        (list || []).forEach(drug => {
            const stat = ankiStats[drug.name] || {};
            const reps = stat.reps || 0;
            const due = stat.due || 0;
            const lastReviewed = stat.lastReviewed || 0;
            if (reps > 0 && due <= now) counts.due++;
            else if (reps === 0 && lastReviewed > 0 && due <= now) counts.learn++;
            else if (reps === 0 && !lastReviewed) counts.new++;
        });
        return counts;
    }

    function updateQueueStats(list) {
        const statsEl = document.getElementById('flashcard-queue-stats');
        if (!statsEl) return;
        const c = getQueueBucketCounts(list || []);
        const cfg = getAnkiQueueConfig();
        const item = (label, value, cap, color) => `<div style="background:white; border:1px solid #e5e7eb; border-radius:10px; padding:8px; text-align:center;"><div style="font-size:0.72rem; color:${color}; font-weight:700;">${label}</div><div style="font-size:1.1rem; font-weight:800; color:#111827;">${value}</div><div style="font-size:0.68rem; color:#6b7280;">limit ${cap}</div></div>`;
        statsEl.innerHTML = item('Due', c.due, cfg.due, '#dc2626') + item('Learn', c.learn, cfg.learn, '#d97706') + item('New', c.new, cfg.new, '#2563eb');
    }

    function renderCard() {
        if(flashcardList.length === 0) {
            document.getElementById('fc-name').innerText = 'No cards due üìö';
            document.getElementById('fc-class').innerText = 'Great job. You have no due cards right now.';
            document.getElementById('fc-system').innerText = 'Flashcard review queue is empty.';
            document.getElementById('fc-indication').innerText = 'Try again later, or learn in Search mode first.';
            document.getElementById('fc-side-effects').innerText = '-';
            document.getElementById('fc-nursing').innerText = '-';
            document.getElementById('counter').innerText = '0 / 0';
            document.getElementById('btn-case').disabled = true;
            document.getElementById('btn-case').innerHTML = 'ü™Ñ AI Clinical Case';
            document.getElementById('fc-ai-case').style.display = 'none';
            document.getElementById('btn-read-case').style.display = 'none';
            document.getElementById('show-answer-btn').style.display = 'none';
            document.getElementById('anki-controls').style.display = 'none';
            updateAnkiMeta(null);
            return;
        }
        const drug = flashcardList[fcCurrentIndex];
        
        document.getElementById('fc-name').innerText = drug.name;
        document.getElementById('fc-class').innerText = drug.class;
        document.getElementById('fc-system').innerText = drug.system || getSystemForDrug(drug);
        document.getElementById('fc-indication').innerText = drug.indication;
        document.getElementById('fc-side-effects').innerText = drug.side_effects || drug.sideEffects || "Not listed";
        
        document.getElementById('fc-nursing').innerText = drug.nursing;
        document.getElementById('counter').innerText = `${fcCurrentIndex + 1} / ${flashcardList.length}`;
        document.getElementById('fc-ai-case').style.display = 'none';
        document.getElementById('btn-read-case').style.display = 'none';
        document.getElementById('flashcard').classList.remove('flipped');
        document.getElementById('show-answer-btn').style.display = 'flex';
        document.getElementById('anki-controls').style.display = 'none';

        document.getElementById('btn-case').innerHTML = 'ü™Ñ AI Clinical Case';
        document.getElementById('btn-case').disabled = false;
        updateAnkiMeta(drug);

        const generics = parseDrugGenerics(drug.name);
        const chipWrap = document.getElementById('fc-multi-chip-wrap');
        if (generics.length > 1) {
            chipWrap.style.display = 'block';
            chipWrap.innerHTML = `<div class="multi-chip-wrap">${generics.map(g => `<span class="multi-chip selectable ${g === fcSelectedDrug ? 'is-active' : ''}" onclick="event.stopPropagation(); selectFlashcardGeneric('${g.replace(/'/g, "\\'")}')">üíñ ${g}</span>`).join('')}</div>`;
        } else {
            chipWrap.style.display = 'none';
            chipWrap.innerHTML = '';
        }

        closeFcDrugPicker();
        selectFlashcardGeneric(generics.includes(fcSelectedDrug) ? fcSelectedDrug : generics[0]);
    }

    function openFcDrugPicker() {
        document.getElementById('fc-drug-picker').style.display = 'flex';
    }

    function closeFcDrugPicker() {
        document.getElementById('fc-drug-picker').style.display = 'none';
    }

    function pickDrugFromList(generics, title, onPick) {
        const pickerList = document.getElementById('fc-picker-list');
        const titleEl = document.querySelector('#fc-drug-picker h3');
        titleEl.innerText = title;
        pickerList.innerHTML = '';
        generics.forEach(gen => {
            const btn = document.createElement('button');
            btn.className = 'action-btn';
            btn.style.margin = '0';
            btn.style.justifyContent = 'flex-start';
            btn.innerText = `üíñ ${gen}`;
            btn.onclick = () => { closeFcDrugPicker(); onPick(gen); };
            pickerList.appendChild(btn);
        });
        openFcDrugPicker();
    }

    function updateFlashcardLinks(genericName) {
        fcSelectedDrug = genericName;
        // Google deep link handled in triggerFcAction('google').
    }

    function selectFlashcardGeneric(genericName) {
        updateFlashcardLinks(genericName);
        const chipWrap = document.getElementById('fc-multi-chip-wrap');
        chipWrap.querySelectorAll('.multi-chip.selectable').forEach((chip) => {
            chip.classList.toggle('is-active', chip.innerText.includes(genericName));
        });
    }

    function triggerFcAction(action) {
        if (!flashcardList.length) return;
        const drug = flashcardList[fcCurrentIndex];
        const generics = parseDrugGenerics(drug.name);
        const run = (pickedDrug) => runFcAction(action, pickedDrug);
        if (generics.length > 1) {
            pickDrugFromList(generics, 'Pick a drug for this action', run);
            return;
        }
        run(generics[0]);
    }

    function runFcAction(action, selectedDrugName) {
        const selected = selectedDrugName || fcSelectedDrug;
        const currentDrug = flashcardList[fcCurrentIndex];
        updateFlashcardLinks(selected);
        if (action === 'google') {
            const googleQuery = `${selected} nursing considerations`;
            openGoogleDeepLink(googleQuery);
        } else if (action === 'drugs') {
            openDrugsCom({name: selected});
        } else if (action === 'case') {
            const d = {...flashcardList[fcCurrentIndex], name: selected};
            getIntegratedCaseStudy(d, 'fc-ai-case', 'btn-case', 'btn-read-case');
        } else if (action === 'speak') {
            const spoken = buildSpeakLabel(selected, currentDrug?.name || selected);
            speakText(spoken || selected);
        }
    }

    function showAnswer() {
        document.getElementById('flashcard').classList.add('flipped');
        document.getElementById('show-answer-btn').style.display = 'none';
        document.getElementById('anki-controls').style.display = 'grid';
    }

    function flipCard(e) {
        if(e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.tagName === 'SELECT') return;
        const card = document.getElementById('flashcard');
        card.classList.toggle('flipped');
        const showingBack = card.classList.contains('flipped');
        document.getElementById('show-answer-btn').style.display = showingBack ? 'none' : 'flex';
        document.getElementById('anki-controls').style.display = showingBack ? 'grid' : 'none';
    }

    function nextCard() {
        if(fcCurrentIndex < flashcardList.length - 1) {
            fcCurrentIndex++;
            renderCard();
            return;
        }
        // End of today's queue: do not auto-load another full batch.
        flashcardList = [];
        fcCurrentIndex = 0;
        renderCard();
    }

    function prevCard() {
        if(fcCurrentIndex > 0) { fcCurrentIndex--; renderCard(); }
    }

    function hydrateAnkiForList(list) {
        list.forEach(drug => {
            if (!ankiStats[drug.name]) {
                ankiStats[drug.name] = { ease: 2.3, interval: 0, reps: 0, lapses: 0, due: null, lastReviewed: 0 };
            }
        });
    }

    function getDueCards(list) {
        hydrateAnkiForList(list);
        const now = Date.now();
        const due = list.filter(d => {
            const stat = ankiStats[d.name] || {};
            return (stat.reps || 0) > 0 && (stat.due || 0) <= now;
        });
        due.sort((a, b) => (ankiStats[a.name].due || 0) - (ankiStats[b.name].due || 0));
        return due;
    }

    function scheduleCardForRetry(drug, stepsAhead = 2) {
        if (!drug || !flashcardList.length) return;
        const tail = flashcardList.slice(fcCurrentIndex + 1).filter(d => d.name !== drug.name);
        const head = flashcardList.slice(0, fcCurrentIndex + 1);
        const insertAt = Math.min(tail.length, Math.max(0, Math.round(stepsAhead)));
        tail.splice(insertAt, 0, drug);
        flashcardList = [...head, ...tail];
    }

    function getTodayStudyQueue(list, maxCards = getAnkiDailyLimit()) {
        hydrateAnkiForList(list);
        const now = Date.now();
        const limit = Math.max(1, Math.round(maxCards));
        const queueCfg = getAnkiQueueConfig();

        const dueReviews = [];
        const learningDue = [];
        const newCards = [];

        list.forEach(drug => {
            const stat = ankiStats[drug.name] || {};
            const reps = stat.reps || 0;
            const due = stat.due || 0;
            const lastReviewed = stat.lastReviewed || 0;

            if (reps > 0 && due <= now) {
                dueReviews.push(drug);
            } else if (reps === 0 && lastReviewed > 0 && due <= now) {
                learningDue.push(drug);
            } else if (reps === 0 && !lastReviewed) {
                newCards.push(drug);
            }
        });

        dueReviews.sort((a, b) => (ankiStats[a.name].due || 0) - (ankiStats[b.name].due || 0));
        learningDue.sort((a, b) => (ankiStats[a.name].due || 0) - (ankiStats[b.name].due || 0));

        const dueSelected = dueReviews.slice(0, queueCfg.due);
        const learnSelected = learningDue.slice(0, queueCfg.learn);
        const remainingSlots = Math.max(0, limit - dueSelected.length - learnSelected.length);
        const newCap = Math.min(queueCfg.new, remainingSlots);
        const seededNew = deterministicShuffle(newCards, getTodaySeed()).slice(0, newCap);

        return [...dueSelected, ...learnSelected, ...seededNew].slice(0, limit);
    }

    function rateCurrentCard(rating) {
        if (flashcardList.length === 0) return;
        const drug = flashcardList[fcCurrentIndex];
        hydrateAnkiForList([drug]);
        const stat = ankiStats[drug.name];

        const qualityMap = { again: 1, hard: 3, good: 4, easy: 5 };
        const q = qualityMap[rating] || 4;

        if (q < 3) {
            stat.reps = 0;
            stat.lapses = (stat.lapses || 0) + 1;
            stat.interval = 1;
        } else {
            stat.reps = (stat.reps || 0) + 1;
            if (stat.reps === 1) stat.interval = 1;
            else if (stat.reps === 2) stat.interval = 3;
            else {
                const mult = rating === 'hard' ? 1.2 : (rating === 'easy' ? (stat.ease + 0.15) : stat.ease);
                stat.interval = Math.max(1, Math.round(stat.interval * mult));
            }
        }

        stat.ease = Math.max(1.3, (stat.ease || 2.3) + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02)));
        const minute = 60 * 1000;
        const day = 24 * 60 * 60 * 1000;
        if (rating === 'again') stat.due = Date.now() + 10 * minute;
        else if (rating === 'hard') stat.due = Date.now() + Math.max(1, Math.round(stat.interval * 0.6)) * day;
        else if (rating === 'easy') stat.due = Date.now() + Math.max(2, Math.round(stat.interval * 1.3)) * day;
        else stat.due = Date.now() + (stat.interval * day);
        stat.lastReviewed = Date.now();

        // Keep "Again" cards in the same session so failed cards repeat quickly.
        if (rating === 'again') {
            scheduleCardForRetry(drug, 2);
        }

        localStorage.setItem('drug_tutor_anki', JSON.stringify(ankiStats));
        nextCard();
    }

    // --- SEARCH LOGIC ---
    function handleSearch() {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => runSearch(), SEARCH_DEBOUNCE_MS);
    }

    function runSearch() {
        const query = document.getElementById('search-input').value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        if(query.length < 2) return;

        const results = activeSourceList.filter(d => (d.__searchBlob || '').includes(query)).slice(0, 20);
        
        if(results.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; color:var(--text-secondary); margin-top:40px;">
                    <p>No local drugs found for "${query}".</p>
                    <button onclick="triggerAISearch('${query.replace(/'/g, "\\'")}')" class="action-btn btn-primary" style="margin-top:15px;">
                        ‚ú® Ask AI to Find & Add "${query}"
                    </button>
                    <div id="ai-search-output"></div>
                </div>
            `;
            return;
        }

        const fragment = document.createDocumentFragment();

        results.forEach((drug, index) => {
            const card = document.createElement('div');
            card.className = 'result-card';
            
            const explainId = 'explain-' + index + '-' + Math.floor(Math.random() * 1000);
            const generics = parseDrugGenerics(drug.name);
            const sideEffectsText = drug.side_effects || drug.sideEffects || "Not listed";

            card.innerHTML = `
                <div class="result-header">
                    <div class="name-with-speak">
                        <span class="result-name">${drug.name}</span>
                        <button class="speak-icon-btn" onclick="event.stopPropagation(); triggerSearchSpeak(this)" title="Speak">üó£Ô∏è</button>
                    </div>
                    <span class="result-class">${drug.class}</span>
                </div>
                <div style="font-size:0.9rem; margin-top:5px; color:#555;">${drug.indication}</div>
                ${generics.length > 1 ? `<div class="multi-chip-wrap" style="margin-top:8px;">${generics.map(g => `<span class=\"multi-chip selectable ${g === generics[0] ? 'is-active' : ''}\" onclick=\"event.stopPropagation(); selectSearchGeneric(this, '${g.replace(/'/g, "\\'")}')\">üíñ ${g}</span>`).join('')}</div>` : ''}
                
                <div class="extra-details">
                    <div style="margin-bottom:5px;"><strong>Side Effects:</strong> <span style="color:#d32f2f;">${sideEffectsText}</span></div>
                    <div style="margin-bottom:5px;"><strong>Nursing:</strong> ${drug.nursing}</div>
                    <div style="margin-bottom:5px;"><strong>System:</strong> ${drug.system}</div>
                    
                    <div style="display:flex; gap:10px; margin-top:15px; overflow-x:auto;">
                         <span class="chip" onclick="event.stopPropagation(); triggerSearchGoogle(this)">üîé Google</span>
                         <span class="chip" onclick="event.stopPropagation(); triggerSearchDrugsCom(this)">üß¥ Drugs.com</span>
                         <span class="chip" style="background:var(--ios-indigo); color:white;" onclick="event.stopPropagation(); triggerSearchExplain(this, '${explainId}')">ü™Ñ Explain</span>
                    </div>
                    <div id="${explainId}" class="ai-output"></div>
                </div>
            `;
            
            card.dataset.currentGeneric = generics[0];
            card.dataset.generics = JSON.stringify(generics);
            
            card.onclick = (e) => {
                if(['SELECT', 'A', 'BUTTON', 'SPAN', 'INPUT'].includes(e.target.tagName)) return;
                card.classList.toggle('expanded');
            };
            
            fragment.appendChild(card);
        });
        
        container.appendChild(fragment);
    }

    function withSearchDrugSelection(btn, title, cb) {
        const card = btn.closest('.result-card');
        const generics = JSON.parse(card.dataset.generics || '[]');
        if (generics.length > 1) {
            pickDrugFromList(generics, title, cb);
            return;
        }
        cb(card.dataset.currentGeneric);
    }

    window.triggerSearchGoogle = function(btn) {
        withSearchDrugSelection(btn, 'Pick a drug for Google', (name) => {
            const q = `${name} nursing considerations`;
            openGoogleDeepLink(q);
        });
    };

    window.triggerSearchDrugsCom = function(btn) {
        withSearchDrugSelection(btn, 'Pick a drug for Drugs.com', (name) => openDrugsCom({name}));
    };
    
    window.triggerSearchSpeak = function(btn) {
        withSearchDrugSelection(btn, 'Pick a drug to speak', (name) => {
            const card = btn.closest('.result-card');
            if (card && name) {
                card.dataset.currentGeneric = name;
                refreshSearchGenericChips(card, name);
                const fullName = card.querySelector('.result-name')?.innerText || name;
                const spoken = buildSpeakLabel(name, fullName);
                speakText(spoken || name);
            }
        });
    };

    window.selectSearchGeneric = function(chipEl, genericName) {
        const card = chipEl.closest('.result-card');
        if (!card || !genericName) return;
        card.dataset.currentGeneric = genericName;
        refreshSearchGenericChips(card, genericName);
    };

    function refreshSearchGenericChips(card, genericName) {
        card.querySelectorAll('.multi-chip.selectable').forEach((chip) => {
            chip.classList.toggle('is-active', chip.innerText.includes(genericName));
        });
    }
    
    window.triggerSearchExplain = function(btn, outputId) {
        const box = document.getElementById(outputId);
        btn.innerText = "‚è≥";
        box.style.display = 'block';
        withSearchDrugSelection(btn, 'Pick a drug for explanation', (pickedName) => {
            const prompt = `Explain ${pickedName} in English with standard medical terminology. Use short Markdown bullet points for fast mobile reading. Format: 1) MOA 2) Key Indication 3) Monitoring 4) Safety Warning. Keep each point under 12 words.`;
            streamAIResponse([{role: "user", content: prompt}], (text) => box.innerHTML = marked.parse(text));
        });
        btn.innerText = "‚úÖ";
    }

    function quickSearch(term) {
        document.getElementById('search-input').value = term;
        runSearch();
    }

    // --- AI & DATA FUNCTIONS ---
    async function triggerAISearch(query) {
        const container = document.getElementById('ai-search-output');
        container.style.display = 'block';
        container.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <div class="loading-spinner"></div>
                <div style="margin-top:10px; font-weight:600;">Searching database...</div>
            </div>`;

        const prompt = `You are a nursing tutor. The user searched for "${query}". Return strict JSON only.
Keys: "name", "class", "system", "indication", "nursing", "side_effects".
Rules:
1) Use English only with clear medical terminology.
2) Keep content short for fast mobile reading.
3) "system" must be exactly one of: [Gastro-intestinal system, Cardiovascular system, Respiratory system, Central nervous system, Infections, Endocrine system, Obstetrics, gynaecology, and urinary-tract disorders, Malignant disease and immunosuppression, Nutrition and blood, Musculoskeletal and joint disease, Eye, Ear, nose, and oropharynx, Skin, Immunological products and vaccines, Anaesthesia].
4) "nursing" and "side_effects" should be short bullet-like strings.
5) Output JSON only, no markdown.`;

        try {
            let fullText = "";
            await streamAIResponse([{role: "user", content: prompt}], (text) => { fullText = text; });
            fullText = fullText.replace(/```json/g, '').replace(/```/g, '').trim();
            const drugData = JSON.parse(fullText);

            container.innerHTML = `
                <div class="ios-card" style="border:2px solid var(--ios-green); margin-top:20px; text-align:left;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; color:var(--ios-blue);">${drugData.name}</h3>
                        <span class="chip" style="background:var(--ios-green); color:white;">AI Found</span>
                    </div>
                    <div class="detail-row"><div class="detail-label">Class</div><div class="detail-content">${drugData.class}</div></div>
                    <div class="detail-row"><div class="detail-label">System</div><div class="detail-content">${drugData.system}</div></div>
                    <div class="detail-row"><div class="detail-label">Indication</div><div class="detail-content">${drugData.indication}</div></div>
                    <div class="detail-row"><div class="detail-label">Side Effects</div><div class="detail-content" style="color:#d32f2f;">${drugData.side_effects}</div></div>
                    <div class="detail-row"><div class="detail-label">Nursing</div><div class="detail-content" style="font-size:0.9rem;">${drugData.nursing}</div></div>
                    <button id="btn-save-sheet" onclick='saveToGoogleSheet(${JSON.stringify(drugData)})' class="action-btn btn-green">üíæ Save to Database</button>
                    <div id="save-status" style="text-align:center; margin-top:10px; font-size:0.85rem; font-weight:600;"></div>
                </div>`;
        } catch (e) {
            container.innerHTML = `<div style="color:red; margin-top:10px;">Search failed. Please try again.</div>`;
        }
    }

    function saveToGoogleSheet(drugData) {
        const statusEl = document.getElementById('save-status');
        const saveBtn = document.getElementById('btn-save-sheet');
        
        if(!googleScriptURL) { alert("Please set the Google Script URL in Settings (‚öôÔ∏è) first."); return; }

        saveBtn.disabled = true; saveBtn.innerText = "‚è≥ Saving..."; statusEl.innerText = "Syncing with cloud...";

        fetch(googleScriptURL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(drugData) })
        .then(() => { 
            statusEl.innerText = "‚úÖ Saved successfully!"; statusEl.style.color = "var(--ios-green)"; 
            saveBtn.innerText = "üíæ Saved"; 
            activeSourceList.push(normalizeDrugData(drugData)); 
        })
        .catch(err => { 
            statusEl.innerText = "‚ùå Save failed."; statusEl.style.color = "var(--ios-red)"; saveBtn.disabled = false; 
        });
    }

    function openGoogleDeepLink(queryText) {
        const q = encodeURIComponent(queryText || '');
        const appLink = `google://search?q=${q}`;
        const webLink = `https://www.google.com/search?igu=1&q=${q}`;

        const now = Date.now();
        window.location.href = appLink;
        setTimeout(() => {
            if (Date.now() - now < 1600) {
                window.open(webLink, '_blank', 'noopener');
            }
        }, 700);
    }

    function openDrugsCom(drug) {
        let cleanName = drug.name.split('(')[0].trim();
        const query = encodeURIComponent(cleanName);
        window.open(`https://www.drugs.com/search.php?searchterm=${query}`, '_blank');
    }

    // --- HELPER FUNCTIONS ---
    function getSystemForDrug(drug) {
        if (drug.system && systemCategories.includes(drug.system)) return drug.system;
        const txt = (drug.class + " " + drug.indication + " " + drug.name).toLowerCase();
        if (txt.includes("antacid") || txt.includes("ulcer")) return "Gastro-intestinal system";
        if (txt.includes("cardio") || txt.includes("beta-blocker")) return "Cardiovascular system";
        if (txt.includes("asthma") || txt.includes("broncho")) return "Respiratory system";
        if (txt.includes("analgesic") || txt.includes("depress")) return "Central nervous system";
        if (txt.includes("antibiotic") || txt.includes("viral")) return "Infections";
        return "Other"; 
    }
    
    function getSystemIcon(sys) {
        for(let k in systemIcons) { if(sys.includes(k) || k.includes(sys.split(' ')[0])) return systemIcons[k]; }
        return "üíä";
    }

    function initSystemDropdown() {
        const select = document.getElementById('system-filter');
        while (select.options.length > 1) { select.remove(1); }
        systemCategories.forEach(sys => {
            const opt = document.createElement('option');
            opt.value = sys; opt.innerText = sys; select.appendChild(opt);
        });
    }

    function initQuizSystemDropdown() {
        const select = document.getElementById('quiz-system');
        if (!select) return;
        select.innerHTML = '<option value="">Select system</option><option value="All">All systems</option>';
        systemCategories.forEach(sys => {
            const opt = document.createElement('option');
            opt.value = sys;
            opt.innerText = sys;
            select.appendChild(opt);
        });
    }
    
    function applyFilter(shouldReshuffle = true) {
        const sysCategory = document.getElementById('system-filter').value;
        const masteryCategory = document.getElementById('mastery-filter').value;
        
        filteredList = activeSourceList.filter(drug => {
            const sys = drug.system || getSystemForDrug(drug);
            const sysMatch = (sysCategory === "All" || sys === sysCategory);
            let masteryMatch = true;
            if (masteryCategory !== "All") {
                const s = quizStats[drug.name];
                const pct = s && s.attempts > 0 ? (s.correct/s.attempts)*100 : 0;
                if(masteryCategory === 'Mastered') masteryMatch = (pct >= 80 && s && s.attempts >= 2);
                else if(masteryCategory === 'Learning') masteryMatch = (pct >= 50 && pct < 80);
                else masteryMatch = (pct < 50 || !s);
            }
            return sysMatch && masteryMatch;
        });
        
        if (filteredList.length === 0) {
            alert("No drugs found matching these filters.");
            document.getElementById('mastery-filter').value = "All";
            filteredList = [...activeSourceList];
        }
        if (shouldReshuffle) reshuffle();
    }
    
    function reshuffle() {
        flashcardList = [...filteredList];
        flashcardList.sort(() => Math.random() - 0.5);
        quizList = [...filteredList];
        fcCurrentIndex = 0;
        hydrateAnkiForList(filteredList);
        flashcardList = getTodayStudyQueue(filteredList, getAnkiDailyLimit());
        updateQueueStats(filteredList);
        renderCard();
    }
    
    function renderAllSystems() {
        const container = document.getElementById('recommend-container');
        container.innerHTML = '';
        systemCategories.forEach(sys => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.style.background = '#E0E7FF'; chip.style.color = '#4338ca';
            const shortName = systemShortNames[sys] || sys;
            chip.innerText = `${getSystemIcon(sys)} ${shortName}`;
            chip.onclick = () => { document.getElementById('search-input').value = sys; runSearch(); };
            container.appendChild(chip);
        });
    }
    
    function renderHistory() {
        const container = document.getElementById('history-container');
        const section = document.getElementById('history-section');
        container.innerHTML = '';
        if(searchHistory.length === 0) { section.style.display = 'none'; return; }
        section.style.display = 'block';
        searchHistory.forEach(term => {
            const chip = document.createElement('div');
            chip.className = 'chip'; chip.innerText = term;
            chip.onclick = () => { document.getElementById('search-input').value = term; runSearch(); };
            container.appendChild(chip);
        });
    }

    // --- QUIZ LOGIC ---
    function updateQuizSessionUI() {
        const answered = quizSession.answered || 0;
        const pct = answered ? Math.round((quizSession.correct / answered) * 100) : 0;
        document.getElementById('quiz-score').innerText = `${pct}%`;
        document.getElementById('quiz-streak').innerText = `${quizSession.streak}`;
        document.getElementById('quiz-answered').innerText = `${answered}`;
    }

    function updateQuizRoundProgress() {
        const el = document.getElementById('quiz-round-progress');
        if (!el) return;
        if (!currentRoundTotal) {
            el.innerText = 'Round not started';
            return;
        }
        el.innerText = `Round progress: ${currentRoundAnswered}/${currentRoundTotal}`;
    }

    function startQuizRound() {
        const levelEl = document.getElementById('quiz-level');
        const systemEl = document.getElementById('quiz-system');
        const countEl = document.getElementById('quiz-count');
        selectedQuizLevel = levelEl ? levelEl.value : '';
        selectedQuizSystem = systemEl ? systemEl.value : '';
        selectedQuizCount = parseInt(countEl?.value || '10', 10) || 10;

        currentRoundTotal = selectedQuizCount;
        currentRoundAnswered = 0;
        quizQuestionQueue = [];
        quizGenerationInFlight = false;
        updateQuizRoundProgress();
        generateQuizQuestion();
    }

    function getWeakDrugPool(list) {
        if (!list.length) return [];
        const scored = list.map(drug => {
            const s = quizStats[drug.name];
            if (!s || !s.attempts) return { drug, weakness: 1.2 };
            const accuracy = s.correct / s.attempts;
            return { drug, weakness: Math.max(0.05, 1 - accuracy) + Math.min(0.5, s.attempts * 0.03) };
        });
        scored.sort((a, b) => b.weakness - a.weakness);
        return scored.slice(0, Math.min(12, scored.length)).map(x => x.drug);
    }

    function buildQuizQuestion(correctDrug, level) {
        const levels = ['remembering', 'understanding', 'applying', 'analyzing', 'evaluating'];
        const resolvedLevel = level === 'mix'
            ? levels[Math.floor(Math.random() * levels.length)]
            : level;
        const nursingContext = `System: ${correctDrug.system || getSystemForDrug(correctDrug)} | Class: ${correctDrug.class}`;
        const templatesByLevel = {
            remembering: [
                {
                    type: 'drug_to_class',
                    prompt: `üß† [Remembering]\nDrug focus: ${correctDrug.name}\n${nursingContext}\nRecall-level check: identify the correct pharmacological class used in bedside medication rounds.`,
                    answerLabel: d => d.class,
                },
                {
                    type: 'drug_to_indication',
                    prompt: `üß† [Remembering]\nDrug focus: ${correctDrug.name}\n${nursingContext}\nRecall-level check: identify the primary clinical indication most relevant to routine nursing administration.`,
                    answerLabel: d => d.indication,
                }
            ],
            understanding: [
                {
                    type: 'class_to_drug',
                    prompt: `üìò [Understanding]\nClass focus: "${correctDrug.class}"\nNursing interpretation: choose the drug that best matches this class and usual nursing intent for monitoring and safe administration.`,
                    answerLabel: d => d.name,
                },
                {
                    type: 'indication_to_drug',
                    prompt: `üìò [Understanding]\nIndication focus: "${correctDrug.indication}"\nNursing interpretation: choose the drug that best explains this indication in day-to-day ward practice.`,
                    answerLabel: d => d.name,
                }
            ],
            applying: [
                {
                    type: 'apply_indication',
                    prompt: `üõ†Ô∏è [Applying]\nClinical mini-scenario: A patient in ${correctDrug.system || getSystemForDrug(correctDrug)} requires treatment for "${correctDrug.indication}".\nApply knowledge of drug class, indication, and practical nursing administration priorities to select the most appropriate drug option.`,
                    answerLabel: d => d.name,
                }
            ],
            analyzing: [
                {
                    type: 'analyze_class',
                    prompt: `üîé [Analyzing]\nReference drug: ${correctDrug.name} (${correctDrug.class}).\nAnalyze all options and identify which option belongs to the same therapeutic class after comparing class-indication relationships relevant to nursing checks and medication safety.`,
                    answerLabel: d => d.name,
                }
            ],
            evaluating: [
                {
                    type: 'evaluate_best_fit',
                    prompt: `‚öñÔ∏è [Evaluating]\nDecision focus: indication "${correctDrug.indication}" in ${correctDrug.system || getSystemForDrug(correctDrug)} care.\nEvaluate all options and choose the best therapeutic fit considering bedside nursing priorities: appropriateness, safety monitoring needs, and risk awareness.`,
                    answerLabel: d => d.name,
                }
            ]
        };

        const templates = templatesByLevel[resolvedLevel] || templatesByLevel.remembering;
        const selectedTemplate = templates[Math.floor(Math.random() * templates.length)];
        return {
            type: selectedTemplate.type,
            prompt: selectedTemplate.prompt,
            answerLabel: selectedTemplate.answerLabel,
            correctDrug,
            level: resolvedLevel
        };
    }

    async function generateQuizQuestion() {
        const container = document.getElementById('quiz-options');
        const qEl = document.getElementById('quiz-question');
        const levelEl = document.getElementById('quiz-level');
        const systemEl = document.getElementById('quiz-system');
        container.innerHTML = '';
        document.getElementById('quiz-feedback').style.display = 'none';
        document.getElementById('next-quiz-btn').style.display = 'none';
        document.getElementById('quiz-mini-explainer').style.display = 'none';
        updateQuizSessionUI();

        if (!selectedQuizLevel || !selectedQuizSystem) {
            qEl.innerText = "Please select both quiz level and drug system before each round.";
            return;
        }

        if (currentRoundTotal && currentRoundAnswered >= currentRoundTotal) {
            qEl.innerText = `Round complete (${currentRoundAnswered}/${currentRoundTotal}). Select options and press Start for a new round.`;
            return;
        }

        if (quizQuestionQueue.length > 0) {
            const nextQ = quizQuestionQueue.shift();
            renderPreparedQuizQuestion(container, qEl, nextQ);
            preGenerateNextQuestion();
            return;
        }

        const roundQuizList = selectedQuizSystem === 'All'
            ? [...quizList]
            : quizList.filter(drug => (drug.system || getSystemForDrug(drug)) === selectedQuizSystem);
        if (roundQuizList.length === 0) { qEl.innerText = "No drugs available for the selected system."; return; }

        qEl.innerText = 'Preparing question...';
        const prepared = await prepareQuizQuestion(roundQuizList, selectedQuizLevel, selectedQuizSystem);
        if (!prepared) {
            qEl.innerText = 'Unable to generate quiz question. Please try again.';
            return;
        }
        renderPreparedQuizQuestion(container, qEl, prepared);
        preGenerateNextQuestion();
    }

    function renderPreparedQuizQuestion(container, qEl, q) {
        if (!q) return;
        currentQuizQuestion = q;
        qEl.innerText = q.prompt;
        container.innerHTML = '';
        (q.options || []).forEach(optText => {
            const btn = document.createElement('button');
            btn.className = 'action-btn quiz-option-btn';
            btn.innerText = optText;
            btn.onclick = () => checkAnswer(btn, optText, q);
            container.appendChild(btn);
        });
    }

    async function prepareQuizQuestion(roundQuizList, level, system) {
        if (quizEngine === 'deepseek' && deepSeekKey && deepSeekKey.startsWith('sk-')) {
            const aiQ = await generateAIQuizQuestionData(roundQuizList, level, system);
            if (aiQ) return aiQ;
        }
        return generateLocalQuizQuestionData(roundQuizList, level);
    }

    async function preGenerateNextQuestion() {
        if (quizGenerationInFlight) return;
        if (!currentRoundTotal || currentRoundAnswered >= currentRoundTotal - 1) return;
        if (quizQuestionQueue.length > 0) return;
        const roundQuizList = selectedQuizSystem === 'All'
            ? [...quizList]
            : quizList.filter(drug => (drug.system || getSystemForDrug(drug)) === selectedQuizSystem);
        if (!roundQuizList.length) return;
        quizGenerationInFlight = true;
        try {
            const nextQ = await prepareQuizQuestion(roundQuizList, selectedQuizLevel, selectedQuizSystem);
            if (nextQ) quizQuestionQueue.push(nextQ);
        } finally {
            quizGenerationInFlight = false;
        }
    }

    function generateLocalQuizQuestionData(roundQuizList, level) {
        const weakPool = getWeakDrugPool(roundQuizList);
        const pickFromWeak = weakPool.length > 0 && Math.random() < 0.7;
        const sourcePool = pickFromWeak ? weakPool : roundQuizList;
        const correctDrug = sourcePool[Math.floor(Math.random() * sourcePool.length)];
        const q = buildQuizQuestion(correctDrug, level);

        const optionDrugs = [correctDrug];
        while (optionDrugs.length < Math.min(4, roundQuizList.length)) {
            const r = roundQuizList[Math.floor(Math.random() * roundQuizList.length)];
            if (!optionDrugs.includes(r)) optionDrugs.push(r);
        }

        const optionTexts = [];
        optionDrugs.forEach(d => {
            const txt = q.answerLabel(d);
            if (!optionTexts.includes(txt)) optionTexts.push(txt);
        });

        while (optionTexts.length < Math.min(4, roundQuizList.length)) {
            const r = roundQuizList[Math.floor(Math.random() * roundQuizList.length)];
            const txt = q.answerLabel(r);
            if (!optionTexts.includes(txt)) optionTexts.push(txt);
        }

        optionTexts.sort(() => Math.random() - 0.5);
        return {
            ...q,
            options: optionTexts
        };
    }

    async function generateAIQuizQuestionData(roundQuizList, level, system) {
        try {
            const sample = [...roundQuizList].sort(() => Math.random() - 0.5).slice(0, 10).map(d => ({
                name: d.name,
                class: d.class,
                indication: d.indication
            }));

            const modelName = currentProvider === 'deepseek-r1' ? 'deepseek-reasoner' : 'deepseek-chat';
            const levelGuidance = {
                remembering: 'Test factual recall only (drug class, key indication, common nursing fact). Avoid scenario reasoning.',
                understanding: 'Test conceptual understanding (match class-to-drug or indication-to-drug) with brief clinical interpretation.',
                applying: 'Use a short patient-care scenario requiring direct application of pharmacology to nursing action/choice.',
                analyzing: 'Require comparison among options and discrimination of class-indication relationships before selecting answer.',
                evaluating: 'Require judgment of best option using safety, appropriateness, and nursing monitoring priorities.',
                mix: 'Randomly choose one Bloom level from remembering/understanding/applying/analyzing/evaluating and reflect it in the question stem.'
            };

            const prompt = `You are a senior nurse educator and clinical pharmacology instructor.
Create ONE high-quality MCQ for nursing students in English.

Round configuration:
- Bloom level: ${level}
- System scope: ${system}

Level-specific design requirement:
${levelGuidance[level] || levelGuidance.mix}

Content requirements:
- Prioritize clinically relevant nursing pharmacology.
- Keep the stem focused on bedside decision making.
- Use medication-safe wording and realistic ward context.
- Keep language concise and mobile-readable.

Output format:
Return strict JSON only (no markdown, no extra text):
{"question":"...","options":["A","B","C","D"],"answer":"exact option text","drug":"drug name in options context","explanation":"1-2 sentence nursing rationale"}

Strict rules:
- exactly 4 options
- exactly one best answer
- "answer" must exactly match one option string
- do not invent drugs outside the provided context
- keep options balanced (no obvious giveaway)
- explanation must mention nursing reasoning (e.g., indication match, class logic, monitoring/safety)

Allowed drug context (use only these):
${JSON.stringify(sample)}`;

            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${deepSeekKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: modelName,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.4,
                    stream: false
                })
            });

            if (!response.ok) return false;
            const data = await response.json();
            const content = data?.choices?.[0]?.message?.content || '';
            const parsed = parseAIQuizJSON(content);
            if (!parsed) return false;

            const mappedDrug = roundQuizList.find(d => d.name.toLowerCase() === String(parsed.drug || '').toLowerCase()) || roundQuizList.find(d => d.name.toLowerCase().includes(String(parsed.drug || '').toLowerCase())) || null;

            const q = {
                type: 'ai_quiz',
                prompt: parsed.question,
                options: parsed.options,
                correctAnswerText: parsed.answer,
                aiExplanation: parsed.explanation,
                correctDrug: mappedDrug,
                answerLabel: () => parsed.answer
            };

            return q;
        } catch (e) {
            return null;
        }
    }

    function parseAIQuizJSON(content) {
        if (!content) return null;
        try {
            const cleaned = content.trim().replace(/^```json\s*/i, '').replace(/^```/, '').replace(/```$/, '').trim();
            const obj = JSON.parse(cleaned);
            if (!obj.question || !Array.isArray(obj.options) || obj.options.length !== 4 || !obj.answer) return null;
            if (!obj.options.includes(obj.answer)) return null;
            return {
                question: String(obj.question),
                options: obj.options.map(o => String(o)),
                answer: String(obj.answer),
                drug: String(obj.drug || ''),
                explanation: String(obj.explanation || '')
            };
        } catch {
            return null;
        }
    }

    function checkAnswer(btn, selectedText, q) {
         const btns = document.querySelectorAll('#quiz-options button');
         btns.forEach(b => b.onclick = null);
         const feedback = document.getElementById('quiz-feedback');
         feedback.style.display = 'block';

         const correct = q.correctAnswerText || q.answerLabel(q.correctDrug);
         const isCorrect = selectedText === correct;

         if(q.correctDrug?.name) {
             if(!quizStats[q.correctDrug.name]) quizStats[q.correctDrug.name] = { correct: 0, attempts: 0 };
             quizStats[q.correctDrug.name].attempts++;
         }
         quizSession.answered++;

         if(isCorrect) {
             btn.style.background = '#dcfce7'; btn.style.color = '#166534';
             feedback.innerHTML = "‚úÖ <strong>Correct!</strong>";
             feedback.style.background = "#dcfce7"; feedback.style.color = "#166534";
             if(q.correctDrug?.name) quizStats[q.correctDrug.name].correct++;
             quizSession.correct++;
             quizSession.streak++;
             quizSession.bestStreak = Math.max(quizSession.bestStreak, quizSession.streak);
         } else {
             btn.style.background = '#fee2e2'; btn.style.color = '#991b1b';
             feedback.innerHTML = `‚ùå <strong>Incorrect.</strong> Correct answer: ${correct}„ÄÇ`;
             feedback.style.background = "#fee2e2"; feedback.style.color = "#991b1b";
             quizSession.streak = 0;
             btns.forEach(b => { if(b.innerText === correct) { b.style.background = '#dcfce7'; b.style.color = '#166534'; } });
         }

         const mini = document.getElementById('quiz-mini-explainer');
         mini.style.display = 'block';
         if (q.aiExplanation) {
             mini.innerHTML = `<strong>AI takeaway:</strong>  ${q.aiExplanation}`;
         } else if (q.correctDrug) {
             mini.innerHTML = `<strong>Clinical link:</strong> ${q.correctDrug.name} ‚Ä¢ Class: <strong>${q.correctDrug.class}</strong> ‚Ä¢ Indication: <strong>${q.correctDrug.indication}</strong>.`;
         } else {
             mini.innerHTML = `<strong>Review tip:</strong>  Focus on class-action and indication pairing.`;
         }

         updateQuizSessionUI();
         currentRoundAnswered++;
         updateQuizRoundProgress();
         localStorage.setItem('drug_tutor_quiz_stats', JSON.stringify(quizStats));
         const nextBtn = document.getElementById('next-quiz-btn');
         if (currentRoundTotal && currentRoundAnswered >= currentRoundTotal) {
             nextBtn.style.display = 'none';
         } else {
             nextBtn.style.display = 'block';
         }
         currentQuizData = { q: q.prompt, u: selectedText, c: q.correctDrug, correctAnswerText: correct };
         preGenerateNextQuestion();
    }

    function nextQuestion() { generateQuizQuestion(); }
    
    function showProgressModal() {
        const modal = document.getElementById('progress-modal');
        const list = document.getElementById('progress-list-content');
        list.innerHTML = '';
        const sorted = Object.keys(quizStats).sort((a,b) => (quizStats[a].correct / quizStats[a].attempts) - (quizStats[b].correct / quizStats[b].attempts));
        sorted.forEach(key => {
            const s = quizStats[key];
            const pct = Math.round((s.correct/s.attempts)*100);
            const row = document.createElement('div');
            row.style.padding = '10px'; row.style.borderBottom = '1px solid #f0f0f0'; row.style.display = 'flex'; row.style.justifyContent = 'space-between';
            row.innerHTML = `<span>${key}</span><span style="font-weight:bold; color:${pct>70?'green':'red'}">${pct}%</span>`;
            list.appendChild(row);
        });
        modal.style.display = 'flex';
    }
    function closeProgressModal() { document.getElementById('progress-modal').style.display = 'none'; }

    // --- AI FUNCTIONS ---
    async function streamAIResponse(messages, onUpdate) {
        // Only DeepSeek supported now
        const apiUrl = "https://api.deepseek.com/chat/completions";
        
        // Determine model based on provider selection
        // If currentProvider is 'deepseek-r1', use 'deepseek-reasoner'
        // Otherwise (default or 'deepseek'), use 'deepseek-chat'
        const modelName = currentProvider === 'deepseek-r1' ? 'deepseek-reasoner' : 'deepseek-chat';

        const headers = { 
            "Authorization": `Bearer ${deepSeekKey}`, 
            "Content-Type": "application/json" 
        };
        
        const body = { 
            model: modelName, 
            messages: messages, 
            temperature: 0.7, 
            stream: true 
        };

        try {
            const response = await fetch(apiUrl, { method: "POST", headers: headers, body: JSON.stringify(body) });
            if (!response.ok) {
                const errText = await response.text();
                onUpdate(`Error: ${response.status} ${response.statusText} - ${errText || 'No details'}`);
                return;
            }

            if (!response.body) {
                const json = await response.json();
                const content = json?.choices?.[0]?.message?.content || '';
                onUpdate(content || 'No explanation content received.');
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        if (line.trim() === 'data: [DONE]') continue;
                        try {
                            const json = JSON.parse(line.substring(6));
                            const content = json.choices?.[0]?.delta?.content || json.choices?.[0]?.message?.content || "";
                            if (content) { fullText += content; onUpdate(fullText); }
                        } catch (e) {}
                    }
                }
            }

            if (!fullText) {
                onUpdate('No explanation content received. Please try again.');
            }
        } catch (e) { onUpdate("Error: " + e.message); }
    }

    async function getIntegratedCaseStudy(drug, outputId, btnId, readBtnId) {
        const btn = document.getElementById(btnId); const box = document.getElementById(outputId);
        btn.innerHTML = '‚è≥ Generating...'; btn.disabled = true; box.style.display = 'block'; box.innerHTML = 'Thinking...';
        
        const prompt = `Create a nursing case study for ${drug.name} in English. Keep medical terminology accurate. Use Markdown bullet points for fast mobile reading. Include: Patient snapshot, key vitals, medication rationale, 3 nursing checks, and 1 critical-thinking question.`;
        
        await streamAIResponse([{role: "user", content: prompt}], (text) => box.innerHTML = marked.parse(text));
        btn.innerHTML = '‚ú® Regenerate case'; btn.disabled = false; document.getElementById(readBtnId).style.display = 'block';
    }

    // --- UTILS ---
    function loadLocalDrugCache() {
        try {
            const raw = localStorage.getItem(LOCAL_DRUG_CACHE_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed.filter(d => d && d.name);
        } catch (_) {
            return [];
        }
    }

    function saveLocalDrugCache(list) {
        try {
            const payload = (list || []).map(d => ({
                name: d.name || '', class: d.class || '', indication: d.indication || '',
                side_effects: d.side_effects || d.sideEffects || '', nursing: d.nursing || '',
                system: d.system || ''
            }));
            localStorage.setItem(LOCAL_DRUG_CACHE_KEY, JSON.stringify(payload));
        } catch (_) {}
    }

    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }
    
    function saveSettings() {
        localStorage.setItem('active_provider', document.getElementById('provider-select').value);
        localStorage.setItem('ds_key', document.getElementById('deepseek-key').value);
        localStorage.setItem('google_script_url', document.getElementById('sheet-url').value);
        localStorage.setItem('quiz_engine', document.getElementById('quiz-engine').value);
        localStorage.setItem('anki_daily_limit', document.getElementById('anki-daily-limit').value || '20');
        localStorage.setItem('anki_due_limit', document.getElementById('anki-due-limit').value || '50');
        localStorage.setItem('anki_learn_limit', document.getElementById('anki-learn-limit').value || '20');
        localStorage.setItem('anki_new_limit', document.getElementById('anki-new-limit').value || '20');
        localStorage.setItem('auto_sync_startup', document.getElementById('auto-sync-startup').checked ? '1' : '0');
        // reload globals
        currentProvider = document.getElementById('provider-select').value;
        deepSeekKey = document.getElementById('deepseek-key').value;
        quizEngine = document.getElementById('quiz-engine').value;
        ankiDailyLimit = parseInt(document.getElementById('anki-daily-limit').value || '20', 10);
        ankiDueLimit = parseInt(document.getElementById('anki-due-limit').value || '50', 10);
        ankiLearnLimit = parseInt(document.getElementById('anki-learn-limit').value || '20', 10);
        ankiNewLimit = parseInt(document.getElementById('anki-new-limit').value || '20', 10);
        autoSyncOnStartup = document.getElementById('auto-sync-startup').checked;
        saveLocalDrugCache(activeSourceList);
        generateDailyPicks();
        updateQueueStats(filteredList.length ? filteredList : activeSourceList);
        toggleSettings();
        alert("Settings saved!");
    }
    
    function updateProviderDisplay() {
        const val = document.getElementById('provider-select').value;
        document.getElementById('deepseek-config').style.display = 'block';
        document.getElementById('provider-display').innerText = val === 'deepseek-r1' ? "DeepSeek R1" : "DeepSeek V3";
    }


    function openWardCheat() {
        document.body.classList.add('page-leaving');
        const go = () => window.location.assign('ward.html');
        if (document.startViewTransition) {
            document.startViewTransition(go);
            return;
        }
        setTimeout(go, 80);
    }

    function warmWardPage() {
        const warmLink = document.createElement('link');
        warmLink.rel = 'prefetch';
        warmLink.as = 'document';
        warmLink.href = 'ward.html';
        document.head.appendChild(warmLink);
    }

    const navWardBtn = document.getElementById('nav-ward');
    if (navWardBtn) {
        navWardBtn.addEventListener('pointerenter', warmWardPage, { once: true });
        navWardBtn.addEventListener('touchstart', warmWardPage, { once: true, passive: true });
    }

    function fetchSheetData(autoSwitch = false) {
        const url = document.getElementById('sheet-url').value;
        let fetchUrl = url;
        if (url.includes("docs.google.com/spreadsheets") && url.includes("/edit")) fetchUrl = url.replace(/\/edit.*$/, "/export?format=csv");
        
        const status = document.getElementById('upload-status');
        status.innerText = "‚è≥ Loading...";
        
        fetch(fetchUrl).then(r => r.text()).then(csv => {
            Papa.parse(csv, { header: true, skipEmptyLines: true, complete: function(results) {
                 if (results.data.length > 0) {
                     extendedDrugs = prepareDrugListForFastSearch(results.data);

                     status.innerText = `‚úÖ Loaded ${extendedDrugs.length} drugs`;
                     document.getElementById('set-btn').innerText = "üìö Source: Online CSV";
                     
                     if(autoSwitch) {
                         activeSourceList = prepareDrugListForFastSearch([...extendedDrugs]);
                         saveLocalDrugCache(activeSourceList);
                         applyFilter();
                         generateDailyPicks();
                         updateQueueStats(filteredList.length ? filteredList : activeSourceList);
                     }
                 }
            }});
        }).catch(e => {
            status.innerText = "‚ùå Load failed, switched to local data.";
            if(autoSwitch) {
                activeSourceList = prepareDrugListForFastSearch([...commonDrugs]);
                applyFilter();
                generateDailyPicks();
                updateQueueStats(filteredList.length ? filteredList : activeSourceList);
            }
        });
    }

    function toggleDrugSet() {
        const usingOnline = document.getElementById('set-btn').innerText.includes('Online CSV');
        if(usingOnline) {
            activeSourceList = prepareDrugListForFastSearch([...commonDrugs]);
            document.getElementById('set-btn').innerText = "üìö Source: Common drugs";
        } else if(extendedDrugs.length > 0) {
            activeSourceList = prepareDrugListForFastSearch([...extendedDrugs]);
            document.getElementById('set-btn').innerText = "üìö Source: Online CSV";
        }
        saveLocalDrugCache(activeSourceList);
        applyFilter();
        generateDailyPicks();
        updateQueueStats(filteredList.length ? filteredList : activeSourceList);
    }
    
    function speakText(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
    }
    
    function readAIContent(id) {
        speakText(document.getElementById(id).innerText);
    }

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').catch(() => {});
    });
}

</script>
</body>
</html>
