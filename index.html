<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Drug Tutor (GitHub + Azure)</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Modern Medical Palette */
            --primary: #4F46E5;       /* Indigo: Trust & Professionalism */
            --primary-hover: #4338ca;
            --secondary: #10B981;     /* Emerald: Success/Safe */
            --accent: #F43F5E;        /* Rose: Attention/Urgent */
            --surface: #ffffff;
            --background: #F3F4F6;
            --text-main: #111827;
            --text-muted: #6B7280;
            
            /* UI Variables */
            --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px; /* Subtle dot pattern */
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        h1 {
            color: var(--text-main);
            margin-bottom: 5px;
            text-align: center;
            font-weight: 800;
            letter-spacing: -0.025em;
            font-size: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .app-logo {
            height: 45px; width: 45px; min-width: 45px;
            border-radius: 12px; box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease;
        }
        .app-logo:hover { transform: rotate(10deg) scale(1.1); }

        .subtitle {
            font-size: 0.9rem; color: var(--text-muted);
            margin-bottom: 30px; text-align: center;
            font-weight: 500; background: #e5e7eb;
            padding: 4px 12px; border-radius: 20px;
            display: inline-block;
        }

        /* --- Controls --- */
        .top-bar {
            display: flex; gap: 12px; justify-content: center;
            margin-bottom: 30px; width: 100%; max-width: 850px;
            flex-wrap: wrap; background: var(--surface);
            padding: 15px; border-radius: var(--radius);
            box-shadow: var(--shadow-sm); border: 1px solid #e5e7eb;
        }

        button {
            padding: 10px 18px; border: none; border-radius: 10px;
            cursor: pointer; font-weight: 600; transition: all 0.2s ease;
            font-size: 0.9rem; display: inline-flex;
            align-items: center; justify-content: center; gap: 6px;
        }
        button:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        button:active { transform: translateY(0); }

        button.mode-active { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        button.secondary { background-color: white; color: var(--text-main); border: 1px solid #d1d5db; }
        button.secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        button.lang-lihkg { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); color: white; }
        button.set-extended { background-color: #7c3aed; color: white; }
        button.muted { background-color: var(--accent); color: white; }

        /* --- Settings Panel --- */
        #settings-panel {
            display: none; background: var(--surface);
            padding: 30px; border-radius: var(--radius);
            box-shadow: var(--shadow-lg); margin-bottom: 30px;
            width: 100%; max-width: 600px;
            border: 1px solid #e5e7eb; box-sizing: border-box;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .settings-label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-main); }
        .settings-input, select {
            width: 100%; padding: 10px 12px;
            border: 1px solid #d1d5db; border-radius: 8px;
            margin-bottom: 15px; box-sizing: border-box;
            font-family: inherit; font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        .settings-input:focus, select:focus { border-color: var(--primary); outline: 3px solid #e0e7ff; }
        
        /* Cloud Import Styling */
        .import-wrapper {
            border: 1px solid #d1d5db; padding: 15px;
            border-radius: 8px; background: #f9fafb;
            margin-bottom: 15px;
        }
        .url-input-group { display: flex; gap: 8px; }
        .url-input-group input { flex-grow: 1; }

        /* --- Main Container --- */
        #app-container { width: 100%; max-width: 650px; perspective: 1000px; }

        /* --- Flashcards --- */
        .flashcard-container {
            width: 100%; height: 750px; /* Taller for extra rows */
            position: relative; transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .flashcard-container.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 24px;
            box-shadow: var(--shadow-lg); background-color: var(--surface);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 30px; box-sizing: border-box;
            text-align: center; border: 1px solid rgba(0,0,0,0.02);
        }
        .card-front { background: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%); }
        .card-back {
            transform: rotateY(180deg); align-items: flex-start;
            text-align: left; overflow-y: auto; padding-top: 25px;
        }
        .card-back::-webkit-scrollbar { width: 6px; }
        .card-back::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }

        .card-title {
            font-size: 1.8rem; font-weight: 800;
            background: -webkit-linear-gradient(45deg, var(--primary), #818cf8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 15px 0;
        }

        .detail-row {
            margin-bottom: 15px; width: 100%;
            border-bottom: 1px solid #f3f4f6; padding-bottom: 10px;
        }
        .detail-label {
            font-size: 0.7rem; font-weight: 700;
            color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 4px;
        }
        .detail-content { font-size: 1rem; color: var(--text-main); font-weight: 500; }

        /* --- Quiz & Search Sections --- */
        .quiz-container, #search-section {
            background: var(--surface); padding: 30px;
            border-radius: var(--radius); box-shadow: var(--shadow-lg);
            border: 1px solid #e5e7eb; display: none;
            box-sizing: border-box; min-height: 400px;
        }

        .quiz-question { font-size: 1.3rem; font-weight: 700; margin-bottom: 25px; color: var(--text-main); }
        .option-btn {
            background-color: #f9fafb; color: var(--text-main);
            text-align: left; border: 1px solid #e5e7eb;
            padding: 16px 20px; border-radius: 12px;
            transition: all 0.2s; font-size: 1rem;
            margin-bottom: 10px; width: 100%; cursor: pointer;
        }
        .option-btn:hover { border-color: var(--primary); background-color: #eef2ff; }
        .option-btn.correct { background-color: #ecfdf5; border-color: var(--secondary); color: #065f46; }
        .option-btn.wrong { background-color: #fef2f2; border-color: var(--accent); color: #991b1b; }

        /* --- Search Specific Styles --- */
        .search-bar { 
            width: 100%; padding: 15px; border-radius: 12px; 
            border: 2px solid #e5e7eb; font-size: 1.1rem; 
            margin-bottom: 20px; box-sizing: border-box; font-family: inherit;
        }
        .search-bar:focus { border-color: var(--primary); outline: none; }
        
        .results-grid { display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .results-grid::-webkit-scrollbar { width: 6px; }
        .results-grid::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }

        .result-card { 
            background: white; padding: 15px; border-radius: 12px; 
            border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; 
        }
        .result-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .result-header { font-weight: 700; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .result-sub { font-size: 0.8rem; color: #6b7280; font-weight: normal; }
        
        .result-detail { 
            margin-top: 12px; display: none; border-top: 1px solid #f3f4f6; 
            padding-top: 12px; font-size: 0.9rem; color: var(--text-main); line-height: 1.5;
        }
        .result-card.expanded .result-detail { display: block; animation: fadeIn 0.3s; }
        .result-card.expanded { border-color: var(--primary); background-color: #fcfaff; }

        /* --- AI Boxes --- */
        .ai-btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; width: 100%; }
        .ai-btn-small { font-size: 0.9rem; padding: 10px 12px; width: 100%; text-align: left; display: flex; align-items: center; gap: 8px; }
        .btn-sim { background-color: var(--secondary); }
        .btn-explain { background-color: var(--primary); color: white; width: 100%; margin-top: 20px; display: none; justify-content: center;}

        .ai-output-box {
            margin-top: 20px; padding: 20px;
            border-radius: 12px; font-size: 0.95rem; line-height: 1.7;
            background: #f0fdfa; border-left: 5px solid var(--secondary);
            animation: fadeIn 0.5s; display: none; width: 100%; box-sizing: border-box;
        }
        
        .ai-output-box h3 { margin: 15px 0 8px 0; font-size: 1.1rem; color: #0f172a; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 4px; font-weight: 800; }
        .ai-output-box ul { padding-left: 20px; margin: 8px 0; }
        
        .btn-read-ai { background-color: #e0e7ff; color: var(--primary); margin-top: 10px; width: 100%; font-size: 0.85rem; display: none; justify-content: center; }

        /* --- Nav Controls --- */
        .nav-controls {
            margin-top: 25px; display: flex; justify-content: space-between; width: 100%;
            background: white; padding: 10px; border-radius: 50px; box-shadow: var(--shadow-md);
        }
        .nav-controls button {
            border-radius: 40px; padding: 12px 24px;
            background: transparent; color: var(--text-main); box-shadow: none;
        }
        .nav-controls button:hover { background: #f3f4f6; transform: none; box-shadow: none; }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #fff;
            animation: spin 0.8s linear infinite; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<h1>
    <svg class="app-logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="64" height="64" rx="16" fill="#4F46E5"/>
        <path d="M32 16V48" stroke="white" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 32H48" stroke="white" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="42" cy="22" r="6" fill="#10B981" stroke="#4F46E5" stroke-width="2"/>
    </svg>
    Integrated Drug
</h1>
    <div class="subtitle" id="provider-display">Provider: Not Configured</div>

    <div class="top-bar">
        <button id="mode-flashcard" class="mode-active" onclick="switchMode('flashcard')">Flashcards</button>
        <button id="mode-quiz" class="secondary" onclick="switchMode('quiz')">Quiz</button>
        <button id="mode-search" class="secondary" onclick="switchMode('search')">Search</button>
        <button onclick="reshuffle()" style="background-color: #f59e0b; color: white;">Reset</button>
        <button onclick="toggleSettings()" class="secondary">‚öôÔ∏è Settings</button>
    </div>

    <div id="settings-panel">
        
        <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <label class="settings-label" style="margin-bottom: 10px;">‚ö° Quick Controls</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                 <button onclick="toggleDrugSet()" id="set-btn" class="secondary" style="width:100%; font-size:0.85rem;">üìö Set: Common</button>
                 <button onclick="toggleLanguage()" id="lang-btn" class="lang-lihkg" style="width:100%; font-size:0.85rem;">üåê Lang: LIHKG</button>
                 <button onclick="toggleMute()" id="mute-btn" class="secondary" style="grid-column: span 2; width:100%;">üîä Audio: On</button>
            </div>
        </div>

        <h3 style="margin-top:0;">Configuration</h3>
        
        <div class="settings-group" style="border-bottom: 1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
            <label class="settings-label">üîä Text-to-Speech Provider:</label>
            <select id="tts-provider-select" onchange="updateTTSUI()">
                <option value="browser">Browser Native (Free/Offline)</option>
                <option value="azure">Azure Neural (High Quality)</option>
            </select>
            
            <div id="azure-config-group" style="display:none; margin-top:10px; background:#eff6ff; padding:10px; border-radius:8px;">
                <label class="settings-label">Azure Speech Key:</label>
                <input type="password" id="azure-key" class="settings-input" placeholder="e.g. 39483..." />
                
                <label class="settings-label">Azure Region:</label>
                <input type="text" id="azure-region" class="settings-input" placeholder="e.g. southeastasia" />
            </div>

            <label class="settings-label" style="margin-top:15px;">Preferred Voice:</label>
            <select id="voice-select">
                <option value="">Default Voice</option>
            </select>
            <button onclick="testVoice()" style="margin-top:10px; font-size:0.8rem; padding:8px 12px; width:100%; border:1px solid #d1d5db;">üîä Test Selected Voice</button>
        </div>

        <div class="settings-group">
            <label class="settings-label">üß† AI Provider:</label>
            <select id="provider-select" onchange="updateProviderDisplay()">
                <option value="github">GitHub Models (Free/Standard)</option>
                <option value="deepseek">DeepSeek Official</option>
                <option value="openrouter">OpenRouter (Xiaomi/Free)</option>
            </select>

            <div id="github-settings" style="display:none; margin-top:15px; background:#fdf4ff; padding:10px; border-radius:8px; border:1px solid #f0abfc;">
                <label class="settings-label">GitHub Personal Access Token (PAT):</label>
                <input type="password" id="github-key" class="settings-input" placeholder="ghp_..." />
                
                <label class="settings-label">Select Model:</label>
                <select id="github-model-select">
                    <option value="gpt-4o">GPT-4o (Smartest)</option>
                    <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
                    <option value="Phi-3.5-mini-instruct">Phi-3.5 (Lightweight)</option>
                    <option value="Llama-3.3-70B-Instruct">Llama 3.3 70B</option>
                    <option value="Mistral-large-2411">Mistral Large</option>
                </select>
                <div style="font-size:0.75rem; color:#666;">Note: GitHub Free Tier has rate limits (approx 50 reqs/day for GPT-4o).</div>
            </div>

            <div id="other-keys" style="margin-top:15px;">
                <label class="settings-label">OpenRouter Key (if using OpenRouter):</label>
                <input type="password" id="openrouter-key" class="settings-input" placeholder="sk-or..." />
                
                <label class="settings-label">DeepSeek Key (if using DeepSeek):</label>
                <input type="password" id="deepseek-key" class="settings-input" placeholder="sk-..." />
            </div>
        </div>

        <div class="settings-group" style="margin-top:20px;">
            <label class="settings-label">Load External Data:</label>
            <div class="import-wrapper">
                <div class="url-input-group">
                    <input type="text" id="sheet-url" class="settings-input" placeholder="https://docs.google.com/spreadsheets/d/..." style="margin-bottom:0;" />
                    <button onclick="fetchSheetData()" style="padding: 5px 15px;">Load</button>
                </div>
                <div id="upload-status" style="font-size:0.8rem; margin-top:5px; color:var(--primary); font-weight:bold;"></div>
            </div>
        </div>

        <button onclick="saveSettings()" style="width:100%; background-color: var(--secondary);">üíæ Save & Close</button>
    </div>

    <div id="app-container">
        
        <div id="flashcard-section">
            <div class="flashcard-container" id="flashcard" onclick="flipCard(event)">
                <div class="card-face card-front">
                    <div style="font-size: 3.5rem; margin-bottom: 20px;">üíä</div>
                    <h2 id="fc-name" class="card-title">Drug Name</h2>
                    <p style="color: #9ca3af; font-size: 0.9rem;">(Tap to flip)</p>
                    <button onclick="event.stopPropagation(); speakText(flashcardList[fcCurrentIndex].name, 'en')" style="margin-top: 20px; background:#e0e7ff; color:var(--primary);">üîä Read Name</button>
                </div>
                <div class="card-face card-back">
                    <div class="detail-row"><div class="detail-label">Class</div><div class="detail-content" id="fc-class">...</div></div>
                    <div class="detail-row"><div class="detail-label">Body System</div><div class="detail-content" id="fc-system">...</div></div>
                    <div class="detail-row"><div class="detail-label">Indication</div><div class="detail-content" id="fc-indication">...</div></div>
                    <div class="detail-row"><div class="detail-label">SideEffects</div><div class="detail-content" id="fc-SideEffects">...</div></div>
                    <div class="detail-row" style="border:none;"><div class="detail-label">Nursing Considerations</div><div class="detail-content" id="fc-nursing">...</div></div>

                    <div class="ai-btn-group">
                        <button onclick="event.stopPropagation(); getIntegratedCaseStudy(flashcardList[fcCurrentIndex], 'fc-ai-case', 'btn-case', 'btn-read-case')" class="ai-btn-small btn-sim" id="btn-case">üè• AI: Generate Integrated Patient Case</button>
                        <div id="fc-ai-case" class="ai-output-box"></div>
                        <button onclick="event.stopPropagation(); readAIContent('fc-ai-case')" class="btn-read-ai" id="btn-read-case">üîä Read Out Loud</button>
                    </div>
                    <button onclick="event.stopPropagation(); speakBack(flashcardList[fcCurrentIndex])" style="margin-top: 20px; width:100%; background:#e0e7ff; color:var(--primary); font-size:0.8rem;">üîä Read Basic Details</button>
                </div>
            </div>
            <div class="nav-controls">
                <button onclick="prevCard()">‚Üê Prev</button>
                <span id="counter" style="align-self: center; font-weight: bold; color:#6b7280;">1 / 10</span>
                <button onclick="nextCard()">Next ‚Üí</button>
            </div>
        </div>

        <div id="quiz-section" class="quiz-container">
            <div id="quiz-content">
                <p class="quiz-question" id="quiz-question">Question...</p>
                <div class="quiz-options" id="quiz-options"></div>
            </div>
            <button id="btn-quiz-explain" class="btn-explain" onclick="triggerQuizExplain()">ü§ñ Explain Why (AI Tutor)</button>
            <div id="ai-container" style="display:none;">
                <h3><span id="ai-status-icon">ü§ñ</span> AI Tutor Explanation</h3>
                <div id="ai-content" class="ai-output-box" style="display:block;"></div>
                <button onclick="readAIContent('ai-content')" class="btn-read-ai" id="btn-read-explain" style="margin-bottom:0;">üîä Read Out Loud</button>
            </div>
            <div class="nav-controls" style="justify-content: flex-end;">
                <button onclick="nextQuestion()" id="next-quiz-btn" style="display:none;">Next Question ‚Üí</button>
            </div>
        </div>

        <div id="search-section">
            <div style="text-align:center; margin-bottom:15px; font-weight:800; color:var(--primary); font-size:1.2rem;">üîç Drug Database Search</div>
            <input type="text" id="search-input" class="search-bar" placeholder="Search generic, brand name, class, or system..." oninput="handleSearch()">
            <div id="search-results" class="results-grid">
                <div style="text-align:center; color:#9ca3af; margin-top:20px;">Type above to search...</div>
            </div>
        </div>

    </div>

    <script src="drugs.js"></script>
    <script src="prompts.js"></script>

    <script>
        // --- CONFIGURATION ---
        let currentProvider = 'github'; 
        let openRouterKey = ""; 
        let deepSeekKey = "sk-92db3cf721454bd7b351ca6ef40eaaf7";
        let githubKey = "";
        let githubModel = "gpt-4o";

        // --- AUDIO STATE ---
        let ttsProvider = 'browser'; 
        let azureSpeechKey = "";
        let azureSpeechRegion = "southeastasia";
        let selectedVoiceURI = ""; 
        let isMuted = false;
        let azureSynthesizer = null; 

        let aiLanguage = 'lihkg'; 
        const defaultSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";

        // --- DATA ---
        let extendedDrugs = []; 
        let activeSourceList = []; 
        let flashcardList = []; 
        let quizList = [];      
        let fcCurrentIndex = 0;
        let quizCurrentIndex = 0;
        let currentQuizData = null;

        function processRawData(data) {
            let processed = [];
            data.forEach(item => {
                if (item.name && typeof item.name === 'string' && item.name.includes(';')) {
                    let names = item.name.split(';');
                    names.forEach(n => {
                        const cleanName = n.trim();
                        if(cleanName) processed.push({ ...item, name: cleanName });
                    });
                } else {
                    if(item.name) item.name = item.name.trim();
                    processed.push(item);
                }
            });
            return processed;
        }

        // --- INITIALIZATION ---
        function init() {
            // Load LLM Keys
            openRouterKey = localStorage.getItem('or_key') || "";
            deepSeekKey = localStorage.getItem('ds_key') || deepSeekKey;
            githubKey = localStorage.getItem('gh_key') || "";
            githubModel = localStorage.getItem('gh_model') || "gpt-4o";
            currentProvider = localStorage.getItem('active_provider') || 'github';

            // Load Audio Settings
            ttsProvider = localStorage.getItem('tts_provider') || 'browser';
            azureSpeechKey = localStorage.getItem('azure_key') || "";
            azureSpeechRegion = localStorage.getItem('azure_region') || "southeastasia";
            selectedVoiceURI = localStorage.getItem('preferred_voice') || "";

            // Populate UI
            document.getElementById('openrouter-key').value = openRouterKey;
            document.getElementById('deepseek-key').value = deepSeekKey;
            document.getElementById('github-key').value = githubKey;
            document.getElementById('github-model-select').value = githubModel;
            document.getElementById('provider-select').value = currentProvider;
            
            document.getElementById('tts-provider-select').value = ttsProvider;
            document.getElementById('azure-key').value = azureSpeechKey;
            document.getElementById('azure-region').value = azureSpeechRegion;
            document.getElementById('sheet-url').value = defaultSheetUrl;
            
            updateProviderDisplay();
            updateTTSUI(); 

            // Load Data
            if(typeof commonDrugs !== 'undefined') { activeSourceList = [...commonDrugs]; }
            fetchSheetData();
            
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
        }

        // --- SETTINGS UI ---
        function updateProviderDisplay() {
            const display = document.getElementById('provider-display');
            const prov = document.getElementById('provider-select').value;
            const ghSettings = document.getElementById('github-settings');
            
            if(prov === 'github') {
                display.innerText = "Provider: GitHub Models (" + document.getElementById('github-model-select').value + ")";
                ghSettings.style.display = 'block';
            } else if(prov === 'openrouter') {
                display.innerText = "Provider: OpenRouter (Xiaomi/Free)";
                ghSettings.style.display = 'none';
            } else {
                display.innerText = "Provider: DeepSeek Official";
                ghSettings.style.display = 'none';
            }
        }

        function updateTTSUI() {
            const provider = document.getElementById('tts-provider-select').value;
            const azureGroup = document.getElementById('azure-config-group');
            azureGroup.style.display = (provider === 'azure') ? 'block' : 'none';
            populateVoiceList();
        }

        function saveSettings() {
            // Save LLM
            openRouterKey = document.getElementById('openrouter-key').value.trim();
            deepSeekKey = document.getElementById('deepseek-key').value.trim();
            githubKey = document.getElementById('github-key').value.trim();
            githubModel = document.getElementById('github-model-select').value;
            currentProvider = document.getElementById('provider-select').value;

            localStorage.setItem('or_key', openRouterKey);
            localStorage.setItem('ds_key', deepSeekKey);
            localStorage.setItem('gh_key', githubKey);
            localStorage.setItem('gh_model', githubModel);
            localStorage.setItem('active_provider', currentProvider);

            // Save Audio
            ttsProvider = document.getElementById('tts-provider-select').value;
            azureSpeechKey = document.getElementById('azure-key').value.trim();
            azureSpeechRegion = document.getElementById('azure-region').value.trim();
            selectedVoiceURI = document.getElementById('voice-select').value;

            localStorage.setItem('tts_provider', ttsProvider);
            localStorage.setItem('azure_key', azureSpeechKey);
            localStorage.setItem('azure_region', azureSpeechRegion);
            localStorage.setItem('preferred_voice', selectedVoiceURI);

            updateProviderDisplay();
            toggleSettings();
        }

        // --- VOICE LOGIC ---
        async function populateVoiceList() {
            const select = document.getElementById('voice-select');
            const provider = document.getElementById('tts-provider-select').value;
            select.innerHTML = '<option value="">Default Voice</option>';

            if (provider === 'browser') {
                const voices = window.speechSynthesis.getVoices();
                if(voices.length === 0) return;
                const sorted = voices.sort((a, b) => {
                    const aName = a.name.toLowerCase(), bName = b.name.toLowerCase();
                    if (aName.includes('enhanced') && !bName.includes('enhanced')) return -1;
                    if (!aName.includes('enhanced') && bName.includes('enhanced')) return 1;
                    return aName.localeCompare(bName);
                });
                sorted.forEach(v => {
                    const option = document.createElement('option');
                    const label = (v.name.includes("Enhanced") || v.name.includes("Siri")) ? `‚ú® ${v.name}` : v.name;
                    option.textContent = `${label} (${v.lang})`;
                    option.value = v.voiceURI;
                    if(v.voiceURI === selectedVoiceURI) option.selected = true;
                    select.appendChild(option);
                });
            } else if (provider === 'azure') {
                const azureVoices = [
                    { name: "Multilingual - Ava (Female)", val: "en-US-AvaMultilingualNeural" },
                    { name: "Multilingual - Andrew (Male)", val: "en-US-AndrewMultilingualNeural" },
                    { name: "HK - HiuGaai (Female)", val: "zh-HK-HiuGaaiNeural" },
                    { name: "HK - WanLung (Male)", val: "zh-HK-WanLungNeural" },
                    { name: "US - Ava (Female)", val: "en-US-AvaNeural" },
                    { name: "CN - Xiaoxiao (Female)", val: "zh-CN-XiaoxiaoNeural" }
                ];
                azureVoices.forEach(v => {
                    const option = document.createElement('option');
                    option.textContent = v.name; option.value = v.val;
                    if(v.val === selectedVoiceURI) option.selected = true;
                    select.appendChild(option);
                });
            }
        }

        function speakText(text, langCode = 'en') {
            if (isMuted) return;
            window.speechSynthesis.cancel();
            if (azureSynthesizer) { try { azureSynthesizer.close(); } catch(e){} azureSynthesizer = null; }

            let targetLang = langCode;
            if ((aiLanguage === 'cantonese' || aiLanguage === 'lihkg') && langCode !== 'en') targetLang = 'zh-HK';

            if (ttsProvider === 'azure' && azureSpeechKey) {
                if (typeof SpeechSDK === 'undefined') return alert("Azure SDK loading...");
                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(azureSpeechKey, azureSpeechRegion);
                let voiceName = "en-US-AvaMultilingualNeural"; 
                if (selectedVoiceURI) voiceName = selectedVoiceURI;
                else if (targetLang === 'zh-HK') voiceName = "zh-HK-HiuGaaiNeural";
                
                speechConfig.speechSynthesisVoiceName = voiceName; 
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
                azureSynthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);
                azureSynthesizer.speakTextAsync(text, r => { azureSynthesizer.close(); }, e => { azureSynthesizer.close(); });
            } else {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = targetLang; utterance.rate = 0.95;
                const voices = window.speechSynthesis.getVoices();
                if (selectedVoiceURI) {
                    const p = voices.find(v => v.voiceURI === selectedVoiceURI);
                    if(p) utterance.voice = p;
                }
                window.speechSynthesis.speak(utterance);
            }
        }

        function testVoice() { speakText("Voice check. Testing audio quality.", 'en'); }
        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if (isMuted) { window.speechSynthesis.cancel(); btn.innerText = "üîá Audio: Off"; btn.classList.add('muted'); btn.classList.remove('secondary'); }
            else { btn.innerText = "üîä Audio: On"; btn.classList.remove('muted'); btn.classList.add('secondary'); }
        }

        // --- API CALLS ---
        async function callGitHubAPI(messages) {
            if(!githubKey) throw new Error("GitHub PAT Missing");
            
            const response = await fetch("https://models.inference.ai.azure.com/chat/completions", {
                method: "POST",
                headers: { 
                    "Authorization": `Bearer ${githubKey}`, 
                    "Content-Type": "application/json" 
                },
                body: JSON.stringify({ 
                    model: githubModel, 
                    messages: messages, 
                    temperature: 0.7 
                })
            });
            
            if(!response.ok) {
                const err = await response.text();
                throw new Error("GitHub API Error: " + response.status);
            }
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function getAIResponse(prompt) {
            const messages = [{ role: "user", content: prompt }];
            if (currentProvider === 'github') return await callGitHubAPI(messages);
            else if (currentProvider === 'deepseek') return await callDeepSeekAPI(messages);
            else return await callOpenRouterAPI(messages);
        }

        // (Existing DeepSeek/OpenRouter functions remain same)
        async function callOpenRouterAPI(messages) {
             const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST", headers: { "Authorization": `Bearer ${openRouterKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "xiaomi/mimo-v2-flash:free", messages: messages })
            });
            const data = await response.json(); return data.choices[0].message.content;
        }
        async function callDeepSeekAPI(messages) {
            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST", headers: { "Authorization": `Bearer ${deepSeekKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "deepseek-chat", messages: messages })
            });
            const data = await response.json(); return data.choices[0].message.content;
        }

        // --- CORE APP LOGIC ---
        async function getIntegratedCaseStudy(drugObj, boxId, btnId, readBtnId) {
            const btn = document.getElementById(btnId), box = document.getElementById(boxId), readBtn = document.getElementById(readBtnId);
            btn.innerHTML = '<span class="loading-spinner"></span> Simulating...'; btn.disabled = true; box.style.display = 'block';
            try {
                const content = await getAIResponse(getCaseStudyPrompt(drugObj, aiLanguage));
                box.innerHTML = marked.parse(content);
                btn.innerHTML = '‚úÖ Case Loaded'; readBtn.style.display = 'block';
            } catch (e) { box.innerHTML = `Error: ${e.message}`; btn.innerText = "Error"; btn.disabled = false; }
        }

        async function triggerQuizExplain() {
            const btn = document.getElementById('btn-quiz-explain'), box = document.getElementById('ai-content');
            btn.innerHTML = '<span class="loading-spinner"></span> Thinking...'; btn.disabled = true; document.getElementById('ai-container').style.display = 'block';
            try {
                const content = await getAIResponse(getQuizExplainPrompt(currentQuizData, aiLanguage));
                box.innerHTML = marked.parse(content);
                btn.innerHTML = '‚úÖ Explained'; document.getElementById('btn-read-explain').style.display = 'block';
            } catch (e) { box.innerHTML = `Error: ${e.message}`; btn.innerText = "Error"; }
        }

        // --- STANDARD UTILS (Search, Fetch, Quiz, etc.) ---
        function fetchSheetData() {
            let url = document.getElementById('sheet-url').value.trim();
            if(!url) return;
            if(url.includes("/edit")) url = url.replace(/\/edit.*$/, "/export?format=csv");
            document.getElementById('upload-status').innerText = "‚è≥ Fetching...";
            fetch(url).then(r=>r.text()).then(csv=>{
                Papa.parse(csv, {header:true, skipEmptyLines:true, complete:res=>{
                    if(res.data.length>0) { extendedDrugs=res.data; document.getElementById('upload-status').innerText=`‚úÖ Loaded ${res.data.length} rows`; activeSourceList=extendedDrugs; reshuffle(); updateSetButton(); }
                }});
            });
        }
        function toggleSettings() { const p=document.getElementById('settings-panel'); p.style.display=(p.style.display==='block'?'none':'block'); }
        function toggleDrugSet() { activeSourceList = (activeSourceList===extendedDrugs && typeof commonDrugs!=='undefined') ? commonDrugs : extendedDrugs; updateSetButton(); reshuffle(); }
        function updateSetButton() { document.getElementById('set-btn').innerText = (activeSourceList===extendedDrugs) ? "üìö Set: Online CSV" : "üìö Set: Common"; }
        function reshuffle() {
            flashcardList=[...activeSourceList].sort(()=>Math.random()-0.5);
            quizList=processRawData(activeSourceList).sort(()=>Math.random()-0.5);
            fcCurrentIndex=0; quizCurrentIndex=0; renderCard(); generateQuizQuestion();
        }
        function toggleLanguage() {
            const b=document.getElementById('lang-btn');
            if(aiLanguage==='english'){ aiLanguage='cantonese'; b.innerText="üåê Lang: Canto"; b.classList.add('lang-canto'); }
            else if(aiLanguage==='cantonese'){ aiLanguage='lihkg'; b.innerText="üåê Lang: LIHKG"; b.classList.add('lang-lihkg'); }
            else { aiLanguage='english'; b.innerText="üåê Lang: Eng"; b.classList.remove('lang-canto','lang-lihkg'); }
        }
        function renderCard() { if(!flashcardList.length) return; fillCardData(flashcardList[fcCurrentIndex]); document.getElementById('counter').innerText=`${fcCurrentIndex+1}/${flashcardList.length}`; }
        function fillCardData(d) {
            ['name','class','system','indication','SideEffects','nursing'].forEach(k=>document.getElementById(`fc-${k}`).innerText=d[k]||"N/A");
            document.getElementById('fc-ai-case').style.display='none'; document.getElementById('btn-read-case').style.display='none'; document.getElementById('btn-case').disabled=false; document.getElementById('btn-case').innerText="üè• AI: Generate Case";
        }
        function nextCard() { if(fcCurrentIndex<flashcardList.length-1) { fcCurrentIndex++; document.getElementById('flashcard').classList.remove('flipped'); renderCard(); } }
        function prevCard() { if(fcCurrentIndex>0) { fcCurrentIndex--; document.getElementById('flashcard').classList.remove('flipped'); renderCard(); } }
        function flipCard(e) { if(e&&e.target.closest('button')) return; document.getElementById('flashcard').classList.toggle('flipped'); }
        function speakBack(d) { speakText(`System: ${d.system}. Class: ${d.class}.`, 'en'); }
        function readAIContent(id) { speakText(document.getElementById(id).innerText, aiLanguage.includes('cantonese')?'zh-HK':'en'); }
        
        function handleSearch() {
            const q=document.getElementById('search-input').value.toLowerCase().trim();
            const res=document.getElementById('search-results'); res.innerHTML='';
            if(!q) return res.innerHTML='<div style="text-align:center;color:#999">Type to search...</div>';
            const m=activeSourceList.filter(d=>(d.name||'').toLowerCase().includes(q)||(d.class||'').toLowerCase().includes(q)||(d.system||'').toLowerCase().includes(q));
            if(!m.length) return res.innerHTML='<div style="text-align:center;color:#999">No matches.</div>';
            m.forEach(d=>{
                const div=document.createElement('div'); div.className='result-card';
                div.innerHTML=`<div class="result-header"><span>${d.name}</span><span class="result-sub">${d.class}</span></div><div class="result-detail"><strong>System:</strong> ${d.system}<br><strong>Indication:</strong> ${d.indication}</div>`;
                div.onclick=()=>div.classList.toggle('expanded');
                res.appendChild(div);
            });
        }
        
        // Quiz logic omitted for brevity (same as previous version)
        function generateQuizQuestion() {
            document.getElementById('next-quiz-btn').style.display='none'; document.getElementById('ai-container').style.display='none';
            if(!quizList.length) return;
            const correct=quizList[quizCurrentIndex], box=document.getElementById('quiz-options'); box.innerHTML='';
            document.getElementById('quiz-question').innerText = `Which drug is a ${correct.class}?`; // Simplified for example
            let opts=[correct]; while(opts.length<4) { const r=quizList[Math.floor(Math.random()*quizList.length)]; if(!opts.includes(r)) opts.push(r); }
            opts.sort(()=>Math.random()-0.5).forEach(o=>{
                const b=document.createElement('button'); b.className='option-btn'; b.innerText=o.name;
                b.onclick=()=>{ 
                    document.querySelectorAll('.option-btn').forEach(btn=>{
                        if(btn.innerText===correct.name) btn.classList.add('correct');
                        else if(btn===b) btn.classList.add('wrong');
                        btn.onclick=null;
                    });
                    currentQuizData={q:`Class: ${correct.class}`, u:o.name, c:correct};
                    document.getElementById('next-quiz-btn').style.display='block'; document.getElementById('btn-quiz-explain').style.display='block';
                };
                box.appendChild(b);
            });
        }
        function nextQuestion() { quizCurrentIndex++; generateQuizQuestion(); }
        function switchMode(m) { 
            ['flashcard','quiz','search'].forEach(id=>document.getElementById(id+'-section').style.display='none');
            document.getElementById(m+'-section').style.display='block';
        }

        init();
    </script>
</body>
</html>
