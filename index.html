<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Drug Tutor">
    <meta name="theme-color" content="#F2F2F7">

    <title>Drug Tutor</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        (function() {
            const svgSource = `
            <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#30cfd0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#330867;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="512" height="512" rx="110" fill="url(#grad1)"/>
                <path d="M256 128c-70.7 0-128 57.3-128 128 0 70.7 57.3 128 128 128 70.7 0 128-57.3 128-128 0-70.7-57.3-128-128-128zm0 224c-53 0-96-43-96-96s43-96 96-96 96 43 96 96-43 96-96 96z" fill="#ffffff" opacity="0.3"/>
                <path d="M352 208h-48v-48c0-8.8-7.2-16-16-16h-64c-8.8 0-16 7.2-16 16v48h-48c-8.8 0-16 7.2-16 16v64c0 8.8 7.2 16 16 16h48v48c0 8.8 7.2 16 16 16h64c8.8 0 16-7.2 16-16v-48h48c8.8 0 16-7.2 16-16v-64c0-8.8-7.2-16-16-16z" fill="#ffffff"/>
            </svg>`;
            
            function setLink(rel, href) {
                let link = document.querySelector(`link[rel="${rel}"]`) || document.createElement('link');
                link.rel = rel; link.href = href; document.head.appendChild(link);
            }

            const img = new Image();
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgSource);
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                canvas.getContext('2d').drawImage(img, 0, 0);
                const pngUrl = canvas.toDataURL('image/png');
                setLink('apple-touch-icon', pngUrl);
                setLink('icon', pngUrl);
            };
        })();
    </script>

    <style>
        :root {
            /* iOS System Colors */
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-indigo: #5856D6;
            --ios-orange: #FF9500;
            --ios-pink: #FF2D55;
            --ios-purple: #AF52DE;
            --ios-red: #FF3B30;
            --ios-teal: #5AC8FA;
            --ios-yellow: #FFCC00;
            --ios-gray: #8E8E93;
            
            /* Theme Variables */
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --bg-header: rgba(242, 242, 247, 0.85);
            --bg-input: #E3E3E8;
            --text-primary: #000000;
            --text-secondary: #6C6C70;
            --text-tertiary: #AEAEB2;
            --border-light: rgba(60, 60, 67, 0.1);
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.03), 0 1px 4px rgba(0,0,0,0.02);
            --shadow-float: 0 8px 32px rgba(0, 0, 0, 0.12);
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --radius-l: 22px;
            --radius-m: 16px;
            --radius-s: 10px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #000000;
                --bg-card: #1C1C1E;
                --bg-header: rgba(28, 28, 30, 0.85);
                --bg-input: #2C2C2E;
                --text-primary: #FFFFFF;
                --text-secondary: #98989D;
                --text-tertiary: #58585E;
                --border-light: rgba(255, 255, 255, 0.12);
                --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.2);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0; padding: 0;
            padding-bottom: calc(var(--safe-bottom) + 80px);
            -webkit-font-smoothing: antialiased;
        }

        /* --- GRADIENT TEXT --- */
        .gradient-text {
            background: linear-gradient(135deg, var(--ios-blue), var(--ios-indigo));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- HEADER --- */
        .app-header {
            position: sticky; top: 0; z-index: 1000;
            background: var(--bg-header);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border-light);
            padding: calc(var(--safe-top) + 10px) 20px 10px 20px;
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
        }
        
        .app-title {
            font-size: 28px; font-weight: 800; letter-spacing: -0.5px; margin: 0;
            display: flex; align-items: center; gap: 8px;
        }

        .header-actions { display: flex; gap: 12px; }
        
        .icon-btn {
            background: rgba(120, 120, 128, 0.1); 
            width: 36px; height: 36px; border-radius: 50%; border: none;
            display: flex; justify-content: center; align-items: center; font-size: 18px;
            cursor: pointer; transition: transform 0.2s; color: var(--ios-blue);
        }
        .icon-btn:active { transform: scale(0.9); opacity: 0.7; }

        /* --- SEARCH --- */
        .search-wrapper { position: relative; margin-top: 5px; }
        .search-input {
            width: 100%; height: 44px;
            background: var(--bg-input); border: none; border-radius: 12px;
            padding: 0 12px 0 40px; font-size: 17px; color: var(--text-primary);
            font-weight: 400; outline: none; transition: background 0.2s;
        }
        .search-input:focus { background: var(--bg-card); box-shadow: 0 0 0 2px var(--ios-blue) inset; }
        .search-icon-svg {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            width: 18px; height: 18px; fill: var(--text-secondary); pointer-events: none;
        }

        /* --- CHIPS --- */
        .chips-container {
            display: flex; gap: 8px; overflow-x: auto; padding: 12px 20px;
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .chips-container::-webkit-scrollbar { display: none; }
        
        .chip {
            padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;
            background: var(--bg-card); color: var(--text-primary); border: 1px solid transparent;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04); white-space: nowrap; flex-shrink: 0;
            transition: all 0.2s; cursor: pointer;
        }
        .chip.active {
            background: var(--ios-blue); color: #fff; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.4);
        }

        /* --- CARDS --- */
        .results-container { padding: 0 20px; display: flex; flex-direction: column; gap: 16px; }

        .drug-card {
            background: var(--bg-card); border-radius: var(--radius-l);
            box-shadow: var(--shadow-card); overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative; border: 1px solid var(--border-light);
        }
        .drug-card:active { transform: scale(0.98); }

        /* Color Strips for Systems */
        .card-accent { height: 6px; width: 100%; background: var(--ios-gray); }
        .acc-cvs { background: linear-gradient(90deg, var(--ios-pink), var(--ios-red)); }
        .acc-resp { background: linear-gradient(90deg, var(--ios-teal), var(--ios-blue)); }
        .acc-gi { background: linear-gradient(90deg, var(--ios-green), #28A745); }
        .acc-cns { background: linear-gradient(90deg, var(--ios-purple), var(--ios-indigo)); }
        .acc-inf { background: linear-gradient(90deg, var(--ios-orange), var(--ios-yellow)); }
        
        .card-content { padding: 18px 20px; }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-title-group { flex: 1; }
        
        .card-name { 
            font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;
            display: flex; align-items: center; gap: 6px;
        }
        .card-class { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        
        .speaker-bubble {
            background: rgba(120, 120, 128, 0.1); border-radius: 50%;
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-left: 6px;
        }
        
        .chevron-btn {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: transparent; color: var(--text-tertiary);
            transition: transform 0.3s; font-size: 20px;
        }
        .drug-card.expanded .chevron-btn { transform: rotate(90deg); color: var(--text-primary); background: var(--bg-input); }

        /* --- EXPANDED DETAILS --- */
        .card-details { display: none; padding-top: 16px; margin-top: 16px; border-top: 1px solid var(--border-light); animation: fadeIn 0.3s ease; }
        .drug-card.expanded .card-details { display: block; }

        .info-row { margin-bottom: 12px; }
        .info-label { 
            font-size: 11px; font-weight: 700; text-transform: uppercase; 
            letter-spacing: 0.5px; color: var(--text-tertiary); margin-bottom: 4px; display: block;
        }
        .info-text { font-size: 15px; color: var(--text-primary); line-height: 1.5; }

        /* --- ACTION GRID (iOS Shortcuts Style) --- */
        .action-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;
        }
        .action-tile {
            background: var(--bg-input); border-radius: 12px; padding: 12px 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 6px; cursor: pointer; border: none; transition: filter 0.2s;
            text-decoration: none; position: relative; overflow: hidden;
        }
        .action-tile:active { filter: brightness(0.9); }
        .tile-icon { font-size: 22px; margin-bottom: 2px; }
        .tile-label { font-size: 11px; font-weight: 600; color: var(--text-primary); text-align: center; }

        /* Tile Colors (Subtle backgrounds) */
        .tile-blue { background: rgba(0, 122, 255, 0.1); color: var(--ios-blue); }
        .tile-green { background: rgba(52, 199, 89, 0.1); color: var(--ios-green); }
        .tile-orange { background: rgba(255, 149, 0, 0.1); color: var(--ios-orange); }
        .tile-purple { background: rgba(175, 82, 222, 0.1); color: var(--ios-purple); }
        .tile-indigo { background: rgba(88, 86, 214, 0.1); color: var(--ios-indigo); }
        .tile-red { background: rgba(255, 59, 48, 0.1); color: var(--ios-red); }

        /* --- ALERTS --- */
        .hold-alert {
            background: rgba(255, 59, 48, 0.1); color: var(--ios-red);
            padding: 12px; border-radius: 12px; font-weight: 600; font-size: 14px;
            display: flex; gap: 8px; align-items: center; margin-bottom: 15px;
        }

        /* --- BOTTOM SHEETS --- */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 2000;
            display: none; align-items: flex-end; backdrop-filter: blur(2px);
            opacity: 0; transition: opacity 0.3s;
        }
        .sheet-overlay.active { opacity: 1; }
        
        .sheet-modal {
            background: var(--bg-card); width: 100%; max-width: 600px; margin: 0 auto;
            border-radius: 24px 24px 0 0; padding: 24px;
            max-height: 90vh; overflow-y: auto; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; flex-direction: column;
            box-shadow: var(--shadow-float);
        }
        .sheet-overlay.active .sheet-modal { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 5px; background: var(--border-light); border-radius: 3px;
            margin: -10px auto 20px auto;
        }

        .sheet-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;
        }
        .sheet-title { font-size: 22px; font-weight: 800; margin: 0; }
        .sheet-close {
            background: var(--bg-input); border: none; width: 30px; height: 30px; border-radius: 50%;
            font-size: 14px; font-weight: 700; color: var(--text-secondary); cursor: pointer;
        }

        /* --- AI OUTPUT --- */
        .ai-box {
            background: var(--bg-input); border-radius: 16px; padding: 16px; margin-top: 16px;
            font-size: 15px; line-height: 1.6; display: none;
        }
        .thought-process {
            font-size: 12px; color: var(--text-secondary); background: rgba(0,0,0,0.03);
            border-left: 2px solid var(--ios-indigo); padding: 8px 12px; margin-bottom: 12px;
            border-radius: 0 8px 8px 0; font-family: "SF Mono", monospace;
        }

        /* --- SPINNER --- */
        .spinner {
            width: 18px; height: 18px; border: 2.5px solid rgba(128,128,128,0.3);
            border-top-color: var(--ios-blue); border-radius: 50%; display: inline-block; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- SKELETON --- */
        .sk-card { height: 90px; margin-bottom: 16px; background: var(--bg-card); border-radius: var(--radius-l); position: relative; overflow: hidden; border:1px solid var(--border-light); }
        .sk-shimmer {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(90deg, transparent, rgba(128,128,128,0.05), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* --- BUTTONS (Large) --- */
        .btn-large {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            font-size: 16px; font-weight: 600; background: var(--ios-blue); color: white;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); transition: transform 0.1s;
        }
        .btn-large:active { transform: scale(0.98); }
        .btn-large.secondary { background: var(--bg-input); color: var(--text-primary); box-shadow: none; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header class="app-header">
    <div class="header-top">
        <h1 class="app-title">
            <span class="gradient-text">Drug Tutor</span>
        </h1>
        <div class="header-actions">
            <button onclick="toggleGen()" class="icon-btn" style="width:auto; padding:0 12px; border-radius:18px; font-size:14px; font-weight:600; background:rgba(0,122,255,0.1);">ü¶† Disease</button>
            <button onclick="toggleVS()" class="icon-btn" style="background:rgba(88,86,214,0.1); color:var(--ios-indigo);">üÜö</button>
            <button onclick="toggleSettings()" class="icon-btn">‚öôÔ∏è</button>
        </div>
    </div>
    
    <div class="search-wrapper">
        <svg class="search-icon-svg" viewBox="0 0 24 24"><path d="M21.71 20.29L18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.42zM11 18a7 7 0 1 1 7-7 7 7 0 0 1-7 7z"/></svg>
        <input type="text" id="search-input" class="search-input" placeholder="Search drug name..." autocomplete="off" oninput="handleSearch()">
    </div>
</header>

<div id="system-chips" class="chips-container"></div>

<div id="history-container" style="display:none; padding-bottom:0;">
    <div style="padding:0 20px; font-size:12px; font-weight:600; color:var(--text-tertiary); text-transform:uppercase;">Recent</div>
    <div id="history-list" class="chips-container" style="padding-top:8px;"></div>
</div>

<div id="loading-skeleton" class="results-container" style="margin-top:20px;">
    <div class="sk-card"><div class="sk-shimmer"></div></div>
    <div class="sk-card"><div class="sk-shimmer"></div></div>
    <div class="sk-card"><div class="sk-shimmer"></div></div>
</div>

<div id="search-results" class="results-container" style="margin-top:20px;">
    <div id="empty-state-msg" style="text-align:center; margin-top:80px; display:none;">
        <div style="font-size:60px; margin-bottom:10px; opacity:0.3;">üíä</div>
        <div style="color:var(--text-tertiary); font-weight:500;">Start typing to search...</div>
    </div>
</div>

<div id="settings-overlay" class="sheet-overlay" onclick="if(event.target===this) toggleSettings()">
    <div class="sheet-modal">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 class="sheet-title">Settings</h2>
            <button class="sheet-close" onclick="toggleSettings()">‚úï</button>
        </div>
        
        <div style="background:var(--bg-input); border-radius:16px; overflow:hidden; margin-bottom:20px;">
            <div style="padding:16px; border-bottom:1px solid var(--border-light); display:flex; justify-content:space-between; align-items:center;">
                <span>üìö Data Source</span>
                <span style="color:var(--text-secondary); font-size:14px;">Google Sheets</span>
            </div>
            <div style="padding:16px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleLanguage()">
                <span>üåê AI Persona</span>
                <span id="lang-display" style="color:var(--ios-blue); font-weight:600;">LIHKG Mode</span>
            </div>
        </div>

        <h3 style="font-size:13px; color:var(--text-tertiary); text-transform:uppercase; margin:0 0 8px 12px;">Voice</h3>
        <div style="background:var(--bg-input); border-radius:16px; padding:8px; margin-bottom:20px;">
            <select id="voice-select" onchange="saveVoiceSelection()" style="width:100%; padding:8px; background:transparent; border:none; font-size:16px; color:var(--text-primary);"></select>
            <div onclick="testVoice()" style="text-align:center; color:var(--ios-blue); font-weight:600; padding:12px; border-top:1px solid var(--border-light); margin-top:8px;">üîä Test Audio</div>
        </div>

        <h3 style="font-size:13px; color:var(--text-tertiary); text-transform:uppercase; margin:0 0 8px 12px;">AI Config</h3>
        <div style="background:var(--bg-input); border-radius:16px; padding:16px;">
            <select id="provider-select" onchange="updateSettingsUI()" style="width:100%; padding:10px; background:var(--bg-card); border-radius:8px; border:none; color:var(--text-primary); font-size:16px;">
                <option value="deepseek">DeepSeek (V3 - Standard)</option>
                <option value="deepseek-r1">DeepSeek Reasoner (R1 - Smart)</option>
                <option value="yinli">Yinli (Custom Proxy)</option>
            </select>
            <div id="settings-dynamic-fields" style="margin-top:12px;"></div>
        </div>
        
        <button onclick="fetchSheetData()" class="btn-large secondary" style="margin-top:24px;">üîÑ Reload Database</button>
    </div>
</div>

<div id="vs-overlay" class="sheet-overlay" onclick="if(event.target===this) toggleVS()">
    <div class="sheet-modal">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 class="sheet-title">Compare Drugs</h2>
            <button class="sheet-close" onclick="toggleVS()">‚úï</button>
        </div>
        
        <div style="display:flex; gap:12px; margin-bottom:20px;">
            <div style="flex:1;">
                <label style="font-size:12px; color:var(--text-tertiary); font-weight:600; display:block; margin-bottom:4px;">DRUG A</label>
                <input type="text" id="vs-input-a" class="search-input" placeholder="e.g. Panadol">
            </div>
            <div style="display:flex; align-items:center; padding-top:18px; color:var(--ios-indigo); font-weight:800;">VS</div>
            <div style="flex:1;">
                <label style="font-size:12px; color:var(--text-tertiary); font-weight:600; display:block; margin-bottom:4px;">DRUG B</label>
                <input type="text" id="vs-input-b" class="search-input" placeholder="e.g. Ibuprofen">
            </div>
        </div>

        <button id="btn-compare" class="btn-large" style="background:var(--ios-indigo);" onclick="triggerCompare()">‚öîÔ∏è Compare</button>
        <div id="vs-result-area" class="ai-box"></div>
    </div>
</div>

<div id="gen-overlay" class="sheet-overlay" onclick="if(event.target===this) toggleGen()">
    <div class="sheet-modal">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 class="sheet-title">Disease Tutor</h2>
            <button class="sheet-close" onclick="toggleGen()">‚úï</button>
        </div>
        
        <textarea id="gen-input" class="search-input" style="height:100px; padding-top:12px; resize:none;" placeholder="Enter condition (e.g. Heart Failure)..."></textarea>
        
        <button id="btn-gen" class="btn-large" style="margin-top:16px; background:var(--ios-blue);" onclick="triggerGen()">‚ú® Explain Treatment</button>
        <div id="gen-result-area" class="ai-box"></div>
    </div>
</div>

<div id="edit-overlay" class="sheet-overlay" onclick="if(event.target===this) toggleEditOverlay()">
    <div class="sheet-modal">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 class="sheet-title">Edit Drug</h2>
            <button class="sheet-close" onclick="toggleEditOverlay()">‚úï</button>
        </div>
        <p style="color:var(--text-secondary); margin-top:0;">Editing: <strong id="edit-drug-name-disp"></strong></p>
        <textarea id="edit-input" class="search-input" style="height:120px; padding-top:12px; resize:none;" placeholder="Describe changes..."></textarea>
        <button id="btn-edit-submit" class="btn-large" style="margin-top:16px; background:var(--ios-orange);" onclick="submitAIEdit()">Update</button>
    </div>
</div>

<div id="select-overlay" class="sheet-overlay" onclick="if(event.target===this) closeSelect()">
    <div class="sheet-modal" style="height:auto;">
        <div class="sheet-header">
            <h2 class="sheet-title">Select Variant</h2>
        </div>
        <div id="select-options-container" style="display:flex; flex-direction:column; gap:8px;"></div>
        <button onclick="closeSelect()" class="btn-large secondary" style="margin-top:16px;">Cancel</button>
    </div>
</div>


<script>
    // --- CONFIGURATION ---
    const DB_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";
    const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxyNPyjbVXDMTQxFPxEuuCDTNNf-iVFfqedfNbh-kgn6Tk9rSIFEfIaLWXxXZoNOVnWug/exec";

    // --- STATE ---
    let drugs = [];
    let searchHistory = [];
    let aiLanguage = 'lihkg';
    let availableVoices = [];
    let selectedVoiceURI = '';
    
    // Edit & Select States
    let currentEditDrug = null;
    let pendingSelectAction = null; 
    
    // --- KEYS (Default) ---
    let provider = 'deepseek-r1'; 
    let keys = { deepseek: "sk-92db3cf721454bd7b351ca6ef40eaaf7", yinli: "" };
    let yinliUrl = "https://yinli.one/v1/chat/completions";
    let yinliModel = "gpt-5.1"; 

    let pendingDrugSave = null;

    // --- üé® SYSTEM COLORS ---
    const systems = [
        {id: "GI", name: "üçΩÔ∏è Gastro", class: "acc-gi", full: "Gastro-intestinal system"},
        {id: "CVS", name: "ü´Ä Cardio", class: "acc-cvs", full: "Cardiovascular system"},
        {id: "Resp", name: "ü´Å Resp", class: "acc-resp", full: "Respiratory system"},
        {id: "CNS", name: "üß† CNS", class: "acc-cns", full: "Central nervous system"},
        {id: "Inf", name: "ü¶† Infect", class: "acc-inf", full: "Infections"},
        {id: "Endo", name: "ü¶ã Endo", class: "acc-gi", full: "Endocrine system"},
        {id: "ObGyn", name: "ü§∞ ObGyn", class: "acc-cns", full: "Obstetrics, gynaecology, and urinary-tract disorders"},
        {id: "Malig", name: "üéóÔ∏è Onco", class: "acc-inf", full: "Malignant disease and immunosuppression"},
        {id: "Nutri", name: "ü©∏ Blood", class: "acc-cvs", full: "Nutrition and blood"},
        {id: "MSK", name: "ü¶¥ MSK", class: "acc-resp", full: "Musculoskeletal and joint disease"}
    ];

    function init() {
        if(localStorage.getItem('ai_provider')) provider = localStorage.getItem('ai_provider');
        if(localStorage.getItem('ds_key')) keys.deepseek = localStorage.getItem('ds_key');
        if(localStorage.getItem('yl_key')) keys.yinli = localStorage.getItem('yl_key');
        if(localStorage.getItem('search_hist')) searchHistory = JSON.parse(localStorage.getItem('search_hist'));
        if(localStorage.getItem('voice_uri')) selectedVoiceURI = localStorage.getItem('voice_uri');

        if (window.speechSynthesis) {
             window.speechSynthesis.onvoiceschanged = loadVoices;
             loadVoices();
        }

        updateSettingsUI();
        renderSystemChips();
        fetchSheetData(true); 
        renderHistory();
        
        const provSelect = document.getElementById('provider-select');
        if(provSelect) provSelect.value = provider;
        
        // Restore last search
        const lastSearch = localStorage.getItem('last_search_term');
        if(lastSearch) {
            document.getElementById('search-input').value = lastSearch;
        }
    }

    // --- RENDER FUNCTIONS ---
    function renderSystemChips() {
        const c = document.getElementById('system-chips');
        c.innerHTML = `<button class="chip active" onclick="filterBySystem('All', this)">All</button>`;
        systems.forEach(s => { c.innerHTML += `<button class="chip" onclick="filterBySystem('${s.full}', this)">${s.name}</button>`; });
    }

    function getSystemColorClass(systemName) {
        if(!systemName) return 'acc-resp'; // default blue
        if(systemName.includes('Cardio') || systemName.includes('Blood')) return 'acc-cvs';
        if(systemName.includes('Gastro') || systemName.includes('Endo')) return 'acc-gi';
        if(systemName.includes('Nervous') || systemName.includes('Obstetrics')) return 'acc-cns';
        if(systemName.includes('Infection') || systemName.includes('Malignant')) return 'acc-inf';
        return 'acc-resp';
    }

    function renderResult(d, idx, container, isNew = false) {
        const div = document.createElement('div');
        div.className = 'drug-card';
        if(isNew) div.style.border = "2px solid var(--ios-green)";
        const uniqueId = Math.random().toString(36).substr(2, 9);
        const aiId = `ai-${uniqueId}`;
        
        const drugStr = JSON.stringify(d).replace(/"/g, '&quot;');
        const safeSpeakerData = encodeURIComponent(JSON.stringify({
            name: d.name.replace(/'/g, ""),
            class: d.class,
            system: d.system,
            indication: d.indication.replace(/\n/g, ""),
            SideEffects: d.SideEffects.replace(/\n/g, ""),
            nursing: d.nursing.replace(/\n/g, "")
        }));
        
        const colorClass = getSystemColorClass(d.system);
        let holdHtml = '';
        if (d.hold_param) { holdHtml = `<div class="hold-alert"><span>‚õîÔ∏è</span><span>HOLD IF: ${d.hold_param}</span></div>`; }

        div.innerHTML = `
            <div class="card-accent ${colorClass}"></div>
            <div class="card-content">
                <div class="card-header">
                    <div class="card-title-group">
                        <div class="card-name">
                            ${d.name} 
                            <div class="speaker-bubble" onclick="triggerSpeak('${safeSpeakerData}')">üîä</div>
                        </div>
                        <div class="card-class">${d.class}</div>
                    </div>
                    <button class="chevron-btn">‚Ä∫</button>
                </div>

                <div class="card-details">
                    ${holdHtml}
                    <div class="info-row"><span class="info-label">Indication</span><span class="info-text">${d.indication || "N/A"}</span></div>
                    <div class="info-row"><span class="info-label">Side Effects</span><span class="info-text">${d.SideEffects || "N/A"}</span></div>
                    <div class="info-row"><span class="info-label">Nursing</span><span class="info-text">${d.nursing || "N/A"}</span></div>
                    
                    <div class="action-grid">
                        <button class="action-tile tile-blue" onclick="event.stopPropagation(); handleToolClick('google', ${drugStr}, '${aiId}', this)">
                            <div class="tile-icon">G</div>
                            <span class="tile-label">Google</span>
                        </button>
                        <button class="action-tile tile-indigo" onclick="event.stopPropagation(); handleToolClick('drugscom', ${drugStr}, '${aiId}', this)">
                            <div class="tile-icon">üíä</div>
                            <span class="tile-label">Drugs.com</span>
                        </button>
                        <button class="action-tile tile-green" onclick="event.stopPropagation(); handleToolClick('explain', ${drugStr}, '${aiId}', this)">
                            <div class="tile-icon">üéì</div>
                            <span class="tile-label">Explain</span>
                        </button>
                        <button class="action-tile tile-teal" onclick="event.stopPropagation(); handleToolClick('cheat', ${drugStr}, '${aiId}', this)">
                            <div class="tile-icon">üìã</div>
                            <span class="tile-label">CheatSheet</span>
                        </button>
                        <button class="action-tile tile-orange" onclick="event.stopPropagation(); triggerEditPrompt(${drugStr})">
                            <div class="tile-icon">‚úèÔ∏è</div>
                            <span class="tile-label">Edit</span>
                        </button>
                        <button class="action-tile tile-purple" onclick="event.stopPropagation(); handleToolClick('mix', ${drugStr}, '${aiId}', this)">
                            <div class="tile-icon">üß™</div>
                            <span class="tile-label">Recon</span>
                        </button>
                    </div>

                    <div id="${aiId}" class="ai-box"></div>
                </div>
            </div>
        `;
        div.onclick = (e) => { 
            if(!e.target.closest('button') && !e.target.closest('a') && !e.target.closest('input')) div.classList.toggle('expanded'); 
        };
        container.appendChild(div);
    }

    // --- SEARCH LOGIC ---
    function handleSearch() {
        pendingDrugSave = null; 
        const q = document.getElementById('search-input').value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        const emptyState = document.getElementById('empty-state-msg');
        
        if(!q) {
            document.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
            document.querySelector('.chip').classList.add('active');
            container.innerHTML = ''; container.appendChild(emptyState); emptyState.style.display = 'none';
            const allDrugs = [...drugs].sort((a,b) => (a.name||"").localeCompare(b.name||""));
            allDrugs.forEach((d, idx) => renderResult(d, idx, container));
            return;
        }
        
        document.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
        container.innerHTML = ''; container.appendChild(emptyState); emptyState.style.display = 'none';

        if(q.length > 3 && !searchHistory.includes(q)) {
            searchHistory.unshift(q);
            if(searchHistory.length > 5) searchHistory.pop();
            localStorage.setItem('search_hist', JSON.stringify(searchHistory));
            renderHistory();
        }

        const matches = drugs.filter(d => (d.name+d.class+d.indication+d.system).toLowerCase().includes(q));
        matches.sort((a, b) => {
            const nameA = (a.name || "").toLowerCase();
            const nameB = (b.name || "").toLowerCase();
            if (nameA.startsWith(q) && !nameB.startsWith(q)) return -1;
            if (!nameA.startsWith(q) && nameB.startsWith(q)) return 1;
            return nameA.localeCompare(nameB);
        });

        if (matches.length > 0) {
            matches.forEach((d, idx) => renderResult(d, idx, container));
        } else {
            const div = document.createElement('div');
            div.style.textAlign = 'center'; div.style.padding = '40px';
            div.innerHTML = `
                <div style="color:var(--text-secondary); margin-bottom:15px;">Drug not found locally.</div>
                <button class="btn-large" onclick="triggerAISearchAndGenerate('${q}')">‚ú® Ask AI Pharmacist</button>
            `;
            container.appendChild(div);
        }
    }

    // --- TOOL ACTIONS (RETAINED LOGIC) ---
    function handleToolClick(action, drugObj, aiId, btnElement) {
        if (drugObj.name.includes(';')) {
            const names = drugObj.name.split(';').map(n => n.trim()).filter(n => n);
            showSelectModal(names, action, drugObj, aiId, btnElement);
        } else {
            executeToolAction(action, drugObj.name, drugObj, aiId, btnElement);
        }
    }

    function showSelectModal(names, action, drugObj, aiId, btnElement) {
        const overlay = document.getElementById('select-overlay');
        const container = document.getElementById('select-options-container');
        container.innerHTML = '';
        pendingSelectAction = { action, drugObj, aiId, btnElement };
        
        names.forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'btn-large secondary';
            btn.innerText = name;
            btn.onclick = () => {
                closeSelect();
                executeToolAction(action, name, drugObj, aiId, btnElement);
            };
            container.appendChild(btn);
        });
        
        overlay.classList.add('active'); overlay.style.display = 'flex';
    }

    function closeSelect() {
        const el = document.getElementById('select-overlay');
        el.classList.remove('active');
        setTimeout(() => el.style.display = 'none', 300);
        pendingSelectAction = null;
    }

    function executeToolAction(action, selectedName, drugObj, aiId, btnElement) {
        const currentSearch = document.getElementById('search-input').value;
        localStorage.setItem('last_search_term', currentSearch);
        let cleanName = selectedName.split('(')[0].trim();
        if(!cleanName) cleanName = selectedName.replace(/[^\w\s-]/g, '');

        if (action === 'google') {
            window.location.href = `https://www.google.com/search?q=${encodeURIComponent(cleanName)}`;
        } else if (action === 'drugscom') {
            window.location.href = `https://www.drugs.com/search.php?searchterm=${encodeURIComponent(cleanName)}`;
        } else {
            triggerAIContext(drugObj, action, aiId, btnElement, selectedName);
        }
    }

    // --- SHEET TOGGLES (ANIMATED) ---
    function toggleSheet(id) {
        const el = document.getElementById(id);
        if(el.style.display === 'flex') {
            el.classList.remove('active');
            setTimeout(() => el.style.display = 'none', 300);
        } else {
            el.style.display = 'flex';
            setTimeout(() => el.classList.add('active'), 10);
        }
    }
    function toggleSettings() { toggleSheet('settings-overlay'); }
    function toggleVS() { toggleSheet('vs-overlay'); }
    function toggleGen() { toggleSheet('gen-overlay'); }
    function toggleEditOverlay() { toggleSheet('edit-overlay'); }

    // --- AI & FETCHING (LOGIC KEPT) ---
    async function triggerAIContext(obj, type, outputId, btn, drugNameOverride) {
        const out = document.getElementById(outputId);
        const name = drugNameOverride || obj.name;
        
        // Visual Loading State in Button?
        // Note: For grid buttons, we might want to just show the loading box
        out.style.display = 'block'; out.innerHTML = '<div style="text-align:center; padding:10px;"><span class="spinner"></span> AI Thinking...</div>';
        
        let prompt = "";
        const hkPersona = "You are a Hong Kong Nursing Senior. Output MUST be in Traditional Chinese (Cantonese) mixed with English medical terms (Kongish). Be direct, medically strict. Use slang like 'Ching', 'BP', 'O2'.";
        const enPersona = "You are a professional Nursing Tutor. Output MUST be in Standard Professional English.";
        const currentPersona = aiLanguage === 'lihkg' ? hkPersona : enPersona;

        if (type === 'explain') {
            prompt = `System: ${currentPersona}. Task: Explain ${name} to a Year 1 student. Use a funny analogy. Explain mechanism simply. Mention one "Killer Side Effect".`;
        } else if (type === 'cheat') {
            prompt = `System: ${currentPersona}. Task: Create a "Ward Survival Cheatsheet" for ${name}. Bullet points: 1. STOP Checks (Hold if...), 2. Monitoring, 3. Red Flags. Keep it ultra-concise.`;
        } else if (type === 'mix') {
             prompt = `System: ${currentPersona}. Task: Explain mixing/admin for ${name} (IV/IM). Diluent, Rate, Incompatibilities.`;
        }

        try {
            await streamAI(prompt, (chunk, thoughts) => { 
                let html = "";
                if(thoughts) html += `<div class="thought-process">${marked.parse(thoughts)}</div>`;
                html += marked.parse(chunk);
                out.innerHTML = html;
            });
        } catch (e) { out.innerHTML = `Error: ${e.message}`; } 
    }

    // --- EDIT & SAVE ---
    function triggerEditPrompt(drugObj) {
        currentEditDrug = drugObj;
        document.getElementById('edit-drug-name-disp').innerText = drugObj.name;
        document.getElementById('edit-input').value = '';
        toggleEditOverlay();
    }

    async function submitAIEdit() {
        if (!currentEditDrug) return;
        const instructions = document.getElementById('edit-input').value.trim();
        const btn = document.getElementById('btn-edit-submit');
        if (!instructions) { alert("Please enter instructions."); return; }
        
        btn.innerHTML = '<span class="spinner"></span> Updating...';
        const prompt = `You are editing a JSON database entry for a drug. Current: ${JSON.stringify(currentEditDrug)}. User Instructions: ${instructions}. Task: Return updated JSON only. Keys: name, class, indication, system, SideEffects, nursing, hold_param.`;
        
        try {
            let jsonString = await getFullAIResponse(prompt);
            jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').replace(/<think>[\s\S]*?<\/think>/g, '').trim();
            const firstBrace = jsonString.indexOf('{');
            const lastBrace = jsonString.lastIndexOf('}');
            if(firstBrace !== -1 && lastBrace !== -1) jsonString = jsonString.substring(firstBrace, lastBrace + 1);
            
            const newDrugData = JSON.parse(jsonString);
            pendingDrugSave = newDrugData;
            toggleEditOverlay();
            confirmSaveDrug(); // Auto save in this version? Or show preview. Let's auto-alert for simplicity in redesign.
        } catch(e) { alert("Error: " + e.message); } 
        finally { btn.innerHTML = "Update"; }
    }
    
    function confirmSaveDrug() {
        if(!pendingDrugSave) return;
        drugs.push(pendingDrugSave);
        fetch(UPLOAD_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(pendingDrugSave) });
        alert("‚úÖ Changes Saved!");
        document.getElementById('search-input').value = '';
        handleSearch();
    }

    // --- STANDARD API CALLS ---
    async function streamAI(prompt, onChunk) {
        let url = "https://api.deepseek.com/chat/completions";
        let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${keys.deepseek}` };
        let modelToUse = (provider === 'deepseek-r1') ? "deepseek-reasoner" : "deepseek-chat"; 
        let body = { model: modelToUse, messages: [{role:"user", content: prompt}], stream: true };
        if(provider === 'yinli') { url = yinliUrl; headers["Authorization"] = `Bearer ${keys.yinli}`; body.model = yinliModel; }

        const response = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "", fullThinking = "", buffer = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, {stream: true});
            const lines = buffer.split('\n');
            buffer = lines.pop(); 
            for (const line of lines) {
                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    try {
                        const json = JSON.parse(line.substring(6));
                        const content = json.choices[0]?.delta?.content || "";
                        const reasoning = json.choices[0]?.delta?.reasoning_content || "";
                        if(reasoning) fullThinking += reasoning;
                        if(content) fullText += content;
                        onChunk(fullText, fullThinking);
                    } catch (e) { }
                }
            }
        }
    }

    async function getFullAIResponse(prompt) {
        let url = "https://api.deepseek.com/chat/completions";
        let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${keys.deepseek}` };
        let modelToUse = (provider === 'deepseek-r1') ? "deepseek-reasoner" : "deepseek-chat";
        let body = { model: modelToUse, messages: [{role:"user", content: prompt}], stream: false };
        if(provider === 'yinli') { url = yinliUrl; headers["Authorization"] = `Bearer ${keys.yinli}`; body.model = yinliModel; }
        const response = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const json = await response.json();
        return json.choices[0].message.content;
    }

    // --- DATA LOADING ---
    function fetchSheetData(silent = false) {
        const loading = document.getElementById('loading-skeleton');
        const results = document.getElementById('search-results');
        const localData = localStorage.getItem('drug_db_cache');
        
        if (localData) {
            drugs = JSON.parse(localData);
            loading.style.display = 'none';
            if(!document.getElementById('search-input').value) {
                const allDrugs = [...drugs].sort((a,b) => (a.name||"").localeCompare(b.name||""));
                results.innerHTML = '';
                allDrugs.forEach((d, idx) => renderResult(d, idx, results));
            }
        } else {
            if(!silent) loading.style.display = 'flex';
        }

        fetch(DB_URL).then(r=>r.text()).then(csv=>{
            Papa.parse(csv, {header:true, skipEmptyLines:true, complete:res=>{
                if(res.data.length){ 
                    drugs = res.data;
                    localStorage.setItem('drug_db_cache', JSON.stringify(drugs));
                    if (!localData) {
                        loading.style.display = 'none'; 
                        if(!silent) alert(`‚úÖ Loaded ${drugs.length} drugs`); 
                        document.getElementById('search-input').value = '';
                        handleSearch();
                    }
                }
            }});
        });
    }

    // --- MISC UTILS ---
    function renderHistory() {
        const c = document.getElementById('history-list');
        const box = document.getElementById('history-container');
        if(searchHistory.length === 0) { box.style.display = 'none'; return; }
        box.style.display = 'block'; c.innerHTML = '';
        searchHistory.forEach(term => { c.innerHTML += `<button class="chip" style="background:var(--bg-input); border:none;" onclick="clickHistory('${term}')">${term}</button>`; });
    }
    function clickHistory(term) { document.getElementById('search-input').value = term; handleSearch(); }
    function filterBySystem(sys, btn) {
        document.getElementById('search-input').value = '';
        document.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const container = document.getElementById('search-results');
        container.innerHTML = ''; 
        const matches = (sys === 'All') ? drugs : drugs.filter(d => (d.system || "").includes(sys));
        matches.sort((a,b) => (a.name||"").localeCompare(b.name||""));
        matches.forEach((d, idx) => renderResult(d, idx, container));
    }
    function saveVoiceSelection() {
        selectedVoiceURI = document.getElementById('voice-select').value;
        localStorage.setItem('voice_uri', selectedVoiceURI);
    }
    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voice-select');
        select.innerHTML = '<option value="">ü§ñ Auto-Detect Best</option>';
        availableVoices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voiceURI; opt.innerText = `${v.name} (${v.lang})`;
            if(v.voiceURI === selectedVoiceURI) opt.selected = true;
            select.appendChild(opt);
        });
    }
    function testVoice() { 
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance("Audio test successful.");
        if(selectedVoiceURI) u.voice = availableVoices.find(v=>v.voiceURI === selectedVoiceURI);
        window.speechSynthesis.speak(u);
    }
    function triggerSpeak(encoded) {
        event.stopPropagation();
        const d = JSON.parse(decodeURIComponent(encoded));
        const txt = aiLanguage === 'lihkg' ? `Ëó•Âêç: ${d.name}„ÄÇ È°ûÂà•: ${d.class}„ÄÇ` : `Drug Name: ${d.name}. Class: ${d.class}.`;
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = aiLanguage === 'lihkg' ? 'zh-HK' : 'en-US';
        if(selectedVoiceURI) u.voice = availableVoices.find(v=>v.voiceURI === selectedVoiceURI);
        window.speechSynthesis.speak(u);
    }
    function updateSettingsUI() {
        const prov = document.getElementById('provider-select').value;
        const container = document.getElementById('settings-dynamic-fields');
        container.innerHTML = '';
        if (prov === 'yinli') container.innerHTML = `<input type="password" id="yinli-key" class="search-input" value="${keys.yinli}" placeholder="Yinli Key..." onchange="keys.yinli=this.value;localStorage.setItem('yl_key',this.value)">`;
        else if (prov.startsWith('deepseek')) container.innerHTML = `<input type="password" id="deepseek-key" class="search-input" value="${keys.deepseek}" placeholder="DeepSeek Key..." onchange="keys.deepseek=this.value;localStorage.setItem('ds_key',this.value)">`;
        localStorage.setItem('ai_provider', prov);
    }
    function toggleLanguage() {
        const display = document.getElementById('lang-display');
        aiLanguage = (aiLanguage === 'english') ? 'lihkg' : 'english';
        display.innerText = (aiLanguage === 'english') ? "English" : "LIHKG Mode";
    }

    init();
</script>
</body>
</html>
