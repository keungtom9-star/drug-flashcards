<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Drug Tutor">
    <meta name="theme-color" content="#F2F2F7">

    <title>iOS Drug Tutor</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // Dynamic App Icon (Blue Gradient Style)
        (function() {
            const svgSource = `
            <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#007AFF;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#5AC8FA;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="512" height="512" rx="120" fill="url(#grad1)"/>
                <path d="M256 120C180.9 120 120 180.9 120 256s60.9 136 136 136 136-60.9 136-136-60.9-136-136-136zm0 248c-61.8 0-112-50.2-112-112s50.2-112 112-112 112 50.2 112 112-50.2 112-112 112z" fill="#ffffff" opacity="0.3"/>
                <path d="M360 256H152c-8.8 0-16-7.2-16-16s7.2-16 16-16h208c8.8 0 16 7.2 16 16s-7.2 16-16 16z" fill="#ffffff"/>
                <path d="M256 360c-8.8 0-16-7.2-16-16V152c0-8.8 7.2-16 16-16s16 7.2 16 16v192c0 8.8-7.2 16-16 16z" fill="#ffffff"/>
            </svg>`;
            
            function setLink(rel, href) {
                let link = document.querySelector(`link[rel="${rel}"]`) || document.createElement('link');
                link.rel = rel; link.href = href; document.head.appendChild(link);
            }

            const img = new Image();
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgSource);
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                canvas.getContext('2d').drawImage(img, 0, 0);
                const pngUrl = canvas.toDataURL('image/png');
                setLink('apple-touch-icon', pngUrl);
                setLink('icon', pngUrl);
                const headerIcon = document.getElementById('header-icon-display');
                if(headerIcon) headerIcon.src = pngUrl;
            };
        })();
    </script>

    <style>
        :root {
            /* iOS System Colors */
            --primary: #007AFF;
            --secondary-acc: #5856D6;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            
            /* Light Mode */
            --background: #F2F2F7;
            --surface: #FFFFFF;
            --surface-secondary: #FFFFFF;
            --text-main: #000000;
            --text-secondary: #8E8E93;
            --border: #C6C6C8;
            --input-bg: #7676801F;
            --separator: #C6C6C8;
            
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --modal-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            
            --radius-card: 16px;
            --radius-btn: 12px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* iOS Dark Mode */
                --background: #000000;
                --surface: #1C1C1E;
                --surface-secondary: #2C2C2E;
                --text-main: #FFFFFF;
                --text-secondary: #8E8E93;
                --border: #38383A;
                --input-bg: #7676803D;
                --separator: #38383A;
                --shadow: 0 2px 12px rgba(0, 0, 0, 0.5);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: var(--font-stack);
            background-color: var(--background);
            color: var(--text-main);
            margin: 0; padding: 0;
            padding-bottom: calc(var(--safe-bottom) + 80px);
            -webkit-font-smoothing: antialiased;
        }

        /* --- iOS HEADER --- */
        .app-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(var(--surface), 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: calc(var(--safe-top) + 10px) 16px 10px 16px;
            border-bottom: 0.5px solid var(--separator);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        @media (prefers-color-scheme: dark) {
            .app-header { background: rgba(28, 28, 30, 0.8); }
        }

        h1 { 
            margin: 0; font-size: 22px; font-weight: 700; 
            display: flex; align-items: center; gap: 10px; 
            letter-spacing: -0.5px;
        }

        .app-icon-img { 
            width: 30px; height: 30px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); 
        }

        .icon-btn {
            background: transparent; border: none; color: var(--primary);
            font-size: 17px; cursor: pointer; padding: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:active { opacity: 0.5; }

        /* --- SEARCH --- */
        .search-container { padding: 12px 16px; background: transparent; }
        .search-wrapper { position: relative; width: 100%; }
        .search-bar {
            width: 100%; padding: 10px 10px 10px 36px; 
            border-radius: 10px; border: none;
            background: var(--input-bg); 
            font-size: 17px; color: var(--text-main);
            transition: all 0.2s;
        }
        .search-bar::placeholder { color: var(--text-secondary); }
        .search-icon { 
            position: absolute; left: 10px; top: 50%; transform: translateY(-50%); 
            color: var(--text-secondary); font-size: 16px; pointer-events: none; 
        }

        /* --- CHIPS --- */
        .chip-scroll-row { 
            display: flex; gap: 10px; overflow-x: auto; 
            padding: 4px 16px 16px 16px; 
            scrollbar-width: none; -webkit-overflow-scrolling: touch; 
        }
        .chip-scroll-row::-webkit-scrollbar { display: none; }

        .filter-chip {
            padding: 8px 14px; border-radius: 18px; 
            font-size: 14px; font-weight: 500;
            white-space: nowrap; flex-shrink: 0; cursor: pointer; 
            border: 1px solid var(--separator);
            background: var(--surface); color: var(--text-main);
            transition: all 0.2s ease;
        }
        .filter-chip.active { 
            background: var(--text-main); color: var(--background); 
            border-color: var(--text-main); 
        }

        /* --- RESULTS --- */
        .results-grid { padding: 0 16px 20px 16px; display: flex; flex-direction: column; gap: 16px; }

        .result-card {
            background: var(--surface); 
            border-radius: var(--radius-card);
            box-shadow: var(--shadow); 
            position: relative; overflow: hidden;
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .result-card:active { transform: scale(0.98); }

        .result-main { padding: 16px; display: flex; justify-content: space-between; align-items: center; }
        
        .drug-info { flex: 1; padding-right: 12px; }
        .drug-name { 
            font-size: 17px; font-weight: 600; color: var(--text-main); 
            margin-bottom: 4px; line-height: 1.2; 
        }
        .drug-class { font-size: 14px; color: var(--text-secondary); font-weight: 400; }

        /* TTS Button */
        .tts-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--input-bg); border: none;
            display: flex; align-items: center; justify-content: center;
            color: var(--primary); font-size: 18px; flex-shrink: 0;
            transition: all 0.2s;
        }
        .tts-btn.speaking { background: var(--primary); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 122, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); } }

        /* Details */
        .result-detail { 
            height: 0; overflow: hidden; opacity: 0;
            border-top: 0.5px solid transparent;
            transition: all 0.35s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .result-card.expanded .result-detail { 
            height: auto; opacity: 1; padding: 16px; 
            border-top-color: var(--separator);
        }
        
        .detail-row { margin-bottom: 12px; }
        .d-label { display: block; font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; }
        .d-content { font-size: 15px; color: var(--text-main); line-height: 1.5; }

        /* Tools */
        .tool-row { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0 0 0; margin-top: 10px; }
        .btn-tool {
            font-size: 13px; padding: 8px 14px; border-radius: 14px; border: none; font-weight: 600;
            flex-shrink: 0; cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        .tool-isbar { background: #FFD60A20; color: #FFD60A; } 
        .tool-cheat { background: #64D2FF20; color: #0091FF; } 
        .tool-mix { background: #BF5AF220; color: #BF5AF2; } 
        .tool-explain { background: #32D74B20; color: #32D74B; } 
        .tool-edit { background: #FF9F0A20; color: #FF9F0A; } 
        
        @media (prefers-color-scheme: dark) {
            .tool-isbar { color: #FFD60A; }
            .tool-cheat { color: #64D2FF; }
        }

        .btn-action {
            width: 100%; background: var(--primary); color: white;
            padding: 14px; border-radius: 12px; border: none; 
            font-size: 16px; font-weight: 600; margin-top: 16px;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-action:disabled { opacity: 0.6; }
        .btn-secondary { background: var(--input-bg); color: var(--primary); }

        /* --- OVERLAYS --- */
        .overlay-backdrop {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 1000; 
            backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
            align-items: flex-end;
            opacity: 0; transition: opacity 0.3s;
        }
        .overlay-backdrop.show { opacity: 1; }
        
        .sheet-modal {
            background: var(--surface-secondary); 
            width: 100%; max-width: 600px; margin: 0 auto;
            border-radius: 20px 20px 0 0; 
            padding: 20px; box-sizing: border-box;
            max-height: 90vh; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: var(--modal-shadow);
        }
        .overlay-backdrop.show .sheet-modal { transform: translateY(0); }

        .sheet-handle { width: 40px; height: 5px; background: var(--separator); border-radius: 3px; margin: 0 auto 20px auto; opacity: 0.5; }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-size: 20px; font-weight: 700; }
        .sheet-close { color: var(--primary); font-weight: 600; background: none; border: none; font-size: 16px; }

        /* Inputs */
        .ios-input-group { background: var(--surface); border-radius: 12px; padding: 0 16px; margin-bottom: 20px; }
        .ios-input-row { padding: 14px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid var(--separator); }
        .ios-input-row:last-child { border-bottom: none; }
        .ios-text-input { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--input-bg); font-size: 16px; color: var(--text-main); }
        .ios-textarea { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--input-bg); font-size: 16px; color: var(--text-main); min-height: 100px; font-family: inherit; resize: none; }

        /* AI Box */
        .ai-output-box { margin-top: 16px; padding: 16px; border-radius: 12px; font-size: 15px; background: var(--surface); color: var(--text-main); display: none; line-height: 1.6; border: 1px solid var(--border); }
        .ai-output-box p { margin: 8px 0; }
        .ai-output-box table { width:100%; border-collapse:collapse; font-size:13px; margin:10px 0; }
        .ai-output-box th { text-align:left; color:var(--text-secondary); font-size:11px; text-transform:uppercase; border-bottom:1px solid var(--separator); padding:4px; }
        .ai-output-box td { border-bottom:1px solid var(--separator); padding:8px 4px; }

        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; display: inline-block; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .skeleton { height: 80px; background: var(--surface); border-radius: 16px; margin-bottom: 16px; opacity: 0.5; animation: pulse-opacity 1.5s infinite; }
        @keyframes pulse-opacity { 0% { opacity: 0.3; } 50% { opacity: 0.7; } 100% { opacity: 0.3; } }
    </style>
</head>
<body>

<div class="app-header">
    <h1>
        <img id="header-icon-display" src="" alt="" class="app-icon-img">
        Drug Tutor
    </h1>
    <div style="display:flex; gap:15px;">
        <button onclick="toggleDisease()" class="icon-btn" style="color:var(--primary); font-weight:600; font-size:15px;">
            ü¶† Disease
        </button>
        <button onclick="toggleVS()" class="icon-btn" style="font-size:20px;">üÜö</button>
        <button onclick="toggleSettings()" class="icon-btn" style="font-size:20px;">‚öôÔ∏è</button>
    </div>
</div>

<div class="search-container">
    <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="search-input" class="search-bar" placeholder="Search drug..." oninput="handleSearch()">
    </div>
</div>

<div id="system-chips" class="chip-scroll-row"></div>

<div id="loading-skeleton" style="padding: 0 16px; display:none;">
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
</div>

<div id="search-results" class="results-grid">
    <div style="text-align:center; color:var(--text-secondary); margin-top:60px;" id="empty-state-msg">
        <div style="font-size:4rem; opacity:0.1; margin-bottom:10px;">ü©∫</div>
        <div>Type to search or select a system</div>
    </div>
</div>

<div id="settings-overlay" class="overlay-backdrop" onclick="if(event.target===this) toggleSettings()">
    <div class="sheet-modal">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <div class="sheet-title">Settings</div>
            <button class="sheet-close" onclick="toggleSettings()">Done</button>
        </div>
        <div class="ios-input-group">
            <div class="ios-input-row" onclick="toggleLanguage()">
                <span>AI Persona</span>
                <span id="lang-display" style="color:var(--primary);">LIHKG (Cantonese)</span>
            </div>
            <div class="ios-input-row">
                <span>AI Provider</span>
                <select id="provider-select" onchange="updateSettingsUI()" style="border:none; background:transparent; color:var(--primary); font-size:16px; text-align:right;">
                    <option value="yinli">Yinli (GPT-5.1)</option>
                    <option value="deepseek">DeepSeek (V3)</option>
                </select>
            </div>
        </div>
        <div id="settings-dynamic-fields" class="ios-input-group"></div>
        <button onclick="fetchSheetData()" class="btn-action btn-secondary">üîÑ Reload Database</button>
    </div>
</div>

<div id="vs-overlay" class="overlay-backdrop" onclick="if(event.target===this) toggleVS()">
    <div class="sheet-modal" style="height:85vh;">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <div class="sheet-title">Compare Drugs</div>
            <button class="sheet-close" onclick="toggleVS()">Close</button>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="text" id="vs-input-a" class="ios-text-input" placeholder="Drug A">
            <input type="text" id="vs-input-b" class="ios-text-input" placeholder="Drug B">
        </div>
        <button id="btn-compare" class="btn-action" onclick="triggerCompare()">‚öîÔ∏è Compare</button>
        <div id="vs-result-area" class="ai-output-box" style="flex:1; overflow-y:auto;"></div>
    </div>
</div>

<div id="gen-overlay" class="overlay-backdrop" onclick="if(event.target===this) toggleDisease()">
    <div class="sheet-modal" style="height:90vh;">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <div class="sheet-title">Disease Protocol</div>
            <button class="sheet-close" onclick="toggleDisease()">Close</button>
        </div>
        <p style="color:var(--text-secondary); font-size:14px; margin-top:0;">Enter a condition to see HA standard drugs.</p>
        <textarea id="gen-input" class="ios-textarea" placeholder="e.g. Heart Failure, COPD, CAP (Pneumonia)..."></textarea>
        
        <button id="btn-gen" class="btn-action" onclick="triggerDisease()">‚ú® Show Related Drugs</button>
        <div id="gen-result-area" class="ai-output-box" style="flex:1; overflow-y:auto; white-space: pre-wrap;"></div>
    </div>
</div>

<div id="edit-overlay" class="overlay-backdrop" onclick="if(event.target===this) toggleEditOverlay()">
    <div class="sheet-modal">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <div class="sheet-title">AI Edit</div>
            <button class="sheet-close" onclick="toggleEditOverlay()">Cancel</button>
        </div>
        <div style="margin-bottom:15px; font-weight:600;" id="edit-drug-name-disp"></div>
        <textarea id="edit-input" class="ios-textarea" placeholder="Instructions: e.g. Add 'Nausea' to side effects..."></textarea>
        <button id="btn-edit-submit" class="btn-action" onclick="submitAIEdit()">Update</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const DB_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhyG6Wkv36DnsJBQ1V2MqJFm9T7iguC0rYxKqc-jhNaDoN7Wweu9lo6KzES-l76YRFP2PQgMf7APIt/pub?gid=1128575640&single=true&output=csv";
    const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxyNPyjbVXDMTQxFPxEuuCDTNNf-iVFfqedfNbh-kgn6Tk9rSIFEfIaLWXxXZoNOVnWug/exec";

    // --- STATE ---
    let drugs = [];
    let aiLanguage = 'lihkg';
    let currentSpeakerId = null; 
    let provider = 'yinli';
    let keys = { deepseek: "sk-92db3cf721454bd7b351ca6ef40eaaf7", yinli: "" };
    let yinliUrl = "https://yinli.one/v1/chat/completions";
    let yinliModel = "gpt-5.1";
    let currentEditDrug = null;
    let pendingDrugSave = null;

    const systems = [
        {id: "All", name: "All"}, {id: "GI", name: "üçΩÔ∏è Gastro"}, {id: "CVS", name: "ü´Ä Cardio"},
        {id: "Resp", name: "ü´Å Resp"}, {id: "CNS", name: "üß† CNS"}, {id: "Inf", name: "ü¶† Infect"},
        {id: "Endo", name: "ü¶ã Endo"}, {id: "Pain", name: "üíä Pain"}
    ];

    function init() {
        if(localStorage.getItem('ai_provider')) provider = localStorage.getItem('ai_provider');
        if(localStorage.getItem('ds_key')) keys.deepseek = localStorage.getItem('ds_key');
        if(localStorage.getItem('yl_key')) keys.yinli = localStorage.getItem('yl_key');
        
        updateSettingsUI();
        renderSystemChips();
        fetchSheetData(true);
        
        const lastSearch = localStorage.getItem('last_search_term');
        if(lastSearch) {
            document.getElementById('search-input').value = lastSearch;
            handleSearch();
        }
    }

    // --- 1. AI SEARCH & SAVE ---
    async function triggerAISearchAndGenerate(query) {
        const container = document.getElementById('search-results');
        container.innerHTML = `
            <div style="text-align:center; padding:40px;">
                <div class="spinner" style="border-color:var(--text-secondary); border-top-color:var(--primary);"></div>
                <div style="margin-top:15px; color:var(--text-secondary);">Consulting AI Database...</div>
            </div>`;

        const prompt = `You are a strict pharmacology database helper.
        Task: Output a JSON object for the drug "${query}".
        
        Strict JSON Format (No markdown, just raw JSON):
        {
            "name": "${query} (Official & Brand Name)",
            "class": "Pharmacological Class",
            "indication": "Short indication summary",
            "system": "Choose ONE: Gastro-intestinal system, Cardiovascular system, Respiratory system, Central nervous system, Infections, Endocrine system, Obstetrics, Malignant disease, Nutrition and blood, Musculoskeletal, Eye, Ear, Skin, Anaesthesia",
            "SideEffects": "Common side effects",
            "nursing": "Critical nursing monitoring points"
        }`;

        try {
            let jsonString = await getAIResponse(prompt);
            jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const drugData = JSON.parse(jsonString);
            pendingDrugSave = drugData;
            
            container.innerHTML = `
                <div class="result-card" style="padding:20px; border: 2px solid var(--primary);">
                    <div style="color:var(--primary); font-weight:700; font-size:12px; margin-bottom:10px;">‚ú® AI GENERATED PREVIEW</div>
                    <div style="font-size:22px; font-weight:700; margin-bottom:5px;">${drugData.name}</div>
                    <div style="color:var(--text-secondary); margin-bottom:20px;">${drugData.class}</div>
                    <div style="font-size:15px; line-height:1.5;">
                        <p><strong>System:</strong> ${drugData.system}</p>
                        <p><strong>Indication:</strong> ${drugData.indication}</p>
                        <p><strong>Side Effects:</strong> ${drugData.SideEffects}</p>
                        <p><strong>Nursing:</strong> ${drugData.nursing}</p>
                    </div>
                    <button class="btn-action" onclick="confirmSaveDrug()">üíæ Save to Database</button>
                    <button class="btn-action" style="background:transparent; color:var(--text-secondary); margin-top:5px;" onclick="handleSearch()">Cancel</button>
                </div>`;
        } catch (e) {
            container.innerHTML = `<div style="padding:20px; text-align:center; color:var(--danger);">Error generating drug: ${e.message}</div>`;
        }
    }

    // --- 2. AI EDIT ---
    function triggerEditPrompt(drugObj) {
        currentEditDrug = drugObj;
        document.getElementById('edit-drug-name-disp').innerText = "Editing: " + drugObj.name;
        document.getElementById('edit-input').value = '';
        toggleEditOverlay();
    }

    async function submitAIEdit() {
        if (!currentEditDrug) return;
        const instructions = document.getElementById('edit-input').value.trim();
        const btn = document.getElementById('btn-edit-submit');
        if (!instructions) return;

        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Updating...';

        const prompt = `You are editing a JSON database entry.
        Current JSON: ${JSON.stringify(currentEditDrug)}
        User Change Request: "${instructions}"
        Task: Return the FULLY updated JSON object. Keep strict keys: name, class, indication, system, SideEffects, nursing.
        Output ONLY JSON.`;

        try {
            let jsonString = await getAIResponse(prompt);
            jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBrace = jsonString.indexOf('{');
            const lastBrace = jsonString.lastIndexOf('}');
            if(firstBrace !== -1 && lastBrace !== -1) jsonString = jsonString.substring(firstBrace, lastBrace + 1);

            const newDrugData = JSON.parse(jsonString);
            pendingDrugSave = newDrugData;
            
            toggleEditOverlay();
            
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'result-card';
            div.style.border = "2px solid var(--warning)";
            div.style.padding = "20px";
            div.innerHTML = `
                <div style="color:var(--warning); font-weight:700; font-size:12px; margin-bottom:10px;">‚úèÔ∏è EDITED PREVIEW</div>
                <div style="font-size:20px; font-weight:700;">${newDrugData.name}</div>
                <div style="color:var(--text-secondary); margin-bottom:15px;">${newDrugData.class}</div>
                <div style="font-size:14px; opacity:0.8; margin-bottom:15px;">${newDrugData.indication}</div>
                <button class="btn-action" onclick="confirmSaveDrug()">üíæ Confirm Changes</button>
                <button class="btn-action" style="background:transparent; color:var(--text-secondary);" onclick="handleSearch()">Cancel</button>
            `;
            container.appendChild(div);
        } catch (e) { alert("Edit Failed: " + e.message); } 
        finally { btn.disabled = false; btn.innerHTML = 'Update'; }
    }

    function confirmSaveDrug() {
        if(!pendingDrugSave) return;
        const existingIdx = drugs.findIndex(d => d.name === pendingDrugSave.name);
        if (existingIdx > -1) drugs[existingIdx] = pendingDrugSave;
        else drugs.push(pendingDrugSave);
        
        localStorage.setItem('drug_db_cache', JSON.stringify(drugs));
        
        const btn = document.querySelector('.btn-action');
        if(btn) { btn.innerHTML = "‚òÅÔ∏è Uploading..."; btn.disabled = true; }
        
        fetch(UPLOAD_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(pendingDrugSave) });
        setTimeout(() => {
            alert("‚úÖ Saved!");
            document.getElementById('search-input').value = pendingDrugSave.name;
            pendingDrugSave = null;
            handleSearch();
        }, 800);
    }

    // --- TTS ---
    function toggleSpeak(btnId, data) {
        const btn = document.getElementById(btnId);
        if (currentSpeakerId === btnId && window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
            resetSpeakerUI();
            return;
        }
        window.speechSynthesis.cancel();
        resetSpeakerUI();

        currentSpeakerId = btnId;
        btn.classList.add('speaking');
        btn.innerHTML = '‚èπ';

        let text = aiLanguage === 'lihkg' 
            ? `Drug Name: ${data.name}. Class: ${data.class}. Uses: ${data.indication}. Side Effects: ${data.SideEffects}. Nursing: ${data.nursing}`
            : `Drug Name: ${data.name}. Class: ${data.class}. Indication: ${data.indication}. Side Effects: ${data.SideEffects}. Nursing Considerations: ${data.nursing}`;

        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.name.includes("Enhanced") || v.name.includes("Premium")) || voices.find(v => v.lang.startsWith("en"));
        if(preferredVoice) utterance.voice = preferredVoice;
        utterance.rate = 0.95;
        utterance.onend = () => { resetSpeakerUI(); };
        window.speechSynthesis.speak(utterance);
    }

    function resetSpeakerUI() {
        if(currentSpeakerId) {
            const btn = document.getElementById(currentSpeakerId);
            if(btn) { btn.classList.remove('speaking'); btn.innerHTML = 'üîä'; }
            currentSpeakerId = null;
        }
    }

    // --- SEARCH ---
    function handleSearch() {
        const q = document.getElementById('search-input').value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        const emptyState = document.getElementById('empty-state-msg');
        localStorage.setItem('last_search_term', q);

        if(!q) {
            container.innerHTML = ''; container.appendChild(emptyState);
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        container.innerHTML = '';

        const matches = drugs.filter(d => (d.name+d.class+d.indication+d.system).toLowerCase().includes(q));
        matches.sort((a,b) => (a.name.length - b.name.length));

        if (matches.length > 0) {
            matches.slice(0, 50).forEach((d, idx) => renderResult(d, idx, container));
        } else {
            container.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <div style="color:var(--text-secondary); margin-bottom:15px;">No local match.</div>
                    <button class="btn-action" style="width:auto; margin:0 auto;" onclick="triggerAISearchAndGenerate('${q}')">
                        ‚ú® Ask AI Pharmacist
                    </button>
                </div>`;
        }
    }

    function renderResult(d, idx, container) {
        const div = document.createElement('div');
        div.className = 'result-card';
        const uniqueId = `drug-${Math.random().toString(36).substr(2, 9)}`;
        const aiId = `ai-${uniqueId}`;
        const speakBtnId = `spk-${uniqueId}`;
        const drugStr = JSON.stringify(d).replace(/"/g, '&quot;');
        const safeData = JSON.stringify({name: d.name, class: d.class, indication: d.indication, SideEffects: d.SideEffects, nursing: d.nursing}).replace(/"/g, '&quot;');

        div.innerHTML = `
            <div class="result-main">
                <div class="drug-info" onclick="toggleCard('${uniqueId}')">
                    <div class="drug-name">${d.name}</div>
                    <div class="drug-class">${d.class}</div>
                </div>
                <button id="${speakBtnId}" class="tts-btn" onclick="toggleSpeak('${speakBtnId}', ${safeData})">üîä</button>
            </div>
            <div id="${uniqueId}" class="result-detail">
                <div class="detail-row"><span class="d-label">Indication</span><span class="d-content">${d.indication || "N/A"}</span></div>
                <div class="detail-row"><span class="d-label">Side Effects</span><span class="d-content">${d.SideEffects || "N/A"}</span></div>
                <div class="detail-row"><span class="d-label">Nursing</span><span class="d-content">${d.nursing || "N/A"}</span></div>
                <div class="tool-row">
                    <button class="btn-tool tool-edit" onclick="triggerEditPrompt(${drugStr})">‚úèÔ∏è Edit</button>
                    <button class="btn-tool tool-isbar" onclick="handleTool('isbar', ${drugStr}, '${aiId}', this)">üöë ISBAR</button>
                    <button class="btn-tool tool-explain" onclick="handleTool('explain', ${drugStr}, '${aiId}', this)">üéì Explain</button>
                    <button class="btn-tool tool-cheat" onclick="handleTool('cheat', ${drugStr}, '${aiId}', this)">üìã Ward Sheet</button>
                    <button class="btn-tool tool-mix" onclick="handleTool('mix', ${drugStr}, '${aiId}', this)">üß™ Mix</button>
                </div>
                <div id="${aiId}" class="ai-output-box"></div>
            </div>`;
        container.appendChild(div);
    }

    function toggleCard(id) { document.getElementById(id).parentElement.classList.toggle('expanded'); }

    // --- DATA ---
    function fetchSheetData(silent = false) {
        const loading = document.getElementById('loading-skeleton');
        const results = document.getElementById('search-results');
        if(!silent) { results.style.display = 'none'; loading.style.display = 'block'; }
        
        const local = localStorage.getItem('drug_db_cache');
        if(local) { drugs = JSON.parse(local); if(!silent) loading.style.display = 'none'; results.style.display = 'flex'; }

        fetch(DB_URL).then(r=>r.text()).then(csv=>{
            Papa.parse(csv, {header:true, skipEmptyLines:true, complete:res=>{
                if(res.data.length){ 
                    drugs = res.data;
                    localStorage.setItem('drug_db_cache', JSON.stringify(drugs));
                    if(!silent) { loading.style.display = 'none'; results.style.display = 'flex'; }
                }
            }});
        });
    }

    function renderSystemChips() {
        const c = document.getElementById('system-chips');
        c.innerHTML = systems.map(s => `<button class="filter-chip ${s.id === 'All' ? 'active' : ''}" onclick="filterSys('${s.id}', this)">${s.name}</button>`).join('');
    }

    function filterSys(sys, btn) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const container = document.getElementById('search-results');
        const emptyState = document.getElementById('empty-state-msg');
        
        container.innerHTML = '';
        if(sys === 'All') { emptyState.style.display = 'block'; return; }
        emptyState.style.display = 'none';
        
        const sysName = sys === 'Inf' ? 'Infections' : sys;
        const matches = drugs.filter(d => (d.system || "").includes(sysName) || (sys === 'All'));
        if(matches.length > 0) matches.forEach((d, i) => renderResult(d, i, container));
        else container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary);">No drugs found in this category.</div>`;
    }

    // --- AI TOOLS ---
    function toggleOverlay(id) {
        const el = document.getElementById(id);
        const isOpen = el.classList.contains('show');
        if(isOpen) { el.classList.remove('show'); setTimeout(() => { el.style.display = 'none'; }, 300); } 
        else { el.style.display = 'flex'; setTimeout(() => { el.classList.add('show'); }, 10); }
    }
    
    function toggleDisease() { toggleOverlay('gen-overlay'); }
    function toggleVS() { toggleOverlay('vs-overlay'); }
    function toggleSettings() { toggleOverlay('settings-overlay'); }
    function toggleEditOverlay() { toggleOverlay('edit-overlay'); }

    async function triggerDisease() {
        const disease = document.getElementById('gen-input').value.trim();
        const btn = document.getElementById('btn-gen');
        const res = document.getElementById('gen-result-area');
        if(!disease) return;
        
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Consulting Protocol...';
        res.style.display = 'block'; res.innerHTML = 'Reading HA Guidelines...';
        
        const prompt = `Act as a Hong Kong Hospital Authority (HA) Pharmacist.
        The user asks about the condition: "${disease}".
        Task: List the standard medications used for this condition in HA hospitals.
        Format:
        1. **Class Name**
           * Drug Name (Route/Dose common range) - *One liner nursing check*
        Style: Use the "Old Seafood" persona (Mix of Professional English terms and Cantonese slang/reminders like "Check BP ar!", "Careful Hypo").
        Be concise. Focus on what a student nurse needs to prepare.`;
        
        try {
            const text = await getAIResponse(prompt);
            res.innerHTML = marked.parse(text);
            btn.innerHTML = '‚ú® Show Related Drugs';
        } catch(e) { res.innerHTML = "Error: " + e.message; } finally { btn.disabled = false; }
    }
    
    async function triggerCompare() {
        const a = document.getElementById('vs-input-a').value.trim();
        const b = document.getElementById('vs-input-b').value.trim();
        const btn = document.getElementById('btn-compare');
        const res = document.getElementById('vs-result-area');
        if (!a || !b) return;

        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Comparing...';
        res.style.display = 'block'; res.innerHTML = 'Analyzing...';

        const prompt = `Compare "${a}" vs "${b}" for a nursing student.
        Format as a Markdown Table.
        Columns: Feature, ${a}, ${b}.
        Rows: Class, Indication, Mechanism, Side Effects, Nursing.
        Summary: One sentence winner description.`;

        try {
            const text = await getAIResponse(prompt);
            res.innerHTML = marked.parse(text);
            btn.innerHTML = "‚úÖ Done";
        } catch(e) { res.innerHTML = "Error: " + e.message; } finally { btn.disabled = false; }
    }

    async function handleTool(type, drug, outId, btn) {
        const out = document.getElementById(outId);
        const originalText = btn.innerText;
        btn.innerHTML = '<span class="spinner"></span>';
        out.style.display = 'block'; out.innerHTML = 'Thinking...';
        
        let prompt = "";
        const persona = "You are a HK Nursing Mentor (Old Seafood style). Speak 'Kongish' (English/Cantonese mix).";
        if (type === 'isbar') prompt = `${persona} Write a realistic ISBAR handover for ${drug.name}. Situation: deterioration. Keep it brief.`;
        if (type === 'explain') prompt = `${persona} Explain ${drug.name} mechanism simply using an analogy. Mention the #1 killer side effect.`;
        if (type === 'cheat') prompt = `${persona} Create a bullet-point 'Survival Sheet' for ${drug.name}: 1. STOP if... 2. Monitor... 3. Red Flags.`;
        if (type === 'mix') prompt = `${persona} How to dilute/administer ${drug.name} (IV/PO)? Compatibility issues?`;

        try {
            const text = await getAIResponse(prompt);
            out.innerHTML = marked.parse(text);
        } catch(e) { out.innerHTML = "Error."; } finally { btn.innerHTML = originalText; }
    }

    async function getAIResponse(prompt) {
        let url = "https://api.deepseek.com/chat/completions";
        let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${keys.deepseek}` };
        let body = { model: "deepseek-chat", messages: [{role:"user", content: prompt}], stream: false };
        if(provider === 'yinli') { url = yinliUrl; headers["Authorization"] = `Bearer ${keys.yinli}`; body.model = yinliModel; }

        const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const json = await res.json();
        return json.choices[0].message.content;
    }

    function updateSettingsUI() {
        const p = document.getElementById('provider-select').value;
        const div = document.getElementById('settings-dynamic-fields');
        div.innerHTML = '';
        if(p === 'yinli') div.innerHTML = `<div class="ios-input-row"><span>API Key</span><input type="password" onchange="keys.yinli=this.value; localStorage.setItem('yl_key', this.value)" value="${keys.yinli}" class="ios-text-input" style="text-align:right"></div>`;
        else div.innerHTML = `<div class="ios-input-row"><span>API Key</span><input type="password" onchange="keys.deepseek=this.value; localStorage.setItem('ds_key', this.value)" value="${keys.deepseek}" class="ios-text-input" style="text-align:right"></div>`;
        provider = p;
        localStorage.setItem('ai_provider', p);
    }
    
    function toggleLanguage() {
        aiLanguage = aiLanguage === 'lihkg' ? 'english' : 'lihkg';
        document.getElementById('lang-display').innerText = aiLanguage === 'lihkg' ? 'LIHKG (Cantonese)' : 'English';
    }

    init();
</script>
</body>
</html>
